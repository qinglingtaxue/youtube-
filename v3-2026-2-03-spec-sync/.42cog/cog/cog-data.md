---
name: cog-data
description: 认知模型数据层 - 数据生命周期与存储策略
version: 1.0
created: 2026-02-04
parent: cog.md
---

# 认知模型数据层

> 本文档记录数据生命周期管理和存储策略，供大规模数据处理参考。
>
> 核心实体定义见：`cog.md`

---

## 时间窗口定义

<TimeWindow>
报告中使用的时间窗口标准定义：

| 窗口名称 | 天数范围 | 用途 |
|---------|---------|-----|
| 1天内 | 0-1 | 实时热点追踪 |
| 15天内 | 0-15 | 短期趋势分析 |
| 30天内 | 0-30 | 月度表现评估 |
| 全部 | 不限 | 全量数据分析 |

**内部存储时间桶**
| 桶名称 | 天数范围 | 说明 |
|-------|---------|-----|
| 24小时内 | 0-1 | 最新内容 |
| 7天内 | 1-7 | 近一周 |
| 30天内 | 7-30 | 近一月 |
| 90天内 | 30-90 | 近一季 |
| 6个月内 | 90-180 | 近半年 |
| 1年内 | 180-365 | 近一年 |
| 1年以上 | 365+ | 历史内容 |
</TimeWindow>

---

## 数据生命周期与存储策略

<DataLifecycle>

### 核心问题

当数据量达到十几万甚至更多时，需要解决：
1. **TrendSnapshot 爆炸**：N个视频 × M天 = N×M 条记录
2. **查询性能下降**：无索引/分区导致全表扫描
3. **存储成本增长**：冗余数据无限膨胀

### 分层存储策略

```
┌─────────────────────────────────────────────────────────────┐
│                    数据温度分层                              │
├─────────────────────────────────────────────────────────────┤
│ 🔴 热数据（近7天）  │ 完整快照，日粒度，支持实时查询          │
│ 🟡 温数据（7-30天） │ 周聚合快照，保留关键指标                │
│ 🔵 冷数据（30-90天）│ 月聚合快照，只保留统计数据              │
│ ⚪ 归档（90天+）    │ 只保留视频元数据，删除详细快照           │
└─────────────────────────────────────────────────────────────┘
```

### 新增实体：TrendAggregate

用于存储压缩后的趋势数据：

```
TrendAggregate:
  - video_id：视频ID
  - period_type：周期类型 ('daily' | 'weekly' | 'monthly')
  - period_start：周期开始时间
  - period_end：周期结束时间
  - views_start：周期开始播放量
  - views_end：周期结束播放量
  - growth_total：周期内总增长
  - growth_rate：增长率 (%)
  - snapshot_count：聚合的快照数量
```

### 数据压缩规则

| 数据年龄 | 存储粒度 | 保留时长 | 压缩操作 |
|----------|----------|----------|----------|
| 0-7天 | 日快照 | 7天 | 不压缩 |
| 7-30天 | 周聚合 | 30天 | 日快照 → 周聚合 |
| 30-90天 | 月聚合 | 90天 | 周聚合 → 月聚合 |
| 90天+ | 仅元数据 | 永久 | 删除所有快照 |

### 压缩效果估算

假设监控 5000 个视频：

| 时间范围 | 无压缩（条数） | 压缩后（条数） | 压缩比 |
|----------|---------------|---------------|--------|
| 1周 | 35,000 | 35,000 | 1:1 |
| 1个月 | 150,000 | 55,000 | 2.7:1 |
| 6个月 | 900,000 | 85,000 | **10:1** |
| 1年 | 1,825,000 | 115,000 | **16:1** |

### 视频数据去重策略

```
问题：同一视频被多个关键词采集 → 重复存储

解决方案：主表去重 + 关联表记录命中

CompetitorVideo（主表，以 youtube_id 为主键）
├─ youtube_id (PK)    # 唯一，不重复
├─ title, channel     # 基础信息
├─ first_seen_at      # 首次采集时间
├─ last_updated_at    # 最后更新时间
├─ current_views      # 当前播放量（覆盖更新）
└─ current_likes      # 当前点赞数（覆盖更新）

VideoKeywordHit（关联表）
├─ youtube_id         # 视频ID
├─ keyword            # 命中的关键词
├─ hit_at             # 命中时间
└─ rank_position      # 搜索排名位置
```

### 分页查询策略

```
问题：前端一次性加载10万条数据 → 浏览器崩溃

解决方案：后端分页 + 统计预计算

API 设计：
├─ GET /api/videos?page=1&limit=50     # 分页返回视频列表
├─ GET /api/stats                       # 返回预计算的统计数据
├─ GET /api/quadrant/summary            # 返回四象限聚合数据
└─ GET /api/duration/distribution       # 返回时长分布聚合

前端只存：
├─ 当前页数据（50条）
├─ 统计摘要数据
└─ 图表聚合数据
```

### 定时任务

```python
# 每日凌晨运行
@scheduled(cron="0 3 * * *")
def daily_data_maintenance():
    # 1. 压缩7天前的日快照为周聚合
    compress_to_weekly(older_than=7)

    # 2. 压缩30天前的周聚合为月聚合
    compress_to_monthly(older_than=30)

    # 3. 删除90天前的详细快照（保留元数据）
    archive_old_snapshots(older_than=90)

    # 4. 更新统计缓存
    refresh_stats_cache()
```

</DataLifecycle>
