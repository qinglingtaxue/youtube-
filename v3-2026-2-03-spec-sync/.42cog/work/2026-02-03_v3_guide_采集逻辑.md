# YouTube 数据采集逻辑

> 基于 `data_collector.py` 和 `yt_dlp_client.py` 的实际实现

---

## 核心架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      DataCollector                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 两阶段采集策略                                            │   │
│  │  - 阶段1: 快速搜索 (search_videos_fast)                   │   │
│  │  - 阶段2: 详情补充 (enrich_video_details)                 │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ YtDlpClient                                               │   │
│  │  - 搜索: search_videos() 使用 YouTube 原生 sp 参数        │   │
│  │  - 详情: get_video_info() 获取完整元数据                  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ CompetitorVideoRepository (SQLite)                        │   │
│  │  - 去重: exists_batch()                                   │   │
│  │  - 存储: save_batch()                                     │   │
│  │  - 查询: find_all(), find_without_details()               │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 两阶段采集策略

### 阶段 1: 快速搜索

**目的**: 快速获取大量视频的基础信息

**方法**: `search_videos_fast()` / `search_videos_parallel()`

**获取字段**:
- youtube_id
- title
- channel (频道名)
- view_count (播放量)
- duration (时长)

**速度**: ~0.5 秒/视频

**代码位置**: `data_collector.py:699-765`

```python
# 使用示例
collector = DataCollector()
new_count, skip_count = collector.search_videos_fast(
    keyword="养生",
    max_results=100,
    time_range="month"  # 使用 YouTube 原生时间过滤
)
```

### 阶段 2: 详情补充

**目的**: 对高播放量视频获取完整元数据

**方法**: `enrich_video_details()`

**获取字段**:
- upload_date (发布日期)
- like_count (点赞数)
- comment_count (评论数)
- description (描述)
- tags (标签)
- channel_id (频道ID)
- thumbnail_url (缩略图)

**速度**: ~3-5 秒/视频

**代码位置**: `data_collector.py:767-831`

```python
# 使用示例
success, fail = collector.enrich_video_details(
    min_views=10000,  # 只对高播放量视频获取详情
    limit=100         # Top 100
)
```

---

## 搜索策略

### 并行多策略搜索

**方法**: `search_videos_parallel()`

**策略组合**:
1. `view_count` - 按播放量排序 (确保 Top 100)
2. `relevance` - 按相关性排序 (覆盖最全)
3. `date` - 按发布日期排序 (发现新视频)

**代码位置**: `data_collector.py:589-697`

```python
# 并行执行 3 种排序策略
new, skip = collector.search_videos_parallel(
    keyword="养生",
    max_per_strategy=50,  # 每种策略 50 个
    time_range="month",
    theme="养生"
)
# 自动去重，合并结果
```

---

## 时间过滤机制

### YouTube 原生 sp 参数

**位置**: `yt_dlp_client.py:52-82`

```python
TIME_FILTER_PARAMS = {
    'hour': 'EgQIARAB',       # 过去 1 小时
    'today': 'EgQIAhAB',      # 24小时内
    'week': 'EgQIAxAB',       # 7天内
    'month': 'EgQIBBAB',      # 30天内
    'year': 'EgQIBRAB',       # 今年
}

# 时间过滤 + 按播放量排序 组合
TIME_AND_VIEW_SORT_PARAMS = {
    'week': 'EgQIAxABGAI%3D',   # 本周 + 按播放量
    'month': 'EgQIBBABGAI%3D',  # 本月 + 按播放量
}
```

### 搜索 URL 构建

**位置**: `yt_dlp_client.py:205-257`

```python
# 构建带过滤的搜索 URL
search_url = f"https://www.youtube.com/results?search_query={keyword}&sp={sp_param}"

# yt-dlp 命令
args = [
    '--dump-json',
    '--no-download',
    '--playlist-end', str(max_results),
    '--ignore-errors',
    search_url
]
```

---

## 关键词扩展

### 三层降级策略

**位置**: `data_collector.py:286-387`

```
┌─────────────────────────────────────────────────────────────────┐
│                    _generate_keywords(theme)                     │
│                                                                  │
│  输入: theme = "养生"                                            │
│  输出: ["养生", "中医养生", "健康养生", ...] (5-15个)            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 优先级 1: YouTube 搜索建议 (真实用户行为)                        │
│                                                                  │
│   expand_keywords_from_youtube("养生", 15)                       │
│                     │                                            │
│                     ▼                                            │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ get_youtube_suggestions("养生")                          │   │
│   │                                                          │   │
│   │ API: suggestqueries.google.com/complete/search           │   │
│   │      ?client=youtube&ds=yt&q=养生                        │   │
│   │                                                          │   │
│   │ 返回 JSONP: window.google.ac.h([                         │   │
│   │   "养生",                                                │   │
│   │   [["养生堂",0], ["养生功法",0], ["养生茶",0], ...]      │   │
│   │ ])                                                       │   │
│   │                                                          │   │
│   │ 解析后: ["养生堂", "养生功法", "养生茶", ...]            │   │
│   └─────────────────────────────────────────────────────────┘   │
│                     │                                            │
│                     ▼                                            │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 后缀扩展: 对每个后缀再获取建议                           │   │
│   │                                                          │   │
│   │ suffixes = ['教程', '入门', '技巧', '方法', ...]         │   │
│   │                                                          │   │
│   │ get_youtube_suggestions("养生教程") → [...]              │   │
│   │ get_youtube_suggestions("养生入门") → [...]              │   │
│   │ ...                                                      │   │
│   │                                                          │   │
│   │ 合并去重 → 最多 15 个                                    │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   ✓ 成功条件: 获取 >= 5 个关键词                                │
│   ✗ 失败条件: 网络错误 / 返回 < 5 个                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                    失败时降级 ▼
┌─────────────────────────────────────────────────────────────────┐
│ 优先级 2: 预定义关键词映射 (人工整理)                            │
│                                                                  │
│   keyword_mappings = {                                           │
│       '养生': ['养生', '中医养生', '健康养生', '养生堂', ...],   │
│       'AI工具': ['AI工具', 'ChatGPT', 'AI应用', ...],            │
│       '美食': ['美食制作', '家常菜', '烹饪技巧', ...],           │
│       ...                                                        │
│   }                                                              │
│                                                                  │
│   匹配逻辑:                                                      │
│   1. 精确匹配: theme == "养生" → 直接返回映射                    │
│   2. 模糊匹配: "老人养生" 包含 "养生" → 返回养生的映射           │
│                                                                  │
│   ✓ 成功条件: 找到匹配的映射                                    │
│   ✗ 失败条件: theme 不在映射表中                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                    失败时降级 ▼
┌─────────────────────────────────────────────────────────────────┐
│ 优先级 3: 默认后缀扩展 (兜底)                                    │
│                                                                  │
│   default_suffixes = ['教程', '入门', '技巧', '方法', ...]       │
│                                                                  │
│   theme = "区块链"  (不在映射表中)                               │
│                                                                  │
│   生成:                                                          │
│   ["区块链", "区块链教程", "区块链入门", "区块链技巧", ...]      │
│                                                                  │
│   ✓ 永远成功 (兜底策略)                                         │
└─────────────────────────────────────────────────────────────────┘
```

### 优先级对比

| 优先级 | 数据来源 | 优点 | 缺点 |
|--------|----------|------|------|
| 1 | YouTube API | **真实用户搜索行为** | 依赖网络 |
| 2 | 预定义映射 | 人工精选，质量高 | 覆盖有限 |
| 3 | 后缀拼接 | 永远可用 | 可能不精准 |

### 为什么优先用 YouTube 搜索建议？

```python
# 这些是用户真正在 YouTube 搜索框输入的词
# 比 AI 猜测的关键词更能反映真实需求

输入: "养生"
YouTube 返回: ["养生堂", "养生功法", "养生茶", "养生操", "养生饮食"]
                 ↑
            这些是真实用户高频搜索词
```

**踩坑经验**: 如果 AI 随意生成关键词（如 "养生秘籍"、"养生宝典"），搜索结果可能很少，浪费采集配额。

### YouTube 搜索建议 API

**位置**: `yt_dlp_client.py:678-772`

```python
def get_youtube_suggestions(keyword: str, limit: int = 10) -> List[str]:
    """
    从 YouTube 搜索建议获取真实用户高频词

    API: https://suggestqueries.google.com/complete/search
         ?client=youtube&ds=yt&q={keyword}

    返回 JSONP 格式，需解析
    """

def expand_keywords_from_youtube(seed_keyword: str, max_keywords: int = 15) -> List[str]:
    """
    基于种子关键词扩展:
    1. 直接获取建议
    2. 添加后缀扩展 (教程、入门、技巧...)
    3. 去重合并
    """
```

### 预定义关键词映射

**位置**: `data_collector.py:314-362`

```python
keyword_mappings = {
    # 养生相关
    '养生': ['养生', '中医养生', '健康养生', '养生堂', '养生食谱', ...],
    '老人养生': ['中医养生', '健康科普', '长寿秘诀', ...],

    # AI 相关
    'AI工具': ['AI工具', 'ChatGPT', 'AI应用', 'Claude', 'Midjourney', ...],

    # 美食相关
    '美食': ['美食制作', '家常菜', '烹饪技巧', '美食vlog', ...],

    # 健身相关
    '健身': ['健身教程', '减肥健身', '居家健身', '瑜伽教程', ...],

    # 编程相关
    'Python': ['Python教程', 'Python入门', 'Python爬虫', ...],

    # 自媒体相关
    'YouTube': ['YouTube运营', 'YouTube涨粉', 'YouTube变现', ...],

    # ... 更多领域
}
```

### 默认后缀扩展

**位置**: `data_collector.py:377-387`

```python
default_suffixes = ['教程', '入门', '技巧', '方法', '推荐', '攻略',
                   '2025', '怎么', '如何', '最新']

# 示例: theme = "区块链"
# 生成: ["区块链", "区块链教程", "区块链入门", "区块链技巧", ...]
```

---

## 大规模采集

### 方法: `collect_large_scale()`

**位置**: `data_collector.py:833-982`

**流程**:

```
1. 生成扩展关键词 (5-15个)
   └── _generate_keywords()

2. 阶段1: 并行搜索 (10个关键词并行)
   └── ThreadPoolExecutor(max_workers=10)
   └── search_videos_parallel() * N

3. 阶段2: Top 100 详情
   └── enrich_video_details(min_views=10000, limit=100)

4. 返回统计信息
```

**示例**:

```python
result = collector.collect_large_scale(
    theme="养生",
    target_count=500,
    detail_min_views=10000,
    detail_limit=200,
    time_range="month"
)

# 返回:
# {
#   'theme': '养生',
#   'keywords': ['养生', '中医养生', ...],
#   'search_phase': {'new_videos': 450, 'skipped': 50},
#   'detail_phase': {'success': 100, 'failed': 5},
#   'database': {'total': 500, ...},
#   'elapsed_seconds': 180
# }
```

---

## 去重机制

### 内存去重

**位置**: `data_collector.py:389-400`

```python
def _deduplicate_videos(self, videos):
    seen_ids = set()
    unique_videos = []
    for video in videos:
        video_id = video.get('id') or video.get('youtube_id')
        if video_id and video_id not in seen_ids:
            seen_ids.add(video_id)
            unique_videos.append(video)
    return unique_videos
```

### 数据库去重

**位置**: `data_collector.py:747-753`

```python
# 批量检查数据库中是否已存在
youtube_ids = [v.youtube_id for v in videos]
existing_ids = self.repository.exists_batch(youtube_ids)

# 过滤已存在的
new_videos = [v for v in videos if v.youtube_id not in existing_ids]
```

---

## 数据模型

### CompetitorVideo

**位置**: `src/shared/models/research.py`

```python
@dataclass
class CompetitorVideo:
    # 基础信息
    youtube_id: str
    title: str
    channel_name: str
    channel_id: Optional[str]

    # 统计数据
    view_count: int
    like_count: Optional[int]
    comment_count: Optional[int]

    # 时间信息
    duration: int
    upload_date: Optional[str]

    # 来源追踪
    keyword_source: str
    theme: Optional[str]
    collected_at: str

    # 详情补充
    description: Optional[str]
    tags: List[str]
    thumbnail_url: Optional[str]

    @classmethod
    def from_ytdlp_search(cls, data, keyword, theme=None):
        """从搜索结果创建"""

    @classmethod
    def from_ytdlp_details(cls, data, keyword, theme=None):
        """从详情结果创建"""
```

---

## 错误处理

### YtDlpError

**位置**: `yt_dlp_client.py:35-37`

```python
class YtDlpError(Exception):
    """yt-dlp 相关错误"""
    pass
```

### 重试策略

```python
# 可重试错误
retry_on = ['network_error', 'timeout', '429', '503']

# 不可重试错误
skip_on = ['404', 'video_unavailable', 'private_video']
```

### 速率限制

```python
# 搜索后延迟
time.sleep(1)

# 详情获取后延迟
time.sleep(1)

# 关键词切换后延迟
time.sleep(2)
```

---

## 存储层

### SQLite 数据库

**表**: `competitor_videos`

**关键字段**:
- `youtube_id` (主键)
- `view_count` (索引, 用于排序)
- `has_details` (标记是否有完整详情)
- `keyword_source` (关键词来源)
- `theme` (主题分类)

### Repository 接口

```python
repository.save_batch(videos)           # 批量保存
repository.exists_batch(youtube_ids)    # 批量检查存在
repository.find_without_details(min_views, limit)  # 查找需要补充详情的
repository.update_details(video)        # 更新详情
repository.find_all(theme=, keyword=, min_views=, has_details=)  # 查询
repository.get_statistics()             # 统计信息
```

---

## 采集命令

### 单关键词快速搜索

```bash
python src/research/data_collector.py "养生" 50
```

### 大规模采集 (CLI)

```bash
python cli.py collect --theme "养生" --count 500 --time-range month
```

### 详情补充

```bash
python scripts/补全视频详情.py
```

### 频道信息补充

```bash
python scripts/fetch_channel_info.py
```

---

## 性能指标

| 操作 | 速度 | 说明 |
|------|------|------|
| 快速搜索 | ~0.5s/视频 | 仅基础信息 |
| 详情获取 | ~3-5s/视频 | 完整元数据 |
| 并行搜索 | ~10个关键词/分钟 | 10并发 |
| 大规模采集 500 | ~3分钟 | 搜索阶段 |
| Top 100 详情 | ~5分钟 | 详情阶段 |

---

## 注意事项

1. **时间过滤**: 必须使用 YouTube 原生 sp 参数，不能只靠本地过滤
2. **关键词来源**: 优先使用 YouTube 搜索建议，避免硬编码
3. **速率限制**: 请求间必须有延迟，避免被 YouTube 限流
4. **去重**: 多策略/多关键词搜索会有重复，必须去重
5. **两阶段**: 先快速搜索获取基础信息，再对 Top 100 获取详情

---

## 每日定时采集策略

### 两轮采集设计

**脚本**: `scripts/daily_update.py`

```
┌─────────────────────────────────────────────────────────────┐
│                    每日定时采集                              │
├─────────────────────────────────────────────────────────────┤
│  第一轮：7天内热门                                           │
│  - 目标：200条                                              │
│  - 详情阈值：播放量 >= 5000                                  │
│  - 详情上限：50条                                            │
│  - 目的：快速发现新爆款                                      │
├─────────────────────────────────────────────────────────────┤
│  第二轮：60天内覆盖                                          │
│  - 目标：500条                                              │
│  - 详情阈值：播放量 >= 10000                                 │
│  - 详情上限：100条                                           │
│  - 目的：积累中期数据，覆盖更广                              │
└─────────────────────────────────────────────────────────────┘
```

### 60天时间范围实现

YouTube 原生只支持 `month`（30天），60天通过 `year` + 后置过滤实现：

```python
# yt_dlp_client.py
TIME_FILTER_PARAMS = {
    'two_months': 'EgQIBRAB',  # 使用 year 参数
}

# 搜索后过滤
if time_range == 'two_months':
    videos = self._filter_by_date_range(videos, days=60)
```

### 使用方式

```bash
# 更新默认主题列表
python scripts/daily_update.py

# 更新指定主题
python scripts/daily_update.py --topics 养生

# 试运行
python scripts/daily_update.py --dry-run
```

---

## 标签二次采集

### 设计思路

从已采集视频的标签中提取高频词，作为新关键词进行补充采集。

**脚本**: `scripts/collect_from_tags.py`

```
┌─────────────────────────────────────────────────────────────┐
│                   标签二次采集                               │
├─────────────────────────────────────────────────────────────┤
│  1. 从数据库提取视频的 tags 字段                             │
│  2. 统计高频标签（出现 >= 10 次）                            │
│  3. 排除已采集过的关键词                                     │
│  4. 用高频标签作为新关键词搜索                               │
└─────────────────────────────────────────────────────────────┘
```

### 核心函数: `get_high_freq_tags()`

**位置**: `scripts/collect_from_tags.py:33-110`

```
┌─────────────────────────────────────────────────────────────────┐
│                get_high_freq_tags(theme, min_count, top_n)       │
│                                                                  │
│  输入: theme="养生", min_count=10, top_n=30                      │
│  输出: [("中老年", 48), ("中医药", 35), ("穴位", 28), ...]       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: 获取已有关键词（避免重复采集）                           │
│                                                                  │
│   SELECT DISTINCT keyword_source FROM competitor_videos          │
│   WHERE theme = '养生'                                           │
│                                                                  │
│   → existing_keywords = {"养生", "中医养生", "健康养生", ...}    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: 获取所有视频的 tags 字段                                 │
│                                                                  │
│   SELECT tags FROM competitor_videos                             │
│   WHERE theme = '养生' AND tags IS NOT NULL                      │
│                                                                  │
│   tags 格式:                                                     │
│   - JSON: '["中老年", "穴位", "经络"]'                           │
│   - 逗号分隔: "中老年,穴位,经络"                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 3: 解析并统计频次                                           │
│                                                                  │
│   tag_counter = Counter()                                        │
│                                                                  │
│   for tags_str in all_tags:                                      │
│       tags = json.loads(tags_str)  # 或按逗号分割                │
│       for tag in tags:                                           │
│           if 2 <= len(tag) <= 10:  # 长度过滤                    │
│               tag_counter[tag] += 1                              │
│                                                                  │
│   结果: {"中老年": 48, "穴位": 35, "经络": 28, "健康": 120, ...} │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 4: 多层过滤                                                 │
│                                                                  │
│   for tag, count in tag_counter.most_common(200):                │
│                                                                  │
│       # 过滤1: 跳过已有关键词                                    │
│       if tag in existing_keywords: continue                      │
│                                                                  │
│       # 过滤2: 跳过英文词                                        │
│       exclude = ['health', 'tips', 'care', 'advice']             │
│       if any(p in tag.lower() for p in exclude): continue        │
│                                                                  │
│       # 过滤3: 跳过太通用的词                                    │
│       generic = {'健康', '中医', '养生', '疾病', '视频', ...}    │
│       if tag in generic: continue                                │
│                                                                  │
│       # 过滤4: 最小出现次数                                      │
│       if count < min_count: continue                             │
│                                                                  │
│       result.append((tag, count))                                │
│       if len(result) >= top_n: break                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 输出: 高质量新关键词列表                                         │
│                                                                  │
│   [("中老年", 48), ("中医药", 35), ("穴位", 28),                 │
│    ("经络养生", 25), ("失眠", 22), ("血压", 20), ...]            │
│                                                                  │
│   特点:                                                          │
│   - 来自真实视频标签（不是 AI 猜测）                             │
│   - 高频出现（说明用户关注）                                     │
│   - 排除已采集的（避免重复）                                     │
│   - 排除太通用的（提高精准度）                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 过滤规则详解

| 过滤类型 | 规则 | 示例 |
|----------|------|------|
| 长度限制 | 2-10 字符 | 排除 "a"、"超长的标签名称..." |
| 已有关键词 | 在 keyword_source 中 | 排除 "养生"、"中医养生" |
| 英文词 | 包含 health/tips/care | 排除 "health tips" |
| 通用词 | 硬编码列表 | 排除 "健康"、"视频"、"分享" |
| 最小频次 | >= min_count | 排除出现 < 10 次的 |

### 通用词过滤列表

```python
generic_words = {
    '健康', '中医', '养生', '疾病', '保健', '视频', '频道',
    '中国', '台湾', '生活', '日常', '分享', '推荐',
}
```

### 为什么有效？

1. **关键词更精准** - 来自实际视频标签，不是凭空猜测
2. **覆盖更广** - 发现常规搜索遗漏的细分领域
3. **去重率低** - 大部分是新视频

### 示例效果

| 关键词 | 新增 | 跳过 |
|--------|------|------|
| 中老年 | 48 | 2 |
| 中医药 | 50 | 0 |
| 中药 | 42 | 8 |
| 健康生活 | 50 | 0 |
| 健康饮食 | 49 | 1 |

### 使用方式

```bash
# 预览将采集的关键词
python scripts/collect_from_tags.py --theme 养生 --dry-run

# 执行采集（使用前20个高频标签）
python scripts/collect_from_tags.py --theme 养生 --top 20

# 自定义参数
python scripts/collect_from_tags.py --theme 养生 --top 30 --target 100 --min-count 5
```

---

## 多领域/多语言采集

### 多领域采集

**脚本**: `scripts/collect_multi_domain.py`

```bash
# 列出可用领域
python scripts/collect_multi_domain.py --list

# 采集所有领域
python scripts/collect_multi_domain.py

# 采集指定领域
python scripts/collect_multi_domain.py --domains 科技 美食
```

### 多语言采集

**脚本**: `scripts/collect_multilang.py`

```bash
# 列出支持的语言和话题
python scripts/collect_multilang.py --list

# 采集指定话题的多语言版本
python scripts/collect_multilang.py --topic 太极 --lang en ja

# 分析已采集的多语言数据
python scripts/collect_multilang.py --analyze
```

---

## 采集策略对比

| 策略 | 脚本 | 适用场景 | 关键词来源 |
|------|------|----------|------------|
| 每日更新 | daily_update.py | 定时任务，持续积累 | YouTube 搜索建议 |
| 标签二次采集 | collect_from_tags.py | 已有数据后的补充采集 | 已采集视频的标签 |
| 多领域采集 | collect_multi_domain.py | 扩展新领域 | 预定义领域关键词 |
| 多语言采集 | collect_multilang.py | 跨语言内容分析 | 多语言翻译映射 |

---

## 采集效果示例（2026-01-25 养生主题）

### 每日更新效果

| 轮次 | 时间范围 | 新增 | 详情 |
|------|----------|------|------|
| 第一轮 | 7天内 | 146 | 91 |
| 第二轮 | 60天内 | ~50 | ~100 |

### 数据分布变化

| 时间段 | 之前 | 之后 | 增长 |
|--------|------|------|------|
| 7天内 | 111 | 270+ | +159 |
| 8-30天 | 181 | 250+ | +69 |
| 31-60天 | 64 | 110+ | +46 |
| 总数 | 2240 | 2700+ | +460+ |
