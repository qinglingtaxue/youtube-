# æŠ€æœ¯å†³ç­–è®°å½•

## TD-001: é€‰æ‹© Better Auth ä½œä¸ºè®¤è¯æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-12-22
**çŠ¶æ€**: âœ… å·²å®æ–½
**å†³ç­–è€…**: å¼€å‘å›¢é˜Ÿ

### èƒŒæ™¯
éœ€è¦ä¸ºè¯—æ­Œå¿ƒæ™ºå¯è§†åŒ–å¹³å°å®ç°ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†åŠŸèƒ½ã€‚

### è€ƒè™‘çš„æ–¹æ¡ˆ

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ç»“è®º |
|------|------|------|------|
| NextAuth.js | ç”Ÿæ€æˆç†Ÿï¼Œæ–‡æ¡£é½å…¨ | é…ç½®å¤æ‚ï¼Œç±»å‹æ”¯æŒä¸å¤Ÿå¥½ | âŒ æ”¾å¼ƒ |
| Clerk | å¼€ç®±å³ç”¨ï¼ŒUI ç»„ä»¶ä¸°å¯Œ | ç¬¬ä¸‰æ–¹æœåŠ¡ä¾èµ–ï¼Œæˆæœ¬è¾ƒé«˜ | âŒ æ”¾å¼ƒ |
| Better Auth | è½»é‡çº§ï¼ŒTypeScript åŸç”Ÿï¼ŒDrizzle é›†æˆå¥½ | ç›¸å¯¹è¾ƒæ–°ï¼Œç¤¾åŒºè¾ƒå° | âœ… é€‰æ‹© |
| è‡ªå»ºè®¤è¯ | å®Œå…¨æ§åˆ¶ | å¼€å‘æˆæœ¬é«˜ï¼Œå®‰å…¨é£é™©å¤§ | âŒ æ”¾å¼ƒ |

### æœ€ç»ˆå†³ç­–
**é€‰æ‹© Better Auth v1.x + Drizzle ORM**

### ç†ç”±
1. **TypeScript åŸç”Ÿæ”¯æŒ**ï¼šç±»å‹å®‰å…¨ï¼Œå¼€å‘ä½“éªŒå¥½
2. **Drizzle ORM é›†æˆ**ï¼šä¸é¡¹ç›®æŠ€æœ¯æ ˆä¸€è‡´
3. **è½»é‡çº§**ï¼šä¸å¼•å…¥è¿‡å¤šä¾èµ–
4. **çµæ´»æ€§**ï¼šæ˜“äºå®šåˆ¶å’Œæ‰©å±•
5. **å¼€æºå…è´¹**ï¼šæ— éœ€ä»˜è´¹è®¢é˜…

### åæœä¸å½±å“
- âœ… å¼€å‘æ•ˆç‡æå‡ï¼ˆç±»å‹å®‰å…¨ï¼‰
- âš ï¸ éœ€è¦å­¦ä¹  Better Auth çš„ç‰¹å®šçº¦å®šï¼ˆschema è§„èŒƒï¼‰
- âœ… ä¸ Drizzle é›†æˆè‰¯å¥½
- âš ï¸ ç¤¾åŒºèµ„æºç›¸å¯¹è¾ƒå°‘ï¼Œéœ€è¦æ›´å¤šå‚è€ƒå®˜æ–¹æ–‡æ¡£

---

## TD-002: Better Auth + Drizzle é›†æˆè¸©å‘è®°å½•

**æ—¥æœŸ**: 2025-12-23
**çŠ¶æ€**: âœ… å·²è§£å†³
**é—®é¢˜ä¸¥é‡ç¨‹åº¦**: ğŸ”¥ ä¸¥é‡ï¼ˆé˜»å¡å¼€å‘ï¼‰

### é—®é¢˜æè¿°
åœ¨é›†æˆ Better Auth å’Œ Drizzle ORM æ—¶ï¼Œé‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š
1. `relation "user" does not exist`
2. `column "userId" of relation "sessions" does not exist`
3. `null value in column "token" of relation "session" violates not-null constraint`

### æ ¹æœ¬åŸå› åˆ†æ

#### åŸå›  1: Schema è¡¨åä¸åŒ¹é…
**é”™è¯¯ä»£ç **ï¼š
```typescript
export const sessions = pgTable('sessions', { ... })  // âŒ å¤æ•°
```

**æ­£ç¡®ä»£ç **ï¼š
```typescript
export const sessions = pgTable('session', { ... })   // âœ… å•æ•°
```

**æ•™è®­**ï¼šBetter Auth æœŸæœ›è¡¨åä¸ºå•æ•°å½¢å¼ï¼Œä¸èƒ½è‡ªå·±çŒœæµ‹ï¼

#### åŸå›  2: å­—æ®µå‘½åä¸ç¬¦åˆè§„èŒƒ
**é”™è¯¯å‡è®¾**ï¼šä½¿ç”¨ snake_case å‘½åï¼ˆå¦‚ `user_id`, `email_verified`ï¼‰

**æ­£ç¡®è§„èŒƒ**ï¼šå¿…é¡»ä½¿ç”¨ camelCaseï¼ˆå¦‚ `userId`, `emailVerified`ï¼‰

#### åŸå›  3: ID ç±»å‹é”™è¯¯
**é”™è¯¯ä»£ç **ï¼š
```typescript
id: uuid('id').defaultRandom().primaryKey()  // âŒ UUID
```

**æ­£ç¡®ä»£ç **ï¼š
```typescript
id: text('id').primaryKey()  // âœ… text ç±»å‹
```

**é…å¥—è¦æ±‚**ï¼š
```typescript
generateId: () => crypto.randomUUID()  // å¿…é¡»é…ç½®
```

#### åŸå›  4: Token å­—æ®µçº¦æŸé”™è¯¯
**é”™è¯¯ä»£ç **ï¼š
```typescript
token: text('token').notNull().unique()  // âŒ NOT NULL
```

**æ­£ç¡®ä»£ç **ï¼š
```typescript
token: text('token').unique()  // âœ… nullable
```

**åŸå› **ï¼šBetter Auth åœ¨æŸäº›æƒ…å†µä¸‹ä¸ç”Ÿæˆ tokenï¼ˆå¦‚ OAuth ç™»å½•ï¼‰

#### åŸå›  5: ç¼ºå°‘ Schema Mapping
**é”™è¯¯åšæ³•**ï¼šæ²¡æœ‰æ˜¾å¼å£°æ˜ schema mappingï¼Œä¾èµ– Better Auth è‡ªåŠ¨æ¨æ–­

**æ­£ç¡®åšæ³•**ï¼š
```typescript
database: drizzleAdapter(db, {
  provider: 'pg',
  schema: {
    user: schema.users,         // å¿…é¡»æ˜¾å¼æ˜ å°„
    session: schema.sessions,
    account: schema.accounts,
    verification: schema.verifications,
  },
  generateId: () => crypto.randomUUID(),
}),
```

### è§£å†³æ–¹æ¡ˆ
1. âœ… æ›´æ–° schema.tsï¼šè¡¨åæ”¹ä¸ºå•æ•°ï¼Œå­—æ®µæ”¹ä¸º camelCaseï¼ŒID æ”¹ä¸º text
2. âœ… ä¿®æ”¹ auth.config.tsï¼šæ·»åŠ  schema mapping å’Œ generateId
3. âœ… ä¿®å¤ token å­—æ®µï¼šä» NOT NULL æ”¹ä¸º nullable
4. âœ… é‡å»ºæ•°æ®åº“è¡¨

### é¢„é˜²æªæ–½
1. **åœ¨ `.42cog/real/real.md` ä¸­æ·»åŠ æŠ€æœ¯çº¦æŸ** âœ… å·²å®Œæˆ
2. **åœ¨ `dev-coding` æŠ€èƒ½ä¸­æ·»åŠ ç¬¬ä¸‰æ–¹åº“é›†æˆæ£€æŸ¥æ¸…å•** âœ… å·²å®Œæˆ
3. **å»ºç«‹"å…ˆæŸ¥æ–‡æ¡£å†ç¼–ç "çš„æµç¨‹**
4. **é‡åˆ°ç¬¬ä¸‰æ–¹åº“ï¼Œä¼˜å…ˆä½¿ç”¨å®˜æ–¹ CLI æˆ– starter template**

### ç»éªŒæ€»ç»“
> **æ•™è®­**ï¼šé›†æˆç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œ**æ°¸è¿œä¸è¦çŒœæµ‹å®ƒçš„ schema è¦æ±‚**ï¼Œå¿…é¡»ï¼š
> 1. é˜…è¯»å®˜æ–¹æ–‡æ¡£çš„ Database Adapter éƒ¨åˆ†
> 2. æŸ¥çœ‹å®˜æ–¹ç¤ºä¾‹ä»£ç 
> 3. å¦‚æœæœ‰ CLIï¼Œä¼˜å…ˆä½¿ç”¨ CLI ç”Ÿæˆ schema
> 4. ä¸¥æ ¼éµå¾ªå®˜æ–¹è§„èŒƒï¼Œä¸åšä»»ä½•å‡è®¾

---

## TD-003: å‰ç«¯ç™»å½•æµç¨‹é—®é¢˜ï¼ˆå·²è§£å†³ï¼‰

**æ—¥æœŸ**: 2025-12-23
**è§£å†³æ—¥æœŸ**: 2025-12-24
**çŠ¶æ€**: âœ… å·²è§£å†³
**é—®é¢˜ä¸¥é‡ç¨‹åº¦**: âš ï¸ ä¸­ç­‰

### é—®é¢˜æè¿°
- åç«¯ API å®Œå…¨æ­£å¸¸ï¼ˆæ³¨å†Œ/ç™»å½•éƒ½è¿”å› 200ï¼‰
- å‰ç«¯ç™»å½•é¡µé¢è°ƒç”¨ `signIn.email()` åæŒ‚èµ·ï¼Œæ²¡æœ‰è·³è½¬

### é—®é¢˜æ’æŸ¥è¿‡ç¨‹

#### 1. ç½‘ç»œç›‘æ§è°ƒè¯•ï¼ˆå…³é”®çªç ´ï¼‰
ä½¿ç”¨ Playwright åˆ›å»ºç½‘ç»œç›‘æ§æµ‹è¯• `test-network-debug.ts`ï¼Œå‘ç°ï¼š
```
ğŸ“¤ Request: POST http://localhost:3002/api/auth/sign-in/email
ğŸ“¥ Response: 200
[Browser log] [Login] ç™»å½•æˆåŠŸ: {user: Object, session: Object, redirect: false}
```

**å…³é”®å‘ç°**ï¼šBetter Auth è¿”å› `redirect: false`ï¼Œè¯´æ˜ï¼š
- ç™»å½• API è°ƒç”¨æˆåŠŸ
- è¿”å›çš„ data åŒ…å« user å’Œ session
- ä½† `redirect` å­—æ®µä¸º `false`ï¼Œè¡¨ç¤ºä¸ä¼šè‡ªåŠ¨è·³è½¬

#### 2. æ ¹æœ¬åŸå› åˆ†æ
Better Auth çš„è®¾è®¡ï¼š
- ç™»å½•æˆåŠŸåè¿”å› `redirect: false`
- éœ€è¦å‰ç«¯ä»£ç **æ‰‹åŠ¨å¤„ç†å¯¼èˆª**
- åŸä»£ç ä½¿ç”¨ `router.push('/')` ä½†å¯èƒ½æ‰§è¡Œæ—¶æœºæœ‰é—®é¢˜

#### 3. è§£å†³æ–¹æ¡ˆ
ä¿®æ”¹ `src/app/login/page.tsx`ï¼š

**ä¿®æ”¹å‰**ï¼š
```typescript
router.push('/')
router.refresh()
```

**ä¿®æ”¹å**ï¼š
```typescript
// ç­‰å¾… session æ›´æ–°åé‡å®šå‘åˆ°é¦–é¡µ
setTimeout(() => {
  console.log('[Login] æ‰§è¡Œè·³è½¬åˆ°é¦–é¡µ')
  window.location.href = '/'
}, 500)
```

**ä¿®æ”¹ç†ç”±**ï¼š
- ä½¿ç”¨ `window.location.href` è€Œé `router.push()` ç¡®ä¿é¡µé¢å®Œå…¨é‡æ–°åŠ è½½
- æ·»åŠ  500ms å»¶è¿Ÿï¼Œç»™ Better Auth è¶³å¤Ÿæ—¶é—´è®¾ç½® session cookie
- æ·»åŠ æ—¥å¿—ä¾¿äºè°ƒè¯•

#### 4. éªŒè¯æµ‹è¯•
åˆ›å»º `test-login-redirect-fix.ts` è¿›è¡ŒéªŒè¯ï¼š
```
âœ… Redirect successful!
ğŸ“ Final URL: http://localhost:3002/
ğŸ‰ SUCCESS: Redirected to homepage as expected!
```

### è§£å†³æˆæœ
- âœ… åç«¯ API æµ‹è¯•é€šè¿‡
- âœ… æ•°æ®åº“æ­£ç¡®ä¿å­˜ç”¨æˆ·å’Œ session
- âœ… ä¿®å¤äº†ç¼ºå¤±çš„ UI ç»„ä»¶ï¼ˆavatar, badgeï¼‰
- âœ… ä¿®å¤äº† auth-client çš„ baseURL é…ç½®
- âœ… å‰ç«¯ç™»å½•æˆåŠŸåæ­£ç¡®è·³è½¬åˆ°é¦–é¡µ

### ç»éªŒæ€»ç»“
> **æ•™è®­**ï¼šå½“ç¬¬ä¸‰æ–¹åº“çš„è¡Œä¸ºä¸ç¬¦åˆé¢„æœŸæ—¶ï¼Œä½¿ç”¨ç½‘ç»œç›‘æ§å·¥å…·ï¼ˆå¦‚ Playwrightï¼‰å¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜ã€‚
>
> **å…³é”®æŠ€å·§**ï¼š
> 1. ä½¿ç”¨ Playwright ç›‘æ§ç½‘ç»œè¯·æ±‚å’Œå“åº”
> 2. ç›‘æ§æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—
> 3. æŸ¥çœ‹ API è¿”å›çš„å®Œæ•´æ•°æ®ç»“æ„ï¼ˆä¸åªæ˜¯ error å­—æ®µï¼‰
> 4. ç†è§£ç¬¬ä¸‰æ–¹åº“çš„è®¾è®¡ç†å¿µï¼ˆBetter Auth ä¸è‡ªåŠ¨è·³è½¬ï¼‰
> 5. ä½¿ç”¨ `window.location.href` æ›¿ä»£ `router.push()` ç¡®ä¿å®Œæ•´é¡µé¢åˆ·æ–°

---

## æŠ€æœ¯å€ºåŠ¡è¿½è¸ª

### é«˜ä¼˜å…ˆçº§
- [x] ~~è§£å†³å‰ç«¯ç™»å½•æŒ‚èµ·é—®é¢˜~~ âœ… å·²äº 2025-12-24 è§£å†³
- [ ] æ·»åŠ è®¤è¯ç›¸å…³çš„å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™è®¤è¯æµç¨‹çš„é›†æˆæµ‹è¯•

### ä¸­ä¼˜å…ˆçº§
- [ ] ä¼˜åŒ– session ç®¡ç†ï¼ˆæ·»åŠ  refresh tokenï¼‰
- [ ] å®ç°é‚®ç®±éªŒè¯åŠŸèƒ½
- [ ] æ·»åŠ å¯†ç é‡ç½®åŠŸèƒ½

### ä½ä¼˜å…ˆçº§
- [ ] æ·»åŠ ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆGitHub, Googleï¼‰
- [ ] å®ç°åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰
- [ ] Session ç®¡ç†çš„æ€§èƒ½ä¼˜åŒ–

---

## å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- Better Auth å®˜æ–¹æ–‡æ¡£: https://www.better-auth.com/docs
- Better Auth + Drizzle é›†æˆ: https://www.better-auth.com/docs/integrations/drizzle
- Drizzle ORM æ–‡æ¡£: https://orm.drizzle.team

### ç›¸å…³ Issues
- Better Auth GitHub Issues: https://github.com/better-auth/better-auth/issues
- ç›¸å…³è®¨è®ºï¼šSchema naming conventions

### å›¢é˜ŸçŸ¥è¯†åº“
- `.42cog/real/real.md` - æŠ€æœ¯çº¦æŸï¼ˆå·²æ›´æ–°ï¼‰
- `.42plugin/42edu/dev-coding/prompt.md` - å¼€å‘æŠ€èƒ½æŒ‡å—ï¼ˆå·²æ›´æ–°ï¼‰
