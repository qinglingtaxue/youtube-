# 设计决策记录 (ADR)

记录项目中重要的架构和技术决策，以及决策原因和影响。

## ADR-001: 使用MCP工具替代YouTube API

**日期**: 2025-12-09
**状态**: 已接受
**类型**: 架构决策

### 背景

项目初始设计使用YouTube Data API v3进行数据收集，但考虑到：
1. API配额限制（每日10,000单位）
2. 需要注册Google Cloud并申请API密钥
3. 可能的数据延迟和缓存问题
4. 无法获取某些非公开数据

### 决策

**采用MCP工具进行真实网页浏览**

### 工具选择策略

**1. Playwright MCP（推荐用于动态内容）**
- 适用于YouTube等JavaScript密集型网站
- 可以等待动态内容加载
- 支持截图、滚动、点击等交互
- 处理单页应用（SPA）更可靠

**2. mcp-server-fetch（适用于静态页面）**
- 适用于简单的静态页面
- 速度快，资源消耗低
- 适合快速数据获取

**3. @hangwin/mcp-chrome（浏览器桥接）**
- 提供浏览器级别的控制
- 适合需要深度交互的场景

### 理由

1. **无配额限制**：通过直接浏览网页获取数据，不受API配额限制
2. **真实数据**：获取最原始、最实时的数据
3. **无需认证**：不需要申请API密钥或配置认证
4. **利用现有资源**：项目中已有CC-Switch管理的MCP服务器
5. **灵活扩展**：可以轻松扩展到其他平台（抖音、B站等）
6. **工具多样性**：根据场景选择最适合的MCP工具

### 影响

**正面影响**：
- 数据获取更加灵活和及时
- 降低了使用门槛
- 节省了API申请和维护成本
- 可以获取API无法访问的数据
- 可以处理复杂的动态内容

**负面影响**：
- 需要编写HTML解析逻辑（更复杂）
- 可能受到网站反爬虫机制影响
- 不同MCP工具有不同的学习成本
- 数据结构可能变化

### 实施

创建 `src/research/mcp_data_collector.py`：
- 根据内容类型选择合适的MCP工具
- Playwright MCP用于YouTube搜索和视频页面
- mcp-server-fetch用于简单的静态页面
- 实现HTML解析逻辑提取视频信息
- 支持搜索、热门视频、频道视频等多种数据源
- 添加缓存机制避免重复请求

### 使用示例

```bash
# 使用Playwright MCP处理动态内容
@playwright 打开 https://www.youtube.com/results?search_query=Python教程

# 使用mcp-server-fetch处理静态页面
@fetch 获取 https://example.com/simple-page

# 使用mcp-chrome进行浏览器交互
@chrome 访问 https://youtube.com 并截图
```

### 相关文件

- `.42cog/real/real.md`: 更新现实约束，强调MCP使用
- `src/research/mcp_data_collector.py`: 新的数据收集器
- `examples/mcp_integration.py`: MCP使用示例

---

## ADR-002: 采用双轨研究系统

**日期**: 2025-12-09
**状态**: 已接受
**类型**: 架构决策

### 背景

用户质疑："除了抽象模式，难道就不需要关心现实生活中每天都在发生什么吗？"
这个问题揭示了单纯依赖长期模式分析的局限性。

### 决策

**采用双轨研究系统：长期模式 + 短期动态追踪**

### 设计

#### 轨道1：长期模式（稳定）
- **频率**：每3天更新一次
- **目标**：发现底层规律和稳定模式
- **价值**：指导长期战略，不被短期波动干扰
- **数据源**：过去30天的数据

#### 轨道2：短期动态（动态）
- **频率**：每小时检查趋势
- **目标**：监控新兴话题、病毒视频、竞品动态
- **价值**：快速响应机会，不错过热点
- **数据源**：过去24小时的数据

### 理由

1. **避免极端化**：既不沉迷于短期热点，也不脱离现实
2. **战略与战术结合**：长期模式指导方向，动态趋势指导执行
3. **平衡效率与质量**：稳定模式确保质量，动态追踪确保效率
4. **适应平台变化**：能够及时适应YouTube算法和政策变化

### 实施

创建 `src/monitoring/` 目录：
- `dynamic_tracker.py`: 动态趋势追踪器
- `scheduler.py`: 自动化调度器

调度配置：
- 每小时 → 趋势检查
- 每天8点 → 生成摘要
- 每周一 → 生成周报
- 每3天 → 更新模式库

### 相关文件

- `src/monitoring/dynamic_tracker.py`: 动态追踪器
- `src/monitoring/scheduler.py`: 调度器
- `examples/dynamic_tracking.py`: 综合分析示例
- `config/config.yaml`: 动态追踪配置

---

## ADR-003: 优先使用现有MCP生态

**日期**: 2025-12-09
**状态**: 已接受
**类型**: 技术决策

### 背景

项目中许多功能可以通过现有MCP服务器实现，但初始设计倾向于自己实现。

### 决策

**优先整合现有MCP服务器，避免重复造轮子**

### 使用的MCP服务器

1. **mcp-server-fetch**: 网页内容获取
2. **tavily**: 实时搜索引擎
3. **sequential-thinking**: 复杂问题分析
4. **github**: 代码搜索和分析
5. **file-system**: 文件操作
6. **@hangwin/mcp-chrome**: 浏览器自动化

### 理由

1. **提高效率**：利用现有成熟工具比自己开发更快
2. **降低成本**：无需维护额外的基础设施
3. **保证质量**：MCP服务器经过验证，稳定可靠
4. **易于扩展**：可以轻松添加更多MCP服务器
5. **统一管理**：通过CC-Switch统一管理所有工具

### 实施

在示例中展示MCP调用方式：
```bash
# 使用Tavily搜索补充信息
@tavily 搜索 "YouTube视频优化技巧 2024"

# 使用sequential-thinking分析复杂问题
@sequential-thinking 分析 "短视频成功因素"

# 使用mcp-server-fetch获取网页内容
@fetch 获取 "https://www.youtube.com/results?search_query=Python教程"
```

### 相关文件

- `examples/mcp_integration.py`: MCP集成示例
- `GIT_WORKFLOW.md`: Git工作流指南

---

## ADR-004: 采用统一启动脚本设计

**日期**: 2025-12-09
**状态**: 已接受
**类型**: 用户体验决策

### 背景

项目有多个示例脚本，用户可能不知道如何选择和运行。

### 决策

**创建 `run.py` 作为统一启动入口**

### 设计

```bash
python3 run.py <command> [options]

可用命令:
- quick: 运行快速开始示例
- custom: 运行自定义分析示例
- batch: 运行批量分析示例
- mcp: 运行MCP集成示例
- workflow: 执行完整工作流
```

### 理由

1. **降低学习成本**：用户只需记住一个命令
2. **统一体验**：所有功能通过同一入口访问
3. **易于扩展**：新功能只需添加新命令
4. **参数统一**：统一的参数解析和处理
5. **便于集成**：可以轻松集成到CI/CD或其他工具

### 实施

创建 `run.py`：
- 使用 argparse 解析命令行参数
- 根据命令调用对应的示例或功能
- 提供帮助信息和示例用法
- 统一的错误处理和日志输出

### 相关文件

- `run.py`: 统一启动脚本
- `快速开始.md`: 使用指南

---

## ADR-005: 基于42COG的完整文档体系

**日期**: 2025-12-09
**状态**: 已接受
**类型**: 文档决策

### 背景

需要建立完整的文档体系，确保项目可理解、可维护、可传承。

### 决策

**采用42COG框架的RCSW工作流文档体系**

### 文档结构

#### Real - 现实约束
- `.42cog/real/real.md`: 项目必须遵守的硬性限制
- 重点关注安全、合规、业务规则
- 最多7条约束

#### Cog - 认知模型
- `.42cog/cog/cog.md`: 核心实体和关系
- 使用XML语义闭合标签
- 定义数据模型和业务逻辑

#### Spec - 规约文档
- 4个视角的规约文档
- `spec/user/`: 用户视角
- `spec/pm/`: 产品视角
- `spec/dev/`: 技术视角
- `spec/design/`: 设计视角

#### Work - 实际作品
- `src/`: 源代码实现
- `work/work.md`: 工作记录
- `meta/meta.md`: 项目元信息和版本历史

### 理由

1. **系统性强**：从抽象到具体，从约束到实现
2. **易于维护**：每个文件职责明确
3. **便于协作**：不同角色可以关注不同文档
4. **可追溯**：完整记录设计决策和变更历史
5. **标准化**：遵循成熟的42COG框架

### 相关文件

- `.42cog/` 目录下的所有文件
- `README.md`: 项目总览
- `快速开始.md`: 5分钟上手指南
- `使用指南.md`: 详细使用说明
- `PROJECT_SUMMARY.md`: 项目总结
- `GIT_WORKFLOW.md`: 版本管理指南

---

## ADR-006: 采用最小故事框架设计

**日期**: 2025-12-09
**状态**: 已接受
**类型**: 架构决策

### 背景

复杂的调研工作需要简化为可操作的三步走策略。

### 决策

**采用"事件1→事件2→事件3"的最小故事框架**

### 设计

```
事件1：研究x个视频 → 找到领域高手 + 总结创作模式
    ↓
事件2：逆向工程 → 将模式应用到文案创作
    ↓
事件3：实战创作 → 写出解决领域难题的创作文案
    ↓
生发意义：积累skill文档 → 成为领域高手
```

### 理由

1. **简化复杂度**：将复杂任务分解为简单步骤
2. **明确目标**：每一步都有清晰的目标和产出
3. **易于执行**：用户容易理解和操作
4. **可复用**：形成的方法论可以应用于不同领域
5. **高效性**：2小时内完成从调研到模板的全流程

### 实施

创建完整的工作流实现：
- `src/research/data_collector.py`: 事件1实现
- `src/analysis/pattern_analyzer.py`: 事件2实现
- `src/template/template_generator.py`: 事件3实现
- `src/workflow/workflow_manager.py`: 统一工作流管理

### 相关文件

- `.42cog/cog/cog.md`: 核心实体定义
- `src/workflow/workflow_manager.py`: 工作流管理器
- `examples/quick_start.py`: 最小故事示例

---

## 未来ADR计划

### 待决策问题

1. **数据库方案**: 当前使用JSON文件，是否需要升级到SQLite/PostgreSQL？
2. **Web界面**: 是否需要开发Web UI来降低使用门槛？
3. **AI增强**: 是否集成GPT/Claude进行智能分析？
4. **多平台支持**: 是否扩展到抖音、B站等其他平台？
5. **实时监控**: 是否需要实时数据监控dashboard？

### 决策流程

当遇到新的架构或技术决策时：
1. 在 `design-decisions.md` 中添加新的ADR记录
2. 包含背景、决策、理由、影响和实施细节
3. 标注日期、状态和类型
4. 更新相关实现文档

---

**记录设计决策，确保项目决策可追溯、可理解、可维护！** 📝
