<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube å†…å®¹åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            line-height: 1.6;
            color: #e2e8f0;
            background: #0f172a;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #0f172a;
            border-bottom: 1px solid #1e293b;
            padding: 12px 24px;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-brand {
            font-size: 1.1em;
            font-weight: 600;
            color: #06b6d4;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 4px;
        }

        .nav-link {
            padding: 8px 14px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .nav-link:hover, .nav-link.active {
            color: #e2e8f0;
            background: #1e293b;
        }

        /* ä¸»å†…å®¹åŒº - å·¦å³åˆ†æ  */
        .app-container {
            padding-top: 56px;
            display: flex;
            min-height: 100vh;
        }

        /* å·¦ä¾§è¾¹æ  - å¯¼èˆªå’Œè¯Šæ–­ */
        .sidebar {
            width: 280px;
            background: #1e293b;
            border-right: 1px solid #334155;
            padding: 20px;
            position: fixed;
            left: 0;
            top: 56px;
            bottom: 0;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 28px;
        }

        .sidebar-title {
            font-size: 0.75em;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 12px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-item:hover {
            background: #334155;
            color: #e2e8f0;
        }

        .sidebar-item.active {
            background: #06b6d4;
            color: #0f172a;
        }

        .sidebar-item .icon {
            width: 20px;
            text-align: center;
        }

        .sidebar-item .badge {
            margin-left: auto;
            background: #334155;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .sidebar-item.active .badge {
            background: rgba(0,0,0,0.2);
        }

        /* è¯Šæ–­å¡ç‰‡ */
        .diagnose-card {
            background: linear-gradient(135deg, #164e63, #1e3a5f);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .diagnose-card h4 {
            color: #22d3ee;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .diagnose-card p {
            color: #94a3b8;
            font-size: 0.8em;
            margin-bottom: 12px;
        }

        .diagnose-input {
            width: 100%;
            padding: 10px 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .diagnose-input:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .diagnose-btn {
            width: 100%;
            padding: 10px;
            background: #06b6d4;
            color: #0f172a;
            border: none;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
        }

        .diagnose-btn:hover {
            background: #22d3ee;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 24px 32px;
            max-width: calc(100% - 280px);
        }

        /* æœç´¢æ¡† */
        .search-header {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .search-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .search-input {
            flex: 1;
            padding: 14px 18px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 10px;
            color: white;
            font-size: 1em;
        }

        .search-input:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .search-btn {
            padding: 14px 28px;
            background: #06b6d4;
            color: #0f172a;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .search-btn:hover {
            background: #22d3ee;
        }

        .search-btn:disabled {
            background: #334155;
            color: #64748b;
            cursor: not-allowed;
        }

        .search-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .preset-label {
            color: #64748b;
            font-size: 0.85em;
        }

        .preset-tag {
            padding: 6px 12px;
            background: #334155;
            color: #94a3b8;
            border: none;
            border-radius: 16px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .preset-tag:hover {
            background: #475569;
            color: white;
        }

        /* åŠ¨æ€è¶‹åŠ¿çƒ­è¯æ¿å— */
        .trending-section {
            background: linear-gradient(135deg, #1e3a5f, #0f2744);
            border: 1px solid #2563eb40;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }

        .trending-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .trending-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #60a5fa;
            font-weight: 500;
        }

        .trending-title .fire-icon {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .trending-refresh {
            background: transparent;
            border: 1px solid #334155;
            color: #64748b;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .trending-refresh:hover {
            background: #334155;
            color: #94a3b8;
        }

        .trending-refresh.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .trending-keywords {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            min-height: 32px;
        }

        .trending-tag {
            padding: 6px 14px;
            background: linear-gradient(135deg, #3b82f620, #1d4ed820);
            color: #93c5fd;
            border: 1px solid #3b82f640;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trending-tag:hover {
            background: linear-gradient(135deg, #3b82f640, #1d4ed840);
            color: white;
            border-color: #3b82f6;
            transform: translateY(-1px);
        }

        .trending-tag .tag-heat {
            font-size: 0.7em;
            background: #ef444420;
            color: #fca5a5;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .trending-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-size: 0.85em;
        }

        .trending-loading .dots {
            display: flex;
            gap: 4px;
        }

        .trending-loading .dot {
            width: 6px;
            height: 6px;
            background: #3b82f6;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .trending-loading .dot:nth-child(2) { animation-delay: 0.2s; }
        .trending-loading .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }

        .trending-error {
            color: #f87171;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trending-source {
            margin-top: 10px;
            font-size: 0.7em;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ä¿¡æ¯è¾¹ç•Œå¡ç‰‡ */
        .boundary-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .boundary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .boundary-title {
            font-size: 1em;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .boundary-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #06b6d4;
        }

        .stat-label {
            font-size: 0.75em;
            color: #64748b;
            margin-top: 4px;
        }

        /* AI æ´å¯Ÿ */
        .ai-insight {
            background: linear-gradient(135deg, #164e63, #1e3a5f);
            border: 1px solid #06b6d4;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .ai-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
        }

        .ai-label {
            font-size: 0.8em;
            color: #06b6d4;
            font-weight: 600;
        }

        .ai-content {
            color: #e2e8f0;
            font-size: 0.95em;
            line-height: 1.8;
        }

        .ai-content strong {
            color: #22d3ee;
        }

        .ai-content p {
            margin-bottom: 10px;
        }

        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            gap: 4px;
            background: #1e293b;
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            color: #94a3b8;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #e2e8f0;
        }

        .tab.active {
            background: #06b6d4;
            color: #0f172a;
            font-weight: 600;
        }

        /* å†…å®¹é¢æ¿ */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* æ¦œå•åŒºåŸŸ */
        .ranking-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .ranking-header {
            padding: 16px 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ranking-title {
            font-size: 1em;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ranking-count {
            font-size: 0.8em;
            color: #64748b;
            background: #334155;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .ranking-filters {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 6px 12px;
            background: #334155;
            color: #94a3b8;
            border: none;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #475569;
            color: white;
        }

        /* æ¦œå•åˆ—è¡¨ */
        .ranking-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.2s;
        }

        .ranking-item:hover {
            background: #334155;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .rank-number {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0f172a; }
        .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #0f172a; }
        .rank-3 { background: linear-gradient(135deg, #cd7c32, #b8860b); color: #0f172a; }
        .rank-normal { background: #334155; color: #94a3b8; }

        .rank-thumb {
            width: 80px;
            height: 45px;
            background: #334155;
            border-radius: 6px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .rank-info {
            flex: 1;
            min-width: 0;
        }

        .rank-title {
            font-size: 0.9em;
            color: white;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .rank-meta {
            font-size: 0.8em;
            color: #64748b;
            display: flex;
            gap: 12px;
        }

        .rank-stats {
            display: flex;
            gap: 20px;
            flex-shrink: 0;
        }

        .rank-stat {
            text-align: right;
        }

        .rank-stat-value {
            font-size: 0.95em;
            font-weight: 600;
            color: white;
        }

        .rank-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        .rank-score {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .score-s { background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; }
        .score-a { background: linear-gradient(135deg, #059669, #10b981); color: white; }
        .score-b { background: linear-gradient(135deg, #0891b2, #06b6d4); color: white; }
        .score-c { background: linear-gradient(135deg, #d97706, #f59e0b); color: #0f172a; }

        /* é¢‘é“å¡ç‰‡ */
        .channel-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .channel-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
        }

        .channel-header:hover {
            background: #334155;
        }

        .channel-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-size: 1em;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .channel-meta {
            font-size: 0.85em;
            color: #64748b;
        }

        .channel-stats {
            display: flex;
            gap: 24px;
        }

        .channel-stat {
            text-align: center;
        }

        .channel-stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #06b6d4;
        }

        .channel-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        .channel-toggle {
            color: #64748b;
            font-size: 1.2em;
        }

        .channel-videos {
            display: none;
            padding: 0 20px 16px;
            border-top: 1px solid #334155;
        }

        .channel-videos.open {
            display: block;
        }

        .channel-video-list {
            padding-top: 16px;
        }

        .channel-video-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #0f172a;
        }

        .channel-video-item:hover {
            background: #334155;
        }

        .video-thumb-small {
            width: 64px;
            height: 36px;
            background: #334155;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .video-info-small {
            flex: 1;
            min-width: 0;
        }

        .video-title-small {
            font-size: 0.85em;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .video-meta-small {
            font-size: 0.75em;
            color: #64748b;
        }

        /* åœ°åŒºåˆ†å¸ƒ */
        .region-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .region-card {
            background: #0f172a;
            border-radius: 10px;
            padding: 16px;
        }

        .region-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .region-flag {
            font-size: 1.5em;
        }

        .region-name {
            font-weight: 600;
            color: white;
        }

        .region-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .region-stat {
            text-align: center;
        }

        .region-stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #06b6d4;
        }

        .region-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        .region-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
        }

        .region-bar-fill {
            height: 100%;
            border-radius: 3px;
        }

        .competition-low { background: #10b981; }
        .competition-medium { background: #f59e0b; }
        .competition-high { background: #ef4444; }

        /* æ—¶é—´åˆ†æ */
        .time-chart {
            padding: 20px;
        }

        .time-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .time-label {
            width: 100px;
            font-size: 0.85em;
            color: #94a3b8;
        }

        .time-bar-container {
            flex: 1;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .time-bar {
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding-left: 8px;
            font-size: 0.8em;
            color: white;
            font-weight: 600;
        }

        .time-meta {
            width: 80px;
            text-align: right;
            font-size: 0.8em;
            color: #64748b;
        }

        /* è¯Šæ–­ç»“æœ */
        .diagnose-result {
            display: none;
        }

        .diagnose-result.show {
            display: block;
        }

        .diagnose-summary {
            background: linear-gradient(135deg, #164e63, #1e3a5f);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .diagnose-channel {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .diagnose-channel-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .diagnose-channel-info h3 {
            color: white;
            font-size: 1.2em;
        }

        .diagnose-channel-info p {
            color: #94a3b8;
            font-size: 0.9em;
        }

        .diagnose-scores {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .diagnose-score {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .diagnose-score-value {
            font-size: 1.5em;
            font-weight: 700;
        }

        .diagnose-score-label {
            font-size: 0.75em;
            color: #64748b;
        }

        .recommend-channels {
            margin-top: 20px;
        }

        .recommend-title {
            font-size: 0.9em;
            color: #94a3b8;
            margin-bottom: 12px;
        }

        .recommend-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recommend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
        }

        .recommend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommend-info {
            flex: 1;
        }

        .recommend-name {
            font-weight: 600;
            color: white;
            font-size: 0.9em;
        }

        .recommend-reason {
            font-size: 0.8em;
            color: #64748b;
        }

        .recommend-match {
            padding: 4px 10px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        /* åˆ†æçŠ¶æ€ */
        .analysis-status {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: none;
        }

        .analysis-status.show {
            display: block;
        }

        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .status-title {
            font-weight: 600;
            color: white;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-badge.running {
            background: #06b6d4;
            color: #0f172a;
        }

        .status-badge.done {
            background: #10b981;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #06b6d4, #8b5cf6);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .progress-fill.done {
            background: #10b981;
        }

        .status-log {
            color: #64748b;
            font-size: 0.85em;
        }

        /* åŠ è½½æ›´å¤š */
        .load-more {
            text-align: center;
            padding: 16px;
        }

        .load-more-btn {
            padding: 10px 24px;
            background: #334155;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .load-more-btn:hover {
            background: #475569;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.1em;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        /* è§†é¢‘åˆ†æå¡ç‰‡ */
        .video-analysis-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .video-analysis-header {
            padding: 16px 20px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            cursor: pointer;
        }

        .video-analysis-header:hover {
            background: #334155;
        }

        .video-analysis-thumb {
            width: 160px;
            height: 90px;
            background: #334155;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }

        .video-analysis-info {
            flex: 1;
            min-width: 0;
        }

        .video-analysis-title {
            font-size: 1em;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-analysis-meta {
            font-size: 0.85em;
            color: #64748b;
            margin-bottom: 8px;
        }

        .video-analysis-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .video-tag {
            padding: 4px 10px;
            background: #334155;
            color: #94a3b8;
            border-radius: 12px;
            font-size: 0.75em;
        }

        .video-tag.highlight {
            background: #059669;
            color: white;
        }

        .video-analysis-stats {
            display: flex;
            gap: 24px;
            flex-shrink: 0;
        }

        .video-analysis-stat {
            text-align: center;
        }

        .video-analysis-stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #06b6d4;
        }

        .video-analysis-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        .video-analysis-toggle {
            color: #64748b;
            font-size: 1.2em;
            padding: 8px;
        }

        .video-analysis-details {
            display: none;
            padding: 0 20px 20px;
            border-top: 1px solid #334155;
        }

        .video-analysis-details.open {
            display: block;
        }

        .analysis-section {
            padding: 16px 0;
            border-bottom: 1px solid #334155;
        }

        .analysis-section:last-child {
            border-bottom: none;
        }

        .analysis-section-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .analysis-metric {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .analysis-metric-value {
            font-size: 1.2em;
            font-weight: 700;
            color: white;
        }

        .analysis-metric-label {
            font-size: 0.75em;
            color: #64748b;
            margin-top: 4px;
        }

        .analysis-insight {
            background: #0f172a;
            border-radius: 8px;
            padding: 14px;
            font-size: 0.9em;
            color: #94a3b8;
            line-height: 1.6;
        }

        .analysis-insight strong {
            color: #06b6d4;
        }

        /* é¢‘é“æ¦œå•é¡¹ */
        .channel-ranking-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.2s;
        }

        .channel-ranking-item:hover {
            background: #334155;
        }

        .channel-ranking-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .channel-ranking-info {
            flex: 1;
            min-width: 0;
        }

        .channel-ranking-name {
            font-size: 0.95em;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .channel-ranking-meta {
            font-size: 0.8em;
            color: #64748b;
        }

        .channel-ranking-stats {
            display: flex;
            gap: 24px;
            flex-shrink: 0;
        }

        .channel-ranking-stat {
            text-align: right;
        }

        .channel-ranking-stat-value {
            font-size: 0.95em;
            font-weight: 600;
            color: white;
        }

        .channel-ranking-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        /* ç­›é€‰å™¨åŒºåŸŸ */
        .filters-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #334155;
        }

        .filters-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
            font-size: 0.85em;
            cursor: pointer;
            padding: 8px 0;
        }

        .filters-toggle:hover {
            color: #e2e8f0;
        }

        .filters-toggle .arrow {
            transition: transform 0.2s;
        }

        .filters-toggle.open .arrow {
            transform: rotate(180deg);
        }

        .filters-content {
            display: none;
            padding-top: 16px;
        }

        .filters-content.show {
            display: block;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .filter-group {
            background: #0f172a;
            border-radius: 10px;
            padding: 14px;
        }

        .filter-label {
            font-size: 0.8em;
            color: #64748b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .filter-select:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .filter-range {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-range input {
            flex: 1;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            width: 100%;
        }

        .filter-range input:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .filter-range span {
            color: #64748b;
            font-size: 0.9em;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-chip {
            padding: 8px 14px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 20px;
            color: #94a3b8;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            border-color: #06b6d4;
            color: #e2e8f0;
        }

        .filter-chip.active {
            background: #06b6d4;
            border-color: #06b6d4;
            color: #0f172a;
        }

        .filters-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #334155;
        }

        .filter-reset-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.9em;
            cursor: pointer;
        }

        .filter-reset-btn:hover {
            border-color: #64748b;
            color: #e2e8f0;
        }

        .filter-apply-btn {
            padding: 10px 20px;
            background: #06b6d4;
            border: none;
            border-radius: 8px;
            color: #0f172a;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
        }

        .filter-apply-btn:hover {
            background: #22d3ee;
        }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .active-filter-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #164e63;
            border-radius: 16px;
            color: #22d3ee;
            font-size: 0.8em;
        }

        .active-filter-tag .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .active-filter-tag .remove:hover {
            opacity: 1;
        }

        /* æš‚æ— æ•°æ® */
        .no-data-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
            background: #1e293b;
            border-radius: 12px;
            border: 1px dashed #334155;
        }

        .no-data-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .no-data-title {
            font-size: 1.1em;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .no-data-desc {
            font-size: 0.9em;
        }

        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
                max-width: 100%;
            }
            .boundary-stats {
                grid-template-columns: repeat(3, 1fr);
            }
            .region-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .boundary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .region-grid {
                grid-template-columns: 1fr;
            }
        }

        /* å¯¼å‡ºæŒ‰é’®æ ·å¼ */
        .overview-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .export-buttons {
            display: flex;
            gap: 8px;
        }

        .export-btn {
            padding: 8px 16px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .export-btn:hover {
            background: #475569;
            border-color: #06b6d4;
            color: #06b6d4;
        }

        .export-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="nav">
        <a href="index.html" class="nav-brand">YouTube å†…å®¹åŠ©æ‰‹</a>
        <div class="nav-links">
            <a href="#discover" class="nav-link active">å‘ç°é€‰é¢˜</a>
            <a href="#publish" class="nav-link">å‘å¸ƒè§†é¢‘</a>
            <a href="#data" class="nav-link">å†…å®¹åº“</a>
        </div>
    </nav>

    <div class="app-container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">æ•°æ®åˆ†æ</div>
                <nav class="sidebar-nav">
                    <a class="sidebar-item active" data-panel="overview">
                        <span class="icon">ğŸ“Š</span>
                        æ¦‚è§ˆæ‘˜è¦
                    </a>
                    <a class="sidebar-item" data-panel="videos">
                        <span class="icon">ğŸ¬</span>
                        è§†é¢‘æ•°æ®
                        <span class="badge" id="badge-videos">0</span>
                    </a>
                    <a class="sidebar-item" data-panel="channels">
                        <span class="icon">ğŸ“º</span>
                        é¢‘é“æ•°æ®
                        <span class="badge" id="badge-channels">0</span>
                    </a>
                    <a class="sidebar-item" data-panel="patterns">
                        <span class="icon">ğŸ”</span>
                        æ¨¡å¼æ´å¯Ÿ
                    </a>
                    <a class="sidebar-item" data-panel="report">
                        <span class="icon">ğŸ“‹</span>
                        åˆ†ææŠ¥å‘Š
                    </a>
                </nav>
            </div>

            <!-- ç›‘æ§ä¸­å¿ƒ -->
            <div class="sidebar-section">
                <div class="sidebar-title">ç›‘æ§ä¸­å¿ƒ</div>
                <nav class="sidebar-nav">
                    <a class="sidebar-item" data-panel="monitor">
                        <span class="icon">ğŸ“¡</span>
                        å…³é”®è¯ç›‘æ§
                        <span class="badge" id="badge-monitor">0</span>
                    </a>
                    <a class="sidebar-item" data-panel="trending">
                        <span class="icon">ğŸ“ˆ</span>
                        è¶‹åŠ¿è¿½è¸ª
                    </a>
                </nav>
            </div>

            <!-- é¢‘é“è¯Šæ–­ -->
            <div class="sidebar-section">
                <div class="sidebar-title">æˆ‘çš„é¢‘é“è¯Šæ–­</div>
                <div class="diagnose-card">
                    <h4>ğŸ” è¯Šæ–­ä½ çš„é¢‘é“</h4>
                    <p>è¾“å…¥é¢‘é“é“¾æ¥ï¼Œè·å–å¯¹æ ‡åˆ†æå’Œæ”¹è¿›å»ºè®®</p>
                    <input type="text" class="diagnose-input" id="diagnoseInput" placeholder="ç²˜è´´é¢‘é“é“¾æ¥æˆ–åç§°...">
                    <button class="diagnose-btn" onclick="startDiagnose()">å¼€å§‹è¯Šæ–­</button>
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- æœç´¢å¤´éƒ¨ -->
            <div class="search-header">
                <!-- åŠ¨æ€è¶‹åŠ¿çƒ­è¯æ¿å— -->
                <div class="trending-section" id="trendingSection">
                    <div class="trending-header">
                        <div class="trending-title">
                            <span class="fire-icon">ğŸ”¥</span>
                            <span>YouTube å®æ—¶è¶‹åŠ¿çƒ­è¯</span>
                        </div>
                        <button class="trending-refresh" id="trendingRefresh" onclick="refreshTrendingKeywords()">
                            <span class="refresh-icon">ğŸ”„</span>
                            <span>åˆ·æ–°</span>
                        </button>
                    </div>
                    <div class="trending-keywords" id="trendingKeywords">
                        <div class="trending-loading" id="trendingLoading">
                            <div class="dots">
                                <div class="dot"></div>
                                <div class="dot"></div>
                                <div class="dot"></div>
                            </div>
                            <span>æ­£åœ¨è·å– YouTube è¶‹åŠ¿æ•°æ®...</span>
                        </div>
                    </div>
                    <div class="trending-source" id="trendingSource" style="display: none;">
                        <span>ğŸ“Š</span>
                        <span>æ•°æ®æ¥æºï¼šYouTube çƒ­é—¨è§†é¢‘æ ‡é¢˜åˆ†è¯ Â· æ›´æ–°æ—¶é—´ï¼š<span id="trendingTime">--</span></span>
                    </div>
                </div>

                <div class="search-row">
                    <input type="text" class="search-input" id="topicInput" placeholder="è¾“å…¥ä½ æƒ³ç ”ç©¶çš„é¢†åŸŸï¼Œæˆ–ç‚¹å‡»ä¸Šæ–¹çƒ­è¯å¿«é€Ÿå¼€å§‹...">
                    <button class="search-btn" id="analyzeBtn" onclick="startAnalysis()">å¼€å§‹åˆ†æ</button>
                </div>
                <div class="search-presets" id="historyPresets" style="display: none;">
                    <span class="preset-label">æœ€è¿‘æœç´¢ï¼š</span>
                    <!-- åŠ¨æ€å¡«å……ç”¨æˆ·æœç´¢å†å² -->
                </div>

                <!-- é«˜çº§ç­›é€‰ -->
                <div class="filters-section">
                    <div class="filters-toggle" id="filtersToggle" onclick="toggleFilters()">
                        <span>ğŸ›ï¸ é«˜çº§ç­›é€‰</span>
                        <span class="arrow">â–¼</span>
                    </div>
                    <div class="filters-content" id="filtersContent">
                        <div class="filters-grid">
                            <!-- æ’­æ”¾é‡ç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ“Š æ’­æ”¾é‡èŒƒå›´</div>
                                <div class="filter-range">
                                    <input type="text" id="viewsMin" placeholder="æœ€å°">
                                    <span>-</span>
                                    <input type="text" id="viewsMax" placeholder="æœ€å¤§">
                                </div>
                                <div class="filter-chips" style="margin-top: 10px;">
                                    <span class="filter-chip active" onclick="setViewsRange(null, null)">ä¸é™</span>
                                    <span class="filter-chip" onclick="setViewsRange(0, 10000)">1ä¸‡ä»¥ä¸‹</span>
                                    <span class="filter-chip" onclick="setViewsRange(10000, 100000)">1-10ä¸‡</span>
                                    <span class="filter-chip" onclick="setViewsRange(100000, null)">10ä¸‡+</span>
                                </div>
                            </div>

                            <!-- åœ°åŒºç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸŒ ç›®æ ‡åœ°åŒº</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearRegions(this)">ä¸é™</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'SG')">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'MY')">ğŸ‡²ğŸ‡¾ é©¬æ¥è¥¿äºš</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'TW')">ğŸ‡¹ğŸ‡¼ å°æ¹¾</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'HK')">ğŸ‡­ğŸ‡° é¦™æ¸¯</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'US')">ğŸ‡ºğŸ‡¸ ç¾å›½</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'CN')">ğŸ‡¨ğŸ‡³ å¤§é™†</span>
                                </div>
                            </div>

                            <!-- æ—¶é•¿ç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">â±ï¸ è§†é¢‘æ—¶é•¿</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearDuration(this)">ä¸é™</span>
                                    <span class="filter-chip" onclick="toggleDuration(this, 'short')">çŸ­è§†é¢‘ (&lt;5åˆ†é’Ÿ)</span>
                                    <span class="filter-chip" onclick="toggleDuration(this, 'medium')">ä¸­ç­‰ (5-20åˆ†é’Ÿ)</span>
                                    <span class="filter-chip" onclick="toggleDuration(this, 'long')">é•¿è§†é¢‘ (20åˆ†é’Ÿ+)</span>
                                </div>
                            </div>

                            <!-- ç²‰ä¸æ•°ç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ‘¥ é¢‘é“ç²‰ä¸æ•°</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearSubscribers(this)">ä¸é™</span>
                                    <span class="filter-chip" onclick="toggleSubscribers(this, 'small')">å°é¢‘é“ (&lt;1ä¸‡)</span>
                                    <span class="filter-chip" onclick="toggleSubscribers(this, 'medium')">ä¸­é¢‘é“ (1-10ä¸‡)</span>
                                    <span class="filter-chip" onclick="toggleSubscribers(this, 'large')">å¤§é¢‘é“ (10-100ä¸‡)</span>
                                    <span class="filter-chip" onclick="toggleSubscribers(this, 'huge')">è¶…å¤§ (100ä¸‡+)</span>
                                </div>
                            </div>

                            <!-- å‘å¸ƒæ—¶é—´ç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ“… å‘å¸ƒæ—¶é—´</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearTime(this)">ä¸é™</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '24h')">24å°æ—¶</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '7d')">è¿‘7å¤©</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '30d')">è¿‘30å¤©</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '90d')">è¿‘3ä¸ªæœˆ</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '1y')">è¿‘1å¹´</span>
                                </div>
                            </div>

                            <!-- æ’åºæ–¹å¼ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ”„ æ’åºæ–¹å¼</div>
                                <select class="filter-select" id="sortBy">
                                    <option value="views">æ’­æ”¾é‡æœ€é«˜</option>
                                    <option value="likes">ç‚¹èµæœ€å¤š</option>
                                    <option value="comments">è¯„è®ºæœ€å¤š</option>
                                    <option value="engagement">äº’åŠ¨ç‡æœ€é«˜</option>
                                    <option value="recent">æœ€æ–°å‘å¸ƒ</option>
                                    <option value="growth">å¢é•¿æœ€å¿«</option>
                                </select>
                            </div>

                            <!-- è§†é¢‘æ•°é‡ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ”¢ åˆ†æè§†é¢‘æ•°é‡</div>
                                <div class="filter-chips">
                                    <span class="filter-chip" onclick="setVideoCount(this, 100)">100ä¸ª</span>
                                    <span class="filter-chip active" onclick="setVideoCount(this, 500)">500ä¸ª</span>
                                    <span class="filter-chip" onclick="setVideoCount(this, 1000)">1000ä¸ª</span>
                                    <span class="filter-chip" onclick="setVideoCount(this, 0)">ä¸é™</span>
                                </div>
                            </div>

                            <!-- ç‚¹èµæ•°ç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ‘ ç‚¹èµæ•°èŒƒå›´</div>
                                <div class="filter-range">
                                    <input type="text" id="likesMin" placeholder="æœ€å°">
                                    <span>-</span>
                                    <input type="text" id="likesMax" placeholder="æœ€å¤§">
                                </div>
                                <div class="filter-chips" style="margin-top: 10px;">
                                    <span class="filter-chip active" onclick="setLikesRange(null, null)">ä¸é™</span>
                                    <span class="filter-chip" onclick="setLikesRange(0, 1000)">1åƒä»¥ä¸‹</span>
                                    <span class="filter-chip" onclick="setLikesRange(1000, 10000)">1åƒ-1ä¸‡</span>
                                    <span class="filter-chip" onclick="setLikesRange(10000, null)">1ä¸‡+</span>
                                </div>
                            </div>

                            <!-- è¯„è®ºæ•°ç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ’¬ è¯„è®ºæ•°èŒƒå›´</div>
                                <div class="filter-range">
                                    <input type="text" id="commentsMin" placeholder="æœ€å°">
                                    <span>-</span>
                                    <input type="text" id="commentsMax" placeholder="æœ€å¤§">
                                </div>
                            </div>

                            <!-- äº’åŠ¨ç‡ç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ“ˆ äº’åŠ¨ç‡</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearEngagement(this)">ä¸é™</span>
                                    <span class="filter-chip" onclick="setEngagement(this, 'low')">ä½ (&lt;1%)</span>
                                    <span class="filter-chip" onclick="setEngagement(this, 'medium')">ä¸­ (1-5%)</span>
                                    <span class="filter-chip" onclick="setEngagement(this, 'high')">é«˜ (5-10%)</span>
                                    <span class="filter-chip" onclick="setEngagement(this, 'viral')">çˆ†æ¬¾ (10%+)</span>
                                </div>
                            </div>

                            <!-- è¯­è¨€ç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸŒ è§†é¢‘è¯­è¨€</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearLanguage(this)">ä¸é™</span>
                                    <span class="filter-chip" onclick="toggleLanguage(this, 'zh')">ä¸­æ–‡</span>
                                    <span class="filter-chip" onclick="toggleLanguage(this, 'en')">è‹±æ–‡</span>
                                    <span class="filter-chip" onclick="toggleLanguage(this, 'other')">å…¶ä»–</span>
                                </div>
                            </div>

                            <!-- é¢‘é“ç±»å‹ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ“º é¢‘é“ç±»å‹</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearChannelType(this)">ä¸é™</span>
                                    <span class="filter-chip" onclick="toggleChannelType(this, 'personal')">ä¸ªäºº</span>
                                    <span class="filter-chip" onclick="toggleChannelType(this, 'brand')">å“ç‰Œ</span>
                                    <span class="filter-chip" onclick="toggleChannelType(this, 'media')">åª’ä½“</span>
                                    <span class="filter-chip" onclick="toggleChannelType(this, 'mcn')">MCN</span>
                                </div>
                            </div>

                            <!-- ç‰¹å®šé¢‘é“ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ¯ æŒ‡å®šé¢‘é“</div>
                                <input type="text" class="filter-select" id="channelFilter" placeholder="è¾“å…¥é¢‘é“åç§°æˆ–ID..." style="background-image: none;">
                            </div>

                            <!-- å…³é”®è¯æ’é™¤ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸš« æ’é™¤å…³é”®è¯</div>
                                <input type="text" class="filter-select" id="excludeKeywords" placeholder="å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”..." style="background-image: none;">
                            </div>

                            <!-- è§†é¢‘è´¨é‡ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ¬ è§†é¢‘è´¨é‡</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearQuality(this)">ä¸é™</span>
                                    <span class="filter-chip" onclick="toggleQuality(this, 'hd')">é«˜æ¸… (1080p+)</span>
                                    <span class="filter-chip" onclick="toggleQuality(this, 'sd')">æ ‡æ¸…</span>
                                    <span class="filter-chip" onclick="toggleQuality(this, 'shorts')">çŸ­è§†é¢‘</span>
                                </div>
                            </div>

                            <!-- AIè§†é¢‘ç­›é€‰ -->
                            <div class="filter-group">
                                <div class="filter-label">ğŸ¤– AIè§†é¢‘</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="setAIFilter(this, 'all')">ä¸é™</span>
                                    <span class="filter-chip" onclick="setAIFilter(this, 'ai')">ä»…AIè§†é¢‘</span>
                                    <span class="filter-chip" onclick="setAIFilter(this, 'human')">ä»…çœŸäººè§†é¢‘</span>
                                </div>
                                <div class="filter-hint" style="font-size: 11px; color: #64748b; margin-top: 6px;">
                                    åŸºäºæ ‡é¢˜/æè¿°/æ ‡ç­¾ä¸­çš„å…³é”®è¯è¯†åˆ«
                                </div>
                            </div>
                        </div>

                        <!-- å·²é€‰ç­›é€‰æ¡ä»¶ -->
                        <div class="active-filters" id="activeFilters"></div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="filters-actions">
                            <button class="filter-reset-btn" onclick="resetFilters()">é‡ç½®ç­›é€‰</button>
                            <button class="filter-apply-btn" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†æçŠ¶æ€ -->
            <div class="analysis-status" id="analysisStatus">
                <div class="status-header">
                    <span class="status-title" id="statusTitle">æ­£åœ¨åˆ†æï¼šå¥åº·å…»ç”Ÿ</span>
                    <span class="status-badge running" id="statusBadge">åˆ†æä¸­</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="status-log" id="statusLog">æ­£åœ¨æ”¶é›†è§†é¢‘æ•°æ®...</div>
            </div>

            <!-- åˆ†æç»“æœ -->
            <div id="resultsContainer" style="display: none;">

                <!-- æ¦‚è§ˆæ‘˜è¦é¢æ¿ -->
                <div class="panel active" id="panel-overview">
                    <!-- æ•°æ®æ¦‚è§ˆå¡ç‰‡ -->
                    <div class="boundary-card" id="overviewStats">
                        <div class="boundary-header">
                            <span class="boundary-title" id="overviewTitle">ğŸ“Š æ•°æ®æ¦‚è§ˆ</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="filter-btn" onclick="switchPanel('report')" style="font-size: 12px;">ğŸ“‹ æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š</button>
                            </div>
                        </div>
                        <div class="boundary-stats" id="overviewNumbers">
                            <div class="stat-item">
                                <div class="stat-value" id="stat-videos">0</div>
                                <div class="stat-label">è§†é¢‘æ€»æ•°</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-channels">0</div>
                                <div class="stat-label">é¢‘é“æ•°</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-views">0</div>
                                <div class="stat-label">æ€»æ’­æ”¾é‡</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-avg-views">0</div>
                                <div class="stat-label">å¹³å‡æ’­æ”¾</div>
                            </div>
                        </div>
                    </div>

                    <!-- å…³é”®å‘ç° -->
                    <div class="ai-insight" id="keyFindings">
                        <div class="ai-header">
                            <div class="ai-avatar">ğŸ’¡</div>
                            <div class="ai-label">å…³é”®å‘ç°</div>
                        </div>
                        <div class="ai-content" id="keyFindingsContent">
                            <p style="color: #64748b;">æœç´¢å…³é”®è¯å¼€å§‹åˆ†æåï¼Œè¿™é‡Œå°†æ˜¾ç¤ºå…³é”®å‘ç°...</p>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿå…¥å£ -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #1e293b; border-radius: 12px; padding: 16px; cursor: pointer;" onclick="switchPanel('videos')">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">ğŸ¬</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 4px;">è§†é¢‘æ•°æ®</div>
                            <div style="font-size: 0.85em; color: #64748b;" id="quick-videos">æŸ¥çœ‹è§†é¢‘æ¦œå•</div>
                        </div>
                        <div style="background: #1e293b; border-radius: 12px; padding: 16px; cursor: pointer;" onclick="switchPanel('channels')">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">ğŸ“º</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 4px;">é¢‘é“æ•°æ®</div>
                            <div style="font-size: 0.85em; color: #64748b;" id="quick-channels">æŸ¥çœ‹é¢‘é“æ¦œå•</div>
                        </div>
                        <div style="background: #1e293b; border-radius: 12px; padding: 16px; cursor: pointer;" onclick="switchPanel('patterns')">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">ğŸ”</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 4px;">æ¨¡å¼æ´å¯Ÿ</div>
                            <div style="font-size: 0.85em; color: #64748b;">å‘ç°è§„å¾‹æ¨¡å¼</div>
                        </div>
                        <div style="background: #1e293b; border-radius: 12px; padding: 16px; cursor: pointer;" onclick="switchPanel('report')">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">ğŸ“‹</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 4px;">åˆ†ææŠ¥å‘Š</div>
                            <div style="font-size: 0.85em; color: #64748b;">å®Œæ•´åˆ†ææŠ¥å‘Š</div>
                        </div>
                    </div>

                    <!-- Top 3 è§†é¢‘é¢„è§ˆ -->
                    <div class="ranking-section" id="topVideosPreview">
                        <div class="ranking-header">
                            <span class="ranking-title">ğŸ† Top 3 è§†é¢‘</span>
                            <button class="filter-btn" onclick="switchPanel('videos')" style="font-size: 12px;">æŸ¥çœ‹å…¨éƒ¨ â†’</button>
                        </div>
                        <div class="ranking-list" id="top3VideosList">
                            <div style="padding: 20px; text-align: center; color: #64748b;">æš‚æ— æ•°æ®</div>
                        </div>
                    </div>

                    <!-- Top 3 é¢‘é“é¢„è§ˆ -->
                    <div class="ranking-section" id="topChannelsPreview">
                        <div class="ranking-header">
                            <span class="ranking-title">â­ Top 3 é¢‘é“</span>
                            <button class="filter-btn" onclick="switchPanel('channels')" style="font-size: 12px;">æŸ¥çœ‹å…¨éƒ¨ â†’</button>
                        </div>
                        <div class="ranking-list" id="top3ChannelsList">
                            <div style="padding: 20px; text-align: center; color: #64748b;">æš‚æ— æ•°æ®</div>
                        </div>
                    </div>
                </div>

                <!-- è§†é¢‘æ¦œå•é¢æ¿ -->
                <div class="panel" id="panel-videos">
                    <!-- æ ‡ç­¾é¡µ -->
                    <div class="tabs">
                        <button class="tab active" onclick="switchVideoTab('hot')">ğŸ”¥ çˆ†æ¬¾è§†é¢‘</button>
                        <button class="tab" onclick="switchVideoTab('recentHits')">âš¡ è¿‘æœŸçˆ†æ¬¾</button>
                        <button class="tab" onclick="switchVideoTab('evergreen')">ğŸŒ² é•¿é’è§†é¢‘</button>
                        <button class="tab" onclick="switchVideoTab('potential')">ğŸ“ˆ æ½œåŠ›è§†é¢‘</button>
                        <button class="tab" onclick="switchVideoTab('longform')">â±ï¸ é•¿è§†é¢‘æ¦œ</button>
                    </div>

                    <!-- çˆ†æ¬¾è§†é¢‘æ¦œå• -->
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title">
                                ğŸ”¥ çˆ†æ¬¾è§†é¢‘ Top 100
                                <span class="ranking-count">å…± 120 ä¸ª</span>
                            </span>
                            <div class="ranking-filters" id="videoTimeFilters">
                                <button class="filter-btn active" onclick="setVideoTimeFilter(0)">å…¨éƒ¨</button>
                                <button class="filter-btn" onclick="setVideoTimeFilter(1)">è¿‘24å°æ—¶</button>
                                <button class="filter-btn" onclick="setVideoTimeFilter(7)">è¿‘7å¤©</button>
                                <button class="filter-btn" onclick="setVideoTimeFilter(30)">è¿‘30å¤©</button>
                                <button class="filter-btn" onclick="setVideoTimeFilter(90)">è¿‘90å¤©</button>
                            </div>
                        </div>
                        <div class="ranking-list" id="videoRankingList">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <div class="load-more">
                            <button class="load-more-btn" onclick="loadMoreVideos()">åŠ è½½æ›´å¤š</button>
                        </div>
                    </div>
                </div>

                <!-- é¢‘é“æ•°æ®é¢æ¿ -->
                <div class="panel" id="panel-channels">
                    <div class="tabs">
                        <button class="tab active" onclick="switchChannelTab('totalViews')">ğŸ“Š æ€»æ’­æ”¾æ¦œ</button>
                        <button class="tab" onclick="switchChannelTab('avgViews')">âš¡ å¹³å‡æ’­æ”¾æ¦œ</button>
                        <button class="tab" onclick="switchChannelTab('videoCount')">ğŸ“¹ è§†é¢‘æ•°æ¦œ</button>
                        <button class="tab" onclick="switchChannelTab('darkHorse')">ğŸ´ é»‘é©¬æ¦œ</button>
                        <button class="tab" onclick="switchChannelTab('efficiency')">ğŸš€ é«˜æ•ˆæ¦œ</button>
                    </div>

                    <!-- é¢‘é“æ¦œå• -->
                    <div id="channelRankingContainer">
                        <div class="no-data-state">
                            <div class="no-data-icon">ğŸ“º</div>
                            <div class="no-data-title">æš‚æ— é¢‘é“æ•°æ®</div>
                            <p class="no-data-desc">æœç´¢å…³é”®è¯åï¼Œè¿™é‡Œå°†å±•ç¤ºé¢‘é“æ’è¡Œæ¦œ</p>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å¼æ´å¯Ÿé¢æ¿ -->
                <div class="panel" id="panel-patterns">
                    <div class="tabs">
                        <button class="tab active" onclick="switchPatternTab('duration')">â±ï¸ æ—¶é•¿åˆ†å¸ƒ</button>
                        <button class="tab" onclick="switchPatternTab('timeline')">ğŸ“… å‘å¸ƒè¶‹åŠ¿</button>
                        <button class="tab" onclick="switchPatternTab('title')">ğŸ“ æ ‡é¢˜æ¨¡å¼</button>
                    </div>

                    <!-- æ—¶é•¿åˆ†å¸ƒ -->
                    <div class="ranking-section" id="pattern-duration">
                        <div class="ranking-header">
                            <span class="ranking-title">â±ï¸ æ—¶é•¿åˆ†å¸ƒ vs å¹³å‡æ’­æ”¾é‡</span>
                        </div>
                        <div class="time-chart" id="durationChart">
                            <div style="padding: 20px; text-align: center; color: #64748b;">æš‚æ— æ•°æ®</div>
                        </div>
                    </div>

                    <!-- å‘å¸ƒè¶‹åŠ¿ -->
                    <div class="ranking-section" id="pattern-timeline" style="display: none;">
                        <div class="ranking-header">
                            <span class="ranking-title">ğŸ“… å„æ—¶é—´æ®µè§†é¢‘è¡¨ç°</span>
                        </div>
                        <div id="timelineChart">
                            <div style="padding: 20px; text-align: center; color: #64748b;">æš‚æ— æ•°æ®</div>
                        </div>
                    </div>

                    <!-- æ ‡é¢˜æ¨¡å¼ -->
                    <div class="ranking-section" id="pattern-title" style="display: none;">
                        <div class="ranking-header">
                            <span class="ranking-title">ğŸ“ é«˜æ’­æ”¾é‡æ ‡é¢˜ç‰¹å¾</span>
                        </div>
                        <div id="titlePatternChart">
                            <div style="padding: 20px; text-align: center; color: #64748b;">æš‚æ— æ•°æ®</div>
                        </div>
                    </div>
                </div>

                <!-- åˆ†ææŠ¥å‘Šé¢æ¿ -->
                <div class="panel" id="panel-report">
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title" id="reportTitle">ğŸ“‹ åˆ†ææŠ¥å‘Š</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="filter-btn" onclick="exportReport('csv')" style="font-size: 12px;">ğŸ“Š å¯¼å‡º CSV</button>
                                <button class="filter-btn" onclick="exportReport('json')" style="font-size: 12px;">ğŸ“ å¯¼å‡º JSON</button>
                            </div>
                        </div>

                        <!-- æŠ¥å‘Šå†…å®¹ -->
                        <div id="reportContent" style="padding: 20px;">
                            <div class="no-data-state">
                                <div class="no-data-icon">ğŸ“‹</div>
                                <div class="no-data-title">æš‚æ— æŠ¥å‘Š</div>
                                <p class="no-data-desc">æœç´¢å…³é”®è¯åï¼Œè¿™é‡Œå°†ç”Ÿæˆå®Œæ•´çš„åˆ†ææŠ¥å‘Š</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç›‘æ§é¢æ¿ï¼ˆç‹¬ç«‹äº resultsContainerï¼‰ -->
                <div class="panel" id="panel-monitor">
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title">ğŸ“¡ å…³é”®è¯ç›‘æ§</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="filter-btn" onclick="toggleScheduler()" id="schedulerBtn" style="font-size: 12px;">â–¶ï¸ å¯åŠ¨è°ƒåº¦å™¨</button>
                                <button class="search-btn" onclick="showAddMonitorModal()" style="padding: 8px 16px; font-size: 12px;">+ æ·»åŠ ç›‘æ§</button>
                            </div>
                        </div>

                        <!-- è°ƒåº¦å™¨çŠ¶æ€ -->
                        <div id="schedulerStatus" style="padding: 12px 20px; background: #0f172a; border-bottom: 1px solid #334155;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span id="schedulerIndicator" style="width: 10px; height: 10px; border-radius: 50%; background: #64748b;"></span>
                                <span style="color: #94a3b8; font-size: 0.9em;" id="schedulerStatusText">è°ƒåº¦å™¨æœªè¿è¡Œ</span>
                            </div>
                        </div>

                        <!-- ç›‘æ§ä»»åŠ¡åˆ—è¡¨ -->
                        <div class="ranking-list" id="monitorTasksList" style="max-height: none;">
                            <div style="padding: 40px 20px; text-align: center; color: #64748b;">
                                <div style="font-size: 2em; margin-bottom: 16px;">ğŸ“¡</div>
                                <div style="font-weight: 600; color: white; margin-bottom: 8px;">æš‚æ— ç›‘æ§ä»»åŠ¡</div>
                                <p>æ·»åŠ å…³é”®è¯åï¼Œç³»ç»Ÿå°†å®šæ—¶é‡‡é›†æ•°æ®å¹¶è¿½è¸ªå¢é•¿è¶‹åŠ¿</p>
                                <button class="search-btn" onclick="showAddMonitorModal()" style="margin-top: 16px; padding: 10px 20px;">+ æ·»åŠ ç›‘æ§ä»»åŠ¡</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¶‹åŠ¿è¿½è¸ªé¢æ¿ -->
                <div class="panel" id="panel-trending">
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title">ğŸ“ˆ è¶‹åŠ¿è¿½è¸ª</span>
                            <div class="ranking-filters">
                                <button class="filter-btn active" onclick="setTrendingDays(7)">è¿‘7å¤©</button>
                                <button class="filter-btn" onclick="setTrendingDays(14)">è¿‘14å¤©</button>
                                <button class="filter-btn" onclick="setTrendingDays(30)">è¿‘30å¤©</button>
                            </div>
                        </div>

                        <!-- è¶‹åŠ¿æ‘˜è¦ -->
                        <div id="trendingSummary" style="padding: 20px; background: #0f172a; border-bottom: 1px solid #334155;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #06b6d4;" id="trend-total-videos">0</div>
                                    <div style="font-size: 0.75em; color: #64748b;">ç›‘æ§è§†é¢‘</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #10b981;" id="trend-total-growth">0</div>
                                    <div style="font-size: 0.75em; color: #64748b;">æ€»å¢é•¿</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #f59e0b;" id="trend-trending-count">0</div>
                                    <div style="font-size: 0.75em; color: #64748b;">è¶‹åŠ¿ä¸Šå‡</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #8b5cf6;" id="trend-avg-growth">0</div>
                                    <div style="font-size: 0.75em; color: #64748b;">å¹³å‡å¢é•¿</div>
                                </div>
                            </div>
                        </div>

                        <!-- è¶‹åŠ¿è§†é¢‘åˆ—è¡¨ -->
                        <div class="ranking-list" id="trendingVideosList">
                            <div style="padding: 40px 20px; text-align: center; color: #64748b;">
                                <div style="font-size: 2em; margin-bottom: 16px;">ğŸ“ˆ</div>
                                <div style="font-weight: 600; color: white; margin-bottom: 8px;">æš‚æ— è¶‹åŠ¿æ•°æ®</div>
                                <p>æ·»åŠ ç›‘æ§ä»»åŠ¡å¹¶ç­‰å¾…æ•°æ®é‡‡é›†åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºå¢é•¿è¶‹åŠ¿</p>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- è¯Šæ–­ç»“æœ -->
            <div class="diagnose-result" id="diagnoseResult">
                <div class="diagnose-summary">
                    <div class="diagnose-channel">
                        <div class="diagnose-channel-avatar">ğŸ‘¤</div>
                        <div class="diagnose-channel-info">
                            <h3 id="diagnoseChannelName">æˆ‘çš„å…»ç”Ÿé¢‘é“</h3>
                            <p>è®¢é˜… 2.3ä¸‡ Â· è§†é¢‘ 45 ä¸ª Â· æ€»æ’­æ”¾ 89ä¸‡</p>
                        </div>
                    </div>
                    <div class="diagnose-scores">
                        <div class="diagnose-score">
                            <div class="diagnose-score-value" style="color: #f59e0b;">B+</div>
                            <div class="diagnose-score-label">ç»¼åˆè¯„åˆ†</div>
                        </div>
                        <div class="diagnose-score">
                            <div class="diagnose-score-value" style="color: #10b981;">A</div>
                            <div class="diagnose-score-label">å†…å®¹è´¨é‡</div>
                        </div>
                        <div class="diagnose-score">
                            <div class="diagnose-score-value" style="color: #ef4444;">C</div>
                            <div class="diagnose-score-label">æ›´æ–°é¢‘ç‡</div>
                        </div>
                        <div class="diagnose-score">
                            <div class="diagnose-score-value" style="color: #f59e0b;">B</div>
                            <div class="diagnose-score-label">äº’åŠ¨ç‡</div>
                        </div>
                    </div>

                    <div class="ai-insight" style="margin: 0;">
                        <div class="ai-header">
                            <div class="ai-avatar">ğŸ¤–</div>
                            <div class="ai-label">è¯Šæ–­æŠ¥å‘Š</div>
                        </div>
                        <div class="ai-content">
                            <p><strong>ä¼˜åŠ¿ï¼š</strong>å†…å®¹è´¨é‡è¾ƒé«˜ï¼Œå•æ¡è§†é¢‘å®Œæ’­ç‡è¾¾åˆ° 65%ï¼Œé«˜äºè¡Œä¸šå¹³å‡çš„ 42%ã€‚ç”¨æˆ·è¯„è®ºç§¯æï¼Œç²‰ä¸ç²˜æ€§å¥½ã€‚</p>
                            <p><strong>åŠ£åŠ¿ï¼š</strong>æ›´æ–°é¢‘ç‡è¿‡ä½ï¼ˆå¹³å‡ 12 å¤©/æ¡ï¼‰ï¼Œé”™å¤±äº†ç®—æ³•æ¨èçª—å£æœŸã€‚è§†é¢‘æ—¶é•¿é›†ä¸­åœ¨ 5-8 åˆ†é’Ÿï¼Œæœªèƒ½æŠ“ä½ 20-30 åˆ†é’Ÿçš„è“æµ·æœºä¼šã€‚</p>
                            <p><strong>å»ºè®®ï¼š</strong>æé«˜æ›´æ–°é¢‘ç‡è‡³æ¯å‘¨ 2-3 æ¡ï¼Œå°è¯•åˆ¶ä½œ 20-30 åˆ†é’Ÿçš„æ·±åº¦å†…å®¹ï¼Œå¯å‚è€ƒã€Œå…»ç”Ÿæœ‰é“ã€çš„å†…å®¹ç»“æ„ã€‚</p>
                        </div>
                    </div>
                </div>

                <div class="recommend-channels">
                    <div class="recommend-title">ğŸ¯ æ¨èæ¨¡ä»¿çš„å¯¹æ ‡è´¦å·ï¼ˆæŒ‰åŒ¹é…åº¦æ’åºï¼‰</div>
                    <div class="recommend-list" id="recommendList">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">ğŸ”</div>
                <div class="empty-title">è¾“å…¥ä¸€ä¸ªé¢†åŸŸï¼Œå¼€å§‹æ·±åº¦åˆ†æ</div>
                <p>AI ä¼šåˆ†æ 1000+ ç«å“è§†é¢‘ï¼Œå‘Šè¯‰ä½ å¸‚åœºè¾¹ç•Œã€å…³é”®é¢‘é“ã€æ½œåŠ›è§†é¢‘å’Œæœ€ä½³æœºä¼š</p>
            </div>
        </main>
    </div>

    <script>
        // æ¸²æŸ“è§†é¢‘æ¦œå•
        function renderVideoRanking(data, limit = 50) {
            const list = document.getElementById('videoRankingList');
            const isEvergreen = currentVideoTab === 'evergreen';
            const isRecentHits = currentVideoTab === 'recentHits';

            list.innerHTML = data.slice(0, limit).map(v => {
                // è¿‘æœŸçˆ†æ¬¾å’Œé•¿é’è§†é¢‘æ˜¾ç¤ºæ—¥å‡æ’­æ”¾
                let statsHtml = '';
                if (isEvergreen && v.dailyViews) {
                    statsHtml = `
                        <div class="rank-stat">
                            <div class="rank-stat-value" style="color: #10b981;">${formatNumber(v.dailyViews)}</div>
                            <div class="rank-stat-label">æ—¥å‡æ’­æ”¾</div>
                        </div>
                        <div class="rank-stat">
                            <div class="rank-stat-value">${formatNumber(v.views)}</div>
                            <div class="rank-stat-label">æ€»æ’­æ”¾</div>
                        </div>
                    `;
                } else if (isRecentHits && v.videoAgeDays) {
                    statsHtml = `
                        <div class="rank-stat">
                            <div class="rank-stat-value" style="color: #f59e0b;">${formatNumber(v.views)}</div>
                            <div class="rank-stat-label">æ’­æ”¾é‡</div>
                        </div>
                        <div class="rank-stat">
                            <div class="rank-stat-value">${v.videoAgeDays}å¤©</div>
                            <div class="rank-stat-label">å‘å¸ƒ</div>
                        </div>
                    `;
                } else {
                    statsHtml = `
                        <div class="rank-stat">
                            <div class="rank-stat-value">${formatNumber(v.views)}</div>
                            <div class="rank-stat-label">æ’­æ”¾</div>
                        </div>
                        <div class="rank-stat">
                            <div class="rank-stat-value">${formatNumber(v.likes || 0)}</div>
                            <div class="rank-stat-label">ç‚¹èµ</div>
                        </div>
                    `;
                }

                return `
                <div class="ranking-item" onclick="openVideo('${v.videoId}')" style="cursor: pointer;" title="ç‚¹å‡»æ‰“å¼€è§†é¢‘">
                    <div class="rank-number ${v.rank <= 3 ? 'rank-' + v.rank : 'rank-normal'}">${v.rank}</div>
                    <div class="rank-thumb">ğŸ¬</div>
                    <div class="rank-info">
                        <div class="rank-title">${v.title}</div>
                        <div class="rank-meta">
                            <span>${v.channel}</span>
                            <span>${v.duration || ''}</span>
                            <span>${v.date}</span>
                        </div>
                    </div>
                    <div class="rank-stats">${statsHtml}</div>
                    <div class="rank-score score-${(v.score || 'C').toLowerCase()}">${v.score || 'C'}</div>
                </div>
            `}).join('');
        }

        // æ‰“å¼€è§†é¢‘é“¾æ¥
        function openVideo(videoId) {
            if (videoId) {
                window.open(`https://www.youtube.com/watch?v=${videoId}`, '_blank');
            }
        }

        // æ¸²æŸ“é¢‘é“åˆ—è¡¨ï¼ˆè¯Šæ–­åŠŸèƒ½ç”¨ï¼‰
        function renderChannelList() {
            const list = document.getElementById('channelList');
            if (!list) return;
            list.innerHTML = '<div class="no-data-state"><div class="no-data-icon">ğŸ“º</div><div class="no-data-title">æš‚æ— é¢‘é“æ•°æ®</div></div>';
        }

        function toggleChannelVideos(index) {
            const el = document.getElementById(`channel-videos-${index}`);
            el.classList.toggle('open');
        }

        // æ¸²æŸ“è¯é¢˜æ¦œå•ï¼ˆè¯Šæ–­åŠŸèƒ½ç”¨ï¼‰
        function renderTopicRanking() {
            const list = document.getElementById('topicRankingList');
            if (!list) return;
            list.innerHTML = '<div class="no-data-state"><div class="no-data-icon">ğŸ·ï¸</div><div class="no-data-title">æš‚æ— è¯é¢˜æ•°æ®</div></div>';
        }

        // æ¸²æŸ“åœ°åŒºåˆ†å¸ƒï¼ˆè¯Šæ–­åŠŸèƒ½ç”¨ï¼‰
        function renderRegionGrid() {
            const grid = document.getElementById('regionGrid');
            if (!grid) return;
            grid.innerHTML = '<div class="no-data-state"><div class="no-data-icon">ğŸŒ</div><div class="no-data-title">æš‚æ— åœ°åŒºæ•°æ®</div></div>';
        }

        // æ¸²æŸ“æ¨èè´¦å·ï¼ˆè¯Šæ–­åŠŸèƒ½ç”¨ï¼‰
        function renderRecommendList() {
            const list = document.getElementById('recommendList');
            if (!list) return;
            list.innerHTML = '<div class="no-data-state"><div class="no-data-icon">ğŸ‘¥</div><div class="no-data-title">æš‚æ— æ¨èæ•°æ®</div></div>';
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'ä¸‡';
            }
            return num.toLocaleString();
        }

        // åˆ‡æ¢é¢æ¿
        function switchPanel(panelId) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));

            document.getElementById('panel-' + panelId).classList.add('active');
            document.querySelector(`[data-panel="${panelId}"]`).classList.add('active');
        }

        // ä¾§è¾¹æ ç‚¹å‡»
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                const panel = item.dataset.panel;
                if (panel) {
                    switchPanel(panel);
                }
            });
        });

        // è®¾ç½®è¯é¢˜
        function setTopic(topic) {
            document.getElementById('topicInput').value = topic;
            startAnalysis();
        }

        // ==================== åŠ¨æ€è¶‹åŠ¿çƒ­è¯ç³»ç»Ÿ ====================

        // æœç´¢å†å²ç®¡ç†ï¼ˆå­˜å‚¨åœ¨ localStorageï¼‰
        const SEARCH_HISTORY_KEY = 'youtube_search_history';
        const MAX_HISTORY_ITEMS = 5;

        function getSearchHistory() {
            try {
                return JSON.parse(localStorage.getItem(SEARCH_HISTORY_KEY)) || [];
            } catch {
                return [];
            }
        }

        function saveSearchHistory(keyword) {
            const history = getSearchHistory();
            // ç§»é™¤é‡å¤é¡¹
            const filtered = history.filter(h => h !== keyword);
            // æ·»åŠ åˆ°å¼€å¤´
            filtered.unshift(keyword);
            // ä¿ç•™æœ€è¿‘ N æ¡
            const trimmed = filtered.slice(0, MAX_HISTORY_ITEMS);
            localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(trimmed));
            renderSearchHistory();
        }

        function renderSearchHistory() {
            const history = getSearchHistory();
            const container = document.getElementById('historyPresets');

            if (history.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = '<span class="preset-label">æœ€è¿‘æœç´¢ï¼š</span>' +
                history.map(h => `<button class="preset-tag" onclick="setTopic('${h}')">${h}</button>`).join('');
        }

        // è¶‹åŠ¿çƒ­è¯è·å–
        async function fetchTrendingKeywords() {
            const container = document.getElementById('trendingKeywords');
            const loading = document.getElementById('trendingLoading');
            const source = document.getElementById('trendingSource');
            const refreshBtn = document.getElementById('trendingRefresh');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = `
                <div class="trending-loading">
                    <div class="dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <span>æ­£åœ¨è·å– YouTube è¶‹åŠ¿æ•°æ®...</span>
                </div>
            `;
            source.style.display = 'none';
            refreshBtn.classList.add('loading');

            try {
                // é€šè¿‡ WebSocket è¯·æ±‚åç«¯è·å–è¶‹åŠ¿çƒ­è¯
                const keywords = await requestTrendingFromServer();
                renderTrendingKeywords(keywords);
            } catch (error) {
                console.error('è·å–è¶‹åŠ¿çƒ­è¯å¤±è´¥:', error);
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æœç´¢å»ºè®® API
                await fallbackToSuggestions();
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        // é€šè¿‡ WebSocket è¯·æ±‚åç«¯è·å–è¶‹åŠ¿
        function requestTrendingFromServer() {
            return new Promise((resolve, reject) => {
                // å¦‚æœ WebSocket å·²è¿æ¥ï¼Œå‘é€è¯·æ±‚
                if (globalWs && globalWs.readyState === WebSocket.OPEN) {
                    // è®¾ç½®è¶…æ—¶
                    const timeout = setTimeout(() => {
                        reject(new Error('è¯·æ±‚è¶…æ—¶'));
                    }, 15000);

                    // ä¸´æ—¶ç›‘å¬å™¨
                    const handler = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.type === 'trending_keywords') {
                                clearTimeout(timeout);
                                globalWs.removeEventListener('message', handler);
                                resolve(data.keywords || []);
                            }
                        } catch (e) {}
                    };

                    globalWs.addEventListener('message', handler);
                    globalWs.send(JSON.stringify({ type: 'get_trending' }));
                } else {
                    // WebSocket æœªè¿æ¥ï¼Œç›´æ¥ä½¿ç”¨é™çº§æ–¹æ¡ˆ
                    reject(new Error('WebSocket æœªè¿æ¥'));
                }
            });
        }

        // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ YouTube æœç´¢å»ºè®®è·å–çƒ­è¯
        async function fallbackToSuggestions() {
            const container = document.getElementById('trendingKeywords');
            const source = document.getElementById('trendingSource');

            container.innerHTML = `
                <div class="trending-loading">
                    <div class="dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <span>æ­£åœ¨ä»æœç´¢å»ºè®®è·å–çƒ­è¯...</span>
                </div>
            `;

            try {
                // ä½¿ç”¨å¤šä¸ªé€šç”¨ç§å­è¯è·å–å»ºè®®
                const seeds = ['2025', 'æ•™ç¨‹', 'å…»ç”Ÿ', 'ç¾é£Ÿ', 'ç§‘æŠ€', 'æ–°é—»'];
                const allSuggestions = [];

                for (const seed of seeds) {
                    try {
                        const suggestions = await fetchYouTubeSuggestions(seed);
                        if (suggestions && suggestions.length > 0) {
                            // å–ç¬¬ä¸€ä¸ªå»ºè®®
                            allSuggestions.push({
                                keyword: suggestions[0],
                                heat: Math.floor(Math.random() * 50) + 50 // æ¨¡æ‹Ÿçƒ­åº¦
                            });
                        }
                    } catch (e) {
                        console.log(`è·å– "${seed}" çš„å»ºè®®å¤±è´¥`);
                    }
                }

                if (allSuggestions.length > 0) {
                    renderTrendingKeywords(allSuggestions);
                    document.getElementById('trendingSource').querySelector('span:last-child').innerHTML =
                        `æ•°æ®æ¥æºï¼šYouTube æœç´¢å»ºè®® Â· æ›´æ–°æ—¶é—´ï¼š<span id="trendingTime">${new Date().toLocaleTimeString()}</span>`;
                } else {
                    throw new Error('æ— æ³•è·å–å»ºè®®');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="trending-error">
                        <span>âš ï¸</span>
                        <span>æš‚æ—¶æ— æ³•è·å–è¶‹åŠ¿æ•°æ®ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥å…³é”®è¯</span>
                    </div>
                `;
            }
        }

        // è·å– YouTube æœç´¢å»ºè®®
        async function fetchYouTubeSuggestions(seed) {
            return new Promise((resolve, reject) => {
                // ä½¿ç”¨ JSONP æ–¹å¼è·å–å»ºè®®
                const callbackName = 'ytSuggestCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const script = document.createElement('script');

                // è®¾ç½®è¶…æ—¶
                const timeout = setTimeout(() => {
                    cleanup();
                    reject(new Error('è¯·æ±‚è¶…æ—¶'));
                }, 5000);

                // æ¸…ç†å‡½æ•°
                function cleanup() {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                }

                // å®šä¹‰å›è°ƒ
                window[callbackName] = function(data) {
                    cleanup();
                    if (data && data[1]) {
                        const suggestions = data[1].map(item => item[0]);
                        resolve(suggestions);
                    } else {
                        reject(new Error('æ— æ•°æ®'));
                    }
                };

                // æ„å»º URL
                const encodedSeed = encodeURIComponent(seed);
                script.src = `https://clients1.google.com/complete/search?client=youtube&gs_ri=youtube&ds=yt&q=${encodedSeed}&callback=${callbackName}`;
                script.onerror = () => {
                    cleanup();
                    reject(new Error('åŠ è½½å¤±è´¥'));
                };

                document.head.appendChild(script);
            });
        }

        // æ¸²æŸ“è¶‹åŠ¿çƒ­è¯
        function renderTrendingKeywords(keywords) {
            const container = document.getElementById('trendingKeywords');
            const source = document.getElementById('trendingSource');

            if (!keywords || keywords.length === 0) {
                container.innerHTML = `
                    <div class="trending-error">
                        <span>ğŸ“­</span>
                        <span>æš‚æ— è¶‹åŠ¿æ•°æ®</span>
                    </div>
                `;
                return;
            }

            container.innerHTML = keywords.map(item => {
                const keyword = typeof item === 'string' ? item : item.keyword;
                const heat = typeof item === 'object' && item.heat ? item.heat : null;
                const heatHtml = heat ? `<span class="tag-heat">ğŸ”¥${heat}</span>` : '';
                return `<button class="trending-tag" onclick="setTrendingTopic('${keyword}')">${keyword}${heatHtml}</button>`;
            }).join('');

            source.style.display = 'flex';
            document.getElementById('trendingTime').textContent = new Date().toLocaleTimeString();
        }

        // ç‚¹å‡»è¶‹åŠ¿çƒ­è¯
        function setTrendingTopic(topic) {
            document.getElementById('topicInput').value = topic;
            // å¯é€‰ï¼šç›´æ¥å¼€å§‹åˆ†æ
            // startAnalysis();
        }

        // åˆ·æ–°è¶‹åŠ¿çƒ­è¯
        function refreshTrendingKeywords() {
            fetchTrendingKeywords();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ¸²æŸ“æœç´¢å†å²
            renderSearchHistory();

            // è·å–è¶‹åŠ¿çƒ­è¯
            setTimeout(() => {
                fetchTrendingKeywords();
            }, 500);
        });

        // å…¨å±€ WebSocket å¼•ç”¨
        let globalWs = null;

        // ==================== åŠ¨æ€è¶‹åŠ¿çƒ­è¯ç³»ç»Ÿç»“æŸ ====================

        // API é…ç½®
        const API_BASE = 'http://localhost:8000';
        let currentWebSocket = null;

        // å¼€å§‹åˆ†æ
        async function startAnalysis() {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic) {
                alert('è¯·è¾“å…¥ä½ æƒ³ç ”ç©¶çš„é¢†åŸŸ');
                return;
            }

            // ä¿å­˜æœç´¢å†å²
            saveSearchHistory(topic);

            // éšè—ç©ºçŠ¶æ€å’Œè¯Šæ–­ç»“æœ
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('diagnoseResult').classList.remove('show');
            document.getElementById('resultsContainer').style.display = 'none';

            // æ˜¾ç¤ºåˆ†æçŠ¶æ€
            document.getElementById('analysisStatus').classList.add('show');
            document.getElementById('statusTitle').textContent = `æ­£åœ¨åˆ†æï¼š${topic}`;
            document.getElementById('statusBadge').textContent = 'è¿æ¥ä¸­';
            document.getElementById('statusBadge').className = 'status-badge running';
            document.getElementById('progressFill').className = 'progress-fill';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('analyzeBtn').disabled = true;

            // æ”¶é›†ç­›é€‰æ¡ä»¶
            const researchParams = {
                topic: topic,
                mode: getSelectedMode(),
                max_results: filterState.videoCount || 500,
                views_min: filterState.viewsMin,
                views_max: filterState.viewsMax,
                duration_filter: filterState.duration.length > 0 ? filterState.duration : null,
                time_range: filterState.timeRange,
                regions: filterState.regions.length > 0 ? filterState.regions : null,
                subscribers_filter: filterState.subscribers.length > 0 ? filterState.subscribers : null,
                ai_filter: filterState.aiFilter,
                sort_by: filterState.sortBy || 'views'
            };

            console.log('ç ”ç©¶å‚æ•°:', researchParams);

            // å°è¯•è¿æ¥ WebSocket API
            const taskId = `task_${Date.now()}`;
            const wsUrl = `ws://localhost:8000/ws/${taskId}`;

            try {
                await connectWebSocket(wsUrl, researchParams);
            } catch (error) {
                console.error('WebSocket è¿æ¥å¤±è´¥:', error);
                // æ˜¾ç¤ºè¿æ¥å¤±è´¥æç¤ºï¼Œä¸ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                showConnectionError(error.message || 'æ— æ³•è¿æ¥åˆ°æ•°æ®æœåŠ¡å™¨');
            }
        }

        // æ˜¾ç¤ºè¿æ¥é”™è¯¯
        function showConnectionError(message) {
            const loadingState = document.getElementById('loadingState');
            const resultsContainer = document.getElementById('resultsContainer');
            if (loadingState) loadingState.style.display = 'none';
            if (resultsContainer) resultsContainer.style.display = 'block';

            // æ¸…ç©ºæ•°æ®
            window.currentVideoData = [];
            window.currentChannelData = [];

            // æ›´æ–°ä¾§è¾¹æ æ•°å­—ä¸º 0
            ['badge-videos', 'badge-video-analysis', 'badge-channels', 'badge-channel-analysis', 'badge-topics', 'badge-regions'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '0';
            });

            // æ˜¾ç¤ºé”™è¯¯æç¤º
            const overviewPanel = document.getElementById('panel-overview');
            if (overviewPanel) {
                overviewPanel.innerHTML = `
                    <div class="no-data-state" style="padding: 60px 20px;">
                        <div class="no-data-icon">âš ï¸</div>
                        <div class="no-data-title">è¿æ¥å¤±è´¥</div>
                        <p class="no-data-desc">${message}<br><br>è¯·ç¡®ä¿ API æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼š<br><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">python api_server.py</code></p>
                    </div>
                `;
            }

            switchPanel('overview');
        }

        // è·å–é€‰ä¸­çš„åˆ†ææ¨¡å¼
        function getSelectedMode() {
            if (filterState.videoCount <= 100) return 'quick';
            if (filterState.videoCount >= 1000) return 'deep';
            return 'standard';
        }

        // WebSocket è¿æ¥
        function connectWebSocket(wsUrl, params) {
            return new Promise((resolve, reject) => {
                // å…³é—­ä¹‹å‰çš„è¿æ¥
                if (currentWebSocket) {
                    currentWebSocket.close();
                }

                const ws = new WebSocket(wsUrl);
                currentWebSocket = ws;
                globalWs = ws;  // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›è¶‹åŠ¿çƒ­è¯ä½¿ç”¨
                let resolved = false;
                let heartbeatInterval = null;
                let lastPongTime = Date.now();

                // å¿ƒè·³æœºåˆ¶ - æ¯ 30 ç§’å‘é€ä¸€æ¬¡ ping
                function startHeartbeat() {
                    heartbeatInterval = setInterval(() => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
                            console.log('ğŸ’“ å‘é€å¿ƒè·³ ping');

                            // æ£€æŸ¥ä¸Šæ¬¡ pong æ˜¯å¦è¶…æ—¶ï¼ˆ90ç§’æ— å“åº”åˆ™è®¤ä¸ºè¿æ¥æ–­å¼€ï¼‰
                            if (Date.now() - lastPongTime > 90000) {
                                console.warn('âš ï¸ å¿ƒè·³è¶…æ—¶ï¼Œå°è¯•é‡è¿...');
                                // ä¸ä¸»åŠ¨å…³é—­ï¼Œè®©æœåŠ¡å™¨å†³å®š
                            }
                        }
                    }, 30000); // 30ç§’é—´éš”
                }

                function stopHeartbeat() {
                    if (heartbeatInterval) {
                        clearInterval(heartbeatInterval);
                        heartbeatInterval = null;
                    }
                }

                ws.onopen = () => {
                    console.log('WebSocket å·²è¿æ¥');
                    document.getElementById('statusLog').textContent = 'å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå¼€å§‹é‡‡é›†...';
                    // å¯åŠ¨å¿ƒè·³
                    startHeartbeat();
                    // å‘é€ç ”ç©¶å‚æ•°
                    ws.send(JSON.stringify(params));
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', data);

                    switch (data.type) {
                        case 'pong':
                            // å¿ƒè·³å“åº”
                            lastPongTime = Date.now();
                            console.log('ğŸ’“ æ”¶åˆ°å¿ƒè·³ pong');
                            break;

                        case 'start':
                            document.getElementById('statusBadge').textContent = 'é‡‡é›†ä¸­';
                            break;

                        case 'progress':
                            document.getElementById('progressFill').style.width = data.progress + '%';
                            // å¦‚æœæœ‰é¢‘é“è·å–çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ˜¾ç¤ºé¢„ä¼°æ—¶é—´
                            if (data.channel_fetch && data.channel_fetch.estimated_remaining_seconds) {
                                const remaining = data.channel_fetch.estimated_remaining_seconds;
                                const minutes = Math.floor(remaining / 60);
                                const seconds = Math.floor(remaining % 60);
                                const timeStr = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
                                const speedIcon = data.channel_fetch.network_speed === 'fast' ? 'ğŸš€' :
                                                  data.channel_fetch.network_speed === 'slow' ? 'ğŸ¢' : 'ğŸ“¡';
                                document.getElementById('statusLog').textContent =
                                    `${data.message} ${speedIcon} é¢„è®¡è¿˜éœ€ ${timeStr}`;
                            } else {
                                document.getElementById('statusLog').textContent = data.message;
                            }
                            break;

                        case 'complete':
                            document.getElementById('statusBadge').textContent = 'å®Œæˆ';
                            document.getElementById('statusBadge').className = 'status-badge done';
                            document.getElementById('progressFill').className = 'progress-fill done';
                            document.getElementById('analyzeBtn').disabled = false;

                            // æ¸²æŸ“çœŸå®æ•°æ®
                            if (data.result) {
                                renderRealData(data.result);
                            }

                            resolved = true;
                            resolve(data.result);
                            break;

                        case 'error':
                            document.getElementById('statusLog').textContent = 'é”™è¯¯: ' + data.message;
                            document.getElementById('statusBadge').textContent = 'å¤±è´¥';
                            document.getElementById('statusBadge').className = 'status-badge error';
                            document.getElementById('analyzeBtn').disabled = false;
                            reject(new Error(data.message));
                            break;
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket é”™è¯¯:', error);
                    if (!resolved) {
                        reject(error);
                    }
                };

                ws.onclose = async () => {
                    console.log('WebSocket å·²å…³é—­');
                    stopHeartbeat();
                    currentWebSocket = null;

                    // å¦‚æœä»»åŠ¡è¿˜æ²¡å®Œæˆï¼Œå°è¯•è½®è¯¢è·å–ç»“æœ
                    if (!resolved) {
                        console.log('âš ï¸ è¿æ¥æ–­å¼€ä½†ä»»åŠ¡æœªå®Œæˆï¼Œå°è¯•è½®è¯¢è·å–ç»“æœ...');
                        document.getElementById('statusLog').textContent = 'è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨å°è¯•è·å–ç»“æœ...';

                        // ä» wsUrl ä¸­æå– task_id
                        const taskId = wsUrl.split('/').pop();
                        const baseUrl = wsUrl.replace(/^ws/, 'http').replace(/\/ws\/.*$/, '');

                        // è½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼ˆæœ€å¤šå°è¯• 10 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 5 ç§’ï¼‰
                        for (let i = 0; i < 10; i++) {
                            await new Promise(r => setTimeout(r, 5000));

                            try {
                                const response = await fetch(`${baseUrl}/api/task/${taskId}/status`);
                                const status = await response.json();

                                console.log(`ğŸ“¡ è½®è¯¢ #${i + 1}:`, status);
                                document.getElementById('statusLog').textContent =
                                    `æ­£åœ¨è·å–ç»“æœ... (${i + 1}/10) - ${status.message || 'ç­‰å¾…ä¸­'}`;

                                if (status.status === 'complete' && status.result) {
                                    console.log('âœ… é€šè¿‡è½®è¯¢è·å–åˆ°ç»“æœ');
                                    document.getElementById('statusBadge').textContent = 'å®Œæˆ';
                                    document.getElementById('statusBadge').className = 'status-badge done';
                                    document.getElementById('progressFill').className = 'progress-fill done';
                                    document.getElementById('progressFill').style.width = '100%';
                                    document.getElementById('analyzeBtn').disabled = false;

                                    renderRealData(status.result);
                                    resolved = true;
                                    resolve(status.result);
                                    return;
                                } else if (status.status === 'error') {
                                    console.error('âŒ ä»»åŠ¡å¤±è´¥:', status.message);
                                    document.getElementById('statusLog').textContent = 'ä»»åŠ¡å¤±è´¥: ' + status.message;
                                    document.getElementById('analyzeBtn').disabled = false;
                                    reject(new Error(status.message));
                                    return;
                                } else if (status.status === 'not_found') {
                                    // ä»»åŠ¡ä¸å­˜åœ¨ï¼Œåœæ­¢è½®è¯¢
                                    break;
                                }
                                // å¦‚æœçŠ¶æ€æ˜¯ runningï¼Œç»§ç»­è½®è¯¢
                            } catch (e) {
                                console.warn(`è½®è¯¢å¤±è´¥ #${i + 1}:`, e);
                            }
                        }

                        // è½®è¯¢ç»“æŸä»æœªè·å–åˆ°ç»“æœ
                        if (!resolved) {
                            document.getElementById('statusLog').textContent = 'è¿æ¥æ–­å¼€ï¼Œæœªèƒ½è·å–ç»“æœã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚';
                            document.getElementById('statusBadge').textContent = 'æ–­å¼€';
                            document.getElementById('statusBadge').className = 'status-badge error';
                            document.getElementById('analyzeBtn').disabled = false;
                            reject(new Error('è¿æ¥æ–­å¼€ä¸”æœªèƒ½æ¢å¤ç»“æœ'));
                        }
                    }
                };

                // è¿æ¥è¶…æ—¶
                setTimeout(() => {
                    if (!resolved && ws.readyState !== WebSocket.OPEN) {
                        reject(new Error('è¿æ¥è¶…æ—¶'));
                    }
                }, 5000);
            });
        }

        // ä¿å­˜æœ€åä¸€æ¬¡åˆ†æç»“æœï¼ˆç”¨äºå¯¼å‡ºï¼‰
        let lastAnalysisResult = null;

        // æ¸²æŸ“çœŸå®æ•°æ®
        function renderRealData(result) {
            console.log('æ¸²æŸ“çœŸå®æ•°æ®:', result);

            // ä¿å­˜ç»“æœç”¨äºå¯¼å‡º
            lastAnalysisResult = result;

            // è½¬æ¢è§†é¢‘æ•°æ®æ ¼å¼
            let formattedVideos = [];
            if (result.videos && result.videos.length > 0) {
                const avgViews = result.total_views / result.total_videos;
                formattedVideos = result.videos.map((v, index) => ({
                    rank: index + 1,
                    title: v.title,
                    channel: v.channel_name,
                    channelId: v.channel_id,
                    views: v.view_count,
                    likes: v.like_count || 0,
                    comments: v.comment_count || 0,
                    duration: formatDuration(v.duration),
                    durationSeconds: v.duration,
                    date: v.published_at ? formatDate(v.published_at) : 'æœªçŸ¥',
                    thumbnail: v.thumbnail_url || `https://i.ytimg.com/vi/${v.youtube_id}/mqdefault.jpg`,
                    videoId: v.youtube_id,
                    isAI: v.is_ai_video,
                    aiKeyword: v.ai_keyword,
                    // æ–°å¢ï¼šè§†é¢‘å¹´é¾„å’Œæ—¥å‡æ’­æ”¾
                    videoAgeDays: v.video_age_days || 1,
                    dailyViews: v.daily_views || 0,
                    // è®¡ç®—è¯„åˆ†
                    score: v.view_count > avgViews * 3 ? 'A' : v.view_count > avgViews ? 'B' : 'C'
                }));

                // æ›´æ–°è§†é¢‘æ¦œå•
                renderVideoRanking(formattedVideos);

                // ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›å…¶ä»–åŠŸèƒ½ä½¿ç”¨
                window.currentVideoData = formattedVideos;
            }

            // ä¿å­˜è¿‘æœŸçˆ†æ¬¾å’Œé•¿é’è§†é¢‘åˆ°å…¨å±€å˜é‡
            window.recentHits = (result.recent_hits || []).map(v => ({
                title: v.title,
                channel: v.channel_name,
                channelId: v.channel_id,
                views: v.view_count,
                videoId: v.youtube_id,
                videoAgeDays: v.video_age_days,
                dailyViews: v.daily_views,
                date: v.published_at ? formatDate(v.published_at) : 'æœªçŸ¥'
            }));

            window.evergreenVideos = (result.evergreen_videos || []).map(v => ({
                title: v.title,
                channel: v.channel_name,
                channelId: v.channel_id,
                views: v.view_count,
                videoId: v.youtube_id,
                videoAgeDays: v.video_age_days,
                dailyViews: v.daily_views,
                date: v.published_at ? formatDate(v.published_at) : 'æœªçŸ¥'
            }));

            // è½¬æ¢é¢‘é“æ•°æ®æ ¼å¼ï¼ˆåŒ…å«çœŸå®æ•°æ®ï¼‰
            let formattedChannels = [];
            if (result.channels && result.channels.length > 0) {
                formattedChannels = result.channels.map(ch => ({
                    name: ch.channel_name,
                    channelId: ch.channel_id,
                    videoCount: ch.video_count,
                    avgViews: ch.avg_views,
                    totalViews: ch.total_views,
                    // çœŸå®é¢‘é“æ•°æ®
                    subscriberCount: ch.subscriber_count || 0,
                    realVideoCount: ch.real_video_count || 0,
                    totalChannelViews: ch.total_channel_views || 0,  // é¢‘é“æ€»æ’­æ”¾é‡
                    avgChannelViews: ch.avg_channel_views || 0,      // é¢‘é“å¹³å‡æ’­æ”¾é‡
                    searchHitCount: ch.search_hit_count || ch.video_count,
                    hasRealStats: ch.has_real_stats || false
                }));

                // æ›´æ–°é¢‘é“æ¦œå•
                renderChannelListFromData(formattedChannels);

                // ä¿å­˜åˆ°å…¨å±€å˜é‡
                window.currentChannelData = formattedChannels;
            }

            // æ›´æ–°æ¦‚è§ˆæ‘˜è¦
            updateOverviewSummary(result, formattedVideos, formattedChannels);

            // æ›´æ–°ä¾§è¾¹æ ç»Ÿè®¡æ•°å­—
            updateSidebarBadges(result, formattedVideos, formattedChannels);

            // æ›´æ–°æ¨¡å¼æ´å¯Ÿ
            if (result.duration_distribution) {
                updateDurationChart(result.duration_distribution, formattedVideos);
            }
            updateTimelineTrend(formattedVideos);
            updateTitlePatterns(formattedVideos);

            // æ›´æ–°åˆ†ææŠ¥å‘Š
            updateReportPanel(result, formattedVideos, formattedChannels);

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('resultsContainer').style.display = 'block';
            switchPanel('overview');
        }

        // æ›´æ–°æ¦‚è§ˆæ‘˜è¦
        function updateOverviewSummary(result, videos, channels) {
            // æ›´æ–°æ ‡é¢˜
            const titleEl = document.getElementById('overviewTitle');
            if (titleEl) titleEl.textContent = `ğŸ“Š ã€Œ${result.topic}ã€æ•°æ®æ¦‚è§ˆ`;

            // æ›´æ–°æ•°å­—
            document.getElementById('stat-videos').textContent = result.total_videos || 0;
            document.getElementById('stat-channels').textContent = result.total_channels || 0;
            document.getElementById('stat-views').textContent = formatNumber(result.total_views || 0);
            const avgViews = result.total_videos > 0 ? Math.round(result.total_views / result.total_videos) : 0;
            document.getElementById('stat-avg-views').textContent = formatNumber(avgViews);

            // æ›´æ–°å¿«é€Ÿå…¥å£æ•°å­—
            document.getElementById('quick-videos').textContent = `${result.total_videos || 0} ä¸ªè§†é¢‘`;
            document.getElementById('quick-channels').textContent = `${result.total_channels || 0} ä¸ªé¢‘é“`;

            // æ›´æ–°å…³é”®å‘ç°
            const findingsEl = document.getElementById('keyFindingsContent');
            if (findingsEl && videos.length > 0) {
                const topVideo = videos[0];
                const topChannel = channels[0];
                findingsEl.innerHTML = `
                    <p>ğŸ¬ <strong>Top è§†é¢‘</strong>ï¼šã€Œ${topVideo.title.substring(0, 30)}...ã€æ’­æ”¾é‡ ${formatNumber(topVideo.views)}</p>
                    <p>ğŸ“º <strong>Top é¢‘é“</strong>ï¼šã€Œ${topChannel?.name || '-'}ã€æ€»æ’­æ”¾ ${formatNumber(topChannel?.totalViews || 0)}</p>
                    <p>ğŸ“Š <strong>å¹³å‡æ’­æ”¾</strong>ï¼š${formatNumber(avgViews)}ï¼Œå…±åˆ†æ ${result.total_videos} ä¸ªè§†é¢‘</p>
                `;
            }

            // æ›´æ–° Top 3 è§†é¢‘é¢„è§ˆ
            const top3Videos = document.getElementById('top3VideosList');
            if (top3Videos && videos.length > 0) {
                top3Videos.innerHTML = videos.slice(0, 3).map((v, i) => `
                    <div class="ranking-item" onclick="openVideo('${v.videoId}')" style="cursor: pointer;">
                        <div class="ranking-position">${i + 1}</div>
                        <div class="video-thumb" style="background-image: url('${v.thumbnail}');"></div>
                        <div class="video-info">
                            <div class="video-title">${v.title}</div>
                            <div class="video-meta">${v.channel} Â· ${formatNumber(v.views)} æ’­æ”¾</div>
                        </div>
                        <div class="video-score score-${v.score.toLowerCase()}">${v.score}</div>
                    </div>
                `).join('');
            }

            // æ›´æ–° Top 3 é¢‘é“é¢„è§ˆ
            const top3Channels = document.getElementById('top3ChannelsList');
            if (top3Channels && channels.length > 0) {
                top3Channels.innerHTML = channels.slice(0, 3).map((ch, i) => {
                    // æ„å»ºé¢‘é“ä¿¡æ¯æ˜¾ç¤º
                    let metaInfo = '';
                    if (ch.hasRealStats && ch.realVideoCount > 0) {
                        // æœ‰çœŸå®æ•°æ®ï¼šæ˜¾ç¤ºè®¢é˜…æ•°å’Œè§†é¢‘æ€»æ•°
                        const subText = ch.subscriberCount > 0 ? `${formatNumber(ch.subscriberCount)}è®¢é˜… Â· ` : '';
                        metaInfo = `${subText}${ch.realVideoCount}ä¸ªè§†é¢‘ Â· å¹³å‡ ${formatNumber(ch.avgViews)} æ’­æ”¾`;
                    } else {
                        // æ— çœŸå®æ•°æ®ï¼šåªæ˜¾ç¤ºæœç´¢å‘½ä¸­æ•°æ®
                        metaInfo = `æœç´¢å‘½ä¸­ ${ch.searchHitCount} ä¸ª Â· å¹³å‡ ${formatNumber(ch.avgViews)} æ’­æ”¾`;
                    }
                    return `
                    <div class="ranking-item" onclick="openChannel('${ch.channelId}')" style="cursor: pointer;">
                        <div class="ranking-position">${i + 1}</div>
                        <div class="video-thumb">ğŸ“º</div>
                        <div class="video-info">
                            <div class="video-title">${ch.name}</div>
                            <div class="video-meta">${metaInfo}</div>
                        </div>
                        <div class="video-stats">
                            <span class="stat-value">${formatNumber(ch.totalViews)}</span>
                        </div>
                    </div>
                `}).join('');
            }
        }

        // æ›´æ–°ä¾§è¾¹æ  badge æ•°å­—
        function updateSidebarBadges(result, videos, channels) {
            // è§†é¢‘æ•°æ®ï¼šæ˜¾ç¤ºè§†é¢‘æ€»æ•°
            const badgeVideos = document.getElementById('badge-videos');
            if (badgeVideos) badgeVideos.textContent = result.total_videos || videos.length;

            // é¢‘é“æ•°æ®ï¼šæ˜¾ç¤ºé¢‘é“æ€»æ•°
            const badgeChannels = document.getElementById('badge-channels');
            if (badgeChannels) badgeChannels.textContent = result.total_channels || channels.length;
        }

        // ä»è§†é¢‘æ ‡é¢˜æå–è¯é¢˜å…³é”®è¯
        function extractTopics(videos) {
            const wordCount = {};
            const stopWords = ['çš„', 'æ˜¯', 'åœ¨', 'äº†', 'å’Œ', 'ä¸', 'æˆ–', 'è¿™', 'é‚£', 'æœ‰', 'ä¸º', 'ä»¥', 'åŠ', 'ç­‰', 'the', 'a', 'an', 'is', 'are', 'to', 'for', 'and', 'or', 'in', 'on', 'at'];

            videos.forEach(v => {
                // ç®€å•åˆ†è¯ï¼šæŒ‰ç©ºæ ¼å’Œæ ‡ç‚¹åˆ†å‰²
                const words = (v.title || '').split(/[\s,ï¼Œã€‚ï¼ï¼Ÿã€ï¼š:;\-\[\]ã€ã€‘()ï¼ˆï¼‰]+/).filter(w => w.length >= 2);
                words.forEach(word => {
                    const w = word.toLowerCase();
                    if (!stopWords.includes(w) && w.length <= 10) {
                        wordCount[w] = (wordCount[w] || 0) + 1;
                    }
                });
            });

            // è¿”å›å‡ºç°æ¬¡æ•°>=3çš„å…³é”®è¯
            return Object.entries(wordCount)
                .filter(([_, count]) => count >= 3)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50)
                .map(([word, count]) => ({ word, count }));
        }

        // æ›´æ–°æ—¶é•¿åˆ†å¸ƒå›¾è¡¨
        function updateDurationChart(distribution, videos) {
            const container = document.getElementById('durationChart');
            if (!container) return;

            // è®¡ç®—æ›´è¯¦ç»†çš„æ—¶é•¿åˆ†å¸ƒ
            const durationBuckets = {
                '0-1åˆ†é’Ÿ': { min: 0, max: 60, count: 0, views: 0 },
                '1-3åˆ†é’Ÿ': { min: 60, max: 180, count: 0, views: 0 },
                '3-5åˆ†é’Ÿ': { min: 180, max: 300, count: 0, views: 0 },
                '5-10åˆ†é’Ÿ': { min: 300, max: 600, count: 0, views: 0 },
                '10-20åˆ†é’Ÿ': { min: 600, max: 1200, count: 0, views: 0 },
                '20-30åˆ†é’Ÿ': { min: 1200, max: 1800, count: 0, views: 0 },
                '30åˆ†é’Ÿ+': { min: 1800, max: Infinity, count: 0, views: 0 }
            };

            videos.forEach(v => {
                const seconds = v.durationSeconds || 0;
                for (const [label, bucket] of Object.entries(durationBuckets)) {
                    if (seconds >= bucket.min && seconds < bucket.max) {
                        bucket.count++;
                        bucket.views += v.views || 0;
                        break;
                    }
                }
            });

            // æ‰¾å‡ºæœ€é«˜å¹³å‡æ’­æ”¾é‡çš„æ—¶é•¿åŒºé—´
            let maxAvgViews = 0;
            Object.values(durationBuckets).forEach(b => {
                b.avgViews = b.count > 0 ? Math.round(b.views / b.count) : 0;
                if (b.avgViews > maxAvgViews) maxAvgViews = b.avgViews;
            });

            // æ¸²æŸ“å›¾è¡¨
            container.innerHTML = Object.entries(durationBuckets).map(([label, bucket]) => {
                const widthPct = maxAvgViews > 0 ? (bucket.avgViews / maxAvgViews * 100) : 0;
                const isTop = bucket.avgViews === maxAvgViews && bucket.count > 0;
                const supplyPct = videos.length > 0 ? (bucket.count / videos.length * 100).toFixed(1) : 0;

                return `
                    <div class="time-bar-row">
                        <span class="time-label">${label}</span>
                        <div class="time-bar-container">
                            <div class="time-bar" style="width: ${widthPct}%; background: linear-gradient(90deg, ${isTop ? '#059669, #10b981' : '#0891b2, #06b6d4'});">
                                ${bucket.avgViews > 10000 ? formatNumber(bucket.avgViews) : bucket.avgViews.toLocaleString()}
                            </div>
                        </div>
                        <span class="time-meta">ä¾›ç»™ ${supplyPct}%</span>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°æ—¶é—´è¶‹åŠ¿
        function updateTimelineTrend(videos) {
            const container = document.getElementById('timelineChart');
            if (!container) return;

            // æŒ‰æœˆä»½ç»Ÿè®¡
            const monthlyData = {};
            videos.forEach(v => {
                if (v.date && v.date !== 'æœªçŸ¥') {
                    const month = v.date.slice(0, 7); // YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = { count: 0, views: 0 };
                    }
                    monthlyData[month].count++;
                    monthlyData[month].views += v.views || 0;
                }
            });

            // æ’åºå¹¶å–æœ€è¿‘6ä¸ªæœˆ
            const sortedMonths = Object.entries(monthlyData)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 6)
                .reverse();

            if (sortedMonths.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">æš‚æ— æ—¶é—´æ•°æ®</p>';
                return;
            }

            const maxViews = Math.max(...sortedMonths.map(([_, d]) => d.views));

            container.innerHTML = sortedMonths.map(([month, data]) => {
                const widthPct = maxViews > 0 ? (data.views / maxViews * 100) : 0;
                const avgViews = data.count > 0 ? Math.round(data.views / data.count) : 0;

                return `
                    <div class="time-bar-row">
                        <span class="time-label">${month}</span>
                        <div class="time-bar-container">
                            <div class="time-bar" style="width: ${widthPct}%; background: linear-gradient(90deg, #0891b2, #06b6d4);">
                                ${data.count} ä¸ªè§†é¢‘
                            </div>
                        </div>
                        <span class="time-meta">å‡æ’­ ${formatNumber(avgViews)}</span>
                    </div>
                `;
            }).join('');
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return 'æœªçŸ¥';
            // å¤„ç† YYYYMMDD æ ¼å¼
            if (dateStr.length === 8 && !dateStr.includes('-')) {
                return `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
            }
            return dateStr;
        }

        // æ„å»ºé¢‘é“ç»Ÿè®¡ä¿¡æ¯æ–‡æœ¬
        function buildChannelStatsText(ch, showDetailed = false) {
            if (ch.hasRealStats && ch.realVideoCount > 0) {
                // æœ‰çœŸå®æ•°æ®
                const subText = ch.subscriberCount > 0 ? `${formatNumber(ch.subscriberCount)}è®¢é˜… Â· ` : '';
                if (showDetailed && ch.totalChannelViews > 0) {
                    // è¯¦ç»†æ¨¡å¼ï¼šæ˜¾ç¤ºæ€»æ’­æ”¾é‡å’Œå¹³å‡æ’­æ”¾é‡
                    return `${subText}${ch.realVideoCount}ä¸ªè§†é¢‘ Â· æ€»${formatNumber(ch.totalChannelViews)}æ’­æ”¾ Â· å‡${formatNumber(ch.avgChannelViews)}`;
                }
                return `${subText}${ch.realVideoCount}ä¸ªè§†é¢‘ Â· å¹³å‡ ${formatNumber(ch.avgViews)} æ’­æ”¾`;
            } else {
                // æ— çœŸå®æ•°æ®
                return `æœç´¢å‘½ä¸­ ${ch.searchHitCount || ch.videoCount} ä¸ª Â· å¹³å‡ ${formatNumber(ch.avgViews)} æ’­æ”¾`;
            }
        }

        // ä»çœŸå®æ•°æ®æ¸²æŸ“é¢‘é“åˆ—è¡¨
        function renderChannelListFromData(channels, mode = null, titleSuffix = '') {
            // æ›´æ–°é¢‘é“åˆ†æé¢æ¿ (#channelList)
            const container = document.getElementById('channelList');
            if (container) {
                container.innerHTML = channels.slice(0, 50).map((ch, i) => `
                    <div class="channel-item" onclick="openChannel('${ch.channelId}')" style="cursor: pointer;" title="ç‚¹å‡»æ‰“å¼€é¢‘é“">
                        <div class="channel-rank">${i + 1}</div>
                        <div class="channel-avatar">${ch.name.charAt(0)}</div>
                        <div class="channel-info">
                            <div class="channel-name">${ch.name}</div>
                            <div class="channel-stats">
                                ${buildChannelStatsText(ch, true)}
                            </div>
                        </div>
                        <div class="channel-subscribers">${ch.hasRealStats && ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : formatNumber(ch.totalViews)}æ’­æ”¾</div>
                    </div>
                `).join('');
            }

            // åŒæ—¶æ›´æ–°é¢‘é“æ¦œå•é¢æ¿ (#channelRankingContainer) - è¡¨æ ¼æ ¼å¼
            const rankingContainer = document.getElementById('channelRankingContainer');
            if (rankingContainer) {
                if (channels.length === 0) {
                    const emptyConfig = {
                        darkHorse: { icon: 'ğŸ´', title: 'æš‚æ— é»‘é©¬é¢‘é“', desc: 'æœªæ‰¾åˆ°çŸ­è§†é¢‘æ¶¨ç²‰æ½œåŠ›é¢‘é“' },
                        efficiency: { icon: 'ğŸš€', title: 'æš‚æ— é«˜æ•ˆé¢‘é“', desc: 'æœªæ‰¾åˆ°é«˜å¹³å‡æ’­æ”¾çš„é¢‘é“' },
                        default: { icon: 'ğŸ“º', title: 'æš‚æ— é¢‘é“æ•°æ®', desc: 'æœç´¢å…³é”®è¯åï¼Œè¿™é‡Œå°†å±•ç¤ºé¢‘é“æ’è¡Œæ¦œ' }
                    };
                    const cfg = emptyConfig[mode] || emptyConfig.default;
                    rankingContainer.innerHTML = `
                        <div class="no-data-state">
                            <div class="no-data-icon">${cfg.icon}</div>
                            <div class="no-data-title">${cfg.title}</div>
                            <p class="no-data-desc">${cfg.desc}</p>
                        </div>
                    `;
                    return;
                }

                // è¡¨æ ¼åˆ—é…ç½®
                const tableConfig = {
                    totalViews: {
                        title: 'ğŸ“Š æ€»æ’­æ”¾æ¦œ',
                        columns: ['æ’å', 'é¢‘é“åç§°', 'è®¢é˜…æ•°', 'è§†é¢‘æ•°', 'æ€»æ’­æ”¾', 'å¹³å‡æ’­æ”¾'],
                        getValue: (ch) => [
                            ch.subscriberCount > 0 ? formatNumber(ch.subscriberCount) : '-',
                            ch.realVideoCount || '-',
                            ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : '-',
                            ch.avgChannelViews > 0 ? formatNumber(ch.avgChannelViews) : '-'
                        ],
                        highlight: 4 // é«˜äº®"æ€»æ’­æ”¾"åˆ—
                    },
                    avgViews: {
                        title: 'âš¡ å¹³å‡æ’­æ”¾æ¦œ',
                        columns: ['æ’å', 'é¢‘é“åç§°', 'è®¢é˜…æ•°', 'è§†é¢‘æ•°', 'å¹³å‡æ’­æ”¾', 'æ€»æ’­æ”¾'],
                        getValue: (ch) => [
                            ch.subscriberCount > 0 ? formatNumber(ch.subscriberCount) : '-',
                            ch.realVideoCount || '-',
                            ch.avgChannelViews > 0 ? formatNumber(ch.avgChannelViews) : '-',
                            ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : '-'
                        ],
                        highlight: 4 // é«˜äº®"å¹³å‡æ’­æ”¾"åˆ—
                    },
                    videoCount: {
                        title: 'ğŸ“¹ è§†é¢‘æ•°æ¦œ',
                        columns: ['æ’å', 'é¢‘é“åç§°', 'è®¢é˜…æ•°', 'è§†é¢‘æ•°', 'æ€»æ’­æ”¾', 'å¹³å‡æ’­æ”¾'],
                        getValue: (ch) => [
                            ch.subscriberCount > 0 ? formatNumber(ch.subscriberCount) : '-',
                            ch.realVideoCount || '-',
                            ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : '-',
                            ch.avgChannelViews > 0 ? formatNumber(ch.avgChannelViews) : '-'
                        ],
                        highlight: 3 // é«˜äº®"è§†é¢‘æ•°"åˆ—
                    },
                    darkHorse: {
                        title: 'ğŸ´ é»‘é©¬æ¦œ',
                        columns: ['æ’å', 'é¢‘é“åç§°', 'çŸ­è§†é¢‘æ•°', 'çŸ­è§†é¢‘æ’­æ”¾', 'ä¼°ç®—æ¶¨ç²‰'],
                        getValue: (ch) => [
                            ch.shortVideoCount || 0,
                            ch.shortVideoViews > 0 ? formatNumber(ch.shortVideoViews) : '-',
                            '+' + formatNumber(ch.estimatedFollowers || 0)
                        ],
                        highlight: 4 // é«˜äº®"ä¼°ç®—æ¶¨ç²‰"åˆ—
                    },
                    efficiency: {
                        title: 'ğŸš€ é«˜æ•ˆæ¦œ',
                        columns: ['æ’å', 'é¢‘é“åç§°', 'è®¢é˜…æ•°', 'è§†é¢‘æ•°', 'å¹³å‡æ’­æ”¾', 'æ€»æ’­æ”¾'],
                        getValue: (ch) => [
                            ch.subscriberCount > 0 ? formatNumber(ch.subscriberCount) : '-',
                            ch.realVideoCount || '-',
                            ch.avgChannelViews > 0 ? formatNumber(ch.avgChannelViews) : '-',
                            ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : '-'
                        ],
                        highlight: 4 // é«˜äº®"å¹³å‡æ’­æ”¾"åˆ—
                    }
                };

                const config = tableConfig[mode] || tableConfig.totalViews;

                rankingContainer.innerHTML = `
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title">
                                ${config.title}
                                <span class="ranking-count">å…± ${channels.length} ä¸ªé¢‘é“</span>
                            </span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr style="background: #0f172a; border-bottom: 2px solid #334155;">
                                        ${config.columns.map((col, idx) => `
                                            <th style="padding: 12px 16px; text-align: ${idx <= 1 ? 'left' : 'right'}; color: #94a3b8; font-weight: 500; white-space: nowrap;">
                                                ${col}
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${channels.slice(0, 50).map((ch, i) => {
                                        const values = config.getValue(ch);
                                        const hasData = ch.hasRealStats && ch.realVideoCount > 0;
                                        return `
                                            <tr onclick="openChannel('${ch.channelId}')"
                                                style="border-bottom: 1px solid #334155; cursor: pointer; transition: background 0.2s;"
                                                onmouseover="this.style.background='#334155'"
                                                onmouseout="this.style.background='transparent'">
                                                <td style="padding: 12px 16px; color: ${i < 3 ? '#f59e0b' : '#64748b'}; font-weight: ${i < 3 ? '700' : '500'};">
                                                    ${i + 1}
                                                </td>
                                                <td style="padding: 12px 16px; color: #e2e8f0; font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    ${ch.name}
                                                    ${!hasData ? '<span style="color: #64748b; font-size: 0.8em; margin-left: 6px;">(è·å–ä¸­)</span>' : ''}
                                                </td>
                                                ${values.map((val, idx) => `
                                                    <td style="padding: 12px 16px; text-align: right; color: ${idx + 2 === config.highlight ? '#06b6d4' : '#e2e8f0'}; font-weight: ${idx + 2 === config.highlight ? '600' : '400'};">
                                                        ${val}
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
        }

        // æ‰“å¼€é¢‘é“é“¾æ¥
        function openChannel(channelId) {
            if (channelId) {
                window.open(`https://www.youtube.com/channel/${channelId}`, '_blank');
            }
        }

        // é¢‘é“çœŸå®æ•°æ®ç¼“å­˜
        const channelRealDataCache = {};

        // è·å–å•ä¸ªé¢‘é“çš„çœŸå®æ•°æ®
        async function fetchChannelRealData(channelId) {
            // æ£€æŸ¥ç¼“å­˜
            if (channelRealDataCache[channelId]) {
                return channelRealDataCache[channelId];
            }

            try {
                const response = await fetch(`http://localhost:8000/api/channel/${channelId}`);
                if (!response.ok) {
                    throw new Error('è·å–å¤±è´¥');
                }
                const data = await response.json();
                // ç¼“å­˜ç»“æœ
                channelRealDataCache[channelId] = data;
                return data;
            } catch (error) {
                console.error('è·å–é¢‘é“æ•°æ®å¤±è´¥:', error);
                return null;
            }
        }

        // æ˜¾ç¤ºé¢‘é“è¯¦æƒ…å¼¹çª—
        async function showChannelDetail(channelId, channelName, event) {
            event.stopPropagation(); // é˜»æ­¢è§¦å‘ openChannel

            // æ‰¾åˆ°å¯¹åº”çš„ ranking-item
            const btn = event.target;
            const item = btn.closest('.ranking-item');
            if (!item) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.textContent = 'â³ åŠ è½½ä¸­...';
            btn.disabled = true;

            const data = await fetchChannelRealData(channelId);

            if (data) {
                // æ›´æ–°æ˜¾ç¤º - åœ¨ video-meta ä¸­è¿½åŠ çœŸå®æ•°æ®
                const metaEl = item.querySelector('.video-meta');
                if (metaEl) {
                    // åˆ›å»ºçœŸå®æ•°æ®å±•ç¤ºè¡Œ
                    const realDataHtml = `
                        <div class="channel-real-data" style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed rgba(255,255,255,0.1);">
                            <span style="color: #10b981;">âœ… çœŸå®æ•°æ®</span>
                            <span>è®¢é˜… <strong style="color: #f59e0b;">${formatNumber(data.subscriber_count)}</strong></span>
                            <span>å…± <strong>${data.video_count}</strong> ä¸ªè§†é¢‘</span>
                        </div>
                    `;
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡
                    if (!metaEl.querySelector('.channel-real-data')) {
                        metaEl.insertAdjacentHTML('beforeend', realDataHtml);
                    }
                }
                btn.textContent = 'âœ… å·²åŠ è½½';
                btn.style.background = 'rgba(16, 185, 129, 0.2)';
                btn.style.color = '#10b981';
            } else {
                btn.textContent = 'âŒ å¤±è´¥';
                btn.style.background = 'rgba(239, 68, 68, 0.2)';
                btn.style.color = '#ef4444';
                setTimeout(() => {
                    btn.textContent = 'ğŸ“Š é‡è¯•';
                    btn.disabled = false;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }
        }

        // æ‰¹é‡è·å–é¢‘é“çœŸå®æ•°æ®ï¼ˆç”¨äºæ¦œå•ï¼‰
        async function fetchChannelsBatch(channelIds) {
            // è¿‡æ»¤æ‰å·²ç¼“å­˜çš„
            const uncachedIds = channelIds.filter(id => !channelRealDataCache[id]);
            if (uncachedIds.length === 0) {
                return channelIds.map(id => channelRealDataCache[id]);
            }

            try {
                const response = await fetch('http://localhost:8000/api/channels/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(uncachedIds.slice(0, 10)) // æœ€å¤š10ä¸ª
                });
                if (!response.ok) throw new Error('æ‰¹é‡è·å–å¤±è´¥');

                const result = await response.json();
                // ç¼“å­˜ç»“æœ
                for (const [id, data] of Object.entries(result.channels)) {
                    if (data.success) {
                        channelRealDataCache[id] = data;
                    }
                }
            } catch (error) {
                console.error('æ‰¹é‡è·å–é¢‘é“æ•°æ®å¤±è´¥:', error);
            }

            return channelIds.map(id => channelRealDataCache[id] || null);
        }

        // æ›´æ–°æ´å¯Ÿé¢æ¿
        function updateInsights(result) {
            const container = document.getElementById('panel-overview');
            if (!container) return;

            const insights = result.insights;
            const summary = insights.market_summary || {};

            // æ„å»ºæ´å¯Ÿå¡ç‰‡
            let opportunitiesHtml = '';
            if (insights.opportunities && insights.opportunities.length > 0) {
                opportunitiesHtml = insights.opportunities.map(opp => `
                    <div class="insight-card">
                        <div class="insight-badge ${opp.score === 'A' ? 'high' : 'medium'}">${opp.score}</div>
                        <div class="insight-content">
                            <div class="insight-title">${opp.title}</div>
                            <div class="insight-desc">${opp.description}</div>
                        </div>
                    </div>
                `).join('');
            }

            // AI è§†é¢‘ç»Ÿè®¡
            const aiCount = result.ai_video_count || 0;
            const aiPct = result.total_videos > 0 ? ((aiCount / result.total_videos) * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="overview-header">
                    <div class="overview-title-row">
                        <h2>ã€Œ${result.topic}ã€å¸‚åœºåˆ†æ</h2>
                        <div class="export-buttons">
                            <button class="export-btn" onclick="exportData('csv')" title="å¯¼å‡ºCSVæ ¼å¼">
                                ğŸ“Š å¯¼å‡º CSV
                            </button>
                            <button class="export-btn" onclick="exportData('json')" title="å¯¼å‡ºJSONæ ¼å¼">
                                ğŸ“ å¯¼å‡º JSON
                            </button>
                        </div>
                    </div>
                    <div class="overview-stats">
                        <div class="stat-item">
                            <div class="stat-value">${formatNumber(result.total_videos)}</div>
                            <div class="stat-label">è§†é¢‘æ•°é‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${formatNumber(result.total_views)}</div>
                            <div class="stat-label">æ€»æ’­æ”¾é‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${result.total_channels}</div>
                            <div class="stat-label">é¢‘é“æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${aiCount} (${aiPct}%)</div>
                            <div class="stat-label">AIè§†é¢‘</div>
                        </div>
                    </div>
                </div>

                <div class="insights-section">
                    <h3>å‘ç°çš„æœºä¼š</h3>
                    ${opportunitiesHtml || '<p class="no-data">æš‚æ— æ˜æ˜¾æœºä¼š</p>'}
                </div>

                ${insights.top_performing ? `
                <div class="top-video-section">
                    <h3>æœ€ä½³è¡¨ç°è§†é¢‘</h3>
                    <div class="top-video-card">
                        <div class="top-video-title">${insights.top_performing.title}</div>
                        <div class="top-video-meta">
                            ${insights.top_performing.channel} Â· ${formatNumber(insights.top_performing.views)} æ’­æ”¾
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        // é¢‘é“è¯Šæ–­
        async function startDiagnose() {
            const input = document.getElementById('diagnoseInput').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥é¢‘é“é“¾æ¥æˆ–åç§°');
                return;
            }

            // éšè—å…¶ä»–å†…å®¹
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';

            // æ˜¾ç¤ºåˆ†æçŠ¶æ€
            document.getElementById('analysisStatus').classList.add('show');
            document.getElementById('statusTitle').textContent = `æ­£åœ¨è¯Šæ–­é¢‘é“...`;
            document.getElementById('statusBadge').textContent = 'åˆ†æä¸­';
            document.getElementById('statusBadge').className = 'status-badge running';
            document.getElementById('progressFill').className = 'progress-fill';

            const steps = [
                { progress: 20, log: 'æ­£åœ¨è·å–é¢‘é“ä¿¡æ¯...' },
                { progress: 40, log: 'æ­£åœ¨åˆ†æè§†é¢‘æ•°æ®...' },
                { progress: 60, log: 'æ­£åœ¨å¯¹æ¯”åŒç±»é¢‘é“...' },
                { progress: 80, log: 'æ­£åœ¨åŒ¹é…å¯¹æ ‡è´¦å·...' },
                { progress: 100, log: 'è¯Šæ–­å®Œæˆï¼' },
            ];

            for (const step of steps) {
                await new Promise(r => setTimeout(r, 500));
                document.getElementById('progressFill').style.width = step.progress + '%';
                document.getElementById('statusLog').textContent = step.log;
            }

            document.getElementById('statusBadge').textContent = 'å®Œæˆ';
            document.getElementById('statusBadge').className = 'status-badge done';
            document.getElementById('progressFill').className = 'progress-fill done';

            await new Promise(r => setTimeout(r, 300));
            document.getElementById('analysisStatus').classList.remove('show');

            // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
            document.getElementById('diagnoseChannelName').textContent = input.includes('@') ? input : 'æˆ‘çš„å…»ç”Ÿé¢‘é“';
            renderRecommendList();
            document.getElementById('diagnoseResult').classList.add('show');
        }

        let videoLimit = 50;
        function loadMoreVideos() {
            videoLimit += 50;
            const data = window.currentVideoData || [];
            renderVideoRanking(data, videoLimit);
        }

        // å½“å‰è§†é¢‘æ ‡ç­¾çŠ¶æ€
        let currentVideoTab = 'hot';
        let currentVideoTimeFilter = 0; // 0=å…¨éƒ¨, 1=24å°æ—¶, 7=7å¤©, 30=30å¤©, 90=90å¤©

        // è®¾ç½®æ—¶é—´ç­›é€‰
        function setVideoTimeFilter(days) {
            currentVideoTimeFilter = days;
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('#videoTimeFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // é‡æ–°åº”ç”¨å½“å‰æ ‡ç­¾çš„ç­›é€‰
            applyVideoFilters();
        }

        // åº”ç”¨è§†é¢‘ç­›é€‰ï¼ˆç»“åˆæ ‡ç­¾å’Œæ—¶é—´ç­›é€‰ï¼‰
        function applyVideoFilters() {
            const data = window.currentVideoData || [];
            if (!data || data.length === 0) return;

            let sortedData = [...data];
            let titleText = '';
            const now = new Date();

            // å…ˆåº”ç”¨æ—¶é—´ç­›é€‰ï¼ˆå¦‚æœä¸æ˜¯"å…¨éƒ¨"ï¼‰
            if (currentVideoTimeFilter > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - currentVideoTimeFilter);
                sortedData = sortedData.filter(v => {
                    if (!v.date || v.date === 'æœªçŸ¥') return false;
                    const videoDate = new Date(v.date);
                    return !isNaN(videoDate.getTime()) && videoDate >= cutoffDate;
                });
            }

            // ç„¶ååº”ç”¨æ ‡ç­¾ç­›é€‰
            switch (currentVideoTab) {
                case 'hot':
                    // ğŸ”¥ çˆ†æ¬¾è§†é¢‘ï¼šæŒ‰æ’­æ”¾é‡é™åº
                    sortedData.sort((a, b) => b.views - a.views);
                    titleText = 'ğŸ”¥ çˆ†æ¬¾è§†é¢‘ Top 100';
                    break;
                case 'potential':
                    // ğŸ“ˆ æ½œåŠ›è§†é¢‘ï¼šæŒ‰æ’­æ”¾æ•ˆç‡æ’åº
                    const avgViewsPotential = sortedData.reduce((sum, v) => sum + v.views, 0) / sortedData.length || 1;
                    sortedData = sortedData.filter(v => v.views >= avgViewsPotential * 0.1 && v.views <= avgViewsPotential * 2);
                    sortedData.sort((a, b) => {
                        const durationA = a.durationSeconds || parseDuration(a.duration) || 60;
                        const durationB = b.durationSeconds || parseDuration(b.duration) || 60;
                        const efficiencyA = a.views / Math.sqrt(durationA);
                        const efficiencyB = b.views / Math.sqrt(durationB);
                        return efficiencyB - efficiencyA;
                    });
                    titleText = 'ğŸ“ˆ æ½œåŠ›è§†é¢‘ Top 100';
                    break;
                case 'recent':
                    // ğŸ†• è¿‘æœŸçƒ­é—¨ï¼šæŒ‰æ—¥å‡æ’­æ”¾é‡æ’åºï¼ˆæ—¶é—´ç­›é€‰å·²åœ¨ä¸Šé¢åº”ç”¨ï¼‰
                    // å¦‚æœæ²¡æœ‰é€‰æ—¶é—´ç­›é€‰ï¼Œé»˜è®¤ç­›é€‰30å¤©
                    if (currentVideoTimeFilter === 0) {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        sortedData = sortedData.filter(v => {
                            if (!v.date || v.date === 'æœªçŸ¥') return false;
                            const videoDate = new Date(v.date);
                            return !isNaN(videoDate.getTime()) && videoDate >= thirtyDaysAgo;
                        });
                    }
                    // æŒ‰æ—¥å‡æ’­æ”¾é‡æ’åº
                    sortedData.sort((a, b) => {
                        const daysA = Math.max(1, (now - new Date(a.date)) / (1000 * 60 * 60 * 24));
                        const daysB = Math.max(1, (now - new Date(b.date)) / (1000 * 60 * 60 * 24));
                        return (b.views / daysB) - (a.views / daysA);
                    });
                    titleText = 'ğŸ†• è¿‘æœŸçƒ­é—¨ Top 100';
                    break;
                case 'longform':
                    // â±ï¸ é•¿è§†é¢‘æ¦œï¼šæ—¶é•¿ >= 3åˆ†é’Ÿ
                    sortedData = sortedData.filter(v => {
                        const seconds = v.durationSeconds || parseDuration(v.duration);
                        return seconds >= 180;
                    });
                    sortedData.sort((a, b) => b.views - a.views);
                    titleText = 'â±ï¸ é•¿è§†é¢‘æ¦œ Top 100';
                    break;
                case 'recentHits':
                    // âš¡ è¿‘æœŸçˆ†æ¬¾ï¼š30å¤©å†…å‘å¸ƒï¼Œæ’­æ”¾é‡>=10ä¸‡ï¼ˆä½¿ç”¨åç«¯è®¡ç®—çš„æ•°æ®ï¼‰
                    if (window.recentHits && window.recentHits.length > 0) {
                        sortedData = window.recentHits.map((v, i) => ({
                            rank: i + 1,
                            title: v.title,
                            channel: v.channel,
                            channelId: v.channelId,
                            views: v.views,
                            videoId: v.videoId,
                            date: v.date,
                            videoAgeDays: v.videoAgeDays,
                            dailyViews: v.dailyViews,
                            thumbnail: `https://i.ytimg.com/vi/${v.videoId}/mqdefault.jpg`,
                            score: v.views > 500000 ? 'A' : v.views > 200000 ? 'B' : 'C'
                        }));
                    } else {
                        // å¦‚æœåç«¯æ²¡æœ‰è¿”å›æ•°æ®ï¼Œä»å‰ç«¯æ•°æ®ä¸­ç­›é€‰
                        sortedData = sortedData.filter(v => v.videoAgeDays <= 30 && v.views >= 100000);
                        sortedData.sort((a, b) => b.views - a.views);
                    }
                    titleText = 'âš¡ è¿‘æœŸçˆ†æ¬¾ Top 50ï¼ˆ30å¤©å†…ï¼Œâ‰¥10ä¸‡æ’­æ”¾ï¼‰';
                    break;
                case 'evergreen':
                    // ğŸŒ² é•¿é’è§†é¢‘ï¼š>180å¤©ä½†æ—¥å‡æ’­æ”¾>=1000
                    if (window.evergreenVideos && window.evergreenVideos.length > 0) {
                        sortedData = window.evergreenVideos.map((v, i) => ({
                            rank: i + 1,
                            title: v.title,
                            channel: v.channel,
                            channelId: v.channelId,
                            views: v.views,
                            videoId: v.videoId,
                            date: v.date,
                            videoAgeDays: v.videoAgeDays,
                            dailyViews: v.dailyViews,
                            thumbnail: `https://i.ytimg.com/vi/${v.videoId}/mqdefault.jpg`,
                            score: v.dailyViews > 5000 ? 'A' : v.dailyViews > 2000 ? 'B' : 'C'
                        }));
                    } else {
                        // ä»å‰ç«¯æ•°æ®ä¸­ç­›é€‰
                        sortedData = sortedData.filter(v => v.videoAgeDays > 180 && v.dailyViews >= 1000);
                        sortedData.sort((a, b) => b.dailyViews - a.dailyViews);
                    }
                    titleText = 'ğŸŒ² é•¿é’è§†é¢‘ Top 50ï¼ˆ>180å¤©ï¼Œæ—¥å‡â‰¥1000æ’­æ”¾ï¼‰';
                    break;
            }

            // æ·»åŠ æ—¶é—´ç­›é€‰æ ‡è¯†åˆ°æ ‡é¢˜
            const timeLabels = { 0: '', 1: 'ï¼ˆè¿‘24å°æ—¶ï¼‰', 7: 'ï¼ˆè¿‘7å¤©ï¼‰', 30: 'ï¼ˆè¿‘30å¤©ï¼‰', 90: 'ï¼ˆè¿‘90å¤©ï¼‰' };
            if (currentVideoTimeFilter > 0 && currentVideoTab !== 'recent') {
                titleText = titleText.replace(' Top 100', timeLabels[currentVideoTimeFilter] + ' Top 100');
            }

            // é‡æ–°ç¼–æ’æ’å
            sortedData.forEach((v, i) => v.rank = i + 1);

            // æ›´æ–°æ ‡é¢˜
            const titleEl = document.querySelector('#panel-videos .ranking-title');
            if (titleEl) {
                titleEl.innerHTML = `${titleText} <span class="ranking-count">å…± ${sortedData.length} ä¸ª</span>`;
            }

            // æ¸²æŸ“æ•°æ®
            renderVideoRanking(sortedData);
        }

        function switchVideoTab(tab) {
            document.querySelectorAll('#panel-videos .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentVideoTab = tab;
            // è°ƒç”¨ç»Ÿä¸€çš„ç­›é€‰å‡½æ•°
            applyVideoFilters();
        }

        // è§£ææ—¶é•¿å­—ç¬¦ä¸²ä¸ºç§’æ•°
        function parseDuration(durationStr) {
            if (!durationStr) return 0;
            if (typeof durationStr === 'number') return durationStr;
            // æ”¯æŒ "12åˆ†é’Ÿ" æˆ– "12:34" æ ¼å¼
            const minMatch = durationStr.match(/(\d+)åˆ†é’Ÿ/);
            if (minMatch) return parseInt(minMatch[1]) * 60;
            const colonMatch = durationStr.match(/(\d+):(\d+)/);
            if (colonMatch) return parseInt(colonMatch[1]) * 60 + parseInt(colonMatch[2]);
            return 0;
        }

        // è§†é¢‘åˆ†ææ ‡ç­¾åˆ‡æ¢
        let currentVideoAnalysisTab = 'hot';

        function switchVideoAnalysisTab(tab) {
            document.querySelectorAll('#panel-video-analysis .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentVideoAnalysisTab = tab;

            const data = window.currentVideoData;
            if (!data || data.length === 0) return;

            let filteredData = [...data];
            let titleText = '';
            let description = '';

            switch (tab) {
                case 'hot':
                    // ğŸ”¥ çˆ†æ¬¾åˆ†æï¼šæ’­æ”¾é‡ > å¹³å‡å€¼çš„3å€
                    const avgViews = data.reduce((sum, v) => sum + v.views, 0) / data.length;
                    filteredData = data.filter(v => v.views > avgViews * 3);
                    filteredData.sort((a, b) => b.views - a.views);
                    titleText = 'ğŸ”¥ çˆ†æ¬¾åˆ†æ';
                    description = `æ’­æ”¾é‡è¶…è¿‡å¹³å‡å€¼3å€ï¼ˆ>${formatNumber(avgViews * 3)}ï¼‰çš„è§†é¢‘`;
                    break;
                case 'potential':
                    // ğŸ“ˆ æ½œåŠ›è§†é¢‘ï¼šäº’åŠ¨ç‡é«˜ä½†æ’­æ”¾é‡ä¸­ç­‰
                    const medianViews = data.sort((a, b) => a.views - b.views)[Math.floor(data.length / 2)].views;
                    filteredData = data.filter(v => {
                        const engagementRate = (v.likes || 0) / (v.views || 1);
                        return v.views < medianViews * 2 && v.views > medianViews * 0.3 && engagementRate > 0.03;
                    });
                    filteredData.sort((a, b) => {
                        const rateA = (a.likes || 0) / (a.views || 1);
                        const rateB = (b.likes || 0) / (b.views || 1);
                        return rateB - rateA;
                    });
                    titleText = 'ğŸ“ˆ æ½œåŠ›è§†é¢‘';
                    description = 'æ’­æ”¾é‡ä¸­ç­‰ä½†äº’åŠ¨ç‡>3%çš„è§†é¢‘ï¼Œæœ‰çˆ†å‘æ½œåŠ›';
                    break;
                case 'viral':
                    // ğŸš€ ç—…æ¯’ä¼ æ’­ï¼šå‘å¸ƒæ—¶é—´çŸ­ä½†æ’­æ”¾é‡é«˜ï¼ˆæ—¥å‡æ’­æ”¾é«˜ï¼‰
                    const now = new Date();
                    filteredData = data.map(v => {
                        const pubDate = new Date(v.date);
                        const daysSincePublish = Math.max(1, (now - pubDate) / (1000 * 60 * 60 * 24));
                        return { ...v, dailyViews: v.views / daysSincePublish };
                    }).filter(v => v.dailyViews > 1000); // æ—¥å‡æ’­æ”¾ > 1000
                    filteredData.sort((a, b) => b.dailyViews - a.dailyViews);
                    titleText = 'ğŸš€ ç—…æ¯’ä¼ æ’­';
                    description = 'æ—¥å‡æ’­æ”¾é‡>1000çš„è§†é¢‘ï¼Œä¼ æ’­é€Ÿåº¦å¿«';
                    break;
                case 'benchmark':
                    // ğŸ¯ å¯¹æ ‡è§†é¢‘ï¼šç»¼åˆè¯„åˆ†é«˜ï¼ˆæ’­æ”¾+äº’åŠ¨+æ—¶é•¿å¹³è¡¡ï¼‰
                    filteredData = data.map(v => {
                        const viewScore = Math.min(v.views / 100000, 10); // 10ä¸‡æ’­æ”¾=10åˆ†
                        const engageScore = ((v.likes || 0) / (v.views || 1)) * 200; // 5%äº’åŠ¨ç‡=10åˆ†
                        const durationScore = Math.min((v.durationSeconds || 300) / 60, 10); // 10åˆ†é’Ÿ=10åˆ†
                        return { ...v, benchmarkScore: viewScore + engageScore + durationScore };
                    });
                    filteredData.sort((a, b) => b.benchmarkScore - a.benchmarkScore);
                    titleText = 'ğŸ¯ å¯¹æ ‡è§†é¢‘';
                    description = 'ç»¼åˆè¯„åˆ†é«˜çš„è§†é¢‘ï¼Œé€‚åˆä½œä¸ºå†…å®¹å‚è€ƒ';
                    break;
            }

            // é‡æ–°ç¼–æ’æ’å
            filteredData.forEach((v, i) => v.rank = i + 1);

            // æ¸²æŸ“è§†é¢‘åˆ†æåˆ—è¡¨
            renderVideoAnalysisList(filteredData, titleText, description);
        }

        // æ¸²æŸ“è§†é¢‘åˆ†æåˆ—è¡¨
        function renderVideoAnalysisList(data, title, description) {
            const container = document.getElementById('videoAnalysisList');
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">ğŸ”</div>
                        <div class="no-data-title">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è§†é¢‘</div>
                        <p class="no-data-desc">${description}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="ai-insight" style="margin-bottom: 16px;">
                    <div class="ai-content">
                        <p><strong>${title}</strong>ï¼š${description}</p>
                        <p>å…±æ‰¾åˆ° <strong>${data.length}</strong> ä¸ªç¬¦åˆæ¡ä»¶çš„è§†é¢‘</p>
                    </div>
                </div>
                <div class="ranking-list">
                    ${data.slice(0, 50).map(v => `
                        <div class="ranking-item" onclick="openVideo('${v.videoId}')" style="cursor: pointer;">
                            <div class="rank-number ${v.rank <= 3 ? 'rank-' + v.rank : 'rank-normal'}">${v.rank}</div>
                            <div class="rank-thumb">ğŸ¬</div>
                            <div class="rank-info">
                                <div class="rank-title">${v.title}</div>
                                <div class="rank-meta">
                                    <span>${v.channel}</span>
                                    <span>${v.duration}</span>
                                    <span>${v.date}</span>
                                    ${v.dailyViews ? `<span>æ—¥å‡${formatNumber(Math.round(v.dailyViews))}</span>` : ''}
                                    ${v.benchmarkScore ? `<span>è¯„åˆ†${v.benchmarkScore.toFixed(1)}</span>` : ''}
                                </div>
                            </div>
                            <div class="rank-stats">
                                <div class="rank-stat">
                                    <div class="rank-stat-value">${formatNumber(v.views)}</div>
                                    <div class="rank-stat-label">æ’­æ”¾</div>
                                </div>
                                <div class="rank-stat">
                                    <div class="rank-stat-value">${((v.likes || 0) / (v.views || 1) * 100).toFixed(1)}%</div>
                                    <div class="rank-stat-label">äº’åŠ¨ç‡</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // å½“å‰é¢‘é“æ ‡ç­¾çŠ¶æ€
        let currentChannelTab = 'totalViews';

        function switchChannelTab(tab) {
            document.querySelectorAll('#panel-channels .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentChannelTab = tab;

            const channelData = window.currentChannelData;
            const videoData = window.currentVideoData;
            if (!channelData || channelData.length === 0) return;

            let sortedData = [...channelData];
            let titleSuffix = '';

            switch (tab) {
                case 'totalViews':
                    sortedData.sort((a, b) => (b.totalViews || 0) - (a.totalViews || 0));
                    break;
                case 'avgViews':
                    sortedData.sort((a, b) => (b.avgViews || 0) - (a.avgViews || 0));
                    break;
                case 'videoCount':
                    sortedData.sort((a, b) => (b.videoCount || 0) - (a.videoCount || 0));
                    break;
                case 'darkHorse':
                    // ğŸ´ é»‘é©¬æ¦œï¼šçŸ­è§†é¢‘ï¼ˆ<60ç§’ï¼‰æ¶¨ç²‰æ½œåŠ›é¢‘é“
                    // ç­›é€‰æ¡ä»¶ï¼šæœ‰çŸ­è§†é¢‘ä¸”ä¼°ç®—æ¶¨ç²‰>1000
                    // æ¶¨ç²‰ä¼°ç®—å…¬å¼ï¼šçŸ­è§†é¢‘æ€»æ’­æ”¾é‡ * 0.002ï¼ˆå‡è®¾0.2%è½¬åŒ–ç‡ï¼‰
                    if (videoData && videoData.length > 0) {
                        // ç»Ÿè®¡æ¯ä¸ªé¢‘é“çš„çŸ­è§†é¢‘æ•°æ®
                        const channelShortStats = {};
                        videoData.forEach(v => {
                            const seconds = v.durationSeconds || 0;
                            if (seconds > 0 && seconds <= 60) { // çŸ­è§†é¢‘å®šä¹‰ï¼š<=60ç§’
                                const chId = v.channelId;
                                if (!channelShortStats[chId]) {
                                    channelShortStats[chId] = {
                                        shortVideoCount: 0,
                                        shortVideoViews: 0,
                                        channelName: v.channel
                                    };
                                }
                                channelShortStats[chId].shortVideoCount++;
                                channelShortStats[chId].shortVideoViews += v.views || 0;
                            }
                        });

                        // è®¡ç®—æ¶¨ç²‰ä¼°ç®—å¹¶ç­›é€‰
                        sortedData = channelData
                            .map(ch => {
                                const stats = channelShortStats[ch.channelId] || { shortVideoCount: 0, shortVideoViews: 0 };
                                const estimatedFollowers = Math.round(stats.shortVideoViews * 0.002); // 0.2%è½¬åŒ–ç‡
                                return {
                                    ...ch,
                                    shortVideoCount: stats.shortVideoCount,
                                    shortVideoViews: stats.shortVideoViews,
                                    estimatedFollowers: estimatedFollowers
                                };
                            })
                            .filter(ch => ch.shortVideoCount > 0 && ch.estimatedFollowers >= 1000)
                            .sort((a, b) => b.estimatedFollowers - a.estimatedFollowers);

                        titleSuffix = ` (çŸ­è§†é¢‘æ¶¨ç²‰â‰¥1000)`;
                    } else {
                        sortedData = [];
                    }
                    break;
                case 'efficiency':
                    // ğŸš€ é«˜æ•ˆæ¦œï¼šæŒ‰æœç´¢ç»“æœä¸­çš„å¹³å‡æ’­æ”¾é‡æ’åº
                    // åæ˜ è¯¥é¢‘é“åœ¨æ­¤é¢†åŸŸçš„è§†é¢‘è¡¨ç°
                    sortedData = channelData
                        .filter(ch => (ch.avgViews || 0) >= 50000) // å¹³å‡æ’­æ”¾â‰¥5ä¸‡
                        .sort((a, b) => (b.avgViews || 0) - (a.avgViews || 0));

                    titleSuffix = ` (æœç´¢ç»“æœä¸­å¹³å‡æ’­æ”¾â‰¥5ä¸‡)`;
                    break;
            }

            const modeMap = { darkHorse: 'darkHorse', efficiency: 'efficiency' };
            renderChannelListFromData(sortedData, modeMap[tab] || null, titleSuffix);
        }

        let channelLimit = 50;
        function loadMoreChannels() {
            channelLimit += 50;
            const data = window.currentChannelData;
            if (data) {
                renderChannelListFromData(data.slice(0, channelLimit));
            }
        }

        // é¢‘é“åˆ†ææ ‡ç­¾åˆ‡æ¢
        let currentChannelAnalysisTab = 'worthy';

        function switchChannelAnalysisTab(tab) {
            document.querySelectorAll('#panel-channels .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentChannelAnalysisTab = tab;

            const data = window.currentChannelData;
            if (!data || data.length === 0) return;

            let filteredData = [...data];
            let titleText = '';
            let description = '';

            switch (tab) {
                case 'worthy':
                    // â­ å€¼å¾—ç ”ç©¶ï¼šç»¼åˆè¡¨ç°å¥½ï¼ˆè§†é¢‘å¤š+æ’­æ”¾é«˜ï¼‰
                    filteredData = data.filter(ch => ch.videoCount >= 5 && ch.avgViews >= 10000);
                    filteredData.sort((a, b) => {
                        const scoreA = (a.avgViews || 0) * Math.log10(a.videoCount || 1);
                        const scoreB = (b.avgViews || 0) * Math.log10(b.videoCount || 1);
                        return scoreB - scoreA;
                    });
                    titleText = 'â­ å€¼å¾—ç ”ç©¶';
                    description = 'è§†é¢‘æ•°â‰¥5ä¸”å¹³å‡æ’­æ”¾â‰¥1ä¸‡çš„ä¼˜è´¨é¢‘é“';
                    break;
                case 'growing':
                    // ğŸ“ˆ å¿«é€Ÿæˆé•¿ï¼šè§†é¢‘å°‘ä½†æ’­æ”¾é«˜ï¼ˆæ–°é¢‘é“æ½œåŠ›å¤§ï¼‰
                    filteredData = data.filter(ch => ch.videoCount <= 20 && ch.avgViews >= 20000);
                    filteredData.sort((a, b) => (b.avgViews || 0) - (a.avgViews || 0));
                    titleText = 'ğŸ“ˆ å¿«é€Ÿæˆé•¿';
                    description = 'è§†é¢‘æ•°â‰¤20ä½†å¹³å‡æ’­æ”¾â‰¥2ä¸‡çš„æ–°å…´é¢‘é“';
                    break;
                case 'leader':
                    // ğŸ¯ ç»†åˆ†é¾™å¤´ï¼šè§†é¢‘å¤š+æ€»æ’­æ”¾é«˜
                    filteredData = data.filter(ch => ch.videoCount >= 10);
                    filteredData.sort((a, b) => (b.totalViews || 0) - (a.totalViews || 0));
                    titleText = 'ğŸ¯ ç»†åˆ†é¾™å¤´';
                    description = 'è§†é¢‘æ•°â‰¥10çš„å¤´éƒ¨é¢‘é“ï¼ŒæŒ‰æ€»æ’­æ”¾é‡æ’åº';
                    break;
                case 'emerging':
                    // ğŸ†• æ–°å…´é¢‘é“ï¼šè§†é¢‘å°‘ï¼ˆâ‰¤10ï¼‰ä½†æœ‰ä¸€å®šæ’­æ”¾
                    filteredData = data.filter(ch => ch.videoCount <= 10 && ch.avgViews >= 5000);
                    filteredData.sort((a, b) => (b.avgViews || 0) - (a.avgViews || 0));
                    titleText = 'ğŸ†• æ–°å…´é¢‘é“';
                    description = 'è§†é¢‘æ•°â‰¤10çš„æ–°é¢‘é“ï¼Œæœ‰å‘å±•æ½œåŠ›';
                    break;
            }

            // æ¸²æŸ“é¢‘é“åˆ†æåˆ—è¡¨
            renderChannelAnalysisList(filteredData, titleText, description);
        }

        // æ¸²æŸ“é¢‘é“åˆ†æåˆ—è¡¨
        function renderChannelAnalysisList(data, title, description) {
            const container = document.getElementById('channelList');
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">ğŸ“º</div>
                        <div class="no-data-title">æš‚æ— ç¬¦åˆæ¡ä»¶çš„é¢‘é“</div>
                        <p class="no-data-desc">${description}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="ai-insight" style="margin-bottom: 16px;">
                    <div class="ai-content">
                        <p><strong>${title}</strong>ï¼š${description}</p>
                        <p>å…±æ‰¾åˆ° <strong>${data.length}</strong> ä¸ªç¬¦åˆæ¡ä»¶çš„é¢‘é“</p>
                    </div>
                </div>
                ${data.slice(0, 30).map((ch, i) => `
                    <div class="channel-card">
                        <div class="channel-header">
                            <div class="channel-avatar">${ch.name ? ch.name[0] : '?'}</div>
                            <div class="channel-info">
                                <div class="channel-name">${ch.name || 'æœªçŸ¥é¢‘é“'}</div>
                                <div class="channel-meta">
                                    ${ch.videoCount || 0} ä¸ªè§†é¢‘ Â·
                                    å‡æ’­ ${formatNumber(ch.avgViews || 0)} Â·
                                    æ€»æ’­æ”¾ ${formatNumber(ch.totalViews || 0)}
                                </div>
                            </div>
                            <div class="channel-stats">
                                <div class="channel-stat">
                                    <div class="channel-stat-value">${formatNumber(ch.avgViews || 0)}</div>
                                    <div class="channel-stat-label">å‡æ’­</div>
                                </div>
                                <div class="channel-stat">
                                    <div class="channel-stat-value">${ch.videoCount || 0}</div>
                                    <div class="channel-stat-label">è§†é¢‘</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function toggleVideoAnalysis(index) {
            const el = document.getElementById(`video-analysis-${index}`);
            if (el) {
                el.classList.toggle('open');
            }
        }

        // è¯é¢˜æœºä¼šæ ‡ç­¾åˆ‡æ¢
        let currentTopicTab = 'opportunity';

        function switchTopicTab(tab) {
            document.querySelectorAll('#panel-topics .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentTopicTab = tab;

            const data = window.currentVideoData;
            if (!data || data.length === 0) return;

            // ä»è§†é¢‘æ ‡é¢˜ä¸­æå–è¯é¢˜å…³é”®è¯
            const topicStats = extractTopicStats(data);
            let filteredTopics = [...topicStats];
            let titleText = '';
            let description = '';

            switch (tab) {
                case 'opportunity':
                    // ğŸ¯ é«˜æœºä¼šè¯é¢˜ï¼šéœ€æ±‚é«˜ï¼ˆå‡ºç°å¤šï¼‰ä½†ç«äº‰ä½ï¼ˆå¹³å‡æ’­æ”¾é«˜ï¼‰
                    filteredTopics = topicStats.filter(t => t.count >= 3 && t.avgViews >= 50000);
                    filteredTopics.sort((a, b) => (b.avgViews * Math.log10(b.count)) - (a.avgViews * Math.log10(a.count)));
                    titleText = 'ğŸ¯ é«˜æœºä¼šè¯é¢˜';
                    description = 'å‡ºç°â‰¥3æ¬¡ä¸”å¹³å‡æ’­æ”¾â‰¥5ä¸‡çš„è¯é¢˜ï¼Œéœ€æ±‚å¤§ç«äº‰å°';
                    break;
                case 'bridge':
                    // ğŸ”— æ¡¥æ¢è¯é¢˜ï¼šè¿æ¥å¤šä¸ªé¢†åŸŸçš„è¯é¢˜
                    filteredTopics = topicStats.filter(t => t.count >= 5);
                    filteredTopics.sort((a, b) => b.count - a.count);
                    titleText = 'ğŸ”— æ¡¥æ¢è¯é¢˜';
                    description = 'å‡ºç°â‰¥5æ¬¡çš„é«˜é¢‘è¯é¢˜ï¼Œå¯ä½œä¸ºå†…å®¹è¿æ¥ç‚¹';
                    break;
                case 'saturated':
                    // ğŸ“Š çƒ­é—¨ä½†é¥±å’Œï¼šå‡ºç°å¤šä½†å¹³å‡æ’­æ”¾ä½
                    filteredTopics = topicStats.filter(t => t.count >= 5 && t.avgViews < 30000);
                    filteredTopics.sort((a, b) => b.count - a.count);
                    titleText = 'ğŸ“Š çƒ­é—¨ä½†é¥±å’Œ';
                    description = 'å‡ºç°â‰¥5æ¬¡ä½†å¹³å‡æ’­æ”¾<3ä¸‡çš„è¯é¢˜ï¼Œç«äº‰æ¿€çƒˆ';
                    break;
            }

            // æ¸²æŸ“è¯é¢˜åˆ—è¡¨
            renderTopicList(filteredTopics, titleText, description);
        }

        // ä»è§†é¢‘æ•°æ®ä¸­æå–è¯é¢˜ç»Ÿè®¡
        function extractTopicStats(videos) {
            const topicMap = new Map();
            const stopWords = ['çš„', 'æ˜¯', 'åœ¨', 'äº†', 'å’Œ', 'ä¸', 'æˆ–', 'è¿™', 'é‚£', 'æœ‰', 'ä¸º', 'ä»¥', 'åŠ', 'ç­‰', 'ä½ ', 'æˆ‘', 'ä»–', 'å¥¹', 'the', 'a', 'an', 'is', 'are', 'to', 'for', 'and', 'or', 'in', 'on', 'at', 'how', 'what', 'why'];

            videos.forEach(v => {
                const words = (v.title || '').split(/[\s,ï¼Œã€‚ï¼ï¼Ÿã€ï¼š:;\-\[\]ã€ã€‘()ï¼ˆï¼‰]+/).filter(w => w.length >= 2 && !stopWords.includes(w.toLowerCase()));
                words.forEach(word => {
                    if (!topicMap.has(word)) {
                        topicMap.set(word, { name: word, count: 0, totalViews: 0, videos: [] });
                    }
                    const topic = topicMap.get(word);
                    topic.count++;
                    topic.totalViews += v.views || 0;
                    topic.videos.push(v);
                });
            });

            // è®¡ç®—å¹³å‡æ’­æ”¾å¹¶è½¬ä¸ºæ•°ç»„
            return Array.from(topicMap.values())
                .map(t => ({ ...t, avgViews: t.totalViews / t.count }))
                .filter(t => t.count >= 2); // è‡³å°‘å‡ºç°2æ¬¡
        }

        // æ¸²æŸ“è¯é¢˜åˆ—è¡¨
        function renderTopicList(topics, title, description) {
            const container = document.getElementById('topicRankingList');
            if (!topics || topics.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">ğŸ’¡</div>
                        <div class="no-data-title">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è¯é¢˜</div>
                        <p class="no-data-desc">${description}</p>
                    </div>
                `;
                // æ›´æ–°æ ‡é¢˜
                const titleEl = document.querySelector('#panel-topics .ranking-title');
                if (titleEl) titleEl.innerHTML = `${title} <span class="ranking-count">å…± 0 ä¸ª</span>`;
                return;
            }

            // æ›´æ–°æ ‡é¢˜
            const titleEl = document.querySelector('#panel-topics .ranking-title');
            if (titleEl) titleEl.innerHTML = `${title} <span class="ranking-count">å…± ${topics.length} ä¸ª</span>`;

            container.innerHTML = topics.slice(0, 30).map((t, i) => `
                <div class="ranking-item">
                    <div class="rank-number ${i < 3 ? 'rank-' + (i + 1) : 'rank-normal'}">${i + 1}</div>
                    <div class="rank-info" style="flex: 1;">
                        <div class="rank-title">${t.name}</div>
                        <div class="rank-meta">
                            <span>å‡ºç° ${t.count} æ¬¡</span>
                            <span>å‡æ’­ ${formatNumber(Math.round(t.avgViews))}</span>
                            <span>æ€»æ’­æ”¾ ${formatNumber(t.totalViews)}</span>
                        </div>
                    </div>
                    <div class="rank-stats">
                        <div class="rank-stat">
                            <div class="rank-stat-value">${t.count}</div>
                            <div class="rank-stat-label">è§†é¢‘æ•°</div>
                        </div>
                        <div class="rank-stat">
                            <div class="rank-stat-value">${formatNumber(Math.round(t.avgViews))}</div>
                            <div class="rank-stat-label">å‡æ’­</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ—¶é—´è¶‹åŠ¿æ ‡ç­¾åˆ‡æ¢
        let currentTimelineTab = 'monthly';

        function switchTimelineTab(tab) {
            document.querySelectorAll('#panel-timeline .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentTimelineTab = tab;

            const data = window.currentVideoData;
            if (!data || data.length === 0) return;

            let titleText = '';
            let chartData = [];

            switch (tab) {
                case 'monthly':
                    // ğŸ“… æœˆåº¦è¶‹åŠ¿
                    chartData = aggregateByMonth(data);
                    titleText = 'ğŸ“… æœˆåº¦è§†é¢‘è¡¨ç°';
                    break;
                case 'quarterly':
                    // ğŸ“† å­£åº¦å¯¹æ¯”
                    chartData = aggregateByQuarter(data);
                    titleText = 'ğŸ“† å­£åº¦è§†é¢‘å¯¹æ¯”';
                    break;
                case 'publishTime':
                    // ğŸ• å‘å¸ƒæ—¶é—´åˆ†å¸ƒ
                    chartData = aggregateByPublishHour(data);
                    titleText = 'ğŸ• å‘å¸ƒæ—¶é—´åˆ†å¸ƒ';
                    break;
            }

            renderTimelineChart(chartData, titleText, tab);
        }

        // æŒ‰æœˆèšåˆ
        function aggregateByMonth(videos) {
            const monthMap = new Map();
            videos.forEach(v => {
                if (!v.date) return;
                const month = v.date.substring(0, 7); // YYYY-MM
                if (!monthMap.has(month)) {
                    monthMap.set(month, { label: month, count: 0, totalViews: 0 });
                }
                const m = monthMap.get(month);
                m.count++;
                m.totalViews += v.views || 0;
            });
            return Array.from(monthMap.values())
                .map(m => ({ ...m, avgViews: m.totalViews / m.count }))
                .sort((a, b) => b.label.localeCompare(a.label));
        }

        // æŒ‰å­£åº¦èšåˆ
        function aggregateByQuarter(videos) {
            const quarterMap = new Map();
            videos.forEach(v => {
                if (!v.date) return;
                const year = v.date.substring(0, 4);
                const month = parseInt(v.date.substring(5, 7));
                const quarter = `${year} Q${Math.ceil(month / 3)}`;
                if (!quarterMap.has(quarter)) {
                    quarterMap.set(quarter, { label: quarter, count: 0, totalViews: 0 });
                }
                const q = quarterMap.get(quarter);
                q.count++;
                q.totalViews += v.views || 0;
            });
            return Array.from(quarterMap.values())
                .map(q => ({ ...q, avgViews: q.totalViews / q.count }))
                .sort((a, b) => b.label.localeCompare(a.label));
        }

        // æŒ‰å‘å¸ƒå°æ—¶èšåˆ
        function aggregateByPublishHour(videos) {
            // ç”±äºæ²¡æœ‰ç²¾ç¡®æ—¶é—´ï¼Œè¿™é‡Œæ¨¡æ‹ŸæŒ‰æ—¶é—´æ®µåˆ†å¸ƒ
            const periods = [
                { label: 'æ—©é—´ (6-9ç‚¹)', count: 0, totalViews: 0 },
                { label: 'ä¸Šåˆ (9-12ç‚¹)', count: 0, totalViews: 0 },
                { label: 'ä¸‹åˆ (12-18ç‚¹)', count: 0, totalViews: 0 },
                { label: 'æ™šé—´ (18-22ç‚¹)', count: 0, totalViews: 0 },
                { label: 'æ·±å¤œ (22-6ç‚¹)', count: 0, totalViews: 0 }
            ];
            // éšæœºåˆ†é…ï¼ˆå®é™…åº”ä»æ•°æ®ä¸­è·å–ï¼‰
            videos.forEach((v, i) => {
                const idx = i % 5;
                periods[idx].count++;
                periods[idx].totalViews += v.views || 0;
            });
            return periods.map(p => ({ ...p, avgViews: p.count > 0 ? p.totalViews / p.count : 0 }));
        }

        // æ¸²æŸ“æ—¶é—´è¶‹åŠ¿å›¾è¡¨
        function renderTimelineChart(data, title, tab) {
            const container = document.getElementById('timelineChart');
            const titleEl = document.querySelector('#panel-timeline .ranking-title');
            if (titleEl) titleEl.textContent = title;

            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">ğŸ“ˆ</div>
                        <div class="no-data-title">æš‚æ— æ—¶é—´è¶‹åŠ¿æ•°æ®</div>
                    </div>
                `;
                return;
            }

            const maxViews = Math.max(...data.map(d => d.avgViews));
            const colors = ['#059669', '#0891b2', '#7c3aed', '#db2777', '#ea580c'];

            container.innerHTML = data.slice(0, 12).map((d, i) => `
                <div class="time-bar-row">
                    <span class="time-label">${d.label}</span>
                    <div class="time-bar-container">
                        <div class="time-bar" style="width: ${(d.avgViews / maxViews * 100).toFixed(1)}%; background: linear-gradient(90deg, ${colors[i % colors.length]}, ${colors[(i + 1) % colors.length]});">
                            ${d.count} ä¸ªè§†é¢‘
                        </div>
                    </div>
                    <span class="time-meta">å‡æ’­ ${formatNumber(Math.round(d.avgViews))}</span>
                </div>
            `).join('');
        }

        // ç­›é€‰å™¨çŠ¶æ€
        const filterState = {
            viewsMin: null,
            viewsMax: null,
            regions: [],
            duration: [],
            subscribers: [],
            timeRange: null,
            sortBy: 'views'
        };

        // åˆ‡æ¢ç­›é€‰å™¨æ˜¾ç¤º
        function toggleFilters() {
            const toggle = document.getElementById('filtersToggle');
            const content = document.getElementById('filtersContent');
            toggle.classList.toggle('open');
            content.classList.toggle('show');
        }

        // è®¾ç½®æ’­æ”¾é‡èŒƒå›´
        function setViewsRange(min, max) {
            const parent = event.target.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('viewsMin').value = min ? min : '';
            document.getElementById('viewsMax').value = max ? max : '';
            filterState.viewsMin = min;
            filterState.viewsMax = max;
            updateActiveFilters();
        }

        // æ¸…é™¤åœ°åŒºé€‰æ‹©
        function clearRegions(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.regions = [];
            updateActiveFilters();
        }

        // åˆ‡æ¢åœ°åŒºé€‰æ‹©
        function toggleRegion(el, region) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // ç§»é™¤"ä¸é™"
            el.classList.toggle('active');
            const idx = filterState.regions.indexOf(region);
            if (idx > -1) {
                filterState.regions.splice(idx, 1);
            } else {
                filterState.regions.push(region);
            }
            // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•åœ°åŒºï¼Œé‡æ–°é€‰ä¸­"ä¸é™"
            if (filterState.regions.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
            updateActiveFilters();
        }

        // æ¸…é™¤æ—¶é•¿é€‰æ‹©
        function clearDuration(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.duration = [];
            updateActiveFilters();
        }

        // åˆ‡æ¢æ—¶é•¿é€‰æ‹©
        function toggleDuration(el, duration) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // ç§»é™¤"ä¸é™"
            el.classList.toggle('active');
            const idx = filterState.duration.indexOf(duration);
            if (idx > -1) {
                filterState.duration.splice(idx, 1);
            } else {
                filterState.duration.push(duration);
            }
            if (filterState.duration.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
            updateActiveFilters();
        }

        // æ¸…é™¤ç²‰ä¸æ•°é€‰æ‹©
        function clearSubscribers(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.subscribers = [];
            updateActiveFilters();
        }

        // åˆ‡æ¢ç²‰ä¸æ•°é€‰æ‹©
        function toggleSubscribers(el, size) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // ç§»é™¤"ä¸é™"
            el.classList.toggle('active');
            const idx = filterState.subscribers.indexOf(size);
            if (idx > -1) {
                filterState.subscribers.splice(idx, 1);
            } else {
                filterState.subscribers.push(size);
            }
            if (filterState.subscribers.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
            updateActiveFilters();
        }

        // æ¸…é™¤æ—¶é—´èŒƒå›´
        function clearTime(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.timeRange = null;

            // æ¸…é™¤æ—¶é—´èŒƒå›´åï¼Œæ¢å¤é»˜è®¤æ’åºï¼ˆæ’­æ”¾é‡æœ€é«˜ï¼‰
            const sortSelect = document.getElementById('sortBy');
            if (sortSelect) {
                sortSelect.value = 'views';
                filterState.sortBy = 'views';
            }

            updateActiveFilters();
        }

        // åˆ‡æ¢æ—¶é—´èŒƒå›´
        function toggleTime(el, time) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.timeRange = time;

            // é€‰æ‹©æ—¶é—´èŒƒå›´åï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸ºæŒ‰"æœ€æ–°å‘å¸ƒ"æ’åº
            const sortSelect = document.getElementById('sortBy');
            if (sortSelect) {
                sortSelect.value = 'recent';
                filterState.sortBy = 'recent';
            }

            updateActiveFilters();
        }

        // æ›´æ–°å·²é€‰ç­›é€‰æ¡ä»¶æ˜¾ç¤º
        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            let html = '';

            if (filterState.viewsMin || filterState.viewsMax) {
                const min = filterState.viewsMin ? formatNumber(filterState.viewsMin) : '0';
                const max = filterState.viewsMax ? formatNumber(filterState.viewsMax) : 'ä¸é™';
                html += `<span class="active-filter-tag">æ’­æ”¾é‡: ${min} - ${max} <span class="remove" onclick="clearViewsFilter()">âœ•</span></span>`;
            }

            filterState.regions.forEach(r => {
                const names = { SG: 'ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡', MY: 'ğŸ‡²ğŸ‡¾ é©¬æ¥è¥¿äºš', TW: 'ğŸ‡¹ğŸ‡¼ å°æ¹¾', HK: 'ğŸ‡­ğŸ‡° é¦™æ¸¯', US: 'ğŸ‡ºğŸ‡¸ ç¾å›½', CN: 'ğŸ‡¨ğŸ‡³ å¤§é™†' };
                html += `<span class="active-filter-tag">${names[r]} <span class="remove" onclick="removeRegion('${r}')">âœ•</span></span>`;
            });

            filterState.duration.forEach(d => {
                const names = { short: 'çŸ­è§†é¢‘', medium: 'ä¸­ç­‰æ—¶é•¿', long: 'é•¿è§†é¢‘' };
                html += `<span class="active-filter-tag">${names[d]} <span class="remove" onclick="removeDuration('${d}')">âœ•</span></span>`;
            });

            filterState.subscribers.forEach(s => {
                const names = { small: 'å°é¢‘é“', medium: 'ä¸­é¢‘é“', large: 'å¤§é¢‘é“', huge: 'è¶…å¤§é¢‘é“' };
                html += `<span class="active-filter-tag">${names[s]} <span class="remove" onclick="removeSubscribers('${s}')">âœ•</span></span>`;
            });

            if (filterState.timeRange) {
                const names = { '24h': '24å°æ—¶', '7d': 'è¿‘7å¤©', '30d': 'è¿‘30å¤©', '90d': 'è¿‘3ä¸ªæœˆ', '1y': 'è¿‘1å¹´' };
                html += `<span class="active-filter-tag">${names[filterState.timeRange]} <span class="remove" onclick="clearTimeFilter()">âœ•</span></span>`;
            }

            if (filterState.aiFilter) {
                const names = { 'ai': 'ğŸ¤– ä»…AIè§†é¢‘', 'human': 'ğŸ‘¤ ä»…çœŸäººè§†é¢‘' };
                html += `<span class="active-filter-tag">${names[filterState.aiFilter]} <span class="remove" onclick="clearAIFilter()">âœ•</span></span>`;
            }

            container.innerHTML = html;
        }

        // æ¸…é™¤æ’­æ”¾é‡ç­›é€‰
        function clearViewsFilter() {
            document.getElementById('viewsMin').value = '';
            document.getElementById('viewsMax').value = '';
            filterState.viewsMin = null;
            filterState.viewsMax = null;
            updateActiveFilters();
        }

        // ç§»é™¤åœ°åŒº
        function removeRegion(region) {
            const idx = filterState.regions.indexOf(region);
            if (idx > -1) filterState.regions.splice(idx, 1);
            document.querySelectorAll('.filter-group:nth-child(2) .filter-chip').forEach(c => {
                if (c.textContent.includes(region === 'SG' ? 'æ–°åŠ å¡' : region === 'MY' ? 'é©¬æ¥è¥¿äºš' : region === 'TW' ? 'å°æ¹¾' : region === 'HK' ? 'é¦™æ¸¯' : region === 'US' ? 'ç¾å›½' : 'å¤§é™†')) {
                    c.classList.remove('active');
                }
            });
            updateActiveFilters();
        }

        // ç§»é™¤æ—¶é•¿
        function removeDuration(duration) {
            const idx = filterState.duration.indexOf(duration);
            if (idx > -1) filterState.duration.splice(idx, 1);
            document.querySelectorAll('.filter-group:nth-child(3) .filter-chip').forEach(c => {
                if ((duration === 'short' && c.textContent.includes('çŸ­è§†é¢‘')) ||
                    (duration === 'medium' && c.textContent.includes('ä¸­ç­‰')) ||
                    (duration === 'long' && c.textContent.includes('é•¿è§†é¢‘'))) {
                    c.classList.remove('active');
                }
            });
            updateActiveFilters();
        }

        // ç§»é™¤ç²‰ä¸æ•°
        function removeSubscribers(size) {
            const idx = filterState.subscribers.indexOf(size);
            if (idx > -1) filterState.subscribers.splice(idx, 1);
            document.querySelectorAll('.filter-group:nth-child(4) .filter-chip').forEach(c => {
                if ((size === 'small' && c.textContent.includes('å°é¢‘é“')) ||
                    (size === 'medium' && c.textContent.includes('ä¸­é¢‘é“')) ||
                    (size === 'large' && c.textContent.includes('å¤§é¢‘é“')) ||
                    (size === 'huge' && c.textContent.includes('è¶…å¤§'))) {
                    c.classList.remove('active');
                }
            });
            updateActiveFilters();
        }

        // æ¸…é™¤æ—¶é—´ç­›é€‰
        function clearTimeFilter() {
            filterState.timeRange = null;
            document.querySelectorAll('.filter-group:nth-child(5) .filter-chip').forEach(c => c.classList.remove('active'));
            updateActiveFilters();
        }

        // æ¸…é™¤AIç­›é€‰
        function clearAIFilter() {
            filterState.aiFilter = null;
            // æ‰¾åˆ°AIè§†é¢‘ç­›é€‰ç»„å¹¶é‡ç½®
            document.querySelectorAll('.filter-group').forEach(group => {
                if (group.querySelector('.filter-label')?.textContent.includes('AIè§†é¢‘')) {
                    group.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    group.querySelector('.filter-chip:first-child').classList.add('active');
                }
            });
            updateActiveFilters();
        }

        // é‡ç½®æ‰€æœ‰ç­›é€‰
        function resetFilters() {
            filterState.viewsMin = null;
            filterState.viewsMax = null;
            filterState.regions = [];
            filterState.duration = [];
            filterState.subscribers = [];
            filterState.timeRange = null;
            filterState.sortBy = 'views';
            filterState.likesMin = null;
            filterState.likesMax = null;
            filterState.engagement = null;
            filterState.languages = [];
            filterState.channelTypes = [];
            filterState.quality = [];
            filterState.aiFilter = null;

            document.getElementById('viewsMin').value = '';
            document.getElementById('viewsMax').value = '';
            document.getElementById('likesMin').value = '';
            document.getElementById('likesMax').value = '';
            document.getElementById('commentsMin').value = '';
            document.getElementById('commentsMax').value = '';
            document.getElementById('sortBy').value = 'views';
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            document.getElementById('channelFilter').value = '';
            document.getElementById('excludeKeywords').value = '';
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            // é‡æ–°æ¿€æ´»æ‰€æœ‰"ä¸é™"æŒ‰é’®
            document.querySelectorAll('.filter-chips').forEach(chips => {
                const first = chips.querySelector('.filter-chip:first-child');
                if (first && first.textContent === 'ä¸é™') {
                    first.classList.add('active');
                }
            });
            updateActiveFilters();
        }

        // è®¾ç½®è§†é¢‘æ•°é‡
        function setVideoCount(el, count) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.videoCount = count;
        }

        // è®¾ç½®ç‚¹èµèŒƒå›´
        function setLikesRange(min, max) {
            const parent = event.target.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('likesMin').value = min ? min : '';
            document.getElementById('likesMax').value = max ? max : '';
            filterState.likesMin = min;
            filterState.likesMax = max;
        }

        // æ¸…é™¤äº’åŠ¨ç‡
        function clearEngagement(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.engagement = null;
        }

        // è®¾ç½®äº’åŠ¨ç‡
        function setEngagement(el, level) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.engagement = level;
        }

        // æ¸…é™¤è¯­è¨€
        function clearLanguage(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.languages = [];
        }

        // åˆ‡æ¢è¯­è¨€
        function toggleLanguage(el, lang) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // ç§»é™¤"ä¸é™"
            el.classList.toggle('active');
            if (!filterState.languages) filterState.languages = [];
            const idx = filterState.languages.indexOf(lang);
            if (idx > -1) {
                filterState.languages.splice(idx, 1);
            } else {
                filterState.languages.push(lang);
            }
            if (filterState.languages.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
        }

        // æ¸…é™¤é¢‘é“ç±»å‹
        function clearChannelType(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.channelTypes = [];
        }

        // åˆ‡æ¢é¢‘é“ç±»å‹
        function toggleChannelType(el, type) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // ç§»é™¤"ä¸é™"
            el.classList.toggle('active');
            if (!filterState.channelTypes) filterState.channelTypes = [];
            const idx = filterState.channelTypes.indexOf(type);
            if (idx > -1) {
                filterState.channelTypes.splice(idx, 1);
            } else {
                filterState.channelTypes.push(type);
            }
            if (filterState.channelTypes.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
        }

        // æ¸…é™¤è§†é¢‘è´¨é‡
        function clearQuality(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.quality = [];
        }

        // åˆ‡æ¢è§†é¢‘è´¨é‡
        function toggleQuality(el, quality) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // ç§»é™¤"ä¸é™"
            el.classList.toggle('active');
            if (!filterState.quality) filterState.quality = [];
            const idx = filterState.quality.indexOf(quality);
            if (idx > -1) {
                filterState.quality.splice(idx, 1);
            } else {
                filterState.quality.push(quality);
            }
            if (filterState.quality.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
        }

        // AIè§†é¢‘ç­›é€‰
        function setAIFilter(el, type) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.aiFilter = type === 'all' ? null : type;
            updateActiveFilters();
        }

        // AIè§†é¢‘æ£€æµ‹å…³é”®è¯
        const AI_VIDEO_KEYWORDS = [
            // å·¥å…·åç§°
            'sora', 'runway', 'pika', 'heygen', 'synthesia', 'd-id', 'midjourney',
            'stable diffusion', 'kling', 'luma', 'gen-2', 'gen-3', 'vidu', 'cogvideo',
            // ä¸­æ–‡å…³é”®è¯
            'aiç”Ÿæˆ', 'aiè§†é¢‘', 'aiåˆ¶ä½œ', 'aiåˆ›ä½œ', 'aié…éŸ³', 'aiæ¢è„¸', 'aiæ•°å­—äºº',
            'æ•°å­—äºº', 'è™šæ‹Ÿäºº', 'äººå·¥æ™ºèƒ½ç”Ÿæˆ', 'aigc',
            // è‹±æ–‡å…³é”®è¯
            'ai generated', 'ai video', 'ai-generated', 'text to video', 'ai avatar'
        ];

        // æ£€æµ‹æ˜¯å¦ä¸ºAIè§†é¢‘
        function detectAIVideo(title, description, tags) {
            const text = `${title || ''} ${description || ''} ${(tags || []).join(' ')}`.toLowerCase();
            for (const kw of AI_VIDEO_KEYWORDS) {
                if (text.includes(kw.toLowerCase())) {
                    return { isAI: true, keyword: kw };
                }
            }
            return { isAI: false, keyword: null };
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            filterState.sortBy = document.getElementById('sortBy').value;
            filterState.dateStart = document.getElementById('dateStart').value;
            filterState.dateEnd = document.getElementById('dateEnd').value;
            filterState.channelFilter = document.getElementById('channelFilter').value;
            filterState.excludeKeywords = document.getElementById('excludeKeywords').value;
            filterState.commentsMin = document.getElementById('commentsMin').value;
            filterState.commentsMax = document.getElementById('commentsMax').value;

            console.log('åº”ç”¨ç­›é€‰:', filterState);
            // è¿™é‡Œå°†æ¥æ¥å…¥çœŸå®æ•°æ®åï¼Œä¼šæ ¹æ®ç­›é€‰æ¡ä»¶é‡æ–°è·å–æ•°æ®
            alert('ç­›é€‰æ¡ä»¶å·²ä¿å­˜ï¼ç‚¹å‡»"å¼€å§‹åˆ†æ"åç”Ÿæ•ˆã€‚');
        }

        // ============ æ•°æ®å¯¼å‡ºåŠŸèƒ½ ============

        // å¯¼å‡ºæ•°æ®
        function exportData(format) {
            if (!lastAnalysisResult) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼Œè¯·å…ˆè¿›è¡Œåˆ†æ');
                return;
            }

            const data = lastAnalysisResult;
            const timestamp = new Date().toISOString().slice(0, 10);
            const topic = data.topic || 'analysis';
            const filename = `youtube_${topic}_${timestamp}`;

            if (format === 'csv') {
                exportCSV(data, filename);
            } else if (format === 'json') {
                exportJSON(data, filename);
            }
        }

        // å¯¼å‡ºä¸º CSV
        function exportCSV(data, filename) {
            // è§†é¢‘æ•°æ® CSV
            const videoHeaders = [
                'YouTube ID',
                'æ ‡é¢˜',
                'é¢‘é“åç§°',
                'é¢‘é“ID',
                'æ’­æ”¾é‡',
                'ç‚¹èµæ•°',
                'è¯„è®ºæ•°',
                'æ—¶é•¿(ç§’)',
                'å‘å¸ƒæ—¥æœŸ',
                'æ˜¯å¦AIè§†é¢‘',
                'AIå…³é”®è¯',
                'è§†é¢‘é“¾æ¥'
            ];

            const videoRows = data.videos.map(v => [
                v.youtube_id,
                `"${(v.title || '').replace(/"/g, '""')}"`,  // å¤„ç†æ ‡é¢˜ä¸­çš„å¼•å·
                `"${(v.channel_name || '').replace(/"/g, '""')}"`,
                v.channel_id || '',
                v.view_count || 0,
                v.like_count || 0,
                v.comment_count || 0,
                v.duration || 0,
                v.published_at || '',
                v.is_ai_video ? 'æ˜¯' : 'å¦',
                v.ai_keyword || '',
                `https://www.youtube.com/watch?v=${v.youtube_id}`
            ].join(','));

            const csvContent = [videoHeaders.join(','), ...videoRows].join('\n');

            // æ·»åŠ  BOM ä»¥æ”¯æŒä¸­æ–‡
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadBlob(blob, `${filename}_videos.csv`);

            // é¢‘é“æ•°æ® CSV
            if (data.channels && data.channels.length > 0) {
                const channelHeaders = ['é¢‘é“åç§°', 'é¢‘é“ID', 'è§†é¢‘æ•°é‡', 'æ€»æ’­æ”¾é‡', 'å¹³å‡æ’­æ”¾é‡'];
                const channelRows = data.channels.map(ch => [
                    `"${(ch.channel_name || '').replace(/"/g, '""')}"`,
                    ch.channel_id || '',
                    ch.video_count || 0,
                    ch.total_views || 0,
                    ch.avg_views || 0
                ].join(','));

                const channelCsv = [channelHeaders.join(','), ...channelRows].join('\n');
                const channelBlob = new Blob(['\ufeff' + channelCsv], { type: 'text/csv;charset=utf-8;' });
                downloadBlob(channelBlob, `${filename}_channels.csv`);
            }

            console.log(`å·²å¯¼å‡º ${data.videos.length} ä¸ªè§†é¢‘å’Œ ${data.channels?.length || 0} ä¸ªé¢‘é“æ•°æ®`);
        }

        // å¯¼å‡ºä¸º JSON
        function exportJSON(data, filename) {
            // å®Œæ•´æ•°æ®å¯¼å‡º
            const exportData = {
                meta: {
                    topic: data.topic,
                    exportTime: new Date().toISOString(),
                    totalVideos: data.total_videos,
                    totalViews: data.total_views,
                    totalChannels: data.total_channels,
                    aiVideoCount: data.ai_video_count
                },
                insights: data.insights,
                durationDistribution: data.duration_distribution,
                videos: data.videos.map(v => ({
                    ...v,
                    url: `https://www.youtube.com/watch?v=${v.youtube_id}`
                })),
                channels: data.channels
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            downloadBlob(blob, `${filename}_full.json`);

            console.log(`å·²å¯¼å‡ºå®Œæ•´æ•°æ® (JSON)`);
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ¨¡å¼æ´å¯Ÿæ ‡ç­¾åˆ‡æ¢
        let currentPatternTab = 'duration';

        function switchPatternTab(tab) {
            document.querySelectorAll('#panel-patterns .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentPatternTab = tab;

            // éšè—æ‰€æœ‰å­é¢æ¿
            document.getElementById('pattern-duration').style.display = 'none';
            document.getElementById('pattern-timeline').style.display = 'none';
            document.getElementById('pattern-title').style.display = 'none';

            // æ˜¾ç¤ºé€‰ä¸­çš„é¢æ¿
            document.getElementById('pattern-' + tab).style.display = 'block';
        }

        // æ›´æ–°æ ‡é¢˜æ¨¡å¼åˆ†æ
        function updateTitlePatterns(videos) {
            const container = document.getElementById('titlePatternChart');
            if (!container || !videos || videos.length === 0) {
                if (container) container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">æš‚æ— æ•°æ®</p>';
                return;
            }

            // åˆ†æé«˜æ’­æ”¾é‡è§†é¢‘çš„æ ‡é¢˜ç‰¹å¾
            const avgViews = videos.reduce((sum, v) => sum + v.views, 0) / videos.length;
            const highPerformingVideos = videos.filter(v => v.views > avgViews).slice(0, 50);

            // æ ‡é¢˜é•¿åº¦åˆ†æ
            const lengthStats = {
                short: { count: 0, views: 0, label: 'çŸ­æ ‡é¢˜ (â‰¤15å­—)' },
                medium: { count: 0, views: 0, label: 'ä¸­ç­‰æ ‡é¢˜ (16-30å­—)' },
                long: { count: 0, views: 0, label: 'é•¿æ ‡é¢˜ (>30å­—)' }
            };

            highPerformingVideos.forEach(v => {
                const len = v.title.length;
                if (len <= 15) {
                    lengthStats.short.count++;
                    lengthStats.short.views += v.views;
                } else if (len <= 30) {
                    lengthStats.medium.count++;
                    lengthStats.medium.views += v.views;
                } else {
                    lengthStats.long.count++;
                    lengthStats.long.views += v.views;
                }
            });

            // å¸¸è§å…³é”®è¯åˆ†æ
            const keywords = {};
            const commonWords = ['çš„', 'å’Œ', 'æ˜¯', 'åœ¨', 'äº†', 'ä¸', 'æœ‰', 'è¿™', 'ä¸ª', 'ä¸Š', 'æˆ‘', 'ä½ ', 'ä»–', 'å¥¹', 'å®ƒ', 'ä»¬'];
            highPerformingVideos.forEach(v => {
                const words = v.title.match(/[\u4e00-\u9fa5]+|[a-zA-Z]+|\d+/g) || [];
                words.forEach(word => {
                    if (word.length >= 2 && !commonWords.includes(word)) {
                        if (!keywords[word]) keywords[word] = { count: 0, views: 0 };
                        keywords[word].count++;
                        keywords[word].views += v.views;
                    }
                });
            });

            const topKeywords = Object.entries(keywords)
                .map(([word, data]) => ({ word, ...data, avgViews: data.views / data.count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            // æ¸²æŸ“
            const maxViews = Math.max(...Object.values(lengthStats).map(s => s.count > 0 ? s.views / s.count : 0));

            container.innerHTML = `
                <div style="padding: 15px;">
                    <h4 style="margin: 0 0 15px; color: #334155; font-size: 14px;">æ ‡é¢˜é•¿åº¦ vs å¹³å‡æ’­æ”¾é‡</h4>
                    ${Object.values(lengthStats).map(stat => {
                        const avgV = stat.count > 0 ? stat.views / stat.count : 0;
                        const pct = maxViews > 0 ? (avgV / maxViews * 100) : 0;
                        return `
                            <div class="time-bar-row" style="margin-bottom: 8px;">
                                <span class="time-label" style="min-width: 120px;">${stat.label}</span>
                                <div class="time-bar-container">
                                    <div class="time-bar" style="width: ${pct}%; background: linear-gradient(90deg, #8b5cf6, #a78bfa);">
                                        ${stat.count} ä¸ª
                                    </div>
                                </div>
                                <span class="time-meta">å‡æ’­ ${formatNumber(Math.round(avgV))}</span>
                            </div>
                        `;
                    }).join('')}

                    <h4 style="margin: 20px 0 15px; color: #334155; font-size: 14px;">é«˜æ’­æ”¾è§†é¢‘å¸¸è§å…³é”®è¯ Top 10</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${topKeywords.map((kw, i) => `
                            <span style="
                                display: inline-block;
                                padding: 6px 12px;
                                background: ${i < 3 ? 'linear-gradient(135deg, #6366f1, #8b5cf6)' : '#f1f5f9'};
                                color: ${i < 3 ? 'white' : '#475569'};
                                border-radius: 16px;
                                font-size: 13px;
                            ">
                                ${kw.word} <span style="opacity: 0.8;">(${kw.count})</span>
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // æ›´æ–°åˆ†ææŠ¥å‘Šé¢æ¿
        function updateReportPanel(result, videos, channels) {
            const container = document.getElementById('reportContent');
            const titleEl = document.getElementById('reportTitle');

            if (!container) return;

            if (!result || !videos || videos.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">ğŸ“‹</div>
                        <div class="no-data-title">æš‚æ— æŠ¥å‘Š</div>
                        <p class="no-data-desc">æœç´¢å…³é”®è¯åï¼Œè¿™é‡Œå°†ç”Ÿæˆå®Œæ•´çš„åˆ†ææŠ¥å‘Š</p>
                    </div>
                `;
                return;
            }

            if (titleEl) titleEl.textContent = `ğŸ“‹ ã€Œ${result.topic}ã€åˆ†ææŠ¥å‘Š`;

            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const avgViews = result.total_videos > 0 ? Math.round(result.total_views / result.total_videos) : 0;
            const topVideos = videos.slice(0, 5);
            const topChannels = channels.slice(0, 5);

            // æ—¶é•¿åˆ†å¸ƒ
            const durationStats = {
                short: videos.filter(v => (v.durationSeconds || 0) < 180).length,
                medium: videos.filter(v => (v.durationSeconds || 0) >= 180 && (v.durationSeconds || 0) < 600).length,
                long: videos.filter(v => (v.durationSeconds || 0) >= 600).length
            };

            container.innerHTML = `
                <div class="report-section" style="margin-bottom: 24px;">
                    <h3 style="color: #1e293b; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ“Š</span> æ•°æ®æ¦‚è§ˆ
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #3b82f6;">${result.total_videos}</div>
                            <div style="font-size: 12px; color: #64748b;">è§†é¢‘æ€»æ•°</div>
                        </div>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #10b981;">${result.total_channels}</div>
                            <div style="font-size: 12px; color: #64748b;">é¢‘é“æ•°é‡</div>
                        </div>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #8b5cf6;">${formatNumber(result.total_views)}</div>
                            <div style="font-size: 12px; color: #64748b;">æ€»æ’­æ”¾é‡</div>
                        </div>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #f59e0b;">${formatNumber(avgViews)}</div>
                            <div style="font-size: 12px; color: #64748b;">å¹³å‡æ’­æ”¾</div>
                        </div>
                    </div>
                </div>

                <div class="report-section" style="margin-bottom: 24px;">
                    <h3 style="color: #1e293b; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ¬</span> Top 5 è§†é¢‘
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f1f5f9;">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">#</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">æ ‡é¢˜</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">é¢‘é“</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">æ’­æ”¾é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topVideos.map((v, i) => `
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 10px; color: #64748b;">${i + 1}</td>
                                    <td style="padding: 10px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${v.title}</td>
                                    <td style="padding: 10px; color: #64748b;">${v.channel}</td>
                                    <td style="padding: 10px; text-align: right; font-weight: 500;">${formatNumber(v.views)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="report-section" style="margin-bottom: 24px;">
                    <h3 style="color: #1e293b; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ“º</span> Top 5 é¢‘é“
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f1f5f9;">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">#</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">é¢‘é“åç§°</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">è§†é¢‘æ•°</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">æ€»æ’­æ”¾</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">å¹³å‡æ’­æ”¾</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topChannels.map((ch, i) => `
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 10px; color: #64748b;">${i + 1}</td>
                                    <td style="padding: 10px;">${ch.name}</td>
                                    <td style="padding: 10px; text-align: right;">${ch.videoCount}</td>
                                    <td style="padding: 10px; text-align: right; font-weight: 500;">${formatNumber(ch.totalViews)}</td>
                                    <td style="padding: 10px; text-align: right;">${formatNumber(ch.avgViews)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="report-section">
                    <h3 style="color: #1e293b; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                        <span>â±ï¸</span> æ—¶é•¿åˆ†å¸ƒ
                    </h3>
                    <div style="display: flex; gap: 16px;">
                        <div style="flex: 1; background: #fef3c7; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: 600; color: #d97706;">${durationStats.short}</div>
                            <div style="font-size: 12px; color: #92400e;">çŸ­è§†é¢‘ (&lt;3åˆ†é’Ÿ)</div>
                        </div>
                        <div style="flex: 1; background: #dbeafe; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: 600; color: #2563eb;">${durationStats.medium}</div>
                            <div style="font-size: 12px; color: #1e40af;">ä¸­ç­‰ (3-10åˆ†é’Ÿ)</div>
                        </div>
                        <div style="flex: 1; background: #ede9fe; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: 600; color: #7c3aed;">${durationStats.long}</div>
                            <div style="font-size: 12px; color: #5b21b6;">é•¿è§†é¢‘ (&gt;10åˆ†é’Ÿ)</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // å¯¼å‡ºæŠ¥å‘Š
        function exportReport(format) {
            const data = lastAnalysisResult;
            if (!data) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆæœç´¢åˆ†æ');
                return;
            }

            const filename = `${data.topic}_report_${new Date().toISOString().slice(0, 10)}`;

            if (format === 'csv') {
                exportCSV(data, filename);
            } else if (format === 'json') {
                exportJSON(data, filename);
            }
        }

        // ==================== ç›‘æ§åŠŸèƒ½ ====================

        let monitorTasks = [];
        let schedulerRunning = false;
        let trendingDays = 7;

        // åŠ è½½ç›‘æ§ä»»åŠ¡åˆ—è¡¨
        async function loadMonitorTasks() {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks`);
                const data = await response.json();
                monitorTasks = data.tasks || [];
                renderMonitorTasks();
                document.getElementById('badge-monitor').textContent = monitorTasks.length;
            } catch (error) {
                console.error('åŠ è½½ç›‘æ§ä»»åŠ¡å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ç›‘æ§ä»»åŠ¡åˆ—è¡¨
        function renderMonitorTasks() {
            const container = document.getElementById('monitorTasksList');

            if (monitorTasks.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #64748b;">
                        <div style="font-size: 2em; margin-bottom: 16px;">ğŸ“¡</div>
                        <div style="font-weight: 600; color: white; margin-bottom: 8px;">æš‚æ— ç›‘æ§ä»»åŠ¡</div>
                        <p>æ·»åŠ å…³é”®è¯åï¼Œç³»ç»Ÿå°†å®šæ—¶é‡‡é›†æ•°æ®å¹¶è¿½è¸ªå¢é•¿è¶‹åŠ¿</p>
                        <button class="search-btn" onclick="showAddMonitorModal()" style="margin-top: 16px; padding: 10px 20px;">+ æ·»åŠ ç›‘æ§ä»»åŠ¡</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = monitorTasks.map((task, index) => `
                <div class="ranking-item" style="flex-wrap: wrap;">
                    <div class="rank-number" style="background: ${task.is_active ? '#06b6d4' : '#64748b'};">
                        ${index + 1}
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; color: white; margin-bottom: 4px;">
                            ${task.keyword}
                            ${task.is_active ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 8px;">è¿è¡Œä¸­</span>' : '<span style="background: #64748b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 8px;">å·²æš‚åœ</span>'}
                        </div>
                        <div style="font-size: 0.85em; color: #94a3b8;">
                            é¢‘ç‡: ${task.frequency === 'hourly' ? 'æ¯å°æ—¶' : task.frequency === 'weekly' ? 'æ¯å‘¨' : 'æ¯å¤©'}
                            Â· ä¸Šæ¬¡è¿è¡Œ: ${task.last_run_at ? new Date(task.last_run_at).toLocaleString() : 'ä»æœª'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="filter-btn" onclick="runMonitorNow(${task.id})" style="font-size: 11px;">â–¶ï¸ ç«‹å³æ‰§è¡Œ</button>
                        <button class="filter-btn" onclick="toggleMonitorTask(${task.id})" style="font-size: 11px;">${task.is_active ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ å¯ç”¨'}</button>
                        <button class="filter-btn" onclick="viewMonitorGrowth(${task.id})" style="font-size: 11px;">ğŸ“ˆ æŸ¥çœ‹å¢é•¿</button>
                        <button class="filter-btn" onclick="deleteMonitorTask(${task.id})" style="font-size: 11px; color: #ef4444;">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºæ·»åŠ ç›‘æ§æ¨¡æ€æ¡†
        function showAddMonitorModal() {
            const modal = document.createElement('div');
            modal.id = 'addMonitorModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); display: flex;
                align-items: center; justify-content: center; z-index: 1000;
            `;
            modal.innerHTML = `
                <div style="background: #1e293b; border-radius: 16px; padding: 24px; width: 400px; max-width: 90%;">
                    <h3 style="color: white; margin-bottom: 20px;">ğŸ“¡ æ·»åŠ ç›‘æ§ä»»åŠ¡</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; font-size: 0.85em; display: block; margin-bottom: 6px;">ç›‘æ§å…³é”®è¯</label>
                        <input type="text" id="monitorKeyword" class="search-input" placeholder="ä¾‹å¦‚ï¼šPythonæ•™ç¨‹ã€å¥åº·å…»ç”Ÿ" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; font-size: 0.85em; display: block; margin-bottom: 6px;">é‡‡é›†é¢‘ç‡</label>
                        <select id="monitorFrequency" style="width: 100%; padding: 12px; background: #0f172a; border: 2px solid #334155; border-radius: 8px; color: white;">
                            <option value="daily">æ¯å¤©</option>
                            <option value="hourly">æ¯å°æ—¶</option>
                            <option value="weekly">æ¯å‘¨</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="color: #94a3b8; font-size: 0.85em; display: block; margin-bottom: 6px;">æ¯æ¬¡é‡‡é›†æ•°é‡</label>
                        <input type="number" id="monitorMaxResults" value="500" style="width: 100%; padding: 12px; background: #0f172a; border: 2px solid #334155; border-radius: 8px; color: white;">
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeAddMonitorModal()" style="flex: 1; padding: 12px; background: #334155; color: white; border: none; border-radius: 8px; cursor: pointer;">å–æ¶ˆ</button>
                        <button onclick="createMonitorTask()" class="search-btn" style="flex: 1; padding: 12px;">åˆ›å»ºç›‘æ§</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeAddMonitorModal() {
            const modal = document.getElementById('addMonitorModal');
            if (modal) modal.remove();
        }

        // åˆ›å»ºç›‘æ§ä»»åŠ¡
        async function createMonitorTask() {
            const keyword = document.getElementById('monitorKeyword').value.trim();
            const frequency = document.getElementById('monitorFrequency').value;
            const maxResults = parseInt(document.getElementById('monitorMaxResults').value) || 500;

            if (!keyword) {
                alert('è¯·è¾“å…¥ç›‘æ§å…³é”®è¯');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, frequency, max_results: maxResults })
                });

                const data = await response.json();
                if (data.success) {
                    closeAddMonitorModal();
                    loadMonitorTasks();
                    alert(`ç›‘æ§ä»»åŠ¡å·²åˆ›å»º: ${keyword}`);
                } else {
                    alert(data.detail || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                alert('åˆ›å»ºç›‘æ§ä»»åŠ¡å¤±è´¥: ' + error.message);
            }
        }

        // ç«‹å³æ‰§è¡Œç›‘æ§ä»»åŠ¡
        async function runMonitorNow(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks/${taskId}/run`, {
                    method: 'POST'
                });
                const data = await response.json();
                alert(data.message || 'ä»»åŠ¡å·²å¼€å§‹æ‰§è¡Œ');
            } catch (error) {
                alert('æ‰§è¡Œå¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢ç›‘æ§ä»»åŠ¡çŠ¶æ€
        async function toggleMonitorTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks/${taskId}/toggle`, {
                    method: 'POST'
                });
                const data = await response.json();
                loadMonitorTasks();
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤ç›‘æ§ä»»åŠ¡
        async function deleteMonitorTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›‘æ§ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                loadMonitorTasks();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æŸ¥çœ‹å¢é•¿æ•°æ®
        async function viewMonitorGrowth(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks/${taskId}/growth?days=${trendingDays}`);
                const data = await response.json();

                // åˆ‡æ¢åˆ°è¶‹åŠ¿é¢æ¿å¹¶æ˜¾ç¤ºæ•°æ®
                switchPanel('trending');
                renderTrendingData(data);
            } catch (error) {
                alert('è·å–å¢é•¿æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“è¶‹åŠ¿æ•°æ®
        function renderTrendingData(data) {
            // æ›´æ–°æ‘˜è¦
            const summary = data.summary || {};
            document.getElementById('trend-total-videos').textContent = formatNumber(summary.total_videos || 0);
            document.getElementById('trend-total-growth').textContent = formatNumber(summary.total_growth || 0);
            document.getElementById('trend-trending-count').textContent = formatNumber(summary.trending_count || 0);
            document.getElementById('trend-avg-growth').textContent = formatNumber(Math.round(summary.avg_growth || 0));

            // æ¸²æŸ“è¶‹åŠ¿è§†é¢‘åˆ—è¡¨
            const container = document.getElementById('trendingVideosList');
            const trending = data.trending_videos || [];

            if (trending.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #64748b;">
                        <div style="font-size: 2em; margin-bottom: 16px;">ğŸ“ˆ</div>
                        <div style="font-weight: 600; color: white; margin-bottom: 8px;">æš‚æ— è¶‹åŠ¿æ•°æ®</div>
                        <p>éœ€è¦è‡³å°‘2å¤©çš„æ•°æ®æ‰èƒ½è®¡ç®—å¢é•¿è¶‹åŠ¿</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = trending.map((video, index) => `
                <div class="ranking-item">
                    <div class="rank-number" style="background: ${index < 3 ? '#f59e0b' : '#334155'};">
                        ${index + 1}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: white; margin-bottom: 4px;">
                            ${video.video_id}
                        </div>
                        <div style="font-size: 0.85em; color: #94a3b8;">
                            è¶‹åŠ¿å¤©æ•°: ${video.trending_days || 0} å¤©
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: #10b981; font-size: 1.1em;">
                            +${formatNumber(video.total_growth || 0)}
                        </div>
                        <div style="font-size: 0.8em; color: #94a3b8;">
                            å¹³å‡ ${(video.avg_growth_rate || 0).toFixed(1)}%
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // è°ƒåº¦å™¨æ§åˆ¶
        async function toggleScheduler() {
            try {
                const endpoint = schedulerRunning ? 'stop' : 'start';
                const response = await fetch(`${API_BASE}/api/monitor/scheduler/${endpoint}`, {
                    method: 'POST'
                });
                const data = await response.json();
                updateSchedulerStatus();
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function updateSchedulerStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/scheduler/status`);
                const data = await response.json();
                schedulerRunning = data.running;

                const indicator = document.getElementById('schedulerIndicator');
                const statusText = document.getElementById('schedulerStatusText');
                const btn = document.getElementById('schedulerBtn');

                if (schedulerRunning) {
                    indicator.style.background = '#10b981';
                    statusText.textContent = 'è°ƒåº¦å™¨è¿è¡Œä¸­';
                    btn.textContent = 'â¹ï¸ åœæ­¢è°ƒåº¦å™¨';
                } else {
                    indicator.style.background = '#64748b';
                    statusText.textContent = 'è°ƒåº¦å™¨æœªè¿è¡Œ';
                    btn.textContent = 'â–¶ï¸ å¯åŠ¨è°ƒåº¦å™¨';
                }
            } catch (error) {
                console.error('è·å–è°ƒåº¦å™¨çŠ¶æ€å¤±è´¥:', error);
            }
        }

        function setTrendingDays(days) {
            trendingDays = days;
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('#panel-trending .ranking-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç›‘æ§æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            loadMonitorTasks();
            updateSchedulerStatus();
        });
    </script>
</body>
</html>
