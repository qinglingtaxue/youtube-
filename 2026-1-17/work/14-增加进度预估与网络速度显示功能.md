# TD-14: è¿›åº¦é¢„ä¼°ä¸ç½‘ç»œé€Ÿåº¦æ˜¾ç¤ºåŠŸèƒ½ / Progress Estimation & Network Speed Display

> é‡‡é›†è¿‡ç¨‹çš„å®æ—¶åé¦ˆä¸ç”¨æˆ·ä½“éªŒå¢å¼º
> Real-time feedback and UX enhancement for collection process

---

## å†³ç­–æ¦‚è¦ / Decision Summary

| å±æ€§ / Attribute | å€¼ / Value |
|------------------|------------|
| å†³ç­–ç¼–å· / ID | TD-14 |
| å†³ç­–ç±»å‹ / Type | å®ç°æ–¹æ¡ˆ / Implementation |
| å†³ç­–æ—¥æœŸ / Date | 2026-01-20 |
| æ¥æºå¯¹è¯ / Source | b6ada673 |
| çŠ¶æ€ / Status | å·²æ‰§è¡Œ / Implemented |

---

## åŠŸèƒ½ç»“æ„ / Feature Structure

```
progress-monitor/
â”œâ”€â”€ components/                     # UI ç»„ä»¶ / UI Components
â”‚   â”œâ”€â”€ ProgressBar.tsx             # è¿›åº¦æ¡
â”‚   â”œâ”€â”€ TimeEstimate.tsx            # æ—¶é—´é¢„ä¼°
â”‚   â”œâ”€â”€ NetworkStatus.tsx           # ç½‘ç»œçŠ¶æ€
â”‚   â””â”€â”€ TaskDetails.tsx             # ä»»åŠ¡è¯¦æƒ…
â”œâ”€â”€ hooks/                          # React Hooks
â”‚   â”œâ”€â”€ useProgress.ts              # è¿›åº¦çŠ¶æ€
â”‚   â”œâ”€â”€ useNetworkSpeed.ts          # ç½‘é€Ÿç›‘æ§
â”‚   â””â”€â”€ useTimeEstimate.ts          # æ—¶é—´é¢„ä¼°
â”œâ”€â”€ lib/                            # å·¥å…·åº“ / Utilities
â”‚   â”œâ”€â”€ progress-tracker.ts         # è¿›åº¦è¿½è¸ªå™¨
â”‚   â”œâ”€â”€ network-monitor.ts          # ç½‘ç»œç›‘æ§å™¨
â”‚   â””â”€â”€ time-estimator.ts           # æ—¶é—´ä¼°ç®—å™¨
â””â”€â”€ types/                          # ç±»å‹å®šä¹‰ / Types
    â””â”€â”€ progress.ts
```

---

## åŠŸèƒ½ç´¢å¼• / Feature Index

| # | åŠŸèƒ½ / Feature | ä¸­æ–‡è¯´æ˜ | English Description | ç»„ä»¶ / Component |
|---|----------------|---------|---------------------|------------------|
| 1 | Progress Bar | è¿›åº¦æ¡æ˜¾ç¤º | Visual progress indicator | `ProgressBar.tsx` |
| 2 | Time Estimate | å‰©ä½™æ—¶é—´é¢„ä¼° | Remaining time estimate | `TimeEstimate.tsx` |
| 3 | Network Speed | å®æ—¶ç½‘é€Ÿæ˜¾ç¤º | Real-time speed display | `NetworkStatus.tsx` |
| 4 | Task Details | å½“å‰ä»»åŠ¡è¯¦æƒ… | Current task details | `TaskDetails.tsx` |
| 5 | Status Alert | çŠ¶æ€å‘Šè­¦ | Status alerts | `NetworkStatus.tsx` |

---

## åŠŸèƒ½è¯¦è§£ / Feature Details

### 1. è¿›åº¦è¿½è¸ª / Progress Tracking

```typescript
// lib/progress-tracker.ts

interface ProgressState {
  total: number           // æ€»ä»»åŠ¡æ•°
  completed: number       // å·²å®Œæˆæ•°
  failed: number          // å¤±è´¥æ•°
  current: string         // å½“å‰ä»»åŠ¡æè¿°
  startTime: Date         // å¼€å§‹æ—¶é—´
  lastUpdateTime: Date    // æœ€åæ›´æ–°æ—¶é—´
}

interface ProgressStats {
  percentage: number      // å®Œæˆç™¾åˆ†æ¯” 0-100
  avgTimePerTask: number  // å¹³å‡æ¯ä»»åŠ¡è€—æ—¶(ms)
  estimatedRemaining: number // é¢„ä¼°å‰©ä½™æ—¶é—´(ms)
  elapsedTime: number     // å·²ç”¨æ—¶é—´(ms)
  successRate: number     // æˆåŠŸç‡ 0-1
}

class ProgressTracker {
  private state: ProgressState
  private taskTimes: number[] = []

  constructor(total: number) {
    this.state = {
      total,
      completed: 0,
      failed: 0,
      current: '',
      startTime: new Date(),
      lastUpdateTime: new Date(),
    }
  }

  start(taskDescription: string): void {
    this.state.current = taskDescription
    this.state.lastUpdateTime = new Date()
  }

  complete(): void {
    const taskTime = Date.now() - this.state.lastUpdateTime.getTime()
    this.taskTimes.push(taskTime)
    this.state.completed++
    this.state.lastUpdateTime = new Date()
  }

  fail(): void {
    this.state.failed++
    this.state.lastUpdateTime = new Date()
  }

  getStats(): ProgressStats {
    const { total, completed, failed, startTime } = this.state
    const elapsedTime = Date.now() - startTime.getTime()

    const avgTimePerTask = this.taskTimes.length > 0
      ? this.taskTimes.reduce((a, b) => a + b, 0) / this.taskTimes.length
      : 0

    const remaining = total - completed - failed
    const estimatedRemaining = avgTimePerTask * remaining

    return {
      percentage: total > 0 ? (completed / total) * 100 : 0,
      avgTimePerTask,
      estimatedRemaining,
      elapsedTime,
      successRate: completed > 0 ? completed / (completed + failed) : 1,
    }
  }

  getState(): ProgressState {
    return { ...this.state }
  }
}
```

---

### 2. ç½‘ç»œç›‘æ§ / Network Monitoring

```typescript
// lib/network-monitor.ts

interface NetworkStats {
  downloadSpeed: number   // bytes/s
  latency: number         // ms
  successRate: number     // 0-1
  status: 'good' | 'slow' | 'poor' | 'offline'
}

interface RequestRecord {
  timestamp: number
  duration: number
  bytes: number
  success: boolean
}

class NetworkMonitor {
  private records: RequestRecord[] = []
  private windowSize = 10 // æ»‘åŠ¨çª—å£å¤§å°

  record(duration: number, bytes: number, success: boolean): void {
    this.records.push({
      timestamp: Date.now(),
      duration,
      bytes,
      success,
    })

    // ä¿æŒçª—å£å¤§å°
    if (this.records.length > this.windowSize) {
      this.records.shift()
    }
  }

  getStats(): NetworkStats {
    if (this.records.length === 0) {
      return {
        downloadSpeed: 0,
        latency: 0,
        successRate: 1,
        status: 'good',
      }
    }

    const successRecords = this.records.filter(r => r.success)
    const totalBytes = successRecords.reduce((sum, r) => sum + r.bytes, 0)
    const totalDuration = successRecords.reduce((sum, r) => sum + r.duration, 0)

    const downloadSpeed = totalDuration > 0 ? (totalBytes / totalDuration) * 1000 : 0
    const latency = successRecords.length > 0
      ? totalDuration / successRecords.length
      : 0
    const successRate = this.records.length > 0
      ? successRecords.length / this.records.length
      : 1

    return {
      downloadSpeed,
      latency,
      successRate,
      status: this.determineStatus(downloadSpeed, latency, successRate),
    }
  }

  private determineStatus(
    speed: number,
    latency: number,
    successRate: number
  ): NetworkStats['status'] {
    if (successRate < 0.5) return 'offline'
    if (successRate < 0.8 || latency > 5000) return 'poor'
    if (speed < 100 * 1024 || latency > 3000) return 'slow'  // < 100KB/s
    return 'good'
  }
}
```

---

### 3. UI ç»„ä»¶ / UI Components

```tsx
// components/ProgressBar.tsx
interface ProgressBarProps {
  percentage: number
  showLabel?: boolean
}

export function ProgressBar({ percentage, showLabel = true }: ProgressBarProps) {
  return (
    <div className="w-full">
      <div className="flex justify-between mb-1">
        {showLabel && (
          <span className="text-sm text-gray-600">è¿›åº¦</span>
        )}
        <span className="text-sm font-medium">{percentage.toFixed(1)}%</span>
      </div>
      <div className="w-full bg-gray-200 rounded-full h-2.5">
        <div
          className="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  )
}
```

```tsx
// components/TimeEstimate.tsx
interface TimeEstimateProps {
  estimatedMs: number
  elapsedMs: number
}

export function TimeEstimate({ estimatedMs, elapsedMs }: TimeEstimateProps) {
  const formatTime = (ms: number): string => {
    if (ms < 60000) return `${Math.round(ms / 1000)}ç§’`
    if (ms < 3600000) return `${Math.round(ms / 60000)}åˆ†é’Ÿ`
    return `${(ms / 3600000).toFixed(1)}å°æ—¶`
  }

  return (
    <div className="flex gap-6 text-sm">
      <div>
        <span className="text-gray-500">å·²ç”¨æ—¶é—´ï¼š</span>
        <span className="font-medium">{formatTime(elapsedMs)}</span>
      </div>
      <div>
        <span className="text-gray-500">é¢„è®¡å‰©ä½™ï¼š</span>
        <span className="font-medium text-blue-600">~{formatTime(estimatedMs)}</span>
      </div>
    </div>
  )
}
```

```tsx
// components/NetworkStatus.tsx
interface NetworkStatusProps {
  stats: NetworkStats
}

const statusConfig = {
  good: { color: 'text-green-600', bg: 'bg-green-100', icon: 'ğŸŸ¢', label: 'ç½‘ç»œæ­£å¸¸' },
  slow: { color: 'text-yellow-600', bg: 'bg-yellow-100', icon: 'ğŸŸ¡', label: 'ç½‘ç»œè¾ƒæ…¢' },
  poor: { color: 'text-red-600', bg: 'bg-red-100', icon: 'ğŸ”´', label: 'ç½‘ç»œå¼‚å¸¸' },
  offline: { color: 'text-gray-600', bg: 'bg-gray-100', icon: 'âš«', label: 'ç½‘ç»œæ–­å¼€' },
}

export function NetworkStatus({ stats }: NetworkStatusProps) {
  const config = statusConfig[stats.status]

  const formatSpeed = (bytesPerSec: number): string => {
    if (bytesPerSec < 1024) return `${bytesPerSec.toFixed(0)} B/s`
    if (bytesPerSec < 1024 * 1024) return `${(bytesPerSec / 1024).toFixed(1)} KB/s`
    return `${(bytesPerSec / 1024 / 1024).toFixed(2)} MB/s`
  }

  return (
    <div className={`p-4 rounded-lg ${config.bg}`}>
      <div className="flex items-center gap-2 mb-2">
        <span>{config.icon}</span>
        <span className={`font-medium ${config.color}`}>{config.label}</span>
      </div>
      <div className="grid grid-cols-3 gap-4 text-sm">
        <div>
          <div className="text-gray-500">ä¸‹è½½é€Ÿåº¦</div>
          <div className="font-medium">{formatSpeed(stats.downloadSpeed)}</div>
        </div>
        <div>
          <div className="text-gray-500">å»¶è¿Ÿ</div>
          <div className="font-medium">{stats.latency.toFixed(0)}ms</div>
        </div>
        <div>
          <div className="text-gray-500">æˆåŠŸç‡</div>
          <div className="font-medium">{(stats.successRate * 100).toFixed(1)}%</div>
        </div>
      </div>
    </div>
  )
}
```

---

### 4. æ•´åˆç•Œé¢ / Integrated UI

```tsx
// components/CollectionProgress.tsx
'use client'

import { useState, useEffect } from 'react'
import { ProgressBar } from './ProgressBar'
import { TimeEstimate } from './TimeEstimate'
import { NetworkStatus } from './NetworkStatus'

interface CollectionProgressProps {
  taskId: string
}

export function CollectionProgress({ taskId }: CollectionProgressProps) {
  const [progress, setProgress] = useState<ProgressStats | null>(null)
  const [network, setNetwork] = useState<NetworkStats | null>(null)
  const [currentTask, setCurrentTask] = useState('')

  useEffect(() => {
    const eventSource = new EventSource(`/api/collect/${taskId}/progress`)

    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data)
      setProgress(data.progress)
      setNetwork(data.network)
      setCurrentTask(data.currentTask)
    }

    return () => eventSource.close()
  }, [taskId])

  if (!progress) return <div>åŠ è½½ä¸­...</div>

  return (
    <div className="space-y-6 p-6 bg-white rounded-xl shadow">
      {/* æ ‡é¢˜ */}
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-semibold">é‡‡é›†è¿›åº¦</h2>
        <span className="text-sm text-gray-500">
          {progress.completed} / {progress.total} ä¸ªä»»åŠ¡
        </span>
      </div>

      {/* è¿›åº¦æ¡ */}
      <ProgressBar percentage={progress.percentage} />

      {/* æ—¶é—´é¢„ä¼° */}
      <TimeEstimate
        estimatedMs={progress.estimatedRemaining}
        elapsedMs={progress.elapsedTime}
      />

      {/* å½“å‰ä»»åŠ¡ */}
      <div className="p-3 bg-gray-50 rounded-lg">
        <div className="text-sm text-gray-500 mb-1">å½“å‰ä»»åŠ¡</div>
        <div className="font-medium truncate">{currentTask}</div>
      </div>

      {/* ç½‘ç»œçŠ¶æ€ */}
      {network && <NetworkStatus stats={network} />}

      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex gap-3">
        <button className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
          æš‚åœ
        </button>
        <button className="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
          å–æ¶ˆ
        </button>
        <button className="px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">
          æŸ¥çœ‹æ—¥å¿—
        </button>
      </div>
    </div>
  )
}
```

---

### 5. å®Œæ•´ç•Œé¢ç¤ºæ„ / Complete UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é‡‡é›†è¿›åº¦                                          150 / 200 ä¸ªä»»åŠ¡  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]  75.0%               â”‚
â”‚                                                                     â”‚
â”‚  å·²ç”¨æ—¶é—´ï¼š15åˆ†é’Ÿ              é¢„è®¡å‰©ä½™ï¼š~5åˆ†é’Ÿ                       â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å½“å‰ä»»åŠ¡                                                     â”‚   â”‚
â”‚  â”‚ æ­£åœ¨é‡‡é›†å…³é”®è¯ "Pythonæ•™ç¨‹" ç¬¬ 8 é¡µ...                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸŸ¢ ç½‘ç»œæ­£å¸¸                                                  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚ ä¸‹è½½é€Ÿåº¦          å»¶è¿Ÿ            æˆåŠŸç‡                      â”‚   â”‚
â”‚  â”‚ 1.2 MB/s         320ms           98.5%                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  [æš‚åœ]  [å–æ¶ˆ]  [æŸ¥çœ‹æ—¥å¿—]                                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¿«é€Ÿå¯¼èˆª / Quick Navigation

### æƒ³äº†è§£è¿›åº¦è¿½è¸ªé€»è¾‘ï¼Ÿ / Want progress tracking logic?
â†’ æŸ¥çœ‹ `lib/progress-tracker.ts`

### æƒ³äº†è§£ç½‘ç»œç›‘æ§ï¼Ÿ / Want network monitoring?
â†’ æŸ¥çœ‹ `lib/network-monitor.ts`

### æƒ³ä¿®æ”¹ UI ç»„ä»¶ï¼Ÿ / Want to modify UI?
â†’ æŸ¥çœ‹ `components/` ç›®å½•

### æƒ³äº†è§£é‡‡é›†æ¶æ„ï¼Ÿ / Want collection architecture?
â†’ é˜…è¯» [TD-04: RPA çŸ©é˜µæ¶æ„](./04-é‡‡ç”¨RPAå›ºåŒ–è„šæœ¬çŸ©é˜µæ¶æ„.md)

---

## æ³¨æ„äº‹é¡¹ / Notes

1. **æ€§èƒ½å¼€é”€ / Performance**ï¼šç›‘æ§ä¸åº”å½±å“é‡‡é›†æ€§èƒ½
2. **å®æ—¶æ›´æ–° / Real-time**ï¼šä½¿ç”¨ SSE æˆ– WebSocket æ¨é€
3. **çŠ¶æ€æŒä¹…åŒ– / Persistence**ï¼šæ”¯æŒé¡µé¢åˆ·æ–°åæ¢å¤
4. **é”™è¯¯å¤„ç† / Error Handling**ï¼šç½‘ç»œæ–­å¼€æ—¶ä¼˜é›…é™çº§
5. **ç”¨æˆ·åé¦ˆ / User Feedback**ï¼šå…³é”®çŠ¶æ€å˜åŒ–æ—¶æç¤º
6. **æ—¥å¿—å…³è” / Logging**ï¼šè¿›åº¦ä¸æ—¥å¿—å¯å…³è”æŸ¥çœ‹

---

## ç›¸å…³å†³ç­– / Related Decisions

| å†³ç­– / Decision | å…³ç³» / Relation |
|-----------------|-----------------|
| [TD-04](./04-é‡‡ç”¨RPAå›ºåŒ–è„šæœ¬çŸ©é˜µæ¶æ„.md) | ä¸Šæ¸¸ï¼šé‡‡é›†æ‰§è¡Œ |
| [TD-07](./07-ç¡®å®šå¤šé¡µé¢äº¤äº’ç³»ç»Ÿæ¶æ„.md) | åº”ç”¨ï¼šé‡‡é›†é¡µé¢ |

---

*æœ€åæ›´æ–° / Last Updated: 2026-01-20*
