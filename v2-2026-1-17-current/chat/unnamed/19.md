▐▛███▜▌   Claude Code v2.0.55
▝▜█████▛▘  Opus 4.5 · Claude Max
  ▘▘ ▝▝    ~/Downloads/3d_games/5-content-creation-tools/youtube-minimal-video-story/2026-1-17

> 在2026-1-17/work中写下你的采集逻辑

⏺ 我来查看当前的采集相关代码和文档，然后在 work 目录中记录采集逻辑。

⏺ Search(pattern: "work/*.md")
  ⎿  Found 44 files (ctrl+o to expand)

⏺ Search(pattern: "src/research/*.py")
  ⎿  Found 6 files (ctrl+o to expand)

⏺ Search(pattern: ".claude/skills/data-collector.md")
  ⎿  Found 1 file (ctrl+o to expand)

⏺ Read(src/research/data_collector.py)
  ⎿  Read 1069 lines

⏺ Read(src/research/yt_dlp_client.py)
  ⎿  Read 804 lines

⏺ Read(.claude/skills/data-collector.md)
  ⎿  Read 615 lines

⏺ 现在我来查看一些相关的采集指令和工作文档：

⏺ Read(work/采集指令.md)
  ⎿  Read 14 lines

⏺ Read(work/15-采用YouTube原生搜索过滤机制.md)
  ⎿  Read 404 lines

⏺ 现在我对采集逻辑有了全面理解。让我在 work 目录中创建采集逻辑文档：

⏺ Write(work/采集逻辑.md)
  ⎿  Wrote 439 lines to work/采集逻辑.md
     # YouTube 数据采集逻辑
     > 基于 `data_collector.py` 和 `yt_dlp_client.py` 的实际实现
     ---
     ## 核心架构
     ```
     ┌─────────────────────────────────────────────────────────────────┐
     … +429 lines (ctrl+o to expand)

⏺ 已在 work/采集逻辑.md 中记录了完整的采集逻辑文档，包含：

  1. 核心架构 - DataCollector → YtDlpClient → Repository 的分层结构
  2. 两阶段采集策略 - 快速搜索 + 详情补充
  3. 搜索策略 - 并行多策略搜索（播放量/相关性/日期）
  4. 时间过滤机制 - YouTube 原生 sp 参数
  5. 关键词扩展 - YouTube 搜索建议优先
  6. 大规模采集 - collect_large_scale() 流程
  7. 去重机制 - 内存 + 数据库双重去重
  8. 数据模型 - CompetitorVideo 结构
  9. 错误处理 - 重试策略、速率限制
  10. 存储层 - SQLite + Repository 接口
  11. 采集命令 - CLI 示例
  12. 性能指标 - 各操作的速度参考

> 1. 生成扩展关键词 (5-15个)
   └── _generate_keywords()请ultrathink，这个逻辑是什么？

⏺ Read(src/research/data_collector.py)
  ⎿  Read 102 lines

⏺ Read(src/research/yt_dlp_client.py)
  ⎿  Read 100 lines

⏺ _generate_keywords() 逻辑详解

  这是一个三层降级策略，确保无论网络状况如何都能获得关键词：

  ┌─────────────────────────────────────────────────────────────────┐
  │                    _generate_keywords(theme)                     │
  │                                                                  │
  │  输入: theme = "养生"                                            │
  │  输出: ["养生", "中医养生", "健康养生", ...] (5-15个)            │
  └─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 优先级 1: YouTube 搜索建议 (真实用户行为)                        │
  │                                                                  │
  │   expand_keywords_from_youtube("养生", 15)                       │
  │                     │                                            │
  │                     ▼                                            │
  │   ┌─────────────────────────────────────────────────────────┐   │
  │   │ get_youtube_suggestions("养生")                          │   │
  │   │                                                          │   │
  │   │ API: suggestqueries.google.com/complete/search           │   │
  │   │      ?client=youtube&ds=yt&q=养生                        │   │
  │   │                                                          │   │
  │   │ 返回 JSONP: window.google.ac.h([                         │   │
  │   │   "养生",                                                │   │
  │   │   [["养生堂",0], ["养生功法",0], ["养生茶",0], ...]      │   │
  │   │ ])                                                       │   │
  │   │                                                          │   │
  │   │ 解析后: ["养生堂", "养生功法", "养生茶", ...]            │   │
  │   └─────────────────────────────────────────────────────────┘   │
  │                     │                                            │
  │                     ▼                                            │
  │   ┌─────────────────────────────────────────────────────────┐   │
  │   │ 后缀扩展: 对每个后缀再获取建议                           │   │
  │   │                                                          │   │
  │   │ suffixes = ['教程', '入门', '技巧', '方法', ...]         │   │
  │   │                                                          │   │
  │   │ get_youtube_suggestions("养生教程") → [...]              │   │
  │   │ get_youtube_suggestions("养生入门") → [...]              │   │
  │   │ ...                                                      │   │
  │   │                                                          │   │
  │   │ 合并去重 → 最多 15 个                                    │   │
  │   └─────────────────────────────────────────────────────────┘   │
  │                                                                  │
  │   ✓ 成功条件: 获取 >= 5 个关键词                                │
  │   ✗ 失败条件: 网络错误 / 返回 < 5 个                            │
  └─────────────────────────────────────────────────────────────────┘
                                │
                      失败时降级 ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 优先级 2: 预定义关键词映射 (人工整理)                            │
  │                                                                  │
  │   keyword_mappings = {                                           │
  │       '养生': ['养生', '中医养生', '健康养生', '养生堂', ...],   │
  │       'AI工具': ['AI工具', 'ChatGPT', 'AI应用', ...],            │
  │       '美食': ['美食制作', '家常菜', '烹饪技巧', ...],           │
  │       ...                                                        │
  │   }                                                              │
  │                                                                  │
  │   匹配逻辑:                                                      │
  │   1. 精确匹配: theme == "养生" → 直接返回映射                    │
  │   2. 模糊匹配: "老人养生" 包含 "养生" → 返回养生的映射           │
  │                                                                  │
  │   ✓ 成功条件: 找到匹配的映射                                    │
  │   ✗ 失败条件: theme 不在映射表中                                │
  └─────────────────────────────────────────────────────────────────┘
                                │
                      失败时降级 ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 优先级 3: 默认后缀扩展 (兜底)                                    │
  │                                                                  │
  │   default_suffixes = ['教程', '入门', '技巧', '方法', ...]       │
  │                                                                  │
  │   theme = "区块链"  (不在映射表中)                               │
  │                                                                  │
  │   生成:                                                          │
  │   ["区块链", "区块链教程", "区块链入门", "区块链技巧", ...]      │
  │                                                                  │
  │   ✓ 永远成功 (兜底策略)                                         │
  └─────────────────────────────────────────────────────────────────┘

  核心设计理念

  | 优先级 | 数据来源        | 优点       | 缺点    |
  |-----|-------------|----------|-------|
  | 1   | YouTube API | 真实用户搜索行为 | 依赖网络  |
  | 2   | 预定义映射       | 人工精选，质量高 | 覆盖有限  |
  | 3   | 后缀拼接        | 永远可用     | 可能不精准 |

  为什么优先用 YouTube 搜索建议？

  # 这些是用户真正在 YouTube 搜索框输入的词
  # 比 AI 猜测的关键词更能反映真实需求

  输入: "养生"
  YouTube 返回: ["养生堂", "养生功法", "养生茶", "养生操", "养生饮食"]
                   ↑
              这些是真实用户高频搜索词

  踩坑经验: 如果 AI 随意生成关键词（如 "养生秘籍"、"养生宝典"），搜索结果可能很少，浪费采集配额。

> 补充到文档里面

⏺ Update(work/采集逻辑.md)
  ⎿  Updated work/采集逻辑.md with 144 additions and 11 removals
       162
       163    ## 关键词扩展
       164
       165 -  ### YouTube 搜索建议
       165 +  ### 三层降级策略
       166
       167 +  **位置**: `data_collector.py:286-387`
       168 +
       169 +  ```
       170 +  ┌─────────────────────────────────────────────────────────────────┐
       171 +  │                    _generate_keywords(theme)                     │
       172 +  │                                                                  │
       173 +  │  输入: theme = "养生"                                            │
       174 +  │  输出: ["养生", "中医养生", "健康养生", ...] (5-15个)            │
       175 +  └─────────────────────────────────────────────────────────────────┘
       176 +                                │
       177 +                                ▼
       178 +  ┌─────────────────────────────────────────────────────────────────┐
       179 +  │ 优先级 1: YouTube 搜索建议 (真实用户行为)                        │
       180 +  │                                                                  │
       181 +  │   expand_keywords_from_youtube("养生", 15)                       │
       182 +  │                     │                                            │
       183 +  │                     ▼                                            │
       184 +  │   ┌─────────────────────────────────────────────────────────┐   │
       185 +  │   │ get_youtube_suggestions("养生")                          │   │
       186 +  │   │                                                          │   │
       187 +  │   │ API: suggestqueries.google.com/complete/search           │   │
       188 +  │   │      ?client=youtube&ds=yt&q=养生                        │   │
       189 +  │   │                                                          │   │
       190 +  │   │ 返回 JSONP: window.google.ac.h([                         │   │
       191 +  │   │   "养生",                                                │   │
       192 +  │   │   [["养生堂",0], ["养生功法",0], ["养生茶",0], ...]      │   │
       193 +  │   │ ])                                                       │   │
       194 +  │   │                                                          │   │
       195 +  │   │ 解析后: ["养生堂", "养生功法", "养生茶", ...]            │   │
       196 +  │   └─────────────────────────────────────────────────────────┘   │
       197 +  │                     │                                            │
       198 +  │                     ▼                                            │
       199 +  │   ┌─────────────────────────────────────────────────────────┐   │
       200 +  │   │ 后缀扩展: 对每个后缀再获取建议                           │   │
       201 +  │   │                                                          │   │
       202 +  │   │ suffixes = ['教程', '入门', '技巧', '方法', ...]         │   │
       203 +  │   │                                                          │   │
       204 +  │   │ get_youtube_suggestions("养生教程") → [...]              │   │
       205 +  │   │ get_youtube_suggestions("养生入门") → [...]              │   │
       206 +  │   │ ...                                                      │   │
       207 +  │   │                                                          │   │
       208 +  │   │ 合并去重 → 最多 15 个                                    │   │
       209 +  │   └─────────────────────────────────────────────────────────┘   │
       210 +  │                                                                  │
       211 +  │   ✓ 成功条件: 获取 >= 5 个关键词                                │
       212 +  │   ✗ 失败条件: 网络错误 / 返回 < 5 个                            │
       213 +  └─────────────────────────────────────────────────────────────────┘
       214 +                                │
       215 +                      失败时降级 ▼
       216 +  ┌─────────────────────────────────────────────────────────────────┐
       217 +  │ 优先级 2: 预定义关键词映射 (人工整理)                            │
       218 +  │                                                                  │
       219 +  │   keyword_mappings = {                                           │
       220 +  │       '养生': ['养生', '中医养生', '健康养生', '养生堂', ...],   │
       221 +  │       'AI工具': ['AI工具', 'ChatGPT', 'AI应用', ...],            │
       222 +  │       '美食': ['美食制作', '家常菜', '烹饪技巧', ...],           │
       223 +  │       ...                                                        │
       224 +  │   }                                                              │
       225 +  │                                                                  │
       226 +  │   匹配逻辑:                                                      │
       227 +  │   1. 精确匹配: theme == "养生" → 直接返回映射                    │
       228 +  │   2. 模糊匹配: "老人养生" 包含 "养生" → 返回养生的映射           │
       229 +  │                                                                  │
       230 +  │   ✓ 成功条件: 找到匹配的映射                                    │
       231 +  │   ✗ 失败条件: theme 不在映射表中                                │
       232 +  └─────────────────────────────────────────────────────────────────┘
       233 +                                │
       234 +                      失败时降级 ▼
       235 +  ┌─────────────────────────────────────────────────────────────────┐
       236 +  │ 优先级 3: 默认后缀扩展 (兜底)                                    │
       237 +  │                                                                  │
       238 +  │   default_suffixes = ['教程', '入门', '技巧', '方法', ...]       │
       239 +  │                                                                  │
       240 +  │   theme = "区块链"  (不在映射表中)                               │
       241 +  │                                                                  │
       242 +  │   生成:                                                          │
       243 +  │   ["区块链", "区块链教程", "区块链入门", "区块链技巧", ...]      │
       244 +  │                                                                  │
       245 +  │   ✓ 永远成功 (兜底策略)                                         │
       246 +  └─────────────────────────────────────────────────────────────────┘
       247 +  ```
       248 +
       249 +  ### 优先级对比
       250 +
       251 +  | 优先级 | 数据来源 | 优点 | 缺点 |
       252 +  |--------|----------|------|------|
       253 +  | 1 | YouTube API | **真实用户搜索行为** | 依赖网络 |
       254 +  | 2 | 预定义映射 | 人工精选，质量高 | 覆盖有限 |
       255 +  | 3 | 后缀拼接 | 永远可用 | 可能不精准 |
       256 +
       257 +  ### 为什么优先用 YouTube 搜索建议？
       258 +
       259 +  ```python
       260 +  # 这些是用户真正在 YouTube 搜索框输入的词
       261 +  # 比 AI 猜测的关键词更能反映真实需求
       262 +
       263 +  输入: "养生"
       264 +  YouTube 返回: ["养生堂", "养生功法", "养生茶", "养生操", "养生饮食"]
       265 +                   ↑
       266 +              这些是真实用户高频搜索词
       267 +  ```
       268 +
       269 +  **踩坑经验**: 如果 AI 随意生成关键词（如
           + "养生秘籍"、"养生宝典"），搜索结果可能很少，浪费采集配额。
       270 +
       271 +  ### YouTube 搜索建议 API
       272 +
       273    **位置**: `yt_dlp_client.py:678-772`
       274
       275    ```python
     ...
       171        """
       172        从 YouTube 搜索建议获取真实用户高频词
       173
       174 -      API: https://suggestqueries.google.com/complete/search?client=youtube&ds=yt&q={keyword}
       174 +      API: https://suggestqueries.google.com/complete/search
       175 +           ?client=youtube&ds=yt&q={keyword}
       176 +
       177 +      返回 JSONP 格式，需解析
       178        """
       179
       180    def expand_keywords_from_youtube(seed_keyword: str, max_keywords: int = 15) -> List[str]:
     ...
       179        基于种子关键词扩展:
       180        1. 直接获取建议
       181        2. 添加后缀扩展 (教程、入门、技巧...)
       182 +      3. 去重合并
       183        """
       184    ```
       185
       186    ### 预定义关键词映射
       187
       188 -  **位置**: `data_collector.py:314-387`
       188 +  **位置**: `data_collector.py:314-362`
       189
       190    ```python
       191    keyword_mappings = {
       192 -      '养生': ['养生', '中医养生', '健康养生', '养生堂', ...],
       193 -      'AI工具': ['AI工具', 'ChatGPT', 'AI应用', ...],
       194 -      '美食': ['美食制作', '家常菜', '烹饪技巧', ...],
       195 -      # ... 更多映射
       192 +      # 养生相关
       193 +      '养生': ['养生', '中医养生', '健康养生', '养生堂', '养生食谱', ...],
       194 +      '老人养生': ['中医养生', '健康科普', '长寿秘诀', ...],
       195 +
       196 +      # AI 相关
       197 +      'AI工具': ['AI工具', 'ChatGPT', 'AI应用', 'Claude', 'Midjourney', ...],
       198 +
       199 +      # 美食相关
       200 +      '美食': ['美食制作', '家常菜', '烹饪技巧', '美食vlog', ...],
       201 +
       202 +      # 健身相关
       203 +      '健身': ['健身教程', '减肥健身', '居家健身', '瑜伽教程', ...],
       204 +
       205 +      # 编程相关
       206 +      'Python': ['Python教程', 'Python入门', 'Python爬虫', ...],
       207 +
       208 +      # 自媒体相关
       209 +      'YouTube': ['YouTube运营', 'YouTube涨粉', 'YouTube变现', ...],
       210 +
       211 +      # ... 更多领域
       212    }
       213    ```
       214
       215 -  **优先级**:
       216 -  1. YouTube 搜索建议 (真实用户行为)
       217 -  2. 预定义映射 (兜底)
       218 -  3. 默认后缀扩展 (最后手段)
       215 +  ### 默认后缀扩展
       216
       217 +  **位置**: `data_collector.py:377-387`
       218 +
       219 +  ```python
       220 +  default_suffixes = ['教程', '入门', '技巧', '方法', '推荐', '攻略',
       221 +                     '2025', '怎么', '如何', '最新']
       222 +
       223 +  # 示例: theme = "区块链"
       224 +  # 生成: ["区块链", "区块链教程", "区块链入门", "区块链技巧", ...]
       225 +  ```
       226 +
       227    ---
       228
       229    ## 大规模采集

⏺ 已将关键词扩展的三层降级策略详细补充到文档中，包括：

  1. 完整流程图 - 展示三层降级的决策流程
  2. 优先级对比表 - 对比各层的优缺点
  3. 设计理念 - 解释为什么优先用 YouTube 搜索建议
  4. 踩坑经验 - AI 随意生成关键词的问题
  5. 各层代码位置 - 方便后续查找

> 请ultrathink，/Users/su/Downloads/3d_games/5-content-creation-tools/youtube-minimal-video-story/2026-1-17/work/采集逻辑. 
md这里有写到如何从数据库中选取高频标签进行搜索的逻辑吗？

⏺ 让我先检查文档的完整内容，以及查看实际的脚本实现：

⏺ Search(pattern: "scripts/collect_from_tags.py")
  ⎿  Found 1 file (ctrl+o to expand)

⏺ Read(work/采集逻辑.md)
  ⎿  Read 50 lines

⏺ Read(scripts/collect_from_tags.py)
  ⎿  Read 235 lines

⏺ 文档中只有概述，没有详细的实现逻辑。让我把 get_high_freq_tags() 的核心逻辑补充进去：

⏺ Update(work/采集逻辑.md)
  ⎿  Updated work/采集逻辑.md with 107 additions
       645    └─────────────────────────────────────────────────────────────┘
       646    ```
       647
       648 +  ### 核心函数: `get_high_freq_tags()`
       649 +
       650 +  **位置**: `scripts/collect_from_tags.py:33-110`
       651 +
       652 +  ```
       653 +  ┌─────────────────────────────────────────────────────────────────┐
       654 +  │                get_high_freq_tags(theme, min_count, top_n)       │
       655 +  │                                                                  │
       656 +  │  输入: theme="养生", min_count=10, top_n=30                      │
       657 +  │  输出: [("中老年", 48), ("中医药", 35), ("穴位", 28), ...]       │
       658 +  └─────────────────────────────────────────────────────────────────┘
       659 +                                │
       660 +                                ▼
       661 +  ┌─────────────────────────────────────────────────────────────────┐
       662 +  │ Step 1: 获取已有关键词（避免重复采集）                           │
       663 +  │                                                                  │
       664 +  │   SELECT DISTINCT keyword_source FROM competitor_videos          │
       665 +  │   WHERE theme = '养生'                                           │
       666 +  │                                                                  │
       667 +  │   → existing_keywords = {"养生", "中医养生", "健康养生", ...}    │
       668 +  └─────────────────────────────────────────────────────────────────┘
       669 +                                │
       670 +                                ▼
       671 +  ┌─────────────────────────────────────────────────────────────────┐
       672 +  │ Step 2: 获取所有视频的 tags 字段                                 │
       673 +  │                                                                  │
       674 +  │   SELECT tags FROM competitor_videos                             │
       675 +  │   WHERE theme = '养生' AND tags IS NOT NULL                      │
       676 +  │                                                                  │
       677 +  │   tags 格式:                                                     │
       678 +  │   - JSON: '["中老年", "穴位", "经络"]'                           │
       679 +  │   - 逗号分隔: "中老年,穴位,经络"                                 │
       680 +  └─────────────────────────────────────────────────────────────────┘
       681 +                                │
       682 +                                ▼
       683 +  ┌─────────────────────────────────────────────────────────────────┐
       684 +  │ Step 3: 解析并统计频次                                           │
       685 +  │                                                                  │
       686 +  │   tag_counter = Counter()                                        │
       687 +  │                                                                  │
       688 +  │   for tags_str in all_tags:                                      │
       689 +  │       tags = json.loads(tags_str)  # 或按逗号分割                │
       690 +  │       for tag in tags:                                           │
       691 +  │           if 2 <= len(tag) <= 10:  # 长度过滤                    │
       692 +  │               tag_counter[tag] += 1                              │
       693 +  │                                                                  │
       694 +  │   结果: {"中老年": 48, "穴位": 35, "经络": 28, "健康": 120, ...} │
       695 +  └─────────────────────────────────────────────────────────────────┘
       696 +                                │
       697 +                                ▼
       698 +  ┌─────────────────────────────────────────────────────────────────┐
       699 +  │ Step 4: 多层过滤                                                 │
       700 +  │                                                                  │
       701 +  │   for tag, count in tag_counter.most_common(200):                │
       702 +  │                                                                  │
       703 +  │       # 过滤1: 跳过已有关键词                                    │
       704 +  │       if tag in existing_keywords: continue                      │
       705 +  │                                                                  │
       706 +  │       # 过滤2: 跳过英文词                                        │
       707 +  │       exclude = ['health', 'tips', 'care', 'advice']             │
       708 +  │       if any(p in tag.lower() for p in exclude): continue        │
       709 +  │                                                                  │
       710 +  │       # 过滤3: 跳过太通用的词                                    │
       711 +  │       generic = {'健康', '中医', '养生', '疾病', '视频', ...}    │
       712 +  │       if tag in generic: continue                                │
       713 +  │                                                                  │
       714 +  │       # 过滤4: 最小出现次数                                      │
       715 +  │       if count < min_count: continue                             │
       716 +  │                                                                  │
       717 +  │       result.append((tag, count))                                │
       718 +  │       if len(result) >= top_n: break                             │
       719 +  └─────────────────────────────────────────────────────────────────┘
       720 +                                │
       721 +                                ▼
       722 +  ┌─────────────────────────────────────────────────────────────────┐
       723 +  │ 输出: 高质量新关键词列表                                         │
       724 +  │                                                                  │
       725 +  │   [("中老年", 48), ("中医药", 35), ("穴位", 28),                 │
       726 +  │    ("经络养生", 25), ("失眠", 22), ("血压", 20), ...]            │
       727 +  │                                                                  │
       728 +  │   特点:                                                          │
       729 +  │   - 来自真实视频标签（不是 AI 猜测）                             │
       730 +  │   - 高频出现（说明用户关注）                                     │
       731 +  │   - 排除已采集的（避免重复）                                     │
       732 +  │   - 排除太通用的（提高精准度）                                   │
       733 +  └─────────────────────────────────────────────────────────────────┘
       734 +  ```
       735 +
       736 +  ### 过滤规则详解
       737 +
       738 +  | 过滤类型 | 规则 | 示例 |
       739 +  |----------|------|------|
       740 +  | 长度限制 | 2-10 字符 | 排除 "a"、"超长的标签名称..." |
       741 +  | 已有关键词 | 在 keyword_source 中 | 排除 "养生"、"中医养生" |
       742 +  | 英文词 | 包含 health/tips/care | 排除 "health tips" |
       743 +  | 通用词 | 硬编码列表 | 排除 "健康"、"视频"、"分享" |
       744 +  | 最小频次 | >= min_count | 排除出现 < 10 次的 |
       745 +
       746 +  ### 通用词过滤列表
       747 +
       748 +  ```python
       749 +  generic_words = {
       750 +      '健康', '中医', '养生', '疾病', '保健', '视频', '频道',
       751 +      '中国', '台湾', '生活', '日常', '分享', '推荐',
       752 +  }
       753 +  ```
       754 +
       755    ### 为什么有效？
       756
       757    1. **关键词更精准** - 来自实际视频标签，不是凭空猜测

⏺ 已补充 get_high_freq_tags() 的详细实现逻辑，包括：

  1. 四步流程图 - 从获取已有关键词到最终输出
  2. 过滤规则表格 - 五种过滤类型及示例
  3. 通用词过滤列表 - 硬编码的排除词
  4. SQL 查询 - 实际的数据库查询语句
  5. 数据格式说明 - JSON 和逗号分隔两种 tags 格式的处理
