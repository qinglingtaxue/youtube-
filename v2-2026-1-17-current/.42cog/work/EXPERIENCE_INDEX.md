# 经验索引

> 这里记录了踩过的坑和积累的经验。
> 做决策时可以翻翻，看看有没有相关参考。
> 踩了新坑，记得更新。

---

## 什么时候查这份文档

```
默认：不看，直接动手

触发查阅：
├── 踩坑了 → 查文档看是否已有经验
├── 不确定 → 查文档看有没有相关思考
├── 重大决策 → 查文档做参考
└── 新领域 → 查文档找入门点
```

---

## 经验分类

### 持久化相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| 重启数据丢了 | 需要持久化吗？存内存还是存文件/数据库？ |
| 中断后要重来 | 需要断点恢复吗？进度存哪里？ |
| 改配置要改代码 | 配置应该外置吗？ |
| 日志查不到历史 | 关键操作有日志吗？ |

### 架构演进相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| 加功能改很多文件 | 模块边界清晰吗？ |
| 改了这里那里也坏 | 依赖是单向的吗？ |
| 想换个库太难 | 接口有抽象吗？ |
| 代码越来越乱 | 以后会变复杂吗？现在的设计能适应吗？ |

### 成本控制相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| 太贵了（token 消耗高） | AI 在循环里吗？应该只在入口 |
| 太慢了 | 哪些逻辑可以固化成脚本？ |
| 不稳定 | 有验收机制吗？ |
| 额度用完被中断 | 考虑过使用额度限制吗？ |

> 参考决策文档：`2026-01-09-决策-为什么放弃纯Playwright采用综合模式.md`

### 需求理解相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| 不是用户要的 | 需求确认了吗？有模糊的地方要先问 |
| 改来改去浪费时间 | 我真的理解需求了吗？ |
| 格式不对要重新处理 | 输入输出契约定了吗？ |
| 做的是一次性的但按长期做了 | 这是一次性任务还是要长期运行？ |

### 第三方集成相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| Schema 不对，集成失败 | 查官方文档了吗？不要猜 |
| 自己写的不如官方工具 | 有官方 CLI 吗？优先用 CLI 生成 |
| API 行为和预期不符 | 试过了吗？还是在假设？ |

> 参考决策文档：`tech-decisions.md`（Better Auth 踩坑记录）

### Skill/插件相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| 创建了 skill 但 Claude 不会自动调用 | skill 注册到 CLAUDE.md 了吗？ |
| prompts 里引用的 skill 不存在 | `.claude/skills/` 目录里有对应文件吗？ |

> **创建 skill 后必须**：在 `CLAUDE.md` 的「Skill 调用规则」表格里注册

### RPA/自动化相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| RPA 报成功但实际失败 | 有验收机制吗？（文件检测即可） |
| 页面变了脚本失效 | 元素定位稳定吗？ |
| 隐藏元素点不到 | 需要 hover 才显示吗？ |

> 参考决策文档：`2026-01-09-决策-为什么放弃纯Playwright采用综合模式.md`

### 数据分析相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| 发现的"规律"是伪相关 | 排除了混杂变量吗？有因果链吗？ |
| 单一领域结论被推广 | 跨领域验证了吗？样本有偏差吗？ |
| 样本量不足结论不稳定 | N是多少？置信区间是多少？ |
| 常识性结论无价值 | 这个发现反直觉吗？有趣度多少？ |
| 结论无法操作 | 能直接指导行动吗？ |
| 评估标准不一致 | 用什么公式评估？参考TD-16 |
| CPM/外部数据来源不明 | 数据来自哪里？交叉验证了吗？ |

> 参考决策文档：
> - `work/16-有趣度评估框架设计.md` - 评估模式价值
> - `work/17-跨语言套利空间计算方法.md` - 计算跨境价值
> - `work/18-外部CPM数据引入.md` - CPM数据来源

### 可视化/图表相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| 频道数据有重复 | 渲染前按channel_id去重了吗？ |
| 图表类型选错 | 用户要的是散点图、折线图还是柱状图？先确认 |
| X/Y轴搞反 | 横坐标和纵坐标分别代表什么？先问清楚 |
| 分布曲线≠散点分布 | 排序后的曲线vs原始散点，用户要哪个？ |
| 聚合统计≠精细展示 | 用户要看区间统计还是每个数据点？ |
| 图例重复显示 | Chart.js自动图例+HTML图例，会重复 |
| **趋势图加了不相关维度** | "播放量趋势"不需要按内容类型分类 |
| **分布图含义搞错** | "频道粉丝分布"是频道数量分布，不是订阅vs播放关系 |
| **无数据时显示空图** | 没有数据时应该显示"缺少xx数据"提示 |

> **图表需求确认清单**：
> 1. X轴是什么？Y轴是什么？
> 2. 每个点代表什么？（一个频道？一个区间？）
> 3. 需要排序吗？按什么排序？
> 4. 需要聚合统计还是原始数据展示？
> 5. **当前是什么阶段？（设计验证/准确性校验/压力测试）**
> 6. **无数据时如何处理？**

### 数据阶段相关（2026-01-28 新增）

| 踩过的坑 | 事先可问 |
|----------|----------|
| **阶段混淆：该用真实数据时用了模拟数据** | 当前是设计验证、准确性校验、还是压力测试？ |
| 设计阶段用真实数据浪费时间 | 只是看布局效果吗？模拟数据够用 |
| 准确性校验用模拟数据无法验证 | 需要验证业务逻辑吗？必须用真实数据 |
| 压力测试数据分布不真实 | 先统计真实数据分布，再按分布生成 |

> **数据阶段判断清单**：
> 1. **设计验证**（信号词：效果、布局、UI、原型）→ 模拟数据 OK，结构必须对
> 2. **准确性校验**（信号词：验证、检查、真实、数据对不对）→ 必须真实数据
> 3. **压力测试**（信号词：性能、扩展、大量、未来）→ 基于真实分布生成
> 4. **不确定时**：默认准确性校验，或问用户
>
> **核心原则**：模拟数据不是禁区，错用阶段才是问题。

### 定时任务/自动化相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| launchd任务不生效 | plist复制到~/Library/LaunchAgents了吗？launchctl load了吗？ |
| plist路径拼写错误 | 检查路径是否正确，特别是长路径 |
| 凌晨任务跳过 | 电脑那时候开着吗？改成白天时间 |
| 采集日期≠发布日期 | collected_at是采集时间，published_at是发布时间 |

> **launchd 检查清单**：
> 1. plist 在 `~/Library/LaunchAgents/` 吗？
> 2. `launchctl list | grep xxx` 能看到吗？
> 3. 路径拼写都正确吗？
> 4. 执行时间电脑会开着吗？

### 数据采集相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| 关键词太少数据不够 | 5个关键词不够，需要65+个覆盖各细分领域 |
| 时间过滤只是动画 | 切换时间范围后数据真的变了吗？ |
| 新视频播放量低 | 刚发布的视频播放量自然低，不是bug |

> **数据量检查**：
> - 核心词 + 长尾词 + 繁体词 应该有 50+ 个关键词
> - 配置文件在 `config/keywords/*.json`

### 文档同步相关

| 踩过的坑 | 事先可问 |
|----------|----------|
| 代码改了但文档没改 | 改了输出格式后，spec 文档更新了吗？ |
| 多处文档描述不一致 | 相关文档都检查了吗？(pipeline/userstory/pr/sys.spec) |
| 验收标准过时导致验收失败 | 验收标准与实际实现一致吗？ |

> **功能变更后必须同步的文档**：
> - `pipeline.spec.md` - 输出契约、后置检查
> - `userstory.spec.md` - 验收标准
> - `pr.spec.md` - 功能描述
> - `sys.spec.md` - 模块规约

### Cog 认知模型同步相关（2026-02-01 新增）

| 踩过的坑 | 事先可问 |
|----------|----------|
| 新增的类/实体没记录到 cog.md | 运行 `python scripts/sync_cog_from_code.py --mode=check` 了吗？ |
| 同步脚本报"过时实体"但不该删除 | 是业务概念（如 ContentQuadrant）还是代码实现？业务概念不需要代码实现 |
| 同步脚本误判文档结构为实体 | 脚本会把"核心属性"等词误判，需要人工区分 |
| cog.md 太长不便维护 | 按层次分：业务概念层、代码实现层、便捷函数层 |

> **Cog 同步检查清单**：
> 1. 业务概念实体（ContentQuadrant, InsightCard 等）→ 不需要代码实现
> 2. 代码实现实体（DataCollector, YtDlpClient 等）→ 需要记录到"代码实现层"
> 3. 枚举类型（VideoStatus, Stage 等）→ 记录到"枚举类型定义"
> 4. 便捷函数 → 记录到"便捷函数索引"
>
> **同步命令**：
> - `--mode=check`：只检查差异
> - `--mode=suggest`：生成更新建议
> - `--mode=full`：完整同步

---

## 什么时候不需要查

```
✓ 熟悉的小改动 → 直接做
✓ 一次性脚本 → 直接做
✓ 探索性尝试 → 先试再说
✓ 成本极低的操作 → 直接做
✓ 模式已知的任务 → 按模板执行
```

---

## 判断要不要前置思考

```
返工成本 = 代码量 × 依赖深度 × 影响范围 × 维护周期

四项都低 → 直接动手
任一项高 → 考虑查查这份文档
```

---

## 如何更新这份文档

```
踩了新坑 → 加到对应分类
发现更好的实践 → 更新原有条目
某条目不再适用 → 删除或标记过时
重大决策 → 单独写决策文档，这里加引用
```

小变化：直接改，git commit
大决策：写 `YYYY-MM-DD-决策-简要描述.md`

---

## 相关决策文档

| 文档 | 内容 |
|------|------|
| `2026-01-09-决策-为什么放弃纯Playwright采用综合模式.md` | Playwright vs RPA 的取舍 |
| `tech-decisions.md` | 技术选型和踩坑记录 |
| `关键决策参考.md` | 项目架构决策 |

---

*最后更新：2026-02-01*
