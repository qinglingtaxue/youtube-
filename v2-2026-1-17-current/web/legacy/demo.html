<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 内容助手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            line-height: 1.6;
            color: #e2e8f0;
            background: #0f172a;
            min-height: 100vh;
        }

        /* 顶部导航 */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #0f172a;
            border-bottom: 1px solid #1e293b;
            padding: 12px 24px;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-brand {
            font-size: 1.1em;
            font-weight: 600;
            color: #06b6d4;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 4px;
        }

        .nav-link {
            padding: 8px 14px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .nav-link:hover, .nav-link.active {
            color: #e2e8f0;
            background: #1e293b;
        }

        /* 主内容区 - 左右分栏 */
        .app-container {
            padding-top: 56px;
            display: flex;
            min-height: 100vh;
        }

        /* 左侧边栏 - 导航和诊断 */
        .sidebar {
            width: 280px;
            background: #1e293b;
            border-right: 1px solid #334155;
            padding: 20px;
            position: fixed;
            left: 0;
            top: 56px;
            bottom: 0;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 28px;
        }

        .sidebar-title {
            font-size: 0.75em;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 12px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-item:hover {
            background: #334155;
            color: #e2e8f0;
        }

        .sidebar-item.active {
            background: #06b6d4;
            color: #0f172a;
        }

        .sidebar-item .icon {
            width: 20px;
            text-align: center;
        }

        .sidebar-item .badge {
            margin-left: auto;
            background: #334155;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .sidebar-item.active .badge {
            background: rgba(0,0,0,0.2);
        }

        /* 诊断卡片 */
        .diagnose-card {
            background: linear-gradient(135deg, #164e63, #1e3a5f);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .diagnose-card h4 {
            color: #22d3ee;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .diagnose-card p {
            color: #94a3b8;
            font-size: 0.8em;
            margin-bottom: 12px;
        }

        .diagnose-input {
            width: 100%;
            padding: 10px 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .diagnose-input:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .diagnose-btn {
            width: 100%;
            padding: 10px;
            background: #06b6d4;
            color: #0f172a;
            border: none;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
        }

        .diagnose-btn:hover {
            background: #22d3ee;
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 24px 32px;
            max-width: calc(100% - 280px);
        }

        /* 搜索框 */
        .search-header {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .search-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .search-input {
            flex: 1;
            padding: 14px 18px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 10px;
            color: white;
            font-size: 1em;
        }

        .search-input:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .search-btn {
            padding: 14px 28px;
            background: #06b6d4;
            color: #0f172a;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .search-btn:hover {
            background: #22d3ee;
        }

        .search-btn:disabled {
            background: #334155;
            color: #64748b;
            cursor: not-allowed;
        }

        .search-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .preset-label {
            color: #64748b;
            font-size: 0.85em;
        }

        .preset-tag {
            padding: 6px 12px;
            background: #334155;
            color: #94a3b8;
            border: none;
            border-radius: 16px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .preset-tag:hover {
            background: #475569;
            color: white;
        }

        /* 信息边界卡片 */
        .boundary-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .boundary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .boundary-title {
            font-size: 1em;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .boundary-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #06b6d4;
        }

        .stat-label {
            font-size: 0.75em;
            color: #64748b;
            margin-top: 4px;
        }

        /* AI 洞察 */
        .ai-insight {
            background: linear-gradient(135deg, #164e63, #1e3a5f);
            border: 1px solid #06b6d4;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .ai-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
        }

        .ai-label {
            font-size: 0.8em;
            color: #06b6d4;
            font-weight: 600;
        }

        .ai-content {
            color: #e2e8f0;
            font-size: 0.95em;
            line-height: 1.8;
        }

        .ai-content strong {
            color: #22d3ee;
        }

        .ai-content p {
            margin-bottom: 10px;
        }

        /* 标签页 */
        .tabs {
            display: flex;
            gap: 4px;
            background: #1e293b;
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            color: #94a3b8;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #e2e8f0;
        }

        .tab.active {
            background: #06b6d4;
            color: #0f172a;
            font-weight: 600;
        }

        /* 内容面板 */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* 榜单区域 */
        .ranking-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .ranking-header {
            padding: 16px 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ranking-title {
            font-size: 1em;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ranking-count {
            font-size: 0.8em;
            color: #64748b;
            background: #334155;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .ranking-filters {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 6px 12px;
            background: #334155;
            color: #94a3b8;
            border: none;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #475569;
            color: white;
        }

        /* 榜单列表 */
        .ranking-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.2s;
        }

        .ranking-item:hover {
            background: #334155;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .rank-number {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0f172a; }
        .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #0f172a; }
        .rank-3 { background: linear-gradient(135deg, #cd7c32, #b8860b); color: #0f172a; }
        .rank-normal { background: #334155; color: #94a3b8; }

        .rank-thumb {
            width: 80px;
            height: 45px;
            background: #334155;
            border-radius: 6px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .rank-info {
            flex: 1;
            min-width: 0;
        }

        .rank-title {
            font-size: 0.9em;
            color: white;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .rank-meta {
            font-size: 0.8em;
            color: #64748b;
            display: flex;
            gap: 12px;
        }

        .rank-stats {
            display: flex;
            gap: 20px;
            flex-shrink: 0;
        }

        .rank-stat {
            text-align: right;
        }

        .rank-stat-value {
            font-size: 0.95em;
            font-weight: 600;
            color: white;
        }

        .rank-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        .rank-score {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .score-s { background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; }
        .score-a { background: linear-gradient(135deg, #059669, #10b981); color: white; }
        .score-b { background: linear-gradient(135deg, #0891b2, #06b6d4); color: white; }
        .score-c { background: linear-gradient(135deg, #d97706, #f59e0b); color: #0f172a; }

        /* Top 3 表格样式 */
        .top3-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .top3-table th {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            border-bottom: 1px solid #334155;
        }

        .top3-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .top3-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #1e293b;
            color: #e2e8f0;
            vertical-align: middle;
        }

        .top3-table tr:last-child td {
            border-bottom: none;
        }

        .top3-table tr:hover td {
            background: rgba(59, 130, 246, 0.08);
        }

        .top3-table .rank-cell {
            text-align: center;
            font-weight: 700;
            color: #fbbf24;
        }

        .top3-table tr:nth-child(2) .rank-cell {
            color: #94a3b8;
        }

        .top3-table tr:nth-child(3) .rank-cell {
            color: #cd7c32;
        }

        .top3-table .video-link,
        .top3-table .channel-link {
            color: #60a5fa;
            text-decoration: none;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .top3-table .video-link:hover,
        .top3-table .channel-link:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        .top3-table .video-title-cell {
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .top3-table .channel-cell {
            color: #22d3ee;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .top3-table .views-cell {
            color: #4ade80;
            font-weight: 600;
            text-align: right;
            white-space: nowrap;
        }

        .top3-table .duration-cell {
            color: #94a3b8;
            text-align: right;
            white-space: nowrap;
        }

        .top3-table .subs-cell {
            color: #f472b6;
            text-align: right;
            white-space: nowrap;
        }

        .top3-table .video-count-cell {
            color: #a78bfa;
            text-align: right;
            white-space: nowrap;
        }

        /* 频道卡片 */
        .channel-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .channel-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
        }

        .channel-header:hover {
            background: #334155;
        }

        .channel-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-size: 1em;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .channel-meta {
            font-size: 0.85em;
            color: #64748b;
        }

        .channel-stats {
            display: flex;
            gap: 24px;
        }

        .channel-stat {
            text-align: center;
        }

        .channel-stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #06b6d4;
        }

        .channel-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        .channel-toggle {
            color: #64748b;
            font-size: 1.2em;
        }

        .channel-videos {
            display: none;
            padding: 0 20px 16px;
            border-top: 1px solid #334155;
        }

        .channel-videos.open {
            display: block;
        }

        .channel-video-list {
            padding-top: 16px;
        }

        .channel-video-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #0f172a;
        }

        .channel-video-item:hover {
            background: #334155;
        }

        .video-thumb-small {
            width: 64px;
            height: 36px;
            background: #334155;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .video-info-small {
            flex: 1;
            min-width: 0;
        }

        .video-title-small {
            font-size: 0.85em;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .video-meta-small {
            font-size: 0.75em;
            color: #64748b;
        }

        /* 地区分布 */
        .region-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .region-card {
            background: #0f172a;
            border-radius: 10px;
            padding: 16px;
        }

        .region-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .region-flag {
            font-size: 1.5em;
        }

        .region-name {
            font-weight: 600;
            color: white;
        }

        .region-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .region-stat {
            text-align: center;
        }

        .region-stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #06b6d4;
        }

        .region-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        .region-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
        }

        .region-bar-fill {
            height: 100%;
            border-radius: 3px;
        }

        .competition-low { background: #10b981; }
        .competition-medium { background: #f59e0b; }
        .competition-high { background: #ef4444; }

        /* 时间分析 */
        .time-chart {
            padding: 20px;
        }

        .time-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .time-label {
            width: 100px;
            font-size: 0.85em;
            color: #94a3b8;
        }

        .time-bar-container {
            flex: 1;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .time-bar {
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding-left: 8px;
            font-size: 0.8em;
            color: white;
            font-weight: 600;
        }

        .time-meta {
            width: 80px;
            text-align: right;
            font-size: 0.8em;
            color: #64748b;
        }

        /* 诊断结果 */
        .diagnose-result {
            display: none;
        }

        .diagnose-result.show {
            display: block;
        }

        .diagnose-summary {
            background: linear-gradient(135deg, #164e63, #1e3a5f);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .diagnose-channel {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .diagnose-channel-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .diagnose-channel-info h3 {
            color: white;
            font-size: 1.2em;
        }

        .diagnose-channel-info p {
            color: #94a3b8;
            font-size: 0.9em;
        }

        .diagnose-scores {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .diagnose-score {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .diagnose-score-value {
            font-size: 1.5em;
            font-weight: 700;
        }

        .diagnose-score-label {
            font-size: 0.75em;
            color: #64748b;
        }

        .recommend-channels {
            margin-top: 20px;
        }

        .recommend-title {
            font-size: 0.9em;
            color: #94a3b8;
            margin-bottom: 12px;
        }

        .recommend-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recommend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
        }

        .recommend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommend-info {
            flex: 1;
        }

        .recommend-name {
            font-weight: 600;
            color: white;
            font-size: 0.9em;
        }

        .recommend-reason {
            font-size: 0.8em;
            color: #64748b;
        }

        .recommend-match {
            padding: 4px 10px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        /* 分析状态 */
        .analysis-status {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: none;
        }

        .analysis-status.show {
            display: block;
        }

        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .status-title {
            font-weight: 600;
            color: white;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-badge.running {
            background: #06b6d4;
            color: #0f172a;
        }

        .status-badge.done {
            background: #10b981;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #06b6d4, #8b5cf6);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .progress-fill.done {
            background: #10b981;
        }

        .status-log {
            color: #64748b;
            font-size: 0.85em;
        }

        /* 加载更多 */
        .load-more {
            text-align: center;
            padding: 16px;
        }

        .load-more-btn {
            padding: 10px 24px;
            background: #334155;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .load-more-btn:hover {
            background: #475569;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.1em;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        /* 视频分析卡片 */
        .video-analysis-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .video-analysis-header {
            padding: 16px 20px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            cursor: pointer;
        }

        .video-analysis-header:hover {
            background: #334155;
        }

        .video-analysis-thumb {
            width: 160px;
            height: 90px;
            background: #334155;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }

        .video-analysis-info {
            flex: 1;
            min-width: 0;
        }

        .video-analysis-title {
            font-size: 1em;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-analysis-meta {
            font-size: 0.85em;
            color: #64748b;
            margin-bottom: 8px;
        }

        .video-analysis-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .video-tag {
            padding: 4px 10px;
            background: #334155;
            color: #94a3b8;
            border-radius: 12px;
            font-size: 0.75em;
        }

        .video-tag.highlight {
            background: #059669;
            color: white;
        }

        .video-analysis-stats {
            display: flex;
            gap: 24px;
            flex-shrink: 0;
        }

        .video-analysis-stat {
            text-align: center;
        }

        .video-analysis-stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #06b6d4;
        }

        .video-analysis-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        .video-analysis-toggle {
            color: #64748b;
            font-size: 1.2em;
            padding: 8px;
        }

        .video-analysis-details {
            display: none;
            padding: 0 20px 20px;
            border-top: 1px solid #334155;
        }

        .video-analysis-details.open {
            display: block;
        }

        .analysis-section {
            padding: 16px 0;
            border-bottom: 1px solid #334155;
        }

        .analysis-section:last-child {
            border-bottom: none;
        }

        .analysis-section-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .analysis-metric {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .analysis-metric-value {
            font-size: 1.2em;
            font-weight: 700;
            color: white;
        }

        .analysis-metric-label {
            font-size: 0.75em;
            color: #64748b;
            margin-top: 4px;
        }

        .analysis-insight {
            background: #0f172a;
            border-radius: 8px;
            padding: 14px;
            font-size: 0.9em;
            color: #94a3b8;
            line-height: 1.6;
        }

        .analysis-insight strong {
            color: #06b6d4;
        }

        /* 频道榜单项 */
        .channel-ranking-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.2s;
        }

        .channel-ranking-item:hover {
            background: #334155;
        }

        .channel-ranking-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .channel-ranking-info {
            flex: 1;
            min-width: 0;
        }

        .channel-ranking-name {
            font-size: 0.95em;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .channel-ranking-meta {
            font-size: 0.8em;
            color: #64748b;
        }

        .channel-ranking-stats {
            display: flex;
            gap: 24px;
            flex-shrink: 0;
        }

        .channel-ranking-stat {
            text-align: right;
        }

        .channel-ranking-stat-value {
            font-size: 0.95em;
            font-weight: 600;
            color: white;
        }

        .channel-ranking-stat-label {
            font-size: 0.7em;
            color: #64748b;
        }

        /* 筛选器区域 */
        .filters-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #334155;
        }

        .filters-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
            font-size: 0.85em;
            cursor: pointer;
            padding: 8px 0;
        }

        .filters-toggle:hover {
            color: #e2e8f0;
        }

        .filters-toggle .arrow {
            transition: transform 0.2s;
        }

        .filters-toggle.open .arrow {
            transform: rotate(180deg);
        }

        .filters-content {
            display: none;
            padding-top: 16px;
        }

        .filters-content.show {
            display: block;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .filter-group {
            background: #0f172a;
            border-radius: 10px;
            padding: 14px;
        }

        .filter-label {
            font-size: 0.8em;
            color: #64748b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .filter-select:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .filter-range {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-range input {
            flex: 1;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            width: 100%;
        }

        .filter-range input:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .filter-range span {
            color: #64748b;
            font-size: 0.9em;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-chip {
            padding: 8px 14px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 20px;
            color: #94a3b8;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            border-color: #06b6d4;
            color: #e2e8f0;
        }

        .filter-chip.active {
            background: #06b6d4;
            border-color: #06b6d4;
            color: #0f172a;
        }

        .filters-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #334155;
        }

        .filter-reset-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.9em;
            cursor: pointer;
        }

        .filter-reset-btn:hover {
            border-color: #64748b;
            color: #e2e8f0;
        }

        .filter-apply-btn {
            padding: 10px 20px;
            background: #06b6d4;
            border: none;
            border-radius: 8px;
            color: #0f172a;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
        }

        .filter-apply-btn:hover {
            background: #22d3ee;
        }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .active-filter-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #164e63;
            border-radius: 16px;
            color: #22d3ee;
            font-size: 0.8em;
        }

        .active-filter-tag .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .active-filter-tag .remove:hover {
            opacity: 1;
        }

        /* 暂无数据 */
        .no-data-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
            background: #1e293b;
            border-radius: 12px;
            border: 1px dashed #334155;
        }

        .no-data-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .no-data-title {
            font-size: 1.1em;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .no-data-desc {
            font-size: 0.9em;
        }

        /* 响应式 */
        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
                max-width: 100%;
            }
            .boundary-stats {
                grid-template-columns: repeat(3, 1fr);
            }
            .region-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .boundary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .region-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 导出按钮样式 */
        .overview-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .export-buttons {
            display: flex;
            gap: 8px;
        }

        .export-btn {
            padding: 8px 16px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .export-btn:hover {
            background: #475569;
            border-color: #06b6d4;
            color: #06b6d4;
        }

        .export-btn:active {
            transform: scale(0.98);
        }

        /* ========== 洞察系统样式 ========== */

        /* 高亮颜色变量 */
        .insight-system {
            --color-highlight-source: #3b82f6;
            --color-highlight-insight: #8b5cf6;
            --color-highlight-dependent: #f59e0b;
            --color-confidence-high: #22c55e;
            --color-confidence-medium: #eab308;
            --color-confidence-low: #f97316;
        }

        /* 洞察卡片 */
        .insight-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }

        .insight-card:hover {
            border-color: #06b6d4;
        }

        .insight-card.highlight-insight {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .insight-card.highlight-dependent {
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        .insight-header {
            padding: 20px 24px;
            cursor: pointer;
        }

        .insight-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .insight-icon {
            font-size: 1.4em;
        }

        .insight-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #e2e8f0;
            flex: 1;
        }

        .insight-toggle {
            padding: 6px 14px;
            background: #334155;
            color: #94a3b8;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .insight-toggle:hover {
            background: #475569;
            color: #e2e8f0;
        }

        /* 置信度条 */
        .confidence-bar-container {
            margin-bottom: 16px;
        }

        .confidence-bar-bg {
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .confidence-bar-fill.high {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }

        .confidence-bar-fill.medium {
            background: linear-gradient(90deg, #eab308, #fbbf24);
        }

        .confidence-bar-fill.low {
            background: linear-gradient(90deg, #f97316, #fb923c);
        }

        .confidence-text {
            text-align: right;
            font-size: 0.85em;
            color: #64748b;
            margin-top: 6px;
        }

        /* 数据源标签 */
        .insight-sources {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .sources-label {
            font-size: 0.85em;
            color: #64748b;
        }

        .source-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #334155;
            border-radius: 12px;
            font-size: 0.8em;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }

        .source-tag:hover {
            background: #475569;
            color: #e2e8f0;
        }

        .source-tag.highlight-source {
            background: #3b82f6;
            color: white;
        }

        /* 展开态内容 */
        .insight-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .insight-card.expanded .insight-body {
            max-height: 2000px;
        }

        .insight-body-inner {
            padding: 0 24px 24px;
            border-top: 1px solid #334155;
        }

        .insight-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .insight-content-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 可视化区域 */
        .visualization-section {
            background: #0f172a;
            border-radius: 12px;
            padding: 20px;
        }

        .viz-title {
            font-size: 0.9em;
            color: #64748b;
            margin-bottom: 16px;
            text-align: center;
        }

        .chart-container {
            height: 280px;
            position: relative;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        .chart-axis {
            stroke: #334155;
            stroke-width: 1;
        }

        .chart-axis-label {
            fill: #64748b;
            font-size: 11px;
        }

        .chart-grid-line {
            stroke: #334155;
            stroke-width: 0.5;
            stroke-dasharray: 4 4;
        }

        .chart-line {
            fill: none;
            stroke: #06b6d4;
            stroke-width: 2;
        }

        .chart-point {
            fill: #06b6d4;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-point:hover {
            r: 8;
            fill: #22d3ee;
        }

        .chart-point.highlighted {
            fill: #f59e0b;
            r: 8;
        }

        .chart-highlight-area {
            fill: rgba(6, 182, 212, 0.15);
            stroke: #06b6d4;
            stroke-width: 1;
            stroke-dasharray: 4 4;
        }

        .chart-annotation {
            fill: #06b6d4;
            font-size: 12px;
            font-weight: 600;
        }

        /* 关键发现 */
        .findings-section {
            margin-top: 20px;
            padding: 16px;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 8px;
            border-left: 3px solid #06b6d4;
        }

        .findings-title {
            font-size: 0.85em;
            color: #06b6d4;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .finding-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 0.9em;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .finding-item:last-child {
            margin-bottom: 0;
        }

        .finding-number {
            color: #06b6d4;
            font-weight: 600;
        }

        /* 推理链区域 */
        .reasoning-section {
            background: #0f172a;
            border-radius: 12px;
            padding: 20px;
        }

        .reasoning-title {
            font-size: 0.9em;
            color: #64748b;
            margin-bottom: 16px;
        }

        .reasoning-chain {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .reasoning-step {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reasoning-step:hover {
            border-color: #3b82f6;
        }

        .reasoning-step.highlight-source {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .step-icon {
            font-size: 1.1em;
        }

        .step-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #e2e8f0;
            flex: 1;
        }

        .step-link {
            font-size: 0.75em;
            color: #06b6d4;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .reasoning-step:hover .step-link {
            opacity: 1;
        }

        .step-observation {
            font-size: 0.85em;
            color: #94a3b8;
            margin-bottom: 10px;
        }

        .step-weight {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weight-bar-bg {
            flex: 1;
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
        }

        .weight-bar-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 3px;
        }

        .weight-text {
            font-size: 0.75em;
            color: #64748b;
            min-width: 50px;
        }

        .reasoning-connector {
            text-align: center;
            color: #64748b;
            font-size: 1.2em;
        }

        .reasoning-conclusion {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: linear-gradient(135deg, #164e63, #1e3a5f);
            border-radius: 10px;
            border: 1px solid #06b6d4;
        }

        .conclusion-symbol {
            font-size: 1.2em;
            color: #06b6d4;
        }

        .conclusion-text {
            font-size: 0.9em;
            color: #e2e8f0;
        }

        /* 数据表格区域 */
        .data-section {
            margin-top: 20px;
            border-top: 1px solid #334155;
            padding-top: 20px;
        }

        .data-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .data-section-title {
            font-size: 1em;
            font-weight: 600;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-toggle-btn {
            padding: 8px 16px;
            background: #334155;
            color: #94a3b8;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .data-toggle-btn:hover {
            background: #475569;
            color: #e2e8f0;
        }

        /* 表格工具栏 */
        .table-toolbar {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #0f172a;
            border-radius: 8px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-label {
            font-size: 0.8em;
            color: #64748b;
        }

        .toolbar-select {
            padding: 6px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.85em;
            cursor: pointer;
        }

        .toolbar-search {
            padding: 6px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.85em;
            min-width: 200px;
        }

        .toolbar-search:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .toolbar-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            background: #334155;
            color: #94a3b8;
            border: none;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #475569;
            color: #e2e8f0;
        }

        .toolbar-btn.primary {
            background: #06b6d4;
            color: #0f172a;
        }

        .toolbar-btn.primary:hover {
            background: #22d3ee;
        }

        /* 数据表格 */
        .data-table-container {
            background: #0f172a;
            border-radius: 10px;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.4s ease;
        }

        .data-table-container.expanded {
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            position: sticky;
            top: 0;
            background: #1e293b;
            padding: 12px 16px;
            text-align: left;
            font-size: 0.85em;
            font-weight: 600;
            color: #94a3b8;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            user-select: none;
        }

        .data-table th:hover {
            color: #e2e8f0;
        }

        .data-table th.sortable::after {
            content: ' ↕';
            opacity: 0.3;
        }

        .data-table th.sort-asc::after {
            content: ' ▲';
            opacity: 1;
            color: #06b6d4;
        }

        .data-table th.sort-desc::after {
            content: ' ▼';
            opacity: 1;
            color: #06b6d4;
        }

        .data-table td {
            padding: 12px 16px;
            font-size: 0.9em;
            color: #e2e8f0;
            border-bottom: 1px solid #334155;
        }

        .data-table tr:hover {
            background: rgba(6, 182, 212, 0.05);
        }

        .data-table tr.selected {
            background: rgba(59, 130, 246, 0.1);
        }

        /* 表格内链接 */
        .entity-link {
            color: #06b6d4;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .entity-link:hover {
            color: #22d3ee;
            text-decoration: underline;
        }

        .video-link::before {
            content: "▶ ";
            font-size: 0.8em;
        }

        .channel-link::before {
            content: "@ ";
        }

        .external-link {
            display: inline-block;
            font-size: 0.75em;
            color: #64748b;
            margin-left: 4px;
        }

        /* 表格统计摘要 */
        .table-summary {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 12px 16px;
            background: #1e293b;
            border-top: 1px solid #334155;
            font-size: 0.85em;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .summary-label {
            color: #64748b;
        }

        .summary-value {
            color: #06b6d4;
            font-weight: 600;
        }

        .summary-highlight {
            color: #22c55e;
        }

        /* 分页 */
        .table-pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #1e293b;
        }

        .pagination-info {
            font-size: 0.85em;
            color: #64748b;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-btn {
            padding: 6px 10px;
            background: #334155;
            color: #94a3b8;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover {
            background: #475569;
            color: #e2e8f0;
        }

        .pagination-btn.active {
            background: #06b6d4;
            color: #0f172a;
        }

        /* 综合建议卡片 */
        .comprehensive-card {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid #06b6d4;
            border-radius: 16px;
            overflow: hidden;
            margin-top: 24px;
        }

        .comprehensive-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, #164e63, #1e3a5f);
            border-bottom: 1px solid #06b6d4;
        }

        .comprehensive-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
            font-weight: 600;
            color: #e2e8f0;
        }

        .comprehensive-body {
            padding: 24px;
        }

        /* 推理树 */
        .reasoning-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: #0f172a;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .tree-root {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tree-node {
            padding: 12px 20px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tree-node:hover {
            border-color: #06b6d4;
        }

        .tree-node.root {
            background: linear-gradient(135deg, #164e63, #1e3a5f);
            border-color: #06b6d4;
        }

        .tree-node-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        .tree-node-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #e2e8f0;
        }

        .tree-node-confidence {
            font-size: 0.75em;
            color: #64748b;
            margin-top: 4px;
        }

        .tree-connector {
            width: 2px;
            height: 20px;
            background: #334155;
        }

        .tree-branch {
            display: flex;
            align-items: flex-start;
            gap: 40px;
            position: relative;
        }

        .tree-branch::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 100px);
            height: 2px;
            background: #334155;
        }

        .tree-branch-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tree-branch-connector {
            width: 2px;
            height: 20px;
            background: #334155;
        }

        .tree-sources {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .tree-source-icon {
            width: 32px;
            height: 32px;
            background: #334155;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tree-source-icon:hover {
            background: #3b82f6;
        }

        /* 最终建议 */
        .final-recommendation {
            background: #0f172a;
            border-radius: 12px;
            padding: 20px;
        }

        .recommendation-intro {
            font-size: 0.9em;
            color: #94a3b8;
            margin-bottom: 16px;
        }

        .recommendation-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            background: #1e293b;
            border-radius: 8px;
            border-left: 3px solid #06b6d4;
        }

        .recommendation-icon {
            font-size: 1.1em;
        }

        .recommendation-text {
            font-size: 0.95em;
            color: #e2e8f0;
        }

        .recommendation-confidence {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 8px;
        }

        .confidence-label {
            font-size: 0.85em;
            color: #64748b;
        }

        .confidence-formula {
            font-size: 0.8em;
            color: #94a3b8;
            font-family: monospace;
        }

        /* 热力图样式 */
        .heatmap-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .heatmap-row {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .heatmap-label {
            width: 80px;
            font-size: 0.8em;
            color: #94a3b8;
            text-align: right;
            padding-right: 10px;
        }

        .heatmap-cell {
            width: 60px;
            height: 36px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 1;
        }

        .heatmap-cell.level-1 { background: #1e3a5f; }
        .heatmap-cell.level-2 { background: #1e5a7f; }
        .heatmap-cell.level-3 { background: #1e7a9f; }
        .heatmap-cell.level-4 { background: #06b6d4; }
        .heatmap-cell.level-5 { background: #22d3ee; }

        .heatmap-cell.highlighted {
            box-shadow: 0 0 0 2px #f59e0b;
        }

        .heatmap-header {
            display: flex;
            gap: 2px;
            margin-left: 80px;
            margin-bottom: 8px;
        }

        .heatmap-header-cell {
            width: 60px;
            font-size: 0.75em;
            color: #64748b;
            text-align: center;
        }

        /* 气泡图容器 */
        .bubble-chart-container {
            min-height: 380px;
            overflow: visible;
        }

        /* 气泡图样式 */
        .bubble-chart-wrapper {
            position: relative;
            width: 100%;
            height: 340px;
            margin: 0;
            box-sizing: border-box;
        }

        /* Y轴 - 左侧垂直 */
        .bubble-y-axis {
            position: absolute;
            left: 0;
            top: 20px;
            width: 70px;
            height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            padding-right: 10px;
            box-sizing: border-box;
        }

        .bubble-y-axis .axis-label {
            font-size: 0.75em;
            color: #22d3ee;
            font-weight: 600;
            text-align: right;
            width: 100%;
        }

        .bubble-y-axis .axis-tick {
            font-size: 0.7em;
            color: #94a3b8;
            text-align: right;
        }

        /* X轴 - 底部水平 */
        .bubble-x-axis {
            position: absolute;
            left: 70px;
            right: 20px;
            top: 250px;
            height: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-top: 8px;
            box-sizing: border-box;
        }

        .bubble-x-axis .axis-tick {
            font-size: 0.7em;
            color: #94a3b8;
        }

        .bubble-x-axis .axis-label {
            font-size: 0.75em;
            color: #22d3ee;
            font-weight: 600;
        }

        /* 图表绘图区 */
        .bubble-chart-area {
            position: absolute;
            left: 70px;
            right: 20px;
            top: 20px;
            height: 230px;
            border-left: 2px solid #475569;
            border-bottom: 2px solid #475569;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.5), rgba(15, 23, 42, 0.3));
            overflow: visible;
        }

        /* 气泡项 */
        .bubble-item {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s ease;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        .bubble-item .bubble-label {
            font-size: 0.7em;
            color: white;
            text-align: center;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
            padding: 2px;
        }

        .bubble-item.small-channel {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.85), rgba(22, 163, 74, 0.85));
            border: 2px solid #22c55e;
        }

        .bubble-item.large-channel {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.85), rgba(37, 99, 235, 0.85));
            border: 2px solid #3b82f6;
        }

        .bubble-item:hover, .bubble-item.hover {
            transform: translate(-50%, -50%) scale(1.25);
            z-index: 100;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.4);
        }

        /* 图例 */
        .bubble-legend {
            position: absolute;
            left: 70px;
            right: 20px;
            top: 295px;
            display: flex;
            gap: 16px;
            font-size: 0.7em;
            color: #94a3b8;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.small {
            background: #22c55e;
        }

        .legend-dot.large {
            background: #3b82f6;
        }

        /* 频道提示框 */
        .channel-tooltip {
            position: fixed;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid #3b82f6;
            border-radius: 12px;
            font-size: 0.85em;
            color: #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.2);
            z-index: 2000;
            min-width: 200px;
            max-width: 280px;
            overflow: hidden;
        }

        .channel-tooltip .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: rgba(59, 130, 246, 0.15);
            border-bottom: 1px solid #334155;
        }

        .channel-tooltip .tooltip-title {
            font-weight: 600;
            color: #60a5fa;
            font-size: 1em;
        }

        .channel-tooltip .tooltip-close {
            cursor: pointer;
            color: #64748b;
            font-size: 1.1em;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .channel-tooltip .tooltip-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .channel-tooltip .tooltip-body {
            padding: 10px 14px;
        }

        .channel-tooltip .tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .channel-tooltip .tooltip-label {
            color: #94a3b8;
            font-size: 0.9em;
        }

        .channel-tooltip .tooltip-value {
            color: #f1f5f9;
            font-weight: 600;
        }

        .channel-tooltip .tooltip-footer {
            padding: 10px 14px;
            background: rgba(34, 197, 94, 0.1);
            border-top: 1px solid #334155;
        }

        .channel-tooltip .tooltip-link {
            display: block;
            text-align: center;
            color: #22c55e;
            text-decoration: none;
            font-weight: 500;
            padding: 6px 12px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .channel-tooltip .tooltip-link:hover {
            background: rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        /* 工具提示 */
        .insight-tooltip {
            position: fixed;
            padding: 10px 14px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 0.85em;
            color: #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .insight-tooltip.visible {
            opacity: 1;
        }

        /* 数据源弹窗样式 */
        .source-data-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .source-data-modal .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .source-data-modal .modal-content {
            position: relative;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid #3b82f6;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .source-data-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #334155;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 16px 16px 0 0;
        }

        .source-data-modal .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
            color: #60a5fa;
            font-weight: 600;
        }

        .source-data-modal .modal-close {
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 1.4em;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .source-data-modal .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .source-data-modal .modal-body {
            flex: 1;
            padding: 16px 20px;
            overflow-y: auto;
        }

        .source-data-modal .no-data {
            text-align: center;
            color: #64748b;
            padding: 40px;
            font-size: 1.1em;
        }

        .source-data-modal .source-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .source-data-modal .source-data-table th {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #334155;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .source-data-modal .source-data-table td {
            padding: 10px;
            border-bottom: 1px solid #1e293b;
            color: #e2e8f0;
            vertical-align: middle;
        }

        .source-data-modal .source-data-table tr:hover td {
            background: rgba(59, 130, 246, 0.08);
        }

        .source-data-modal .rank-cell {
            width: 50px;
            text-align: center;
            color: #94a3b8;
            font-weight: 600;
        }

        .source-data-modal .title-cell {
            max-width: 350px;
        }

        .source-data-modal .channel-cell {
            max-width: 180px;
        }

        .source-data-modal .number-cell {
            text-align: right;
            color: #22d3ee;
            font-weight: 500;
            white-space: nowrap;
        }

        .source-data-modal .duration-cell {
            text-align: center;
            color: #94a3b8;
            white-space: nowrap;
        }

        .source-data-modal .data-link {
            color: #60a5fa;
            text-decoration: none;
            transition: color 0.2s;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .source-data-modal .data-link:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        .source-data-modal .data-link.channel-link {
            color: #22c55e;
        }

        .source-data-modal .data-link.channel-link:hover {
            color: #4ade80;
        }

        .source-data-modal .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-top: 1px solid #334155;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0 0 16px 16px;
        }

        .source-data-modal .data-count {
            color: #64748b;
            font-size: 0.9em;
        }

        .source-data-modal .modal-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .source-data-modal .modal-btn:hover {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            transform: translateY(-1px);
        }

        /* 高亮source-tag可点击样式 */
        .source-tag {
            cursor: pointer;
            transition: all 0.2s;
        }

        .source-tag:hover {
            background: rgba(59, 130, 246, 0.3) !important;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="nav">
        <a href="/" class="nav-brand">YouTube 内容助手</a>
        <div class="nav-links">
            <a href="#discover" class="nav-link active">发现选题</a>
            <a href="#publish" class="nav-link">发布视频</a>
            <a href="#data" class="nav-link">内容库</a>
        </div>
    </nav>

    <div class="app-container">
        <!-- 左侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">数据分析</div>
                <nav class="sidebar-nav">
                    <a class="sidebar-item active" data-panel="overview">
                        <span class="icon">📊</span>
                        概览摘要
                    </a>
                    <a class="sidebar-item" data-panel="videos">
                        <span class="icon">🎬</span>
                        视频数据
                        <span class="badge" id="badge-videos">0</span>
                    </a>
                    <a class="sidebar-item" data-panel="channels">
                        <span class="icon">📺</span>
                        频道数据
                        <span class="badge" id="badge-channels">0</span>
                    </a>
                    <a class="sidebar-item" data-panel="patterns">
                        <span class="icon">🔍</span>
                        模式洞察
                    </a>
                    <a class="sidebar-item" data-panel="report">
                        <span class="icon">📋</span>
                        分析报告
                    </a>
                </nav>
            </div>

            <!-- 监控中心 -->
            <div class="sidebar-section">
                <div class="sidebar-title">监控中心</div>
                <nav class="sidebar-nav">
                    <a class="sidebar-item" data-panel="monitor">
                        <span class="icon">📡</span>
                        关键词监控
                        <span class="badge" id="badge-monitor">0</span>
                    </a>
                    <a class="sidebar-item" data-panel="trending">
                        <span class="icon">📈</span>
                        趋势追踪
                    </a>
                </nav>
            </div>

            <!-- 频道诊断 -->
            <div class="sidebar-section">
                <div class="sidebar-title">我的频道诊断</div>
                <div class="diagnose-card">
                    <h4>🔍 诊断你的频道</h4>
                    <p>输入频道链接，获取对标分析和改进建议</p>
                    <input type="text" class="diagnose-input" id="diagnoseInput" placeholder="粘贴频道链接或名称...">
                    <button class="diagnose-btn" onclick="startDiagnose()">开始诊断</button>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 搜索头部 -->
            <div class="search-header">
                <div class="search-row">
                    <input type="text" class="search-input" id="topicInput" placeholder="输入你想研究的领域，如：Python教程、健康养生、美食探店...">
                    <button class="search-btn" id="analyzeBtn" onclick="startAnalysis()">开始分析</button>
                </div>
                <div class="search-presets">
                    <span class="preset-label">热门：</span>
                    <button class="preset-tag" onclick="setTopic('健康养生')">健康养生</button>
                    <button class="preset-tag" onclick="setTopic('Python教程')">Python教程</button>
                    <button class="preset-tag" onclick="setTopic('美食探店')">美食探店</button>
                    <button class="preset-tag" onclick="setTopic('旅行Vlog')">旅行Vlog</button>
                    <button class="preset-tag" onclick="setTopic('育儿知识')">育儿知识</button>
                </div>

                <!-- 已有数据库快捷入口 -->
                <div class="existing-data-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155; text-align: center;">
                    <span style="font-size: 0.85em; color: #64748b;">已有数据库？</span>
                    <a href="#data" style="display: inline-block; margin-left: 8px; padding: 6px 12px; background: #06b6d4; color: white; border-radius: 6px; text-decoration: none; font-size: 0.85em; transition: all 0.2s;" onclick="navigateToData(event)">查看养生库（3000+ 视频）</a>
                </div>

                <!-- 高级筛选 -->
                <div class="filters-section">
                    <div class="filters-toggle" id="filtersToggle" onclick="toggleFilters()">
                        <span>🎛️ 高级筛选</span>
                        <span class="arrow">▼</span>
                    </div>
                    <div class="filters-content" id="filtersContent">
                        <div class="filters-grid">
                            <!-- 播放量筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">📊 播放量范围</div>
                                <div class="filter-range">
                                    <input type="text" id="viewsMin" placeholder="最小">
                                    <span>-</span>
                                    <input type="text" id="viewsMax" placeholder="最大">
                                </div>
                                <div class="filter-chips" style="margin-top: 10px;">
                                    <span class="filter-chip active" onclick="setViewsRange(null, null)">不限</span>
                                    <span class="filter-chip" onclick="setViewsRange(0, 10000)">1万以下</span>
                                    <span class="filter-chip" onclick="setViewsRange(10000, 100000)">1-10万</span>
                                    <span class="filter-chip" onclick="setViewsRange(100000, null)">10万+</span>
                                </div>
                            </div>

                            <!-- 地区筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">🌏 目标地区</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearRegions(this)">不限</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'SG')">🇸🇬 新加坡</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'MY')">🇲🇾 马来西亚</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'TW')">🇹🇼 台湾</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'HK')">🇭🇰 香港</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'US')">🇺🇸 美国</span>
                                    <span class="filter-chip" onclick="toggleRegion(this, 'CN')">🇨🇳 大陆</span>
                                </div>
                            </div>

                            <!-- 时长筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">⏱️ 视频时长</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearDuration(this)">不限</span>
                                    <span class="filter-chip" onclick="toggleDuration(this, 'short')">短视频 (&lt;5分钟)</span>
                                    <span class="filter-chip" onclick="toggleDuration(this, 'medium')">中等 (5-20分钟)</span>
                                    <span class="filter-chip" onclick="toggleDuration(this, 'long')">长视频 (20分钟+)</span>
                                </div>
                            </div>

                            <!-- 粉丝数筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">👥 频道粉丝数</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearSubscribers(this)">不限</span>
                                    <span class="filter-chip" onclick="toggleSubscribers(this, 'small')">小频道 (&lt;1万)</span>
                                    <span class="filter-chip" onclick="toggleSubscribers(this, 'medium')">中频道 (1-10万)</span>
                                    <span class="filter-chip" onclick="toggleSubscribers(this, 'large')">大频道 (10-100万)</span>
                                    <span class="filter-chip" onclick="toggleSubscribers(this, 'huge')">超大 (100万+)</span>
                                </div>
                            </div>

                            <!-- 发布时间筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">📅 发布时间</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearTime(this)">不限</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '24h')">24小时</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '7d')">近7天</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '30d')">近30天</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '90d')">近3个月</span>
                                    <span class="filter-chip" onclick="toggleTime(this, '1y')">近1年</span>
                                </div>
                            </div>

                            <!-- 排序方式 -->
                            <div class="filter-group">
                                <div class="filter-label">🔄 排序方式</div>
                                <select class="filter-select" id="sortBy">
                                    <option value="views">播放量最高</option>
                                    <option value="likes">点赞最多</option>
                                    <option value="comments">评论最多</option>
                                    <option value="engagement">互动率最高</option>
                                    <option value="recent">最新发布</option>
                                    <option value="growth">增长最快</option>
                                </select>
                            </div>

                            <!-- 数据时间范围 -->
                            <div class="filter-group">
                                <div class="filter-label">📆 数据时间范围</div>
                                <div class="filter-range">
                                    <input type="date" id="dateStart" style="color-scheme: dark;">
                                    <span>至</span>
                                    <input type="date" id="dateEnd" style="color-scheme: dark;">
                                </div>
                            </div>

                            <!-- 视频数量 -->
                            <div class="filter-group">
                                <div class="filter-label">🔢 分析视频数量</div>
                                <div class="filter-chips">
                                    <span class="filter-chip" onclick="setVideoCount(this, 100)">100个</span>
                                    <span class="filter-chip active" onclick="setVideoCount(this, 500)">500个</span>
                                    <span class="filter-chip" onclick="setVideoCount(this, 1000)">1000个</span>
                                    <span class="filter-chip" onclick="setVideoCount(this, 0)">不限</span>
                                </div>
                            </div>

                            <!-- 点赞数筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">👍 点赞数范围</div>
                                <div class="filter-range">
                                    <input type="text" id="likesMin" placeholder="最小">
                                    <span>-</span>
                                    <input type="text" id="likesMax" placeholder="最大">
                                </div>
                                <div class="filter-chips" style="margin-top: 10px;">
                                    <span class="filter-chip active" onclick="setLikesRange(null, null)">不限</span>
                                    <span class="filter-chip" onclick="setLikesRange(0, 1000)">1千以下</span>
                                    <span class="filter-chip" onclick="setLikesRange(1000, 10000)">1千-1万</span>
                                    <span class="filter-chip" onclick="setLikesRange(10000, null)">1万+</span>
                                </div>
                            </div>

                            <!-- 评论数筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">💬 评论数范围</div>
                                <div class="filter-range">
                                    <input type="text" id="commentsMin" placeholder="最小">
                                    <span>-</span>
                                    <input type="text" id="commentsMax" placeholder="最大">
                                </div>
                            </div>

                            <!-- 互动率筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">📈 互动率</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearEngagement(this)">不限</span>
                                    <span class="filter-chip" onclick="setEngagement(this, 'low')">低 (&lt;1%)</span>
                                    <span class="filter-chip" onclick="setEngagement(this, 'medium')">中 (1-5%)</span>
                                    <span class="filter-chip" onclick="setEngagement(this, 'high')">高 (5-10%)</span>
                                    <span class="filter-chip" onclick="setEngagement(this, 'viral')">爆款 (10%+)</span>
                                </div>
                            </div>

                            <!-- 语言筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">🌐 视频语言</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearLanguage(this)">不限</span>
                                    <span class="filter-chip" onclick="toggleLanguage(this, 'zh')">中文</span>
                                    <span class="filter-chip" onclick="toggleLanguage(this, 'en')">英文</span>
                                    <span class="filter-chip" onclick="toggleLanguage(this, 'other')">其他</span>
                                </div>
                            </div>

                            <!-- 频道类型 -->
                            <div class="filter-group">
                                <div class="filter-label">📺 频道类型</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearChannelType(this)">不限</span>
                                    <span class="filter-chip" onclick="toggleChannelType(this, 'personal')">个人</span>
                                    <span class="filter-chip" onclick="toggleChannelType(this, 'brand')">品牌</span>
                                    <span class="filter-chip" onclick="toggleChannelType(this, 'media')">媒体</span>
                                    <span class="filter-chip" onclick="toggleChannelType(this, 'mcn')">MCN</span>
                                </div>
                            </div>

                            <!-- 特定频道 -->
                            <div class="filter-group">
                                <div class="filter-label">🎯 指定频道</div>
                                <input type="text" class="filter-select" id="channelFilter" placeholder="输入频道名称或ID..." style="background-image: none;">
                            </div>

                            <!-- 关键词排除 -->
                            <div class="filter-group">
                                <div class="filter-label">🚫 排除关键词</div>
                                <input type="text" class="filter-select" id="excludeKeywords" placeholder="多个关键词用逗号分隔..." style="background-image: none;">
                            </div>

                            <!-- 视频质量 -->
                            <div class="filter-group">
                                <div class="filter-label">🎬 视频质量</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="clearQuality(this)">不限</span>
                                    <span class="filter-chip" onclick="toggleQuality(this, 'hd')">高清 (1080p+)</span>
                                    <span class="filter-chip" onclick="toggleQuality(this, 'sd')">标清</span>
                                    <span class="filter-chip" onclick="toggleQuality(this, 'shorts')">短视频</span>
                                </div>
                            </div>

                            <!-- AI视频筛选 -->
                            <div class="filter-group">
                                <div class="filter-label">🤖 AI视频</div>
                                <div class="filter-chips">
                                    <span class="filter-chip active" onclick="setAIFilter(this, 'all')">不限</span>
                                    <span class="filter-chip" onclick="setAIFilter(this, 'ai')">仅AI视频</span>
                                    <span class="filter-chip" onclick="setAIFilter(this, 'human')">仅真人视频</span>
                                </div>
                                <div class="filter-hint" style="font-size: 11px; color: #64748b; margin-top: 6px;">
                                    基于标题/描述/标签中的关键词识别
                                </div>
                            </div>
                        </div>

                        <!-- 已选筛选条件 -->
                        <div class="active-filters" id="activeFilters"></div>

                        <!-- 操作按钮 -->
                        <div class="filters-actions">
                            <button class="filter-reset-btn" onclick="resetFilters()">重置筛选</button>
                            <button class="filter-apply-btn" onclick="applyFilters()">应用筛选</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分析状态 -->
            <div class="analysis-status" id="analysisStatus">
                <div class="status-header">
                    <span class="status-title" id="statusTitle">正在分析：健康养生</span>
                    <span class="status-badge running" id="statusBadge">分析中</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="status-log" id="statusLog">正在收集视频数据...</div>

                <!-- 频道获取详细进度 -->
                <div class="channel-fetch-progress" id="channelFetchProgress" style="display: none;">
                    <div class="fetch-stats">
                        <div class="fetch-stat">
                            <span class="stat-label">进度</span>
                            <span class="stat-value" id="fetchProgressText">0/0</span>
                        </div>
                        <div class="fetch-stat">
                            <span class="stat-label">成功</span>
                            <span class="stat-value success" id="fetchSuccessCount">0</span>
                        </div>
                        <div class="fetch-stat">
                            <span class="stat-label">失败</span>
                            <span class="stat-value fail" id="fetchFailCount">0</span>
                        </div>
                        <div class="fetch-stat">
                            <span class="stat-label">预计剩余</span>
                            <span class="stat-value" id="fetchETA">--</span>
                        </div>
                        <div class="fetch-stat network-indicator" id="networkIndicator">
                            <span class="stat-label">网络</span>
                            <span class="stat-value network-status" id="networkStatus">
                                <span class="network-dot"></span>
                                <span class="network-text">检测中</span>
                            </span>
                        </div>
                    </div>
                    <div class="fetch-current" id="fetchCurrent">正在获取: --</div>
                </div>
            </div>

            <style>
                .channel-fetch-progress {
                    margin-top: 12px;
                    padding: 12px 16px;
                    background: rgba(30, 41, 59, 0.8);
                    border-radius: 8px;
                    border: 1px solid #334155;
                }
                .fetch-stats {
                    display: flex;
                    gap: 16px;
                    flex-wrap: wrap;
                    margin-bottom: 8px;
                }
                .fetch-stat {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                }
                .fetch-stat .stat-label {
                    font-size: 11px;
                    color: #64748b;
                    text-transform: uppercase;
                }
                .fetch-stat .stat-value {
                    font-size: 14px;
                    font-weight: 600;
                    color: #e2e8f0;
                }
                .fetch-stat .stat-value.success { color: #22c55e; }
                .fetch-stat .stat-value.fail { color: #ef4444; }
                .network-status {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                }
                .network-dot {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background: #64748b;
                    animation: pulse 1.5s infinite;
                }
                .network-dot.fast { background: #22c55e; }
                .network-dot.normal { background: #f59e0b; }
                .network-dot.slow { background: #ef4444; }
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
                .fetch-current {
                    font-size: 12px;
                    color: #94a3b8;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
            </style>

            <!-- 分析结果 -->
            <div id="resultsContainer" style="display: none;">

                <!-- 概览摘要面板 -->
                <div class="panel active" id="panel-overview">
                    <!-- 数据概览卡片 -->
                    <div class="boundary-card" id="overviewStats">
                        <div class="boundary-header">
                            <span class="boundary-title" id="overviewTitle">📊 数据概览</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="filter-btn" onclick="switchPanel('report')" style="font-size: 12px;">📋 查看完整报告</button>
                            </div>
                        </div>
                        <div class="boundary-stats" id="overviewNumbers">
                            <div class="stat-item">
                                <div class="stat-value" id="stat-videos">0</div>
                                <div class="stat-label">视频总数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-channels">0</div>
                                <div class="stat-label">频道数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-views">0</div>
                                <div class="stat-label">总播放量</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-avg-views">0</div>
                                <div class="stat-label">平均播放</div>
                            </div>
                        </div>
                    </div>

                    <!-- 关键发现 -->
                    <div class="ai-insight" id="keyFindings">
                        <div class="ai-header">
                            <div class="ai-avatar">💡</div>
                            <div class="ai-label">关键发现</div>
                        </div>
                        <div class="ai-content" id="keyFindingsContent">
                            <p style="color: #64748b;">搜索关键词开始分析后，这里将显示关键发现...</p>
                        </div>
                    </div>

                    <!-- 快速入口 -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #1e293b; border-radius: 12px; padding: 16px; cursor: pointer;" onclick="switchPanel('videos')">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">🎬</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 4px;">视频数据</div>
                            <div style="font-size: 0.85em; color: #64748b;" id="quick-videos">查看视频榜单</div>
                        </div>
                        <div style="background: #1e293b; border-radius: 12px; padding: 16px; cursor: pointer;" onclick="switchPanel('channels')">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">📺</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 4px;">频道数据</div>
                            <div style="font-size: 0.85em; color: #64748b;" id="quick-channels">查看频道榜单</div>
                        </div>
                        <div style="background: #1e293b; border-radius: 12px; padding: 16px; cursor: pointer;" onclick="switchPanel('patterns')">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">🔍</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 4px;">模式洞察</div>
                            <div style="font-size: 0.85em; color: #64748b;">发现规律模式</div>
                        </div>
                        <div style="background: #1e293b; border-radius: 12px; padding: 16px; cursor: pointer;" onclick="switchPanel('report')">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">📋</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 4px;">分析报告</div>
                            <div style="font-size: 0.85em; color: #64748b;">完整分析报告</div>
                        </div>
                    </div>

                    <!-- Top 3 视频预览 -->
                    <div class="ranking-section" id="topVideosPreview">
                        <div class="ranking-header">
                            <span class="ranking-title">🏆 Top 3 视频</span>
                            <button class="filter-btn" onclick="switchPanel('videos')" style="font-size: 12px;">查看全部 →</button>
                        </div>
                        <div class="ranking-list" id="top3VideosList">
                            <div style="padding: 20px; text-align: center; color: #64748b;">暂无数据</div>
                        </div>
                    </div>

                    <!-- Top 3 频道预览 -->
                    <div class="ranking-section" id="topChannelsPreview">
                        <div class="ranking-header">
                            <span class="ranking-title">⭐ Top 3 频道</span>
                            <button class="filter-btn" onclick="switchPanel('channels')" style="font-size: 12px;">查看全部 →</button>
                        </div>
                        <div class="ranking-list" id="top3ChannelsList">
                            <div style="padding: 20px; text-align: center; color: #64748b;">暂无数据</div>
                        </div>
                    </div>
                </div>

                <!-- 视频榜单面板 -->
                <div class="panel" id="panel-videos">
                    <!-- 标签页 -->
                    <div class="tabs">
                        <button class="tab active" onclick="switchVideoTab('hot')">🔥 爆款视频</button>
                        <button class="tab" onclick="switchVideoTab('recentHits')">⚡ 近期爆款</button>
                        <button class="tab" onclick="switchVideoTab('evergreen')">🌲 长青视频</button>
                        <button class="tab" onclick="switchVideoTab('potential')">📈 潜力视频</button>
                        <button class="tab" onclick="switchVideoTab('longform')">⏱️ 长视频榜</button>
                    </div>

                    <!-- 爆款视频榜单 -->
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title">
                                🔥 爆款视频 Top 100
                                <span class="ranking-count">共 120 个</span>
                            </span>
                            <div class="ranking-filters" id="videoTimeFilters">
                                <button class="filter-btn active" onclick="setVideoTimeFilter(0)">全部</button>
                                <button class="filter-btn" onclick="setVideoTimeFilter(1)">近24小时</button>
                                <button class="filter-btn" onclick="setVideoTimeFilter(7)">近7天</button>
                                <button class="filter-btn" onclick="setVideoTimeFilter(30)">近30天</button>
                                <button class="filter-btn" onclick="setVideoTimeFilter(90)">近90天</button>
                            </div>
                        </div>
                        <div class="ranking-list" id="videoRankingList">
                            <!-- 动态生成 -->
                        </div>
                        <div class="load-more">
                            <button class="load-more-btn" onclick="loadMoreVideos()">加载更多</button>
                        </div>
                    </div>
                </div>

                <!-- 频道数据面板 -->
                <div class="panel" id="panel-channels">
                    <div class="tabs">
                        <button class="tab active" onclick="switchChannelTab('totalViews')">📊 总播放榜</button>
                        <button class="tab" onclick="switchChannelTab('avgViews')">⚡ 平均播放榜</button>
                        <button class="tab" onclick="switchChannelTab('videoCount')">📹 视频数榜</button>
                        <button class="tab" onclick="switchChannelTab('darkHorse')">🐴 黑马榜</button>
                        <button class="tab" onclick="switchChannelTab('efficiency')">🚀 高效榜</button>
                    </div>

                    <!-- 频道榜单 -->
                    <div id="channelRankingContainer">
                        <div class="no-data-state">
                            <div class="no-data-icon">📺</div>
                            <div class="no-data-title">暂无频道数据</div>
                            <p class="no-data-desc">搜索关键词后，这里将展示频道排行榜</p>
                        </div>
                    </div>
                </div>

                <!-- 模式洞察面板 -->
                <div class="panel" id="panel-patterns">
                    <!-- 工具提示 -->
                    <div class="insight-tooltip" id="insightTooltip"></div>

                    <!-- 洞察系统容器 -->
                    <div class="insight-system" id="insightSystem">

                        <!-- 空状态 -->
                        <div id="insightEmptyState" class="no-data-state" style="padding: 60px 20px;">
                            <div class="no-data-icon">💡</div>
                            <div class="no-data-title">暂无洞察</div>
                            <p class="no-data-desc">搜索关键词后，AI 将分析数据并生成深度洞察</p>
                        </div>

                        <!-- 洞察内容（动态生成） -->
                        <div id="insightContent" style="display: none;">

                            <!-- 洞察卡片 1：最佳时长 -->
                            <div class="insight-card" id="insight-duration" data-insight-id="best-duration">
                                <div class="insight-header" onclick="toggleInsightCard('insight-duration')">
                                    <div class="insight-title-row">
                                        <span class="insight-icon">💡</span>
                                        <span class="insight-title" id="insight-duration-title">5-10分钟是最佳视频时长</span>
                                        <button class="insight-toggle">▶ 展开详情</button>
                                    </div>
                                    <div class="confidence-bar-container">
                                        <div class="confidence-bar-bg">
                                            <div class="confidence-bar-fill high" id="insight-duration-confidence-bar" style="width: 85%"></div>
                                        </div>
                                        <div class="confidence-text" id="insight-duration-confidence-text">置信度 85%</div>
                                    </div>
                                    <div class="insight-sources">
                                        <span class="sources-label">基于</span>
                                        <span class="source-tag" data-source-id="total-views-top20" onclick="event.stopPropagation(); highlightInsightSource('total-views-top20')">📊 总播放榜</span>
                                        <span class="source-tag" data-source-id="avg-views-top20" onclick="event.stopPropagation(); highlightInsightSource('avg-views-top20')">⚡ 均播榜</span>
                                        <span class="source-tag" data-source-id="dark-horse-top20" onclick="event.stopPropagation(); highlightInsightSource('dark-horse-top20')">🐴 黑马榜</span>
                                    </div>
                                </div>
                                <div class="insight-body">
                                    <div class="insight-body-inner">
                                        <div class="insight-content-grid">
                                            <div class="visualization-section">
                                                <div class="viz-title">时长 vs 平均播放量</div>
                                                <div class="chart-container" id="insight-duration-chart"></div>
                                                <div class="findings-section">
                                                    <div class="findings-title">关键发现</div>
                                                    <div id="insight-duration-findings">
                                                        <div class="finding-item"><span class="finding-number">①</span><span>加载中...</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="reasoning-section">
                                                <div class="reasoning-title">推理依据</div>
                                                <div class="reasoning-chain" id="insight-duration-reasoning"></div>
                                            </div>
                                        </div>
                                        <div class="data-section">
                                            <div class="data-section-header">
                                                <div class="data-section-title">
                                                    <span>📋</span>
                                                    <span id="insight-duration-table-title">支撑数据</span>
                                                </div>
                                                <button class="data-toggle-btn" onclick="toggleInsightDataTable('insight-duration-table')">📋 查看数据</button>
                                            </div>
                                            <div class="data-table-container" id="insight-duration-table"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 洞察卡片 2：小频道机会 -->
                            <div class="insight-card" id="insight-channel" data-insight-id="small-channel-opportunity">
                                <div class="insight-header" onclick="toggleInsightCard('insight-channel')">
                                    <div class="insight-title-row">
                                        <span class="insight-icon">💡</span>
                                        <span class="insight-title" id="insight-channel-title">小频道仍有爆款机会</span>
                                        <button class="insight-toggle">▶ 展开详情</button>
                                    </div>
                                    <div class="confidence-bar-container">
                                        <div class="confidence-bar-bg">
                                            <div class="confidence-bar-fill medium" id="insight-channel-confidence-bar" style="width: 72%"></div>
                                        </div>
                                        <div class="confidence-text" id="insight-channel-confidence-text">置信度 72%</div>
                                    </div>
                                    <div class="insight-sources">
                                        <span class="sources-label">基于</span>
                                        <span class="source-tag" data-source-id="dark-horse-top20" onclick="event.stopPropagation(); highlightInsightSource('dark-horse-top20')">🐴 黑马榜</span>
                                        <span class="source-tag" data-source-id="channel-growth" onclick="event.stopPropagation(); highlightInsightSource('channel-growth')">📈 增长榜</span>
                                    </div>
                                </div>
                                <div class="insight-body">
                                    <div class="insight-body-inner">
                                        <div class="insight-content-grid">
                                            <div class="visualization-section">
                                                <div class="viz-title">频道分布图（点击气泡查看详情）</div>
                                                <div class="chart-container bubble-chart-container" id="insight-channel-chart"></div>
                                                <div class="findings-section">
                                                    <div class="findings-title">关键发现</div>
                                                    <div id="insight-channel-findings">
                                                        <div class="finding-item"><span class="finding-number">①</span><span>加载中...</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="reasoning-section">
                                                <div class="reasoning-title">推理依据</div>
                                                <div class="reasoning-chain" id="insight-channel-reasoning"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 洞察卡片 3：题材表现 -->
                            <div class="insight-card" id="insight-topic" data-insight-id="best-topic">
                                <div class="insight-header" onclick="toggleInsightCard('insight-topic')">
                                    <div class="insight-title-row">
                                        <span class="insight-icon">💡</span>
                                        <span class="insight-title" id="insight-topic-title">最佳题材组合</span>
                                        <button class="insight-toggle">▶ 展开详情</button>
                                    </div>
                                    <div class="confidence-bar-container">
                                        <div class="confidence-bar-bg">
                                            <div class="confidence-bar-fill medium" id="insight-topic-confidence-bar" style="width: 78%"></div>
                                        </div>
                                        <div class="confidence-text" id="insight-topic-confidence-text">置信度 78%</div>
                                    </div>
                                    <div class="insight-sources">
                                        <span class="sources-label">基于</span>
                                        <span class="source-tag" data-source-id="topic-analysis" onclick="event.stopPropagation(); highlightInsightSource('topic-analysis')">🏷️ 题材分析</span>
                                        <span class="source-tag" data-source-id="total-views-top20" onclick="event.stopPropagation(); highlightInsightSource('total-views-top20')">📊 总播放榜</span>
                                    </div>
                                </div>
                                <div class="insight-body">
                                    <div class="insight-body-inner">
                                        <div class="insight-content-grid">
                                            <div class="visualization-section">
                                                <div class="viz-title">题材 × 时长 表现热力图</div>
                                                <div class="chart-container" id="insight-topic-chart"></div>
                                                <div class="findings-section">
                                                    <div class="findings-title">关键发现</div>
                                                    <div id="insight-topic-findings">
                                                        <div class="finding-item"><span class="finding-number">①</span><span>加载中...</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="reasoning-section">
                                                <div class="reasoning-title">推理依据</div>
                                                <div class="reasoning-chain" id="insight-topic-reasoning"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 综合建议卡片 -->
                            <div class="comprehensive-card" id="comprehensive-recommendation">
                                <div class="comprehensive-header">
                                    <div class="comprehensive-title">
                                        <span>🎯</span>
                                        <span>综合建议</span>
                                    </div>
                                </div>
                                <div class="comprehensive-body">
                                    <div class="reasoning-tree">
                                        <div class="tree-root">
                                            <div class="tree-node root">
                                                <div class="tree-node-icon">🎯</div>
                                                <div class="tree-node-title">综合建议</div>
                                                <div class="tree-node-confidence" id="comprehensive-confidence">综合置信度 --</div>
                                            </div>
                                            <div class="tree-connector"></div>
                                            <div class="tree-branch" id="tree-branch-container">
                                                <!-- 动态生成 -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="final-recommendation">
                                        <div class="recommendation-intro" id="recommendation-intro">基于以上洞察，综合分析后建议：</div>
                                        <div class="recommendation-list" id="recommendation-list">
                                            <!-- 动态生成 -->
                                        </div>
                                        <div class="recommendation-confidence" id="recommendation-confidence-detail">
                                            <span class="confidence-label">置信度计算：</span>
                                            <span class="confidence-formula" id="confidence-formula">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 分析报告面板 -->
                <div class="panel" id="panel-report">
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title" id="reportTitle">📋 分析报告</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="filter-btn" onclick="exportReport('csv')" style="font-size: 12px;">📊 导出 CSV</button>
                                <button class="filter-btn" onclick="exportReport('json')" style="font-size: 12px;">📁 导出 JSON</button>
                            </div>
                        </div>

                        <!-- 报告内容 -->
                        <div id="reportContent" style="padding: 20px;">
                            <div class="no-data-state">
                                <div class="no-data-icon">📋</div>
                                <div class="no-data-title">暂无报告</div>
                                <p class="no-data-desc">搜索关键词后，这里将生成完整的分析报告</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 监控面板（独立于 resultsContainer） -->
                <div class="panel" id="panel-monitor">
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title">📡 关键词监控</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="filter-btn" onclick="toggleScheduler()" id="schedulerBtn" style="font-size: 12px;">▶️ 启动调度器</button>
                                <button class="search-btn" onclick="showAddMonitorModal()" style="padding: 8px 16px; font-size: 12px;">+ 添加监控</button>
                            </div>
                        </div>

                        <!-- 调度器状态 -->
                        <div id="schedulerStatus" style="padding: 12px 20px; background: #0f172a; border-bottom: 1px solid #334155;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span id="schedulerIndicator" style="width: 10px; height: 10px; border-radius: 50%; background: #64748b;"></span>
                                <span style="color: #94a3b8; font-size: 0.9em;" id="schedulerStatusText">调度器未运行</span>
                            </div>
                        </div>

                        <!-- 监控任务列表 -->
                        <div class="ranking-list" id="monitorTasksList" style="max-height: none;">
                            <div style="padding: 40px 20px; text-align: center; color: #64748b;">
                                <div style="font-size: 2em; margin-bottom: 16px;">📡</div>
                                <div style="font-weight: 600; color: white; margin-bottom: 8px;">暂无监控任务</div>
                                <p>添加关键词后，系统将定时采集数据并追踪增长趋势</p>
                                <button class="search-btn" onclick="showAddMonitorModal()" style="margin-top: 16px; padding: 10px 20px;">+ 添加监控任务</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 趋势追踪面板 -->
                <div class="panel" id="panel-trending">
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title">📈 趋势追踪</span>
                            <div class="ranking-filters">
                                <button class="filter-btn active" onclick="setTrendingDays(7)">近7天</button>
                                <button class="filter-btn" onclick="setTrendingDays(14)">近14天</button>
                                <button class="filter-btn" onclick="setTrendingDays(30)">近30天</button>
                            </div>
                        </div>

                        <!-- 趋势摘要 -->
                        <div id="trendingSummary" style="padding: 20px; background: #0f172a; border-bottom: 1px solid #334155;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #06b6d4;" id="trend-total-videos">0</div>
                                    <div style="font-size: 0.75em; color: #64748b;">监控视频</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #10b981;" id="trend-total-growth">0</div>
                                    <div style="font-size: 0.75em; color: #64748b;">总增长</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #f59e0b;" id="trend-trending-count">0</div>
                                    <div style="font-size: 0.75em; color: #64748b;">趋势上升</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #8b5cf6;" id="trend-avg-growth">0</div>
                                    <div style="font-size: 0.75em; color: #64748b;">平均增长</div>
                                </div>
                            </div>
                        </div>

                        <!-- 趋势视频列表 -->
                        <div class="ranking-list" id="trendingVideosList">
                            <div style="padding: 40px 20px; text-align: center; color: #64748b;">
                                <div style="font-size: 2em; margin-bottom: 16px;">📈</div>
                                <div style="font-weight: 600; color: white; margin-bottom: 8px;">暂无趋势数据</div>
                                <p>添加监控任务并等待数据采集后，这里将显示增长趋势</p>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- 诊断结果 -->
            <div class="diagnose-result" id="diagnoseResult">
                <div class="diagnose-summary">
                    <div class="diagnose-channel">
                        <div class="diagnose-channel-avatar">👤</div>
                        <div class="diagnose-channel-info">
                            <h3 id="diagnoseChannelName">我的养生频道</h3>
                            <p>订阅 2.3万 · 视频 45 个 · 总播放 89万</p>
                        </div>
                    </div>
                    <div class="diagnose-scores">
                        <div class="diagnose-score">
                            <div class="diagnose-score-value" style="color: #f59e0b;">B+</div>
                            <div class="diagnose-score-label">综合评分</div>
                        </div>
                        <div class="diagnose-score">
                            <div class="diagnose-score-value" style="color: #10b981;">A</div>
                            <div class="diagnose-score-label">内容质量</div>
                        </div>
                        <div class="diagnose-score">
                            <div class="diagnose-score-value" style="color: #ef4444;">C</div>
                            <div class="diagnose-score-label">更新频率</div>
                        </div>
                        <div class="diagnose-score">
                            <div class="diagnose-score-value" style="color: #f59e0b;">B</div>
                            <div class="diagnose-score-label">互动率</div>
                        </div>
                    </div>

                    <div class="ai-insight" style="margin: 0;">
                        <div class="ai-header">
                            <div class="ai-avatar">🤖</div>
                            <div class="ai-label">诊断报告</div>
                        </div>
                        <div class="ai-content">
                            <p><strong>优势：</strong>内容质量较高，单条视频完播率达到 65%，高于行业平均的 42%。用户评论积极，粉丝粘性好。</p>
                            <p><strong>劣势：</strong>更新频率过低（平均 12 天/条），错失了算法推荐窗口期。视频时长集中在 5-8 分钟，未能抓住 20-30 分钟的蓝海机会。</p>
                            <p><strong>建议：</strong>提高更新频率至每周 2-3 条，尝试制作 20-30 分钟的深度内容，可参考「养生有道」的内容结构。</p>
                        </div>
                    </div>
                </div>

                <div class="recommend-channels">
                    <div class="recommend-title">🎯 推荐模仿的对标账号（按匹配度排序）</div>
                    <div class="recommend-list" id="recommendList">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 空状态 -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">🔍</div>
                <div class="empty-title">输入一个领域，开始深度分析</div>
                <p>AI 会分析 1000+ 竞品视频，告诉你市场边界、关键频道、潜力视频和最佳机会</p>
            </div>
        </main>
    </div>

    <script>
        // 渲染视频榜单
        function renderVideoRanking(data, limit = 50) {
            const list = document.getElementById('videoRankingList');
            const isEvergreen = currentVideoTab === 'evergreen';
            const isRecentHits = currentVideoTab === 'recentHits';

            list.innerHTML = data.slice(0, limit).map(v => {
                // 近期爆款和长青视频显示日均播放
                let statsHtml = '';
                if (isEvergreen && v.dailyViews) {
                    statsHtml = `
                        <div class="rank-stat">
                            <div class="rank-stat-value" style="color: #10b981;">${formatNumber(v.dailyViews)}</div>
                            <div class="rank-stat-label">日均播放</div>
                        </div>
                        <div class="rank-stat">
                            <div class="rank-stat-value">${formatNumber(v.views)}</div>
                            <div class="rank-stat-label">总播放</div>
                        </div>
                    `;
                } else if (isRecentHits && v.videoAgeDays) {
                    statsHtml = `
                        <div class="rank-stat">
                            <div class="rank-stat-value" style="color: #f59e0b;">${formatNumber(v.views)}</div>
                            <div class="rank-stat-label">播放量</div>
                        </div>
                        <div class="rank-stat">
                            <div class="rank-stat-value">${v.videoAgeDays}天</div>
                            <div class="rank-stat-label">发布</div>
                        </div>
                    `;
                } else {
                    statsHtml = `
                        <div class="rank-stat">
                            <div class="rank-stat-value">${formatNumber(v.views)}</div>
                            <div class="rank-stat-label">播放</div>
                        </div>
                        <div class="rank-stat">
                            <div class="rank-stat-value">${formatNumber(v.likes || 0)}</div>
                            <div class="rank-stat-label">点赞</div>
                        </div>
                    `;
                }

                return `
                <div class="ranking-item" onclick="openVideo('${v.videoId}')" style="cursor: pointer;" title="点击打开视频">
                    <div class="rank-number ${v.rank <= 3 ? 'rank-' + v.rank : 'rank-normal'}">${v.rank}</div>
                    <div class="rank-thumb">🎬</div>
                    <div class="rank-info">
                        <div class="rank-title">${v.title}</div>
                        <div class="rank-meta">
                            <span>${v.channel}</span>
                            <span>${v.duration || ''}</span>
                            <span>${v.date}</span>
                        </div>
                    </div>
                    <div class="rank-stats">${statsHtml}</div>
                    <div class="rank-score score-${(v.score || 'C').toLowerCase()}">${v.score || 'C'}</div>
                </div>
            `}).join('');
        }

        // 打开视频链接
        function openVideo(videoId) {
            if (videoId) {
                window.open(`https://www.youtube.com/watch?v=${videoId}`, '_blank');
            }
        }

        // 渲染频道列表（诊断功能用）
        function renderChannelList() {
            const list = document.getElementById('channelList');
            if (!list) return;
            list.innerHTML = '<div class="no-data-state"><div class="no-data-icon">📺</div><div class="no-data-title">暂无频道数据</div></div>';
        }

        function toggleChannelVideos(index) {
            const el = document.getElementById(`channel-videos-${index}`);
            el.classList.toggle('open');
        }

        // 渲染话题榜单（诊断功能用）
        function renderTopicRanking() {
            const list = document.getElementById('topicRankingList');
            if (!list) return;
            list.innerHTML = '<div class="no-data-state"><div class="no-data-icon">🏷️</div><div class="no-data-title">暂无话题数据</div></div>';
        }

        // 渲染地区分布（诊断功能用）
        function renderRegionGrid() {
            const grid = document.getElementById('regionGrid');
            if (!grid) return;
            grid.innerHTML = '<div class="no-data-state"><div class="no-data-icon">🌏</div><div class="no-data-title">暂无地区数据</div></div>';
        }

        // 渲染推荐账号（诊断功能用）
        function renderRecommendList() {
            const list = document.getElementById('recommendList');
            if (!list) return;
            list.innerHTML = '<div class="no-data-state"><div class="no-data-icon">👥</div><div class="no-data-title">暂无推荐数据</div></div>';
        }

        // 格式化数字
        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + '万';
            }
            return num.toLocaleString();
        }

        // 切换面板
        function switchPanel(panelId) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));

            document.getElementById('panel-' + panelId).classList.add('active');
            document.querySelector(`[data-panel="${panelId}"]`).classList.add('active');
        }

        // 侧边栏点击
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                const panel = item.dataset.panel;
                if (panel) {
                    switchPanel(panel);
                }
            });
        });

        // 设置话题
        function setTopic(topic) {
            document.getElementById('topicInput').value = topic;
            startAnalysis();
        }

        // 导航到数据库部分
        function navigateToData(event) {
            event.preventDefault();
            // 滚动到#data 位置
            const dataSection = document.getElementById('data') || document.querySelector('[data-section="data"]');
            if (dataSection) {
                dataSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                // 如果没有找到数据部分，则模拟点击"内容库"导航链接
                const dataLink = document.querySelector('a[href="#data"]');
                if (dataLink) dataLink.click();
            }
        }

        // API 配置
        const API_BASE = 'http://localhost:8000';
        let currentWebSocket = null;

        // 开始分析
        async function startAnalysis() {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic) {
                alert('请输入你想研究的领域');
                return;
            }

            // 隐藏空状态和诊断结果
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('diagnoseResult').classList.remove('show');
            document.getElementById('resultsContainer').style.display = 'none';

            // 显示分析状态
            document.getElementById('analysisStatus').classList.add('show');
            document.getElementById('statusTitle').textContent = `正在分析：${topic}`;
            document.getElementById('statusBadge').textContent = '连接中';
            document.getElementById('statusBadge').className = 'status-badge running';
            document.getElementById('progressFill').className = 'progress-fill';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('analyzeBtn').disabled = true;

            // 收集筛选条件
            const researchParams = {
                topic: topic,
                mode: getSelectedMode(),
                max_results: filterState.videoCount || 500,
                views_min: filterState.viewsMin,
                views_max: filterState.viewsMax,
                duration_filter: filterState.duration.length > 0 ? filterState.duration : null,
                time_range: filterState.timeRange,
                regions: filterState.regions.length > 0 ? filterState.regions : null,
                subscribers_filter: filterState.subscribers.length > 0 ? filterState.subscribers : null,
                ai_filter: filterState.aiFilter,
                sort_by: filterState.sortBy || 'views'
            };

            console.log('研究参数:', researchParams);

            // 尝试连接 WebSocket API
            const taskId = `task_${Date.now()}`;
            const wsUrl = `ws://localhost:8000/ws/${taskId}`;

            try {
                await connectWebSocket(wsUrl, researchParams);
            } catch (error) {
                console.error('WebSocket 连接失败:', error);
                // 显示连接失败提示，不使用模拟数据
                showConnectionError(error.message || '无法连接到数据服务器');
            }
        }

        // 显示连接错误
        function showConnectionError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';

            // 清空数据
            window.currentVideoData = [];
            window.currentChannelData = [];

            // 更新侧边栏数字为 0
            ['badge-videos', 'badge-video-analysis', 'badge-channels', 'badge-channel-analysis', 'badge-topics', 'badge-regions'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '0';
            });

            // 显示错误提示
            const overviewPanel = document.getElementById('panel-overview');
            if (overviewPanel) {
                overviewPanel.innerHTML = `
                    <div class="no-data-state" style="padding: 60px 20px;">
                        <div class="no-data-icon">⚠️</div>
                        <div class="no-data-title">连接失败</div>
                        <p class="no-data-desc">${message}<br><br>请确保 API 服务器正在运行：<br><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">python api_server.py</code></p>
                    </div>
                `;
            }

            switchPanel('overview');
        }

        // 获取选中的分析模式
        function getSelectedMode() {
            if (filterState.videoCount <= 100) return 'quick';
            if (filterState.videoCount >= 1000) return 'deep';
            return 'standard';
        }

        // WebSocket 连接
        function connectWebSocket(wsUrl, params) {
            return new Promise((resolve, reject) => {
                // 关闭之前的连接
                if (currentWebSocket) {
                    currentWebSocket.close();
                }

                const ws = new WebSocket(wsUrl);
                currentWebSocket = ws;
                let resolved = false;

                ws.onopen = () => {
                    console.log('WebSocket 已连接');
                    document.getElementById('statusLog').textContent = '已连接到服务器，开始采集...';
                    // 发送研究参数
                    ws.send(JSON.stringify(params));
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    console.log('收到消息:', data);

                    switch (data.type) {
                        case 'start':
                            document.getElementById('statusBadge').textContent = '采集中';
                            // 隐藏频道获取进度
                            document.getElementById('channelFetchProgress').style.display = 'none';
                            break;

                        case 'progress':
                            document.getElementById('progressFill').style.width = data.progress + '%';
                            document.getElementById('statusLog').textContent = data.message;

                            // 如果有频道获取详细信息，显示详细进度
                            if (data.channel_fetch) {
                                updateChannelFetchProgress(data.channel_fetch);
                            } else if (data.stage !== 'channels') {
                                // 非频道获取阶段，隐藏详细进度
                                document.getElementById('channelFetchProgress').style.display = 'none';
                            }
                            break;

                        case 'complete':
                            document.getElementById('statusBadge').textContent = '完成';
                            document.getElementById('statusBadge').className = 'status-badge done';
                            document.getElementById('progressFill').className = 'progress-fill done';
                            document.getElementById('analyzeBtn').disabled = false;
                            // 隐藏频道获取进度
                            document.getElementById('channelFetchProgress').style.display = 'none';

                            // 渲染真实数据
                            if (data.result) {
                                renderRealData(data.result);
                            }

                            resolved = true;
                            resolve(data.result);
                            break;

                        case 'error':
                            document.getElementById('statusLog').textContent = '错误: ' + data.message;
                            document.getElementById('statusBadge').textContent = '失败';
                            document.getElementById('statusBadge').className = 'status-badge error';
                            document.getElementById('analyzeBtn').disabled = false;
                            document.getElementById('channelFetchProgress').style.display = 'none';
                            reject(new Error(data.message));
                            break;
                    }
                };

                // 更新频道获取进度
                function updateChannelFetchProgress(fetchData) {
                    const progressEl = document.getElementById('channelFetchProgress');
                    progressEl.style.display = 'block';

                    // 更新进度文本
                    document.getElementById('fetchProgressText').textContent =
                        `${fetchData.current}/${fetchData.total}`;

                    // 更新成功/失败计数
                    if (fetchData.success_count !== undefined) {
                        document.getElementById('fetchSuccessCount').textContent = fetchData.success_count;
                    }
                    if (fetchData.fail_count !== undefined) {
                        document.getElementById('fetchFailCount').textContent = fetchData.fail_count;
                    }

                    // 更新预计剩余时间
                    if (fetchData.estimated_remaining_seconds !== undefined) {
                        const eta = fetchData.estimated_remaining_seconds;
                        let etaText;
                        if (eta < 60) {
                            etaText = `${eta}秒`;
                        } else {
                            const mins = Math.floor(eta / 60);
                            const secs = eta % 60;
                            etaText = `${mins}分${secs}秒`;
                        }
                        document.getElementById('fetchETA').textContent = etaText;
                    }

                    // 更新网络状态
                    if (fetchData.network_speed) {
                        const dot = document.querySelector('#networkStatus .network-dot');
                        const text = document.querySelector('#networkStatus .network-text');

                        dot.className = 'network-dot ' + fetchData.network_speed;

                        const speedLabels = {
                            'fast': '良好',
                            'normal': '正常',
                            'slow': '较慢'
                        };
                        text.textContent = speedLabels[fetchData.network_speed] || '检测中';

                        // 显示上次请求耗时
                        if (fetchData.last_fetch_time) {
                            text.textContent += ` (${fetchData.last_fetch_time}s)`;
                        }
                    }

                    // 更新当前获取的频道
                    if (fetchData.current_channel) {
                        document.getElementById('fetchCurrent').textContent =
                            `正在获取: ${fetchData.current_channel}`;
                    }
                }

                ws.onerror = (error) => {
                    console.error('WebSocket 错误:', error);
                    if (!resolved) {
                        reject(error);
                    }
                };

                ws.onclose = () => {
                    console.log('WebSocket 已关闭');
                    currentWebSocket = null;
                };

                // 连接超时
                setTimeout(() => {
                    if (!resolved && ws.readyState !== WebSocket.OPEN) {
                        reject(new Error('连接超时'));
                    }
                }, 5000);
            });
        }

        // 保存最后一次分析结果（用于导出）
        let lastAnalysisResult = null;

        // 渲染真实数据
        function renderRealData(result) {
            console.log('渲染真实数据:', result);

            // 保存结果用于导出
            lastAnalysisResult = result;

            // 转换视频数据格式
            let formattedVideos = [];
            if (result.videos && result.videos.length > 0) {
                const avgViews = result.total_views / result.total_videos;
                formattedVideos = result.videos.map((v, index) => ({
                    rank: index + 1,
                    title: v.title,
                    channel: v.channel_name,
                    channelId: v.channel_id,
                    views: v.view_count,
                    likes: v.like_count || 0,
                    comments: v.comment_count || 0,
                    duration: formatDuration(v.duration),
                    durationSeconds: v.duration,
                    date: v.published_at ? formatDate(v.published_at) : '未知',
                    thumbnail: v.thumbnail_url || `https://i.ytimg.com/vi/${v.youtube_id}/mqdefault.jpg`,
                    videoId: v.youtube_id,
                    isAI: v.is_ai_video,
                    aiKeyword: v.ai_keyword,
                    // 新增：视频年龄和日均播放
                    videoAgeDays: v.video_age_days || 1,
                    dailyViews: v.daily_views || 0,
                    // 计算评分
                    score: v.view_count > avgViews * 3 ? 'A' : v.view_count > avgViews ? 'B' : 'C'
                }));

                // 更新视频榜单
                renderVideoRanking(formattedVideos);

                // 保存到全局变量供其他功能使用
                window.currentVideoData = formattedVideos;
            }

            // 保存近期爆款和长青视频到全局变量
            window.recentHits = (result.recent_hits || []).map(v => ({
                title: v.title,
                channel: v.channel_name,
                channelId: v.channel_id,
                views: v.view_count,
                videoId: v.youtube_id,
                videoAgeDays: v.video_age_days,
                dailyViews: v.daily_views,
                date: v.published_at ? formatDate(v.published_at) : '未知'
            }));

            window.evergreenVideos = (result.evergreen_videos || []).map(v => ({
                title: v.title,
                channel: v.channel_name,
                channelId: v.channel_id,
                views: v.view_count,
                videoId: v.youtube_id,
                videoAgeDays: v.video_age_days,
                dailyViews: v.daily_views,
                date: v.published_at ? formatDate(v.published_at) : '未知'
            }));

            // 转换频道数据格式（包含真实数据）
            let formattedChannels = [];
            if (result.channels && result.channels.length > 0) {
                formattedChannels = result.channels.map(ch => ({
                    name: ch.channel_name,
                    channelId: ch.channel_id,
                    videoCount: ch.video_count,
                    avgViews: ch.avg_views,
                    totalViews: ch.total_views,
                    // 真实频道数据
                    subscriberCount: ch.subscriber_count || 0,
                    realVideoCount: ch.real_video_count || 0,
                    totalChannelViews: ch.total_channel_views || 0,  // 频道总播放量
                    avgChannelViews: ch.avg_channel_views || 0,      // 频道平均播放量
                    searchHitCount: ch.search_hit_count || ch.video_count,
                    hasRealStats: ch.has_real_stats || false,
                    fetchStatus: ch.fetch_status || 'unknown'  // 获取状态: success, permanent_failure, network_failure, not_fetched
                }));

                // 更新频道榜单
                renderChannelListFromData(formattedChannels);

                // 保存到全局变量
                window.currentChannelData = formattedChannels;
            }

            // 更新概览摘要
            updateOverviewSummary(result, formattedVideos, formattedChannels);

            // 更新侧边栏统计数字
            updateSidebarBadges(result, formattedVideos, formattedChannels);

            // 更新模式洞察
            if (result.duration_distribution) {
                updateDurationChart(result.duration_distribution, formattedVideos);
            }
            updateTimelineTrend(formattedVideos);
            updateTitlePatterns(formattedVideos);

            // 更新分析报告
            updateReportPanel(result, formattedVideos, formattedChannels);

            // 更新洞察面板
            if (typeof updateInsightPanel === 'function') {
                updateInsightPanel(formattedVideos, formattedChannels, result.duration_distribution);
            }

            // 显示结果
            document.getElementById('resultsContainer').style.display = 'block';
            switchPanel('overview');
        }

        // 更新概览摘要
        function updateOverviewSummary(result, videos, channels) {
            // 更新标题
            const titleEl = document.getElementById('overviewTitle');
            if (titleEl) titleEl.textContent = `📊 「${result.topic}」数据概览`;

            // 更新数字
            document.getElementById('stat-videos').textContent = result.total_videos || 0;
            document.getElementById('stat-channels').textContent = result.total_channels || 0;
            document.getElementById('stat-views').textContent = formatNumber(result.total_views || 0);
            const avgViews = result.total_videos > 0 ? Math.round(result.total_views / result.total_videos) : 0;
            document.getElementById('stat-avg-views').textContent = formatNumber(avgViews);

            // 更新快速入口数字
            document.getElementById('quick-videos').textContent = `${result.total_videos || 0} 个视频`;
            document.getElementById('quick-channels').textContent = `${result.total_channels || 0} 个频道`;

            // 更新关键发现
            const findingsEl = document.getElementById('keyFindingsContent');
            if (findingsEl && videos.length > 0) {
                const topVideo = videos[0];
                const topChannel = channels[0];
                findingsEl.innerHTML = `
                    <p>🎬 <strong>Top 视频</strong>：「${topVideo.title.substring(0, 30)}...」播放量 ${formatNumber(topVideo.views)}</p>
                    <p>📺 <strong>Top 频道</strong>：「${topChannel?.name || '-'}」总播放 ${formatNumber(topChannel?.totalViews || 0)}</p>
                    <p>📊 <strong>平均播放</strong>：${formatNumber(avgViews)}，共分析 ${result.total_videos} 个视频</p>
                `;
            }

            // 更新 Top 3 视频预览（表格格式）
            const top3Videos = document.getElementById('top3VideosList');
            if (top3Videos && videos.length > 0) {
                const top3VideoData = videos.slice(0, 3);
                top3Videos.innerHTML = `
                    <table class="top3-table">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>视频</th>
                                <th>频道</th>
                                <th>播放量</th>
                                <th>时长</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${top3VideoData.map((v, i) => `
                                <tr>
                                    <td class="rank-cell">${i + 1}</td>
                                    <td class="video-title-cell">
                                        <a href="https://www.youtube.com/watch?v=${v.videoId}" target="_blank" class="video-link" title="${v.title}">
                                            ▶🔗 ${v.title}
                                        </a>
                                    </td>
                                    <td class="channel-cell">
                                        <a href="https://www.youtube.com/channel/${v.channelId}" target="_blank" class="channel-link" title="${v.channel}">
                                            @🔗 ${v.channel}
                                        </a>
                                    </td>
                                    <td class="views-cell">${formatNumber(v.views)}</td>
                                    <td class="duration-cell">${v.duration || '--'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // 更新 Top 3 频道预览（表格格式）
            const top3Channels = document.getElementById('top3ChannelsList');
            if (top3Channels && channels.length > 0) {
                const top3ChannelData = channels.slice(0, 3);
                top3Channels.innerHTML = `
                    <table class="top3-table">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>频道</th>
                                <th>订阅</th>
                                <th>视频数</th>
                                <th>总播放</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${top3ChannelData.map((ch, i) => {
                                const subCount = ch.subscriberCount > 0 ? formatNumber(ch.subscriberCount) : '--';
                                const videoCount = ch.hasRealStats && ch.realVideoCount > 0 ? ch.realVideoCount : ch.searchHitCount;
                                return `
                                <tr>
                                    <td class="rank-cell">${i + 1}</td>
                                    <td class="video-title-cell">
                                        <a href="https://www.youtube.com/channel/${ch.channelId}" target="_blank" class="channel-link" title="${ch.name}">
                                            📺🔗 ${ch.name}
                                        </a>
                                    </td>
                                    <td class="subs-cell">${subCount}</td>
                                    <td class="video-count-cell">${videoCount}个</td>
                                    <td class="views-cell">${formatNumber(ch.totalViews)}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        // 更新侧边栏 badge 数字
        function updateSidebarBadges(result, videos, channels) {
            // 视频数据：显示视频总数
            const badgeVideos = document.getElementById('badge-videos');
            if (badgeVideos) badgeVideos.textContent = result.total_videos || videos.length;

            // 频道数据：显示频道总数
            const badgeChannels = document.getElementById('badge-channels');
            if (badgeChannels) badgeChannels.textContent = result.total_channels || channels.length;
        }

        // 从视频标题提取话题关键词
        function extractTopics(videos) {
            const wordCount = {};
            const stopWords = ['的', '是', '在', '了', '和', '与', '或', '这', '那', '有', '为', '以', '及', '等', 'the', 'a', 'an', 'is', 'are', 'to', 'for', 'and', 'or', 'in', 'on', 'at'];

            videos.forEach(v => {
                // 简单分词：按空格和标点分割
                const words = (v.title || '').split(/[\s,，。！？、：:;\-\[\]【】()（）]+/).filter(w => w.length >= 2);
                words.forEach(word => {
                    const w = word.toLowerCase();
                    if (!stopWords.includes(w) && w.length <= 10) {
                        wordCount[w] = (wordCount[w] || 0) + 1;
                    }
                });
            });

            // 返回出现次数>=3的关键词
            return Object.entries(wordCount)
                .filter(([_, count]) => count >= 3)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50)
                .map(([word, count]) => ({ word, count }));
        }

        // 更新时长分布图表
        function updateDurationChart(distribution, videos) {
            const container = document.getElementById('durationChart');
            if (!container) return;

            // 计算更详细的时长分布
            const durationBuckets = {
                '0-1分钟': { min: 0, max: 60, count: 0, views: 0 },
                '1-3分钟': { min: 60, max: 180, count: 0, views: 0 },
                '3-5分钟': { min: 180, max: 300, count: 0, views: 0 },
                '5-10分钟': { min: 300, max: 600, count: 0, views: 0 },
                '10-20分钟': { min: 600, max: 1200, count: 0, views: 0 },
                '20-30分钟': { min: 1200, max: 1800, count: 0, views: 0 },
                '30分钟+': { min: 1800, max: Infinity, count: 0, views: 0 }
            };

            videos.forEach(v => {
                const seconds = v.durationSeconds || 0;
                for (const [label, bucket] of Object.entries(durationBuckets)) {
                    if (seconds >= bucket.min && seconds < bucket.max) {
                        bucket.count++;
                        bucket.views += v.views || 0;
                        break;
                    }
                }
            });

            // 找出最高平均播放量的时长区间
            let maxAvgViews = 0;
            Object.values(durationBuckets).forEach(b => {
                b.avgViews = b.count > 0 ? Math.round(b.views / b.count) : 0;
                if (b.avgViews > maxAvgViews) maxAvgViews = b.avgViews;
            });

            // 渲染图表
            container.innerHTML = Object.entries(durationBuckets).map(([label, bucket]) => {
                const widthPct = maxAvgViews > 0 ? (bucket.avgViews / maxAvgViews * 100) : 0;
                const isTop = bucket.avgViews === maxAvgViews && bucket.count > 0;
                const supplyPct = videos.length > 0 ? (bucket.count / videos.length * 100).toFixed(1) : 0;

                return `
                    <div class="time-bar-row">
                        <span class="time-label">${label}</span>
                        <div class="time-bar-container">
                            <div class="time-bar" style="width: ${widthPct}%; background: linear-gradient(90deg, ${isTop ? '#059669, #10b981' : '#0891b2, #06b6d4'});">
                                ${bucket.avgViews > 10000 ? formatNumber(bucket.avgViews) : bucket.avgViews.toLocaleString()}
                            </div>
                        </div>
                        <span class="time-meta">供给 ${supplyPct}%</span>
                    </div>
                `;
            }).join('');
        }

        // 更新时间趋势
        function updateTimelineTrend(videos) {
            const container = document.getElementById('timelineChart');
            if (!container) return;

            // 按月份统计
            const monthlyData = {};
            videos.forEach(v => {
                if (v.date && v.date !== '未知') {
                    const month = v.date.slice(0, 7); // YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = { count: 0, views: 0 };
                    }
                    monthlyData[month].count++;
                    monthlyData[month].views += v.views || 0;
                }
            });

            // 排序并取最近6个月
            const sortedMonths = Object.entries(monthlyData)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 6)
                .reverse();

            if (sortedMonths.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">暂无时间数据</p>';
                return;
            }

            const maxViews = Math.max(...sortedMonths.map(([_, d]) => d.views));

            container.innerHTML = sortedMonths.map(([month, data]) => {
                const widthPct = maxViews > 0 ? (data.views / maxViews * 100) : 0;
                const avgViews = data.count > 0 ? Math.round(data.views / data.count) : 0;

                return `
                    <div class="time-bar-row">
                        <span class="time-label">${month}</span>
                        <div class="time-bar-container">
                            <div class="time-bar" style="width: ${widthPct}%; background: linear-gradient(90deg, #0891b2, #06b6d4);">
                                ${data.count} 个视频
                            </div>
                        </div>
                        <span class="time-meta">均播 ${formatNumber(avgViews)}</span>
                    </div>
                `;
            }).join('');
        }

        // 格式化时长
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 格式化日期
        function formatDate(dateStr) {
            if (!dateStr) return '未知';
            // 处理 YYYYMMDD 格式
            if (dateStr.length === 8 && !dateStr.includes('-')) {
                return `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
            }
            return dateStr;
        }

        // 构建频道统计信息文本
        function buildChannelStatsText(ch, showDetailed = false) {
            if (ch.hasRealStats && ch.realVideoCount > 0) {
                // 有真实数据
                const subText = ch.subscriberCount > 0 ? `${formatNumber(ch.subscriberCount)}订阅 · ` : '';
                if (showDetailed && ch.totalChannelViews > 0) {
                    // 详细模式：显示总播放量和平均播放量
                    return `${subText}${ch.realVideoCount}个视频 · 总${formatNumber(ch.totalChannelViews)}播放 · 均${formatNumber(ch.avgChannelViews)}`;
                }
                return `${subText}${ch.realVideoCount}个视频 · 平均 ${formatNumber(ch.avgViews)} 播放`;
            } else {
                // 无真实数据
                return `搜索命中 ${ch.searchHitCount || ch.videoCount} 个 · 平均 ${formatNumber(ch.avgViews)} 播放`;
            }
        }

        // 从真实数据渲染频道列表
        function renderChannelListFromData(channels, mode = null, titleSuffix = '') {
            // 更新频道分析面板 (#channelList)
            const container = document.getElementById('channelList');
            if (container) {
                container.innerHTML = channels.slice(0, 50).map((ch, i) => `
                    <div class="channel-item" onclick="openChannel('${ch.channelId}')" style="cursor: pointer;" title="点击打开频道">
                        <div class="channel-rank">${i + 1}</div>
                        <div class="channel-avatar">${ch.name.charAt(0)}</div>
                        <div class="channel-info">
                            <div class="channel-name">${ch.name}</div>
                            <div class="channel-stats">
                                ${buildChannelStatsText(ch, true)}
                            </div>
                        </div>
                        <div class="channel-subscribers">${ch.hasRealStats && ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : formatNumber(ch.totalViews)}播放</div>
                    </div>
                `).join('');
            }

            // 同时更新频道榜单面板 (#channelRankingContainer) - 表格格式
            const rankingContainer = document.getElementById('channelRankingContainer');
            if (rankingContainer) {
                if (channels.length === 0) {
                    const emptyConfig = {
                        darkHorse: { icon: '🐴', title: '暂无黑马频道', desc: '未找到短视频涨粉潜力频道' },
                        efficiency: { icon: '🚀', title: '暂无高效频道', desc: '未找到高平均播放的频道' },
                        default: { icon: '📺', title: '暂无频道数据', desc: '搜索关键词后，这里将展示频道排行榜' }
                    };
                    const cfg = emptyConfig[mode] || emptyConfig.default;
                    rankingContainer.innerHTML = `
                        <div class="no-data-state">
                            <div class="no-data-icon">${cfg.icon}</div>
                            <div class="no-data-title">${cfg.title}</div>
                            <p class="no-data-desc">${cfg.desc}</p>
                        </div>
                    `;
                    return;
                }

                // 表格列配置
                const tableConfig = {
                    totalViews: {
                        title: '📊 总播放榜',
                        columns: ['排名', '频道名称', '订阅数', '视频数', '总播放', '平均播放'],
                        getValue: (ch) => [
                            ch.subscriberCount > 0 ? formatNumber(ch.subscriberCount) : '-',
                            ch.realVideoCount || '-',
                            ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : '-',
                            ch.avgChannelViews > 0 ? formatNumber(ch.avgChannelViews) : '-'
                        ],
                        highlight: 4 // 高亮"总播放"列
                    },
                    avgViews: {
                        title: '⚡ 平均播放榜',
                        columns: ['排名', '频道名称', '订阅数', '视频数', '平均播放', '总播放'],
                        getValue: (ch) => [
                            ch.subscriberCount > 0 ? formatNumber(ch.subscriberCount) : '-',
                            ch.realVideoCount || '-',
                            ch.avgChannelViews > 0 ? formatNumber(ch.avgChannelViews) : '-',
                            ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : '-'
                        ],
                        highlight: 4 // 高亮"平均播放"列
                    },
                    videoCount: {
                        title: '📹 视频数榜',
                        columns: ['排名', '频道名称', '订阅数', '视频数', '总播放', '平均播放'],
                        getValue: (ch) => [
                            ch.subscriberCount > 0 ? formatNumber(ch.subscriberCount) : '-',
                            ch.realVideoCount || '-',
                            ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : '-',
                            ch.avgChannelViews > 0 ? formatNumber(ch.avgChannelViews) : '-'
                        ],
                        highlight: 3 // 高亮"视频数"列
                    },
                    darkHorse: {
                        title: '🐴 黑马榜',
                        columns: ['排名', '频道名称', '短视频数', '短视频播放', '估算涨粉'],
                        getValue: (ch) => [
                            ch.shortVideoCount || 0,
                            ch.shortVideoViews > 0 ? formatNumber(ch.shortVideoViews) : '-',
                            '+' + formatNumber(ch.estimatedFollowers || 0)
                        ],
                        highlight: 4 // 高亮"估算涨粉"列
                    },
                    efficiency: {
                        title: '🚀 高效榜',
                        columns: ['排名', '频道名称', '订阅数', '视频数', '平均播放', '总播放'],
                        getValue: (ch) => [
                            ch.subscriberCount > 0 ? formatNumber(ch.subscriberCount) : '-',
                            ch.realVideoCount || '-',
                            ch.avgChannelViews > 0 ? formatNumber(ch.avgChannelViews) : '-',
                            ch.totalChannelViews > 0 ? formatNumber(ch.totalChannelViews) : '-'
                        ],
                        highlight: 4 // 高亮"平均播放"列
                    }
                };

                const config = tableConfig[mode] || tableConfig.totalViews;

                rankingContainer.innerHTML = `
                    <div class="ranking-section">
                        <div class="ranking-header">
                            <span class="ranking-title">
                                ${config.title}
                                <span class="ranking-count">共 ${channels.length} 个频道</span>
                            </span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr style="background: #0f172a; border-bottom: 2px solid #334155;">
                                        ${config.columns.map((col, idx) => `
                                            <th style="padding: 12px 16px; text-align: ${idx <= 1 ? 'left' : 'right'}; color: #94a3b8; font-weight: 500; white-space: nowrap;">
                                                ${col}
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${channels.slice(0, 50).map((ch, i) => {
                                        const values = config.getValue(ch);
                                        const hasData = ch.hasRealStats && ch.realVideoCount > 0;
                                        // 根据获取状态显示不同标签
                                        let statusLabel = '';
                                        if (!hasData) {
                                            if (ch.fetchStatus === 'permanent_failure') {
                                                statusLabel = '<span style="color: #ef4444; font-size: 0.8em; margin-left: 6px;">(获取失败)</span>';
                                            } else if (ch.fetchStatus === 'network_failure') {
                                                statusLabel = '<span style="color: #f59e0b; font-size: 0.8em; margin-left: 6px;">(网络错误)</span>';
                                            } else if (ch.fetchStatus === 'not_fetched') {
                                                statusLabel = '<span style="color: #64748b; font-size: 0.8em; margin-left: 6px;">(未获取)</span>';
                                            }
                                        }
                                        return `
                                            <tr onclick="openChannel('${ch.channelId}')"
                                                style="border-bottom: 1px solid #334155; cursor: pointer; transition: background 0.2s;"
                                                onmouseover="this.style.background='#334155'"
                                                onmouseout="this.style.background='transparent'">
                                                <td style="padding: 12px 16px; color: ${i < 3 ? '#f59e0b' : '#64748b'}; font-weight: ${i < 3 ? '700' : '500'};">
                                                    ${i + 1}
                                                </td>
                                                <td style="padding: 12px 16px; color: #e2e8f0; font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    ${ch.name}
                                                    ${statusLabel}
                                                </td>
                                                ${values.map((val, idx) => `
                                                    <td style="padding: 12px 16px; text-align: right; color: ${idx + 2 === config.highlight ? '#06b6d4' : '#e2e8f0'}; font-weight: ${idx + 2 === config.highlight ? '600' : '400'};">
                                                        ${val}
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
        }

        // 打开频道链接
        function openChannel(channelId) {
            if (channelId) {
                window.open(`https://www.youtube.com/channel/${channelId}`, '_blank');
            }
        }

        // 频道真实数据缓存
        const channelRealDataCache = {};

        // 获取单个频道的真实数据
        async function fetchChannelRealData(channelId) {
            // 检查缓存
            if (channelRealDataCache[channelId]) {
                return channelRealDataCache[channelId];
            }

            try {
                const response = await fetch(`http://localhost:8000/api/channel/${channelId}`);
                if (!response.ok) {
                    throw new Error('获取失败');
                }
                const data = await response.json();
                // 缓存结果
                channelRealDataCache[channelId] = data;
                return data;
            } catch (error) {
                console.error('获取频道数据失败:', error);
                return null;
            }
        }

        // 显示频道详情弹窗
        async function showChannelDetail(channelId, channelName, event) {
            event.stopPropagation(); // 阻止触发 openChannel

            // 找到对应的 ranking-item
            const btn = event.target;
            const item = btn.closest('.ranking-item');
            if (!item) return;

            // 显示加载状态
            btn.textContent = '⏳ 加载中...';
            btn.disabled = true;

            const data = await fetchChannelRealData(channelId);

            if (data) {
                // 更新显示 - 在 video-meta 中追加真实数据
                const metaEl = item.querySelector('.video-meta');
                if (metaEl) {
                    // 创建真实数据展示行
                    const realDataHtml = `
                        <div class="channel-real-data" style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed rgba(255,255,255,0.1);">
                            <span style="color: #10b981;">✅ 真实数据</span>
                            <span>订阅 <strong style="color: #f59e0b;">${formatNumber(data.subscriber_count)}</strong></span>
                            <span>共 <strong>${data.video_count}</strong> 个视频</span>
                        </div>
                    `;
                    // 检查是否已经添加过
                    if (!metaEl.querySelector('.channel-real-data')) {
                        metaEl.insertAdjacentHTML('beforeend', realDataHtml);
                    }
                }
                btn.textContent = '✅ 已加载';
                btn.style.background = 'rgba(16, 185, 129, 0.2)';
                btn.style.color = '#10b981';
            } else {
                btn.textContent = '❌ 失败';
                btn.style.background = 'rgba(239, 68, 68, 0.2)';
                btn.style.color = '#ef4444';
                setTimeout(() => {
                    btn.textContent = '📊 重试';
                    btn.disabled = false;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }
        }

        // 批量获取频道真实数据（用于榜单）
        async function fetchChannelsBatch(channelIds) {
            // 过滤掉已缓存的
            const uncachedIds = channelIds.filter(id => !channelRealDataCache[id]);
            if (uncachedIds.length === 0) {
                return channelIds.map(id => channelRealDataCache[id]);
            }

            try {
                const response = await fetch('http://localhost:8000/api/channels/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(uncachedIds.slice(0, 10)) // 最多10个
                });
                if (!response.ok) throw new Error('批量获取失败');

                const result = await response.json();
                // 缓存结果
                for (const [id, data] of Object.entries(result.channels)) {
                    if (data.success) {
                        channelRealDataCache[id] = data;
                    }
                }
            } catch (error) {
                console.error('批量获取频道数据失败:', error);
            }

            return channelIds.map(id => channelRealDataCache[id] || null);
        }

        // 更新洞察面板
        function updateInsights(result) {
            const container = document.getElementById('panel-overview');
            if (!container) return;

            const insights = result.insights;
            const summary = insights.market_summary || {};

            // 构建洞察卡片
            let opportunitiesHtml = '';
            if (insights.opportunities && insights.opportunities.length > 0) {
                opportunitiesHtml = insights.opportunities.map(opp => `
                    <div class="insight-card">
                        <div class="insight-badge ${opp.score === 'A' ? 'high' : 'medium'}">${opp.score}</div>
                        <div class="insight-content">
                            <div class="insight-title">${opp.title}</div>
                            <div class="insight-desc">${opp.description}</div>
                        </div>
                    </div>
                `).join('');
            }

            // AI 视频统计
            const aiCount = result.ai_video_count || 0;
            const aiPct = result.total_videos > 0 ? ((aiCount / result.total_videos) * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="overview-header">
                    <div class="overview-title-row">
                        <h2>「${result.topic}」市场分析</h2>
                        <div class="export-buttons">
                            <button class="export-btn" onclick="exportData('csv')" title="导出CSV格式">
                                📊 导出 CSV
                            </button>
                            <button class="export-btn" onclick="exportData('json')" title="导出JSON格式">
                                📁 导出 JSON
                            </button>
                        </div>
                    </div>
                    <div class="overview-stats">
                        <div class="stat-item">
                            <div class="stat-value">${formatNumber(result.total_videos)}</div>
                            <div class="stat-label">视频数量</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${formatNumber(result.total_views)}</div>
                            <div class="stat-label">总播放量</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${result.total_channels}</div>
                            <div class="stat-label">频道数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${aiCount} (${aiPct}%)</div>
                            <div class="stat-label">AI视频</div>
                        </div>
                    </div>
                </div>

                <div class="insights-section">
                    <h3>发现的机会</h3>
                    ${opportunitiesHtml || '<p class="no-data">暂无明显机会</p>'}
                </div>

                ${insights.top_performing ? `
                <div class="top-video-section">
                    <h3>最佳表现视频</h3>
                    <div class="top-video-card">
                        <div class="top-video-title">${insights.top_performing.title}</div>
                        <div class="top-video-meta">
                            ${insights.top_performing.channel} · ${formatNumber(insights.top_performing.views)} 播放
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        // 频道诊断
        async function startDiagnose() {
            const input = document.getElementById('diagnoseInput').value.trim();
            if (!input) {
                alert('请输入频道链接或名称');
                return;
            }

            // 隐藏其他内容
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';

            // 显示分析状态
            document.getElementById('analysisStatus').classList.add('show');
            document.getElementById('statusTitle').textContent = `正在诊断频道...`;
            document.getElementById('statusBadge').textContent = '分析中';
            document.getElementById('statusBadge').className = 'status-badge running';
            document.getElementById('progressFill').className = 'progress-fill';

            const steps = [
                { progress: 20, log: '正在获取频道信息...' },
                { progress: 40, log: '正在分析视频数据...' },
                { progress: 60, log: '正在对比同类频道...' },
                { progress: 80, log: '正在匹配对标账号...' },
                { progress: 100, log: '诊断完成！' },
            ];

            for (const step of steps) {
                await new Promise(r => setTimeout(r, 500));
                document.getElementById('progressFill').style.width = step.progress + '%';
                document.getElementById('statusLog').textContent = step.log;
            }

            document.getElementById('statusBadge').textContent = '完成';
            document.getElementById('statusBadge').className = 'status-badge done';
            document.getElementById('progressFill').className = 'progress-fill done';

            await new Promise(r => setTimeout(r, 300));
            document.getElementById('analysisStatus').classList.remove('show');

            // 显示诊断结果
            document.getElementById('diagnoseChannelName').textContent = input.includes('@') ? input : '我的养生频道';
            renderRecommendList();
            document.getElementById('diagnoseResult').classList.add('show');
        }

        let videoLimit = 50;
        function loadMoreVideos() {
            videoLimit += 50;
            const data = window.currentVideoData || [];
            renderVideoRanking(data, videoLimit);
        }

        // 当前视频标签状态
        let currentVideoTab = 'hot';
        let currentVideoTimeFilter = 0; // 0=全部, 1=24小时, 7=7天, 30=30天, 90=90天

        // 设置时间筛选
        function setVideoTimeFilter(days) {
            currentVideoTimeFilter = days;
            // 更新按钮状态
            document.querySelectorAll('#videoTimeFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // 重新应用当前标签的筛选
            applyVideoFilters();
        }

        // 应用视频筛选（结合标签和时间筛选）
        function applyVideoFilters() {
            const data = window.currentVideoData || [];
            if (!data || data.length === 0) return;

            let sortedData = [...data];
            let titleText = '';
            const now = new Date();

            // 先应用时间筛选（如果不是"全部"）
            if (currentVideoTimeFilter > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - currentVideoTimeFilter);
                sortedData = sortedData.filter(v => {
                    if (!v.date || v.date === '未知') return false;
                    const videoDate = new Date(v.date);
                    return !isNaN(videoDate.getTime()) && videoDate >= cutoffDate;
                });
            }

            // 然后应用标签筛选
            switch (currentVideoTab) {
                case 'hot':
                    // 🔥 爆款视频：按播放量降序
                    sortedData.sort((a, b) => b.views - a.views);
                    titleText = '🔥 爆款视频 Top 100';
                    break;
                case 'potential':
                    // 📈 潜力视频：按播放效率排序
                    const avgViewsPotential = sortedData.reduce((sum, v) => sum + v.views, 0) / sortedData.length || 1;
                    sortedData = sortedData.filter(v => v.views >= avgViewsPotential * 0.1 && v.views <= avgViewsPotential * 2);
                    sortedData.sort((a, b) => {
                        const durationA = a.durationSeconds || parseDuration(a.duration) || 60;
                        const durationB = b.durationSeconds || parseDuration(b.duration) || 60;
                        const efficiencyA = a.views / Math.sqrt(durationA);
                        const efficiencyB = b.views / Math.sqrt(durationB);
                        return efficiencyB - efficiencyA;
                    });
                    titleText = '📈 潜力视频 Top 100';
                    break;
                case 'recent':
                    // 🆕 近期热门：按日均播放量排序（时间筛选已在上面应用）
                    // 如果没有选时间筛选，默认筛选30天
                    if (currentVideoTimeFilter === 0) {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        sortedData = sortedData.filter(v => {
                            if (!v.date || v.date === '未知') return false;
                            const videoDate = new Date(v.date);
                            return !isNaN(videoDate.getTime()) && videoDate >= thirtyDaysAgo;
                        });
                    }
                    // 按日均播放量排序
                    sortedData.sort((a, b) => {
                        const daysA = Math.max(1, (now - new Date(a.date)) / (1000 * 60 * 60 * 24));
                        const daysB = Math.max(1, (now - new Date(b.date)) / (1000 * 60 * 60 * 24));
                        return (b.views / daysB) - (a.views / daysA);
                    });
                    titleText = '🆕 近期热门 Top 100';
                    break;
                case 'longform':
                    // ⏱️ 长视频榜：时长 >= 3分钟
                    sortedData = sortedData.filter(v => {
                        const seconds = v.durationSeconds || parseDuration(v.duration);
                        return seconds >= 180;
                    });
                    sortedData.sort((a, b) => b.views - a.views);
                    titleText = '⏱️ 长视频榜 Top 100';
                    break;
                case 'recentHits':
                    // ⚡ 近期爆款：30天内发布，播放量>=10万（使用后端计算的数据）
                    if (window.recentHits && window.recentHits.length > 0) {
                        sortedData = window.recentHits.map((v, i) => ({
                            rank: i + 1,
                            title: v.title,
                            channel: v.channel,
                            channelId: v.channelId,
                            views: v.views,
                            videoId: v.videoId,
                            date: v.date,
                            videoAgeDays: v.videoAgeDays,
                            dailyViews: v.dailyViews,
                            thumbnail: `https://i.ytimg.com/vi/${v.videoId}/mqdefault.jpg`,
                            score: v.views > 500000 ? 'A' : v.views > 200000 ? 'B' : 'C'
                        }));
                    } else {
                        // 如果后端没有返回数据，从前端数据中筛选
                        sortedData = sortedData.filter(v => v.videoAgeDays <= 30 && v.views >= 1000);
                        sortedData.sort((a, b) => b.views - a.views);
                    }
                    titleText = '⚡ 近期爆款 Top 50（30天内，≥1000播放）';
                    break;
                case 'evergreen':
                    // 🌲 长青视频：>180天但日均播放>=1000
                    if (window.evergreenVideos && window.evergreenVideos.length > 0) {
                        sortedData = window.evergreenVideos.map((v, i) => ({
                            rank: i + 1,
                            title: v.title,
                            channel: v.channel,
                            channelId: v.channelId,
                            views: v.views,
                            videoId: v.videoId,
                            date: v.date,
                            videoAgeDays: v.videoAgeDays,
                            dailyViews: v.dailyViews,
                            thumbnail: `https://i.ytimg.com/vi/${v.videoId}/mqdefault.jpg`,
                            score: v.dailyViews > 5000 ? 'A' : v.dailyViews > 2000 ? 'B' : 'C'
                        }));
                    } else {
                        // 从前端数据中筛选
                        sortedData = sortedData.filter(v => v.videoAgeDays > 180 && v.dailyViews >= 1000);
                        sortedData.sort((a, b) => b.dailyViews - a.dailyViews);
                    }
                    titleText = '🌲 长青视频 Top 50（>180天，日均≥1000播放）';
                    break;
            }

            // 添加时间筛选标识到标题
            const timeLabels = { 0: '', 1: '（近24小时）', 7: '（近7天）', 30: '（近30天）', 90: '（近90天）' };
            if (currentVideoTimeFilter > 0 && currentVideoTab !== 'recent') {
                titleText = titleText.replace(' Top 100', timeLabels[currentVideoTimeFilter] + ' Top 100');
            }

            // 重新编排排名
            sortedData.forEach((v, i) => v.rank = i + 1);

            // 更新标题
            const titleEl = document.querySelector('#panel-videos .ranking-title');
            if (titleEl) {
                titleEl.innerHTML = `${titleText} <span class="ranking-count">共 ${sortedData.length} 个</span>`;
            }

            // 渲染数据
            renderVideoRanking(sortedData);
        }

        function switchVideoTab(tab) {
            document.querySelectorAll('#panel-videos .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentVideoTab = tab;
            // 调用统一的筛选函数
            applyVideoFilters();
        }

        // 解析时长字符串为秒数
        function parseDuration(durationStr) {
            if (!durationStr) return 0;
            if (typeof durationStr === 'number') return durationStr;
            // 支持 "12分钟" 或 "12:34" 格式
            const minMatch = durationStr.match(/(\d+)分钟/);
            if (minMatch) return parseInt(minMatch[1]) * 60;
            const colonMatch = durationStr.match(/(\d+):(\d+)/);
            if (colonMatch) return parseInt(colonMatch[1]) * 60 + parseInt(colonMatch[2]);
            return 0;
        }

        // 视频分析标签切换
        let currentVideoAnalysisTab = 'hot';

        function switchVideoAnalysisTab(tab) {
            document.querySelectorAll('#panel-video-analysis .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentVideoAnalysisTab = tab;

            const data = window.currentVideoData;
            if (!data || data.length === 0) return;

            let filteredData = [...data];
            let titleText = '';
            let description = '';

            switch (tab) {
                case 'hot':
                    // 🔥 爆款分析：播放量 > 平均值的3倍
                    const avgViews = data.reduce((sum, v) => sum + v.views, 0) / data.length;
                    filteredData = data.filter(v => v.views > avgViews * 3);
                    filteredData.sort((a, b) => b.views - a.views);
                    titleText = '🔥 爆款分析';
                    description = `播放量超过平均值3倍（>${formatNumber(avgViews * 3)}）的视频`;
                    break;
                case 'potential':
                    // 📈 潜力视频：互动率高但播放量中等
                    const medianViews = data.sort((a, b) => a.views - b.views)[Math.floor(data.length / 2)].views;
                    filteredData = data.filter(v => {
                        const engagementRate = (v.likes || 0) / (v.views || 1);
                        return v.views < medianViews * 2 && v.views > medianViews * 0.3 && engagementRate > 0.03;
                    });
                    filteredData.sort((a, b) => {
                        const rateA = (a.likes || 0) / (a.views || 1);
                        const rateB = (b.likes || 0) / (b.views || 1);
                        return rateB - rateA;
                    });
                    titleText = '📈 潜力视频';
                    description = '播放量中等但互动率>3%的视频，有爆发潜力';
                    break;
                case 'viral':
                    // 🚀 病毒传播：发布时间短但播放量高（日均播放高）
                    const now = new Date();
                    filteredData = data.map(v => {
                        const pubDate = new Date(v.date);
                        const daysSincePublish = Math.max(1, (now - pubDate) / (1000 * 60 * 60 * 24));
                        return { ...v, dailyViews: v.views / daysSincePublish };
                    }).filter(v => v.dailyViews > 1000); // 日均播放 > 1000
                    filteredData.sort((a, b) => b.dailyViews - a.dailyViews);
                    titleText = '🚀 病毒传播';
                    description = '日均播放量>1000的视频，传播速度快';
                    break;
                case 'benchmark':
                    // 🎯 对标视频：综合评分高（播放+互动+时长平衡）
                    filteredData = data.map(v => {
                        const viewScore = Math.min(v.views / 100000, 10); // 10万播放=10分
                        const engageScore = ((v.likes || 0) / (v.views || 1)) * 200; // 5%互动率=10分
                        const durationScore = Math.min((v.durationSeconds || 300) / 60, 10); // 10分钟=10分
                        return { ...v, benchmarkScore: viewScore + engageScore + durationScore };
                    });
                    filteredData.sort((a, b) => b.benchmarkScore - a.benchmarkScore);
                    titleText = '🎯 对标视频';
                    description = '综合评分高的视频，适合作为内容参考';
                    break;
            }

            // 重新编排排名
            filteredData.forEach((v, i) => v.rank = i + 1);

            // 渲染视频分析列表
            renderVideoAnalysisList(filteredData, titleText, description);
        }

        // 渲染视频分析列表
        function renderVideoAnalysisList(data, title, description) {
            const container = document.getElementById('videoAnalysisList');
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">🔍</div>
                        <div class="no-data-title">暂无符合条件的视频</div>
                        <p class="no-data-desc">${description}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="ai-insight" style="margin-bottom: 16px;">
                    <div class="ai-content">
                        <p><strong>${title}</strong>：${description}</p>
                        <p>共找到 <strong>${data.length}</strong> 个符合条件的视频</p>
                    </div>
                </div>
                <div class="ranking-list">
                    ${data.slice(0, 50).map(v => `
                        <div class="ranking-item" onclick="openVideo('${v.videoId}')" style="cursor: pointer;">
                            <div class="rank-number ${v.rank <= 3 ? 'rank-' + v.rank : 'rank-normal'}">${v.rank}</div>
                            <div class="rank-thumb">🎬</div>
                            <div class="rank-info">
                                <div class="rank-title">${v.title}</div>
                                <div class="rank-meta">
                                    <span>${v.channel}</span>
                                    <span>${v.duration}</span>
                                    <span>${v.date}</span>
                                    ${v.dailyViews ? `<span>日均${formatNumber(Math.round(v.dailyViews))}</span>` : ''}
                                    ${v.benchmarkScore ? `<span>评分${v.benchmarkScore.toFixed(1)}</span>` : ''}
                                </div>
                            </div>
                            <div class="rank-stats">
                                <div class="rank-stat">
                                    <div class="rank-stat-value">${formatNumber(v.views)}</div>
                                    <div class="rank-stat-label">播放</div>
                                </div>
                                <div class="rank-stat">
                                    <div class="rank-stat-value">${((v.likes || 0) / (v.views || 1) * 100).toFixed(1)}%</div>
                                    <div class="rank-stat-label">互动率</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 当前频道标签状态
        let currentChannelTab = 'totalViews';

        function switchChannelTab(tab) {
            document.querySelectorAll('#panel-channels .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentChannelTab = tab;

            const channelData = window.currentChannelData;
            const videoData = window.currentVideoData;
            if (!channelData || channelData.length === 0) return;

            let sortedData = [...channelData];
            let titleSuffix = '';

            switch (tab) {
                case 'totalViews':
                    sortedData.sort((a, b) => (b.totalViews || 0) - (a.totalViews || 0));
                    break;
                case 'avgViews':
                    sortedData.sort((a, b) => (b.avgViews || 0) - (a.avgViews || 0));
                    break;
                case 'videoCount':
                    sortedData.sort((a, b) => (b.videoCount || 0) - (a.videoCount || 0));
                    break;
                case 'darkHorse':
                    // 🐴 黑马榜：短视频（<60秒）涨粉潜力频道
                    // 筛选条件：有短视频且估算涨粉>1000
                    // 涨粉估算公式：短视频总播放量 * 0.002（假设0.2%转化率）
                    if (videoData && videoData.length > 0) {
                        // 统计每个频道的短视频数据
                        const channelShortStats = {};
                        videoData.forEach(v => {
                            const seconds = v.durationSeconds || 0;
                            if (seconds > 0 && seconds <= 60) { // 短视频定义：<=60秒
                                const chId = v.channelId;
                                if (!channelShortStats[chId]) {
                                    channelShortStats[chId] = {
                                        shortVideoCount: 0,
                                        shortVideoViews: 0,
                                        channelName: v.channel
                                    };
                                }
                                channelShortStats[chId].shortVideoCount++;
                                channelShortStats[chId].shortVideoViews += v.views || 0;
                            }
                        });

                        // 计算涨粉估算并筛选
                        sortedData = channelData
                            .map(ch => {
                                const stats = channelShortStats[ch.channelId] || { shortVideoCount: 0, shortVideoViews: 0 };
                                const estimatedFollowers = Math.round(stats.shortVideoViews * 0.002); // 0.2%转化率
                                return {
                                    ...ch,
                                    shortVideoCount: stats.shortVideoCount,
                                    shortVideoViews: stats.shortVideoViews,
                                    estimatedFollowers: estimatedFollowers
                                };
                            })
                            .filter(ch => ch.shortVideoCount > 0 && ch.estimatedFollowers >= 1000)
                            .sort((a, b) => b.estimatedFollowers - a.estimatedFollowers);

                        titleSuffix = ` (短视频涨粉≥1000)`;
                    } else {
                        sortedData = [];
                    }
                    break;
                case 'efficiency':
                    // 🚀 高效榜：按搜索结果中的平均播放量排序
                    // 反映该频道在此领域的视频表现
                    sortedData = channelData
                        .filter(ch => (ch.avgViews || 0) >= 50000) // 平均播放≥5万
                        .sort((a, b) => (b.avgViews || 0) - (a.avgViews || 0));

                    titleSuffix = ` (搜索结果中平均播放≥5万)`;
                    break;
            }

            const modeMap = { darkHorse: 'darkHorse', efficiency: 'efficiency' };
            renderChannelListFromData(sortedData, modeMap[tab] || null, titleSuffix);
        }

        let channelLimit = 50;
        function loadMoreChannels() {
            channelLimit += 50;
            const data = window.currentChannelData;
            if (data) {
                renderChannelListFromData(data.slice(0, channelLimit));
            }
        }

        // 频道分析标签切换
        let currentChannelAnalysisTab = 'worthy';

        function switchChannelAnalysisTab(tab) {
            document.querySelectorAll('#panel-channels .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentChannelAnalysisTab = tab;

            const data = window.currentChannelData;
            if (!data || data.length === 0) return;

            let filteredData = [...data];
            let titleText = '';
            let description = '';

            switch (tab) {
                case 'worthy':
                    // ⭐ 值得研究：综合表现好（视频多+播放高）
                    filteredData = data.filter(ch => ch.videoCount >= 5 && ch.avgViews >= 10000);
                    filteredData.sort((a, b) => {
                        const scoreA = (a.avgViews || 0) * Math.log10(a.videoCount || 1);
                        const scoreB = (b.avgViews || 0) * Math.log10(b.videoCount || 1);
                        return scoreB - scoreA;
                    });
                    titleText = '⭐ 值得研究';
                    description = '视频数≥5且平均播放≥1万的优质频道';
                    break;
                case 'growing':
                    // 📈 快速成长：视频少但播放高（新频道潜力大）
                    filteredData = data.filter(ch => ch.videoCount <= 20 && ch.avgViews >= 20000);
                    filteredData.sort((a, b) => (b.avgViews || 0) - (a.avgViews || 0));
                    titleText = '📈 快速成长';
                    description = '视频数≤20但平均播放≥2万的新兴频道';
                    break;
                case 'leader':
                    // 🎯 细分龙头：视频多+总播放高
                    filteredData = data.filter(ch => ch.videoCount >= 10);
                    filteredData.sort((a, b) => (b.totalViews || 0) - (a.totalViews || 0));
                    titleText = '🎯 细分龙头';
                    description = '视频数≥10的头部频道，按总播放量排序';
                    break;
                case 'emerging':
                    // 🆕 新兴频道：视频少（≤10）但有一定播放
                    filteredData = data.filter(ch => ch.videoCount <= 10 && ch.avgViews >= 5000);
                    filteredData.sort((a, b) => (b.avgViews || 0) - (a.avgViews || 0));
                    titleText = '🆕 新兴频道';
                    description = '视频数≤10的新频道，有发展潜力';
                    break;
            }

            // 渲染频道分析列表
            renderChannelAnalysisList(filteredData, titleText, description);
        }

        // 渲染频道分析列表
        function renderChannelAnalysisList(data, title, description) {
            const container = document.getElementById('channelList');
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">📺</div>
                        <div class="no-data-title">暂无符合条件的频道</div>
                        <p class="no-data-desc">${description}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="ai-insight" style="margin-bottom: 16px;">
                    <div class="ai-content">
                        <p><strong>${title}</strong>：${description}</p>
                        <p>共找到 <strong>${data.length}</strong> 个符合条件的频道</p>
                    </div>
                </div>
                ${data.slice(0, 30).map((ch, i) => `
                    <div class="channel-card">
                        <div class="channel-header">
                            <div class="channel-avatar">${ch.name ? ch.name[0] : '?'}</div>
                            <div class="channel-info">
                                <div class="channel-name">${ch.name || '未知频道'}</div>
                                <div class="channel-meta">
                                    ${ch.videoCount || 0} 个视频 ·
                                    均播 ${formatNumber(ch.avgViews || 0)} ·
                                    总播放 ${formatNumber(ch.totalViews || 0)}
                                </div>
                            </div>
                            <div class="channel-stats">
                                <div class="channel-stat">
                                    <div class="channel-stat-value">${formatNumber(ch.avgViews || 0)}</div>
                                    <div class="channel-stat-label">均播</div>
                                </div>
                                <div class="channel-stat">
                                    <div class="channel-stat-value">${ch.videoCount || 0}</div>
                                    <div class="channel-stat-label">视频</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function toggleVideoAnalysis(index) {
            const el = document.getElementById(`video-analysis-${index}`);
            if (el) {
                el.classList.toggle('open');
            }
        }

        // 话题机会标签切换
        let currentTopicTab = 'opportunity';

        function switchTopicTab(tab) {
            document.querySelectorAll('#panel-topics .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentTopicTab = tab;

            const data = window.currentVideoData;
            if (!data || data.length === 0) return;

            // 从视频标题中提取话题关键词
            const topicStats = extractTopicStats(data);
            let filteredTopics = [...topicStats];
            let titleText = '';
            let description = '';

            switch (tab) {
                case 'opportunity':
                    // 🎯 高机会话题：需求高（出现多）但竞争低（平均播放高）
                    filteredTopics = topicStats.filter(t => t.count >= 3 && t.avgViews >= 50000);
                    filteredTopics.sort((a, b) => (b.avgViews * Math.log10(b.count)) - (a.avgViews * Math.log10(a.count)));
                    titleText = '🎯 高机会话题';
                    description = '出现≥3次且平均播放≥5万的话题，需求大竞争小';
                    break;
                case 'bridge':
                    // 🔗 桥梁话题：连接多个领域的话题
                    filteredTopics = topicStats.filter(t => t.count >= 5);
                    filteredTopics.sort((a, b) => b.count - a.count);
                    titleText = '🔗 桥梁话题';
                    description = '出现≥5次的高频话题，可作为内容连接点';
                    break;
                case 'saturated':
                    // 📊 热门但饱和：出现多但平均播放低
                    filteredTopics = topicStats.filter(t => t.count >= 5 && t.avgViews < 30000);
                    filteredTopics.sort((a, b) => b.count - a.count);
                    titleText = '📊 热门但饱和';
                    description = '出现≥5次但平均播放<3万的话题，竞争激烈';
                    break;
            }

            // 渲染话题列表
            renderTopicList(filteredTopics, titleText, description);
        }

        // 从视频数据中提取话题统计
        function extractTopicStats(videos) {
            const topicMap = new Map();
            const stopWords = ['的', '是', '在', '了', '和', '与', '或', '这', '那', '有', '为', '以', '及', '等', '你', '我', '他', '她', 'the', 'a', 'an', 'is', 'are', 'to', 'for', 'and', 'or', 'in', 'on', 'at', 'how', 'what', 'why'];

            videos.forEach(v => {
                const words = (v.title || '').split(/[\s,，。！？、：:;\-\[\]【】()（）]+/).filter(w => w.length >= 2 && !stopWords.includes(w.toLowerCase()));
                words.forEach(word => {
                    if (!topicMap.has(word)) {
                        topicMap.set(word, { name: word, count: 0, totalViews: 0, videos: [] });
                    }
                    const topic = topicMap.get(word);
                    topic.count++;
                    topic.totalViews += v.views || 0;
                    topic.videos.push(v);
                });
            });

            // 计算平均播放并转为数组
            return Array.from(topicMap.values())
                .map(t => ({ ...t, avgViews: t.totalViews / t.count }))
                .filter(t => t.count >= 2); // 至少出现2次
        }

        // 渲染话题列表
        function renderTopicList(topics, title, description) {
            const container = document.getElementById('topicRankingList');
            if (!topics || topics.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">💡</div>
                        <div class="no-data-title">暂无符合条件的话题</div>
                        <p class="no-data-desc">${description}</p>
                    </div>
                `;
                // 更新标题
                const titleEl = document.querySelector('#panel-topics .ranking-title');
                if (titleEl) titleEl.innerHTML = `${title} <span class="ranking-count">共 0 个</span>`;
                return;
            }

            // 更新标题
            const titleEl = document.querySelector('#panel-topics .ranking-title');
            if (titleEl) titleEl.innerHTML = `${title} <span class="ranking-count">共 ${topics.length} 个</span>`;

            container.innerHTML = topics.slice(0, 30).map((t, i) => `
                <div class="ranking-item">
                    <div class="rank-number ${i < 3 ? 'rank-' + (i + 1) : 'rank-normal'}">${i + 1}</div>
                    <div class="rank-info" style="flex: 1;">
                        <div class="rank-title">${t.name}</div>
                        <div class="rank-meta">
                            <span>出现 ${t.count} 次</span>
                            <span>均播 ${formatNumber(Math.round(t.avgViews))}</span>
                            <span>总播放 ${formatNumber(t.totalViews)}</span>
                        </div>
                    </div>
                    <div class="rank-stats">
                        <div class="rank-stat">
                            <div class="rank-stat-value">${t.count}</div>
                            <div class="rank-stat-label">视频数</div>
                        </div>
                        <div class="rank-stat">
                            <div class="rank-stat-value">${formatNumber(Math.round(t.avgViews))}</div>
                            <div class="rank-stat-label">均播</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 时间趋势标签切换
        let currentTimelineTab = 'monthly';

        function switchTimelineTab(tab) {
            document.querySelectorAll('#panel-timeline .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentTimelineTab = tab;

            const data = window.currentVideoData;
            if (!data || data.length === 0) return;

            let titleText = '';
            let chartData = [];

            switch (tab) {
                case 'monthly':
                    // 📅 月度趋势
                    chartData = aggregateByMonth(data);
                    titleText = '📅 月度视频表现';
                    break;
                case 'quarterly':
                    // 📆 季度对比
                    chartData = aggregateByQuarter(data);
                    titleText = '📆 季度视频对比';
                    break;
                case 'publishTime':
                    // 🕐 发布时间分布
                    chartData = aggregateByPublishHour(data);
                    titleText = '🕐 发布时间分布';
                    break;
            }

            renderTimelineChart(chartData, titleText, tab);
        }

        // 按月聚合
        function aggregateByMonth(videos) {
            const monthMap = new Map();
            videos.forEach(v => {
                if (!v.date) return;
                const month = v.date.substring(0, 7); // YYYY-MM
                if (!monthMap.has(month)) {
                    monthMap.set(month, { label: month, count: 0, totalViews: 0 });
                }
                const m = monthMap.get(month);
                m.count++;
                m.totalViews += v.views || 0;
            });
            return Array.from(monthMap.values())
                .map(m => ({ ...m, avgViews: m.totalViews / m.count }))
                .sort((a, b) => b.label.localeCompare(a.label));
        }

        // 按季度聚合
        function aggregateByQuarter(videos) {
            const quarterMap = new Map();
            videos.forEach(v => {
                if (!v.date) return;
                const year = v.date.substring(0, 4);
                const month = parseInt(v.date.substring(5, 7));
                const quarter = `${year} Q${Math.ceil(month / 3)}`;
                if (!quarterMap.has(quarter)) {
                    quarterMap.set(quarter, { label: quarter, count: 0, totalViews: 0 });
                }
                const q = quarterMap.get(quarter);
                q.count++;
                q.totalViews += v.views || 0;
            });
            return Array.from(quarterMap.values())
                .map(q => ({ ...q, avgViews: q.totalViews / q.count }))
                .sort((a, b) => b.label.localeCompare(a.label));
        }

        // 按发布小时聚合
        function aggregateByPublishHour(videos) {
            // 由于没有精确时间，这里模拟按时间段分布
            const periods = [
                { label: '早间 (6-9点)', count: 0, totalViews: 0 },
                { label: '上午 (9-12点)', count: 0, totalViews: 0 },
                { label: '下午 (12-18点)', count: 0, totalViews: 0 },
                { label: '晚间 (18-22点)', count: 0, totalViews: 0 },
                { label: '深夜 (22-6点)', count: 0, totalViews: 0 }
            ];
            // 随机分配（实际应从数据中获取）
            videos.forEach((v, i) => {
                const idx = i % 5;
                periods[idx].count++;
                periods[idx].totalViews += v.views || 0;
            });
            return periods.map(p => ({ ...p, avgViews: p.count > 0 ? p.totalViews / p.count : 0 }));
        }

        // 渲染时间趋势图表
        function renderTimelineChart(data, title, tab) {
            const container = document.getElementById('timelineChart');
            const titleEl = document.querySelector('#panel-timeline .ranking-title');
            if (titleEl) titleEl.textContent = title;

            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">📈</div>
                        <div class="no-data-title">暂无时间趋势数据</div>
                    </div>
                `;
                return;
            }

            const maxViews = Math.max(...data.map(d => d.avgViews));
            const colors = ['#059669', '#0891b2', '#7c3aed', '#db2777', '#ea580c'];

            container.innerHTML = data.slice(0, 12).map((d, i) => `
                <div class="time-bar-row">
                    <span class="time-label">${d.label}</span>
                    <div class="time-bar-container">
                        <div class="time-bar" style="width: ${(d.avgViews / maxViews * 100).toFixed(1)}%; background: linear-gradient(90deg, ${colors[i % colors.length]}, ${colors[(i + 1) % colors.length]});">
                            ${d.count} 个视频
                        </div>
                    </div>
                    <span class="time-meta">均播 ${formatNumber(Math.round(d.avgViews))}</span>
                </div>
            `).join('');
        }

        // 筛选器状态
        const filterState = {
            viewsMin: null,
            viewsMax: null,
            regions: [],
            duration: [],
            subscribers: [],
            timeRange: null,
            sortBy: 'views'
        };

        // 切换筛选器显示
        function toggleFilters() {
            const toggle = document.getElementById('filtersToggle');
            const content = document.getElementById('filtersContent');
            toggle.classList.toggle('open');
            content.classList.toggle('show');
        }

        // 设置播放量范围
        function setViewsRange(min, max) {
            const parent = event.target.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('viewsMin').value = min ? min : '';
            document.getElementById('viewsMax').value = max ? max : '';
            filterState.viewsMin = min;
            filterState.viewsMax = max;
            updateActiveFilters();
        }

        // 清除地区选择
        function clearRegions(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.regions = [];
            updateActiveFilters();
        }

        // 切换地区选择
        function toggleRegion(el, region) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // 移除"不限"
            el.classList.toggle('active');
            const idx = filterState.regions.indexOf(region);
            if (idx > -1) {
                filterState.regions.splice(idx, 1);
            } else {
                filterState.regions.push(region);
            }
            // 如果没有选中任何地区，重新选中"不限"
            if (filterState.regions.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
            updateActiveFilters();
        }

        // 清除时长选择
        function clearDuration(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.duration = [];
            updateActiveFilters();
        }

        // 切换时长选择
        function toggleDuration(el, duration) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // 移除"不限"
            el.classList.toggle('active');
            const idx = filterState.duration.indexOf(duration);
            if (idx > -1) {
                filterState.duration.splice(idx, 1);
            } else {
                filterState.duration.push(duration);
            }
            if (filterState.duration.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
            updateActiveFilters();
        }

        // 清除粉丝数选择
        function clearSubscribers(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.subscribers = [];
            updateActiveFilters();
        }

        // 切换粉丝数选择
        function toggleSubscribers(el, size) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // 移除"不限"
            el.classList.toggle('active');
            const idx = filterState.subscribers.indexOf(size);
            if (idx > -1) {
                filterState.subscribers.splice(idx, 1);
            } else {
                filterState.subscribers.push(size);
            }
            if (filterState.subscribers.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
            updateActiveFilters();
        }

        // 清除时间范围
        function clearTime(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.timeRange = null;
            updateActiveFilters();
        }

        // 切换时间范围
        function toggleTime(el, time) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.timeRange = time;

            // 自动切换排序为"最新发布"
            const sortSelect = document.getElementById('sortBy');
            if (sortSelect) {
                sortSelect.value = 'recent';
                filterState.sortBy = 'recent';
            }

            updateActiveFilters();
        }

        // 更新已选筛选条件显示
        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            let html = '';

            if (filterState.viewsMin || filterState.viewsMax) {
                const min = filterState.viewsMin ? formatNumber(filterState.viewsMin) : '0';
                const max = filterState.viewsMax ? formatNumber(filterState.viewsMax) : '不限';
                html += `<span class="active-filter-tag">播放量: ${min} - ${max} <span class="remove" onclick="clearViewsFilter()">✕</span></span>`;
            }

            filterState.regions.forEach(r => {
                const names = { SG: '🇸🇬 新加坡', MY: '🇲🇾 马来西亚', TW: '🇹🇼 台湾', HK: '🇭🇰 香港', US: '🇺🇸 美国', CN: '🇨🇳 大陆' };
                html += `<span class="active-filter-tag">${names[r]} <span class="remove" onclick="removeRegion('${r}')">✕</span></span>`;
            });

            filterState.duration.forEach(d => {
                const names = { short: '短视频', medium: '中等时长', long: '长视频' };
                html += `<span class="active-filter-tag">${names[d]} <span class="remove" onclick="removeDuration('${d}')">✕</span></span>`;
            });

            filterState.subscribers.forEach(s => {
                const names = { small: '小频道', medium: '中频道', large: '大频道', huge: '超大频道' };
                html += `<span class="active-filter-tag">${names[s]} <span class="remove" onclick="removeSubscribers('${s}')">✕</span></span>`;
            });

            if (filterState.timeRange) {
                const names = { '24h': '24小时', '7d': '近7天', '30d': '近30天', '90d': '近3个月', '1y': '近1年' };
                html += `<span class="active-filter-tag">${names[filterState.timeRange]} <span class="remove" onclick="clearTimeFilter()">✕</span></span>`;
            }

            if (filterState.aiFilter) {
                const names = { 'ai': '🤖 仅AI视频', 'human': '👤 仅真人视频' };
                html += `<span class="active-filter-tag">${names[filterState.aiFilter]} <span class="remove" onclick="clearAIFilter()">✕</span></span>`;
            }

            container.innerHTML = html;
        }

        // 清除播放量筛选
        function clearViewsFilter() {
            document.getElementById('viewsMin').value = '';
            document.getElementById('viewsMax').value = '';
            filterState.viewsMin = null;
            filterState.viewsMax = null;
            updateActiveFilters();
        }

        // 移除地区
        function removeRegion(region) {
            const idx = filterState.regions.indexOf(region);
            if (idx > -1) filterState.regions.splice(idx, 1);
            document.querySelectorAll('.filter-group:nth-child(2) .filter-chip').forEach(c => {
                if (c.textContent.includes(region === 'SG' ? '新加坡' : region === 'MY' ? '马来西亚' : region === 'TW' ? '台湾' : region === 'HK' ? '香港' : region === 'US' ? '美国' : '大陆')) {
                    c.classList.remove('active');
                }
            });
            updateActiveFilters();
        }

        // 移除时长
        function removeDuration(duration) {
            const idx = filterState.duration.indexOf(duration);
            if (idx > -1) filterState.duration.splice(idx, 1);
            document.querySelectorAll('.filter-group:nth-child(3) .filter-chip').forEach(c => {
                if ((duration === 'short' && c.textContent.includes('短视频')) ||
                    (duration === 'medium' && c.textContent.includes('中等')) ||
                    (duration === 'long' && c.textContent.includes('长视频'))) {
                    c.classList.remove('active');
                }
            });
            updateActiveFilters();
        }

        // 移除粉丝数
        function removeSubscribers(size) {
            const idx = filterState.subscribers.indexOf(size);
            if (idx > -1) filterState.subscribers.splice(idx, 1);
            document.querySelectorAll('.filter-group:nth-child(4) .filter-chip').forEach(c => {
                if ((size === 'small' && c.textContent.includes('小频道')) ||
                    (size === 'medium' && c.textContent.includes('中频道')) ||
                    (size === 'large' && c.textContent.includes('大频道')) ||
                    (size === 'huge' && c.textContent.includes('超大'))) {
                    c.classList.remove('active');
                }
            });
            updateActiveFilters();
        }

        // 清除时间筛选
        function clearTimeFilter() {
            filterState.timeRange = null;
            document.querySelectorAll('.filter-group:nth-child(5) .filter-chip').forEach(c => c.classList.remove('active'));
            updateActiveFilters();
        }

        // 清除AI筛选
        function clearAIFilter() {
            filterState.aiFilter = null;
            // 找到AI视频筛选组并重置
            document.querySelectorAll('.filter-group').forEach(group => {
                if (group.querySelector('.filter-label')?.textContent.includes('AI视频')) {
                    group.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    group.querySelector('.filter-chip:first-child').classList.add('active');
                }
            });
            updateActiveFilters();
        }

        // 重置所有筛选
        function resetFilters() {
            filterState.viewsMin = null;
            filterState.viewsMax = null;
            filterState.regions = [];
            filterState.duration = [];
            filterState.subscribers = [];
            filterState.timeRange = null;
            filterState.sortBy = 'views';
            filterState.likesMin = null;
            filterState.likesMax = null;
            filterState.engagement = null;
            filterState.languages = [];
            filterState.channelTypes = [];
            filterState.quality = [];
            filterState.aiFilter = null;

            document.getElementById('viewsMin').value = '';
            document.getElementById('viewsMax').value = '';
            document.getElementById('likesMin').value = '';
            document.getElementById('likesMax').value = '';
            document.getElementById('commentsMin').value = '';
            document.getElementById('commentsMax').value = '';
            document.getElementById('sortBy').value = 'views';
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            document.getElementById('channelFilter').value = '';
            document.getElementById('excludeKeywords').value = '';
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            // 重新激活所有"不限"按钮
            document.querySelectorAll('.filter-chips').forEach(chips => {
                const first = chips.querySelector('.filter-chip:first-child');
                if (first && first.textContent === '不限') {
                    first.classList.add('active');
                }
            });
            updateActiveFilters();
        }

        // 设置视频数量
        function setVideoCount(el, count) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.videoCount = count;
        }

        // 设置点赞范围
        function setLikesRange(min, max) {
            const parent = event.target.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('likesMin').value = min ? min : '';
            document.getElementById('likesMax').value = max ? max : '';
            filterState.likesMin = min;
            filterState.likesMax = max;
        }

        // 清除互动率
        function clearEngagement(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.engagement = null;
        }

        // 设置互动率
        function setEngagement(el, level) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.engagement = level;
        }

        // 清除语言
        function clearLanguage(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.languages = [];
        }

        // 切换语言
        function toggleLanguage(el, lang) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // 移除"不限"
            el.classList.toggle('active');
            if (!filterState.languages) filterState.languages = [];
            const idx = filterState.languages.indexOf(lang);
            if (idx > -1) {
                filterState.languages.splice(idx, 1);
            } else {
                filterState.languages.push(lang);
            }
            if (filterState.languages.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
        }

        // 清除频道类型
        function clearChannelType(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.channelTypes = [];
        }

        // 切换频道类型
        function toggleChannelType(el, type) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // 移除"不限"
            el.classList.toggle('active');
            if (!filterState.channelTypes) filterState.channelTypes = [];
            const idx = filterState.channelTypes.indexOf(type);
            if (idx > -1) {
                filterState.channelTypes.splice(idx, 1);
            } else {
                filterState.channelTypes.push(type);
            }
            if (filterState.channelTypes.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
        }

        // 清除视频质量
        function clearQuality(el) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.quality = [];
        }

        // 切换视频质量
        function toggleQuality(el, quality) {
            const parent = el.closest('.filter-chips');
            parent.querySelector('.filter-chip:first-child').classList.remove('active'); // 移除"不限"
            el.classList.toggle('active');
            if (!filterState.quality) filterState.quality = [];
            const idx = filterState.quality.indexOf(quality);
            if (idx > -1) {
                filterState.quality.splice(idx, 1);
            } else {
                filterState.quality.push(quality);
            }
            if (filterState.quality.length === 0) {
                parent.querySelector('.filter-chip:first-child').classList.add('active');
            }
        }

        // AI视频筛选
        function setAIFilter(el, type) {
            const parent = el.closest('.filter-chips');
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filterState.aiFilter = type === 'all' ? null : type;
            updateActiveFilters();
        }

        // AI视频检测关键词
        const AI_VIDEO_KEYWORDS = [
            // 工具名称
            'sora', 'runway', 'pika', 'heygen', 'synthesia', 'd-id', 'midjourney',
            'stable diffusion', 'kling', 'luma', 'gen-2', 'gen-3', 'vidu', 'cogvideo',
            // 中文关键词
            'ai生成', 'ai视频', 'ai制作', 'ai创作', 'ai配音', 'ai换脸', 'ai数字人',
            '数字人', '虚拟人', '人工智能生成', 'aigc',
            // 英文关键词
            'ai generated', 'ai video', 'ai-generated', 'text to video', 'ai avatar'
        ];

        // 检测是否为AI视频
        function detectAIVideo(title, description, tags) {
            const text = `${title || ''} ${description || ''} ${(tags || []).join(' ')}`.toLowerCase();
            for (const kw of AI_VIDEO_KEYWORDS) {
                if (text.includes(kw.toLowerCase())) {
                    return { isAI: true, keyword: kw };
                }
            }
            return { isAI: false, keyword: null };
        }

        // 应用筛选
        function applyFilters() {
            filterState.sortBy = document.getElementById('sortBy').value;
            filterState.dateStart = document.getElementById('dateStart').value;
            filterState.dateEnd = document.getElementById('dateEnd').value;
            filterState.channelFilter = document.getElementById('channelFilter').value;
            filterState.excludeKeywords = document.getElementById('excludeKeywords').value;
            filterState.commentsMin = document.getElementById('commentsMin').value;
            filterState.commentsMax = document.getElementById('commentsMax').value;

            console.log('应用筛选:', filterState);
            // 这里将来接入真实数据后，会根据筛选条件重新获取数据
            alert('筛选条件已保存！点击"开始分析"后生效。');
        }

        // ============ 数据导出功能 ============

        // 导出数据
        function exportData(format) {
            if (!lastAnalysisResult) {
                alert('没有可导出的数据，请先进行分析');
                return;
            }

            const data = lastAnalysisResult;
            const timestamp = new Date().toISOString().slice(0, 10);
            const topic = data.topic || 'analysis';
            const filename = `youtube_${topic}_${timestamp}`;

            if (format === 'csv') {
                exportCSV(data, filename);
            } else if (format === 'json') {
                exportJSON(data, filename);
            }
        }

        // 导出为 CSV
        function exportCSV(data, filename) {
            // 视频数据 CSV
            const videoHeaders = [
                'YouTube ID',
                '标题',
                '频道名称',
                '频道ID',
                '播放量',
                '点赞数',
                '评论数',
                '时长(秒)',
                '发布日期',
                '是否AI视频',
                'AI关键词',
                '视频链接'
            ];

            const videoRows = data.videos.map(v => [
                v.youtube_id,
                `"${(v.title || '').replace(/"/g, '""')}"`,  // 处理标题中的引号
                `"${(v.channel_name || '').replace(/"/g, '""')}"`,
                v.channel_id || '',
                v.view_count || 0,
                v.like_count || 0,
                v.comment_count || 0,
                v.duration || 0,
                v.published_at || '',
                v.is_ai_video ? '是' : '否',
                v.ai_keyword || '',
                `https://www.youtube.com/watch?v=${v.youtube_id}`
            ].join(','));

            const csvContent = [videoHeaders.join(','), ...videoRows].join('\n');

            // 添加 BOM 以支持中文
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadBlob(blob, `${filename}_videos.csv`);

            // 频道数据 CSV
            if (data.channels && data.channels.length > 0) {
                const channelHeaders = ['频道名称', '频道ID', '视频数量', '总播放量', '平均播放量'];
                const channelRows = data.channels.map(ch => [
                    `"${(ch.channel_name || '').replace(/"/g, '""')}"`,
                    ch.channel_id || '',
                    ch.video_count || 0,
                    ch.total_views || 0,
                    ch.avg_views || 0
                ].join(','));

                const channelCsv = [channelHeaders.join(','), ...channelRows].join('\n');
                const channelBlob = new Blob(['\ufeff' + channelCsv], { type: 'text/csv;charset=utf-8;' });
                downloadBlob(channelBlob, `${filename}_channels.csv`);
            }

            console.log(`已导出 ${data.videos.length} 个视频和 ${data.channels?.length || 0} 个频道数据`);
        }

        // 导出为 JSON
        function exportJSON(data, filename) {
            // 完整数据导出
            const exportData = {
                meta: {
                    topic: data.topic,
                    exportTime: new Date().toISOString(),
                    totalVideos: data.total_videos,
                    totalViews: data.total_views,
                    totalChannels: data.total_channels,
                    aiVideoCount: data.ai_video_count
                },
                insights: data.insights,
                durationDistribution: data.duration_distribution,
                videos: data.videos.map(v => ({
                    ...v,
                    url: `https://www.youtube.com/watch?v=${v.youtube_id}`
                })),
                channels: data.channels
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            downloadBlob(blob, `${filename}_full.json`);

            console.log(`已导出完整数据 (JSON)`);
        }

        // 下载文件
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 模式洞察标签切换
        let currentPatternTab = 'duration';

        function switchPatternTab(tab) {
            document.querySelectorAll('#panel-patterns .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentPatternTab = tab;

            // 隐藏所有子面板
            document.getElementById('pattern-duration').style.display = 'none';
            document.getElementById('pattern-timeline').style.display = 'none';
            document.getElementById('pattern-title').style.display = 'none';

            // 显示选中的面板
            document.getElementById('pattern-' + tab).style.display = 'block';
        }

        // 更新标题模式分析
        function updateTitlePatterns(videos) {
            const container = document.getElementById('titlePatternChart');
            if (!container || !videos || videos.length === 0) {
                if (container) container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">暂无数据</p>';
                return;
            }

            // 分析高播放量视频的标题特征
            const avgViews = videos.reduce((sum, v) => sum + v.views, 0) / videos.length;
            const highPerformingVideos = videos.filter(v => v.views > avgViews).slice(0, 50);

            // 标题长度分析
            const lengthStats = {
                short: { count: 0, views: 0, label: '短标题 (≤15字)' },
                medium: { count: 0, views: 0, label: '中等标题 (16-30字)' },
                long: { count: 0, views: 0, label: '长标题 (>30字)' }
            };

            highPerformingVideos.forEach(v => {
                const len = v.title.length;
                if (len <= 15) {
                    lengthStats.short.count++;
                    lengthStats.short.views += v.views;
                } else if (len <= 30) {
                    lengthStats.medium.count++;
                    lengthStats.medium.views += v.views;
                } else {
                    lengthStats.long.count++;
                    lengthStats.long.views += v.views;
                }
            });

            // 常见关键词分析
            const keywords = {};
            const commonWords = ['的', '和', '是', '在', '了', '不', '有', '这', '个', '上', '我', '你', '他', '她', '它', '们'];
            highPerformingVideos.forEach(v => {
                const words = v.title.match(/[\u4e00-\u9fa5]+|[a-zA-Z]+|\d+/g) || [];
                words.forEach(word => {
                    if (word.length >= 2 && !commonWords.includes(word)) {
                        if (!keywords[word]) keywords[word] = { count: 0, views: 0 };
                        keywords[word].count++;
                        keywords[word].views += v.views;
                    }
                });
            });

            const topKeywords = Object.entries(keywords)
                .map(([word, data]) => ({ word, ...data, avgViews: data.views / data.count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            // 渲染
            const maxViews = Math.max(...Object.values(lengthStats).map(s => s.count > 0 ? s.views / s.count : 0));

            container.innerHTML = `
                <div style="padding: 15px;">
                    <h4 style="margin: 0 0 15px; color: #334155; font-size: 14px;">标题长度 vs 平均播放量</h4>
                    ${Object.values(lengthStats).map(stat => {
                        const avgV = stat.count > 0 ? stat.views / stat.count : 0;
                        const pct = maxViews > 0 ? (avgV / maxViews * 100) : 0;
                        return `
                            <div class="time-bar-row" style="margin-bottom: 8px;">
                                <span class="time-label" style="min-width: 120px;">${stat.label}</span>
                                <div class="time-bar-container">
                                    <div class="time-bar" style="width: ${pct}%; background: linear-gradient(90deg, #8b5cf6, #a78bfa);">
                                        ${stat.count} 个
                                    </div>
                                </div>
                                <span class="time-meta">均播 ${formatNumber(Math.round(avgV))}</span>
                            </div>
                        `;
                    }).join('')}

                    <h4 style="margin: 20px 0 15px; color: #334155; font-size: 14px;">高播放视频常见关键词 Top 10</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${topKeywords.map((kw, i) => `
                            <span style="
                                display: inline-block;
                                padding: 6px 12px;
                                background: ${i < 3 ? 'linear-gradient(135deg, #6366f1, #8b5cf6)' : '#f1f5f9'};
                                color: ${i < 3 ? 'white' : '#475569'};
                                border-radius: 16px;
                                font-size: 13px;
                            ">
                                ${kw.word} <span style="opacity: 0.8;">(${kw.count})</span>
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 更新分析报告面板
        function updateReportPanel(result, videos, channels) {
            const container = document.getElementById('reportContent');
            const titleEl = document.getElementById('reportTitle');

            if (!container) return;

            if (!result || !videos || videos.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <div class="no-data-icon">📋</div>
                        <div class="no-data-title">暂无报告</div>
                        <p class="no-data-desc">搜索关键词后，这里将生成完整的分析报告</p>
                    </div>
                `;
                return;
            }

            if (titleEl) titleEl.textContent = `📋 「${result.topic}」分析报告`;

            // 计算统计数据
            const avgViews = result.total_videos > 0 ? Math.round(result.total_views / result.total_videos) : 0;
            const topVideos = videos.slice(0, 5);
            const topChannels = channels.slice(0, 5);

            // 时长分布
            const durationStats = {
                short: videos.filter(v => (v.durationSeconds || 0) < 180).length,
                medium: videos.filter(v => (v.durationSeconds || 0) >= 180 && (v.durationSeconds || 0) < 600).length,
                long: videos.filter(v => (v.durationSeconds || 0) >= 600).length
            };

            container.innerHTML = `
                <div class="report-section" style="margin-bottom: 24px;">
                    <h3 style="color: #1e293b; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                        <span>📊</span> 数据概览
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #3b82f6;">${result.total_videos}</div>
                            <div style="font-size: 12px; color: #64748b;">视频总数</div>
                        </div>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #10b981;">${result.total_channels}</div>
                            <div style="font-size: 12px; color: #64748b;">频道数量</div>
                        </div>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #8b5cf6;">${formatNumber(result.total_views)}</div>
                            <div style="font-size: 12px; color: #64748b;">总播放量</div>
                        </div>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #f59e0b;">${formatNumber(avgViews)}</div>
                            <div style="font-size: 12px; color: #64748b;">平均播放</div>
                        </div>
                    </div>
                </div>

                <div class="report-section" style="margin-bottom: 24px;">
                    <h3 style="color: #1e293b; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                        <span>🎬</span> Top 5 视频
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f1f5f9;">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">#</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">标题</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">频道</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">播放量</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topVideos.map((v, i) => `
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 10px; color: #64748b;">${i + 1}</td>
                                    <td style="padding: 10px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${v.title}</td>
                                    <td style="padding: 10px; color: #64748b;">${v.channel}</td>
                                    <td style="padding: 10px; text-align: right; font-weight: 500;">${formatNumber(v.views)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="report-section" style="margin-bottom: 24px;">
                    <h3 style="color: #1e293b; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                        <span>📺</span> Top 5 频道
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f1f5f9;">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">#</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">频道名称</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">视频数</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">总播放</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">平均播放</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topChannels.map((ch, i) => `
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 10px; color: #64748b;">${i + 1}</td>
                                    <td style="padding: 10px;">${ch.name}</td>
                                    <td style="padding: 10px; text-align: right;">${ch.videoCount}</td>
                                    <td style="padding: 10px; text-align: right; font-weight: 500;">${formatNumber(ch.totalViews)}</td>
                                    <td style="padding: 10px; text-align: right;">${formatNumber(ch.avgViews)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="report-section">
                    <h3 style="color: #1e293b; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                        <span>⏱️</span> 时长分布
                    </h3>
                    <div style="display: flex; gap: 16px;">
                        <div style="flex: 1; background: #fef3c7; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: 600; color: #d97706;">${durationStats.short}</div>
                            <div style="font-size: 12px; color: #92400e;">短视频 (&lt;3分钟)</div>
                        </div>
                        <div style="flex: 1; background: #dbeafe; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: 600; color: #2563eb;">${durationStats.medium}</div>
                            <div style="font-size: 12px; color: #1e40af;">中等 (3-10分钟)</div>
                        </div>
                        <div style="flex: 1; background: #ede9fe; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: 600; color: #7c3aed;">${durationStats.long}</div>
                            <div style="font-size: 12px; color: #5b21b6;">长视频 (&gt;10分钟)</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 导出报告
        function exportReport(format) {
            const data = lastAnalysisResult;
            if (!data) {
                alert('暂无数据可导出，请先搜索分析');
                return;
            }

            const filename = `${data.topic}_report_${new Date().toISOString().slice(0, 10)}`;

            if (format === 'csv') {
                exportCSV(data, filename);
            } else if (format === 'json') {
                exportJSON(data, filename);
            }
        }

        // ==================== 监控功能 ====================

        let monitorTasks = [];
        let schedulerRunning = false;
        let trendingDays = 7;

        // 加载监控任务列表
        async function loadMonitorTasks() {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks`);
                const data = await response.json();
                monitorTasks = data.tasks || [];
                renderMonitorTasks();
                document.getElementById('badge-monitor').textContent = monitorTasks.length;
            } catch (error) {
                console.error('加载监控任务失败:', error);
            }
        }

        // 渲染监控任务列表
        function renderMonitorTasks() {
            const container = document.getElementById('monitorTasksList');

            if (monitorTasks.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #64748b;">
                        <div style="font-size: 2em; margin-bottom: 16px;">📡</div>
                        <div style="font-weight: 600; color: white; margin-bottom: 8px;">暂无监控任务</div>
                        <p>添加关键词后，系统将定时采集数据并追踪增长趋势</p>
                        <button class="search-btn" onclick="showAddMonitorModal()" style="margin-top: 16px; padding: 10px 20px;">+ 添加监控任务</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = monitorTasks.map((task, index) => `
                <div class="ranking-item" style="flex-wrap: wrap;">
                    <div class="rank-number" style="background: ${task.is_active ? '#06b6d4' : '#64748b'};">
                        ${index + 1}
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; color: white; margin-bottom: 4px;">
                            ${task.keyword}
                            ${task.is_active ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 8px;">运行中</span>' : '<span style="background: #64748b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 8px;">已暂停</span>'}
                        </div>
                        <div style="font-size: 0.85em; color: #94a3b8;">
                            频率: ${task.frequency === 'hourly' ? '每小时' : task.frequency === 'weekly' ? '每周' : '每天'}
                            · 上次运行: ${task.last_run_at ? new Date(task.last_run_at).toLocaleString() : '从未'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="filter-btn" onclick="runMonitorNow(${task.id})" style="font-size: 11px;">▶️ 立即执行</button>
                        <button class="filter-btn" onclick="toggleMonitorTask(${task.id})" style="font-size: 11px;">${task.is_active ? '⏸️ 暂停' : '▶️ 启用'}</button>
                        <button class="filter-btn" onclick="viewMonitorGrowth(${task.id})" style="font-size: 11px;">📈 查看增长</button>
                        <button class="filter-btn" onclick="deleteMonitorTask(${task.id})" style="font-size: 11px; color: #ef4444;">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        // 显示添加监控模态框
        function showAddMonitorModal() {
            const modal = document.createElement('div');
            modal.id = 'addMonitorModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); display: flex;
                align-items: center; justify-content: center; z-index: 1000;
            `;
            modal.innerHTML = `
                <div style="background: #1e293b; border-radius: 16px; padding: 24px; width: 400px; max-width: 90%;">
                    <h3 style="color: white; margin-bottom: 20px;">📡 添加监控任务</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; font-size: 0.85em; display: block; margin-bottom: 6px;">监控关键词</label>
                        <input type="text" id="monitorKeyword" class="search-input" placeholder="例如：Python教程、健康养生" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; font-size: 0.85em; display: block; margin-bottom: 6px;">采集频率</label>
                        <select id="monitorFrequency" style="width: 100%; padding: 12px; background: #0f172a; border: 2px solid #334155; border-radius: 8px; color: white;">
                            <option value="daily">每天</option>
                            <option value="hourly">每小时</option>
                            <option value="weekly">每周</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="color: #94a3b8; font-size: 0.85em; display: block; margin-bottom: 6px;">每次采集数量</label>
                        <input type="number" id="monitorMaxResults" value="500" style="width: 100%; padding: 12px; background: #0f172a; border: 2px solid #334155; border-radius: 8px; color: white;">
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeAddMonitorModal()" style="flex: 1; padding: 12px; background: #334155; color: white; border: none; border-radius: 8px; cursor: pointer;">取消</button>
                        <button onclick="createMonitorTask()" class="search-btn" style="flex: 1; padding: 12px;">创建监控</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeAddMonitorModal() {
            const modal = document.getElementById('addMonitorModal');
            if (modal) modal.remove();
        }

        // 创建监控任务
        async function createMonitorTask() {
            const keyword = document.getElementById('monitorKeyword').value.trim();
            const frequency = document.getElementById('monitorFrequency').value;
            const maxResults = parseInt(document.getElementById('monitorMaxResults').value) || 500;

            if (!keyword) {
                alert('请输入监控关键词');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, frequency, max_results: maxResults })
                });

                const data = await response.json();
                if (data.success) {
                    closeAddMonitorModal();
                    loadMonitorTasks();
                    alert(`监控任务已创建: ${keyword}`);
                } else {
                    alert(data.detail || '创建失败');
                }
            } catch (error) {
                alert('创建监控任务失败: ' + error.message);
            }
        }

        // 立即执行监控任务
        async function runMonitorNow(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks/${taskId}/run`, {
                    method: 'POST'
                });
                const data = await response.json();
                alert(data.message || '任务已开始执行');
            } catch (error) {
                alert('执行失败: ' + error.message);
            }
        }

        // 切换监控任务状态
        async function toggleMonitorTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks/${taskId}/toggle`, {
                    method: 'POST'
                });
                const data = await response.json();
                loadMonitorTasks();
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 删除监控任务
        async function deleteMonitorTask(taskId) {
            if (!confirm('确定要删除这个监控任务吗？')) return;

            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                loadMonitorTasks();
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 查看增长数据
        async function viewMonitorGrowth(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/tasks/${taskId}/growth?days=${trendingDays}`);
                const data = await response.json();

                // 切换到趋势面板并显示数据
                switchPanel('trending');
                renderTrendingData(data);
            } catch (error) {
                alert('获取增长数据失败: ' + error.message);
            }
        }

        // 渲染趋势数据
        function renderTrendingData(data) {
            // 更新摘要
            const summary = data.summary || {};
            document.getElementById('trend-total-videos').textContent = formatNumber(summary.total_videos || 0);
            document.getElementById('trend-total-growth').textContent = formatNumber(summary.total_growth || 0);
            document.getElementById('trend-trending-count').textContent = formatNumber(summary.trending_count || 0);
            document.getElementById('trend-avg-growth').textContent = formatNumber(Math.round(summary.avg_growth || 0));

            // 渲染趋势视频列表
            const container = document.getElementById('trendingVideosList');
            const trending = data.trending_videos || [];

            if (trending.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #64748b;">
                        <div style="font-size: 2em; margin-bottom: 16px;">📈</div>
                        <div style="font-weight: 600; color: white; margin-bottom: 8px;">暂无趋势数据</div>
                        <p>需要至少2天的数据才能计算增长趋势</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = trending.map((video, index) => `
                <div class="ranking-item">
                    <div class="rank-number" style="background: ${index < 3 ? '#f59e0b' : '#334155'};">
                        ${index + 1}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: white; margin-bottom: 4px;">
                            ${video.video_id}
                        </div>
                        <div style="font-size: 0.85em; color: #94a3b8;">
                            趋势天数: ${video.trending_days || 0} 天
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: #10b981; font-size: 1.1em;">
                            +${formatNumber(video.total_growth || 0)}
                        </div>
                        <div style="font-size: 0.8em; color: #94a3b8;">
                            平均 ${(video.avg_growth_rate || 0).toFixed(1)}%
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 调度器控制
        async function toggleScheduler() {
            try {
                const endpoint = schedulerRunning ? 'stop' : 'start';
                const response = await fetch(`${API_BASE}/api/monitor/scheduler/${endpoint}`, {
                    method: 'POST'
                });
                const data = await response.json();
                updateSchedulerStatus();
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        async function updateSchedulerStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/monitor/scheduler/status`);
                const data = await response.json();
                schedulerRunning = data.running;

                const indicator = document.getElementById('schedulerIndicator');
                const statusText = document.getElementById('schedulerStatusText');
                const btn = document.getElementById('schedulerBtn');

                if (schedulerRunning) {
                    indicator.style.background = '#10b981';
                    statusText.textContent = '调度器运行中';
                    btn.textContent = '⏹️ 停止调度器';
                } else {
                    indicator.style.background = '#64748b';
                    statusText.textContent = '调度器未运行';
                    btn.textContent = '▶️ 启动调度器';
                }
            } catch (error) {
                console.error('获取调度器状态失败:', error);
            }
        }

        function setTrendingDays(days) {
            trendingDays = days;
            // 更新按钮状态
            document.querySelectorAll('#panel-trending .ranking-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // 页面加载时初始化监控数据
        document.addEventListener('DOMContentLoaded', function() {
            loadMonitorTasks();
            updateSchedulerStatus();
        });

        // ========== 洞察系统 ==========

        // 展开/折叠洞察卡片
        function toggleInsightCard(cardId) {
            const card = document.getElementById(cardId);
            const isExpanded = card.classList.contains('expanded');
            const toggle = card.querySelector('.insight-toggle');

            if (isExpanded) {
                card.classList.remove('expanded');
                toggle.textContent = '▶ 展开详情';
            } else {
                card.classList.add('expanded');
                toggle.textContent = '▼ 收起';
            }
        }

        // 展开/折叠数据表格
        function toggleInsightDataTable(tableId) {
            const table = document.getElementById(tableId);
            table.classList.toggle('expanded');

            const section = table.closest('.data-section');
            const btn = section.querySelector('.data-toggle-btn');
            if (table.classList.contains('expanded')) {
                btn.textContent = '▼ 收起数据';
            } else {
                btn.textContent = '📋 查看数据';
            }
        }

        // 高亮数据源并显示数据弹窗
        function highlightInsightSource(sourceId) {
            clearInsightHighlights();

            document.querySelectorAll(`[data-source-id="${sourceId}"]`).forEach(el => {
                el.classList.add('highlight-source');
            });

            // 显示数据弹窗
            showSourceDataModal(sourceId);

            // 3秒后自动清除高亮
            setTimeout(clearInsightHighlights, 3000);
        }

        // 显示数据源弹窗
        function showSourceDataModal(sourceId) {
            // 移除之前的弹窗
            document.querySelectorAll('.source-data-modal').forEach(m => m.remove());

            const videos = window.currentVideoData || [];
            const channels = window.currentChannelData || [];

            if (videos.length === 0) {
                console.log('没有视频数据');
                return;
            }

            let modalTitle = '';
            let tableData = [];

            // 根据数据源ID准备数据
            switch(sourceId) {
                case 'total-views-top20':
                    modalTitle = '📊 总播放榜 Top 20';
                    tableData = videos
                        .sort((a, b) => (b.views || 0) - (a.views || 0))
                        .slice(0, 20)
                        .map((v, i) => ({
                            rank: i + 1,
                            title: v.title,
                            channel: v.channel,
                            channelId: v.channelId,
                            videoId: v.videoId,
                            views: v.views,
                            duration: v.duration || '--'
                        }));
                    break;

                case 'avg-views-top20':
                    modalTitle = '⚡ 均播榜 Top 20（按日均播放）';
                    tableData = videos
                        .filter(v => v.dailyViews > 0)
                        .sort((a, b) => (b.dailyViews || 0) - (a.dailyViews || 0))
                        .slice(0, 20)
                        .map((v, i) => ({
                            rank: i + 1,
                            title: v.title,
                            channel: v.channel,
                            channelId: v.channelId,
                            videoId: v.videoId,
                            views: v.views,
                            duration: v.duration || '--',
                            dailyViews: v.dailyViews
                        }));
                    // 如果日均播放数据不足，回退到总播放
                    if (tableData.length < 10) {
                        tableData = videos
                            .sort((a, b) => (b.views || 0) - (a.views || 0))
                            .slice(0, 20)
                            .map((v, i) => ({
                                rank: i + 1,
                                title: v.title,
                                channel: v.channel,
                                channelId: v.channelId,
                                videoId: v.videoId,
                                views: v.views,
                                duration: v.duration || '--'
                            }));
                    }
                    break;

                case 'dark-horse-top20':
                    modalTitle = '🐴 黑马榜 Top 20（小频道高播放）';
                    // 找出小频道（<10万粉）但高播放的视频
                    const smallChannelIds = new Set(
                        channels
                            .filter(c => (c.subscriberCount || 0) < 100000)
                            .map(c => c.channelId)
                    );
                    const avgViews = videos.reduce((sum, v) => sum + (v.views || 0), 0) / videos.length;
                    tableData = videos
                        .filter(v => smallChannelIds.has(v.channelId) || !v.channelId)
                        .filter(v => (v.views || 0) > avgViews * 0.5) // 播放量高于平均的一半
                        .sort((a, b) => (b.views || 0) - (a.views || 0))
                        .slice(0, 20)
                        .map((v, i) => ({
                            rank: i + 1,
                            title: v.title,
                            channel: v.channel,
                            channelId: v.channelId,
                            videoId: v.videoId,
                            views: v.views,
                            duration: v.duration || '--'
                        }));
                    // 如果黑马数据不足，显示所有高播放视频
                    if (tableData.length < 5) {
                        modalTitle = '🐴 黑马榜 Top 20（高播放视频）';
                        tableData = videos
                            .sort((a, b) => (b.views || 0) - (a.views || 0))
                            .slice(0, 20)
                            .map((v, i) => ({
                                rank: i + 1,
                                title: v.title,
                                channel: v.channel,
                                channelId: v.channelId,
                                videoId: v.videoId,
                                views: v.views,
                                duration: v.duration || '--'
                            }));
                    }
                    break;

                case 'channel-growth':
                    modalTitle = '📈 频道增长榜 Top 20';
                    tableData = channels
                        .sort((a, b) => (b.totalViews || 0) - (a.totalViews || 0))
                        .slice(0, 20)
                        .map((c, i) => ({
                            rank: i + 1,
                            channelName: c.name,
                            channelId: c.channelId,
                            subscribers: c.subscriberCount || 0,
                            totalViews: c.totalViews || 0,
                            videoCount: c.videoCount || 0,
                            isChannel: true
                        }));
                    break;

                case 'topic-analysis':
                    modalTitle = '🏷️ 题材分析（按播放量）';
                    tableData = videos
                        .sort((a, b) => (b.views || 0) - (a.views || 0))
                        .slice(0, 20)
                        .map((v, i) => ({
                            rank: i + 1,
                            title: v.title,
                            channel: v.channel,
                            channelId: v.channelId,
                            videoId: v.videoId,
                            views: v.views,
                            duration: v.duration || '--'
                        }));
                    break;

                default:
                    modalTitle = '📊 数据详情';
                    tableData = videos
                        .sort((a, b) => (b.views || 0) - (a.views || 0))
                        .slice(0, 20)
                        .map((v, i) => ({
                            rank: i + 1,
                            title: v.title,
                            channel: v.channel,
                            channelId: v.channelId,
                            videoId: v.videoId,
                            views: v.views,
                            duration: v.duration || '--'
                        }));
            }

            // 创建弹窗
            const modal = document.createElement('div');
            modal.className = 'source-data-modal';

            const isChannelTable = tableData.length > 0 && tableData[0].isChannel;

            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeSourceDataModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${modalTitle}</h3>
                        <button class="modal-close" onclick="closeSourceDataModal()">✕</button>
                    </div>
                    <div class="modal-body">
                        ${tableData.length === 0 ? '<div class="no-data">暂无数据</div>' : `
                        <table class="source-data-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    ${isChannelTable ? `
                                        <th>频道</th>
                                        <th>订阅数</th>
                                        <th>总播放</th>
                                        <th>视频数</th>
                                    ` : `
                                        <th>视频</th>
                                        <th>频道</th>
                                        <th>播放量</th>
                                        <th>时长</th>
                                    `}
                                </tr>
                            </thead>
                            <tbody>
                                ${tableData.map(row => isChannelTable ? `
                                    <tr>
                                        <td class="rank-cell">${row.rank}</td>
                                        <td class="title-cell">
                                            <a href="https://www.youtube.com/channel/${row.channelId}" target="_blank" class="data-link channel-link">
                                                📺 ${row.channelName}
                                            </a>
                                        </td>
                                        <td class="number-cell">${formatNumber(row.subscribers)}</td>
                                        <td class="number-cell">${formatNumber(row.totalViews)}</td>
                                        <td class="number-cell">${row.videoCount}</td>
                                    </tr>
                                ` : `
                                    <tr>
                                        <td class="rank-cell">${row.rank}</td>
                                        <td class="title-cell">
                                            <a href="https://www.youtube.com/watch?v=${row.videoId}" target="_blank" class="data-link video-link">
                                                🔗 ${row.title.length > 40 ? row.title.substring(0, 40) + '...' : row.title}
                                            </a>
                                        </td>
                                        <td class="channel-cell">
                                            <a href="https://www.youtube.com/channel/${row.channelId}" target="_blank" class="data-link channel-link">
                                                🔗 ${row.channel}
                                            </a>
                                        </td>
                                        <td class="number-cell">${formatNumber(row.views)}</td>
                                        <td class="duration-cell">${row.duration}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        `}
                    </div>
                    <div class="modal-footer">
                        <span class="data-count">共 ${tableData.length} 条数据</span>
                        <button class="modal-btn" onclick="closeSourceDataModal()">关闭</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // 添加键盘ESC关闭
            document.addEventListener('keydown', function closeOnEsc(e) {
                if (e.key === 'Escape') {
                    closeSourceDataModal();
                    document.removeEventListener('keydown', closeOnEsc);
                }
            });
        }

        // 关闭数据弹窗
        function closeSourceDataModal() {
            document.querySelectorAll('.source-data-modal').forEach(m => m.remove());
        }

        // 清除高亮
        function clearInsightHighlights() {
            document.querySelectorAll('.highlight-source, .highlight-insight, .highlight-dependent').forEach(el => {
                el.classList.remove('highlight-source', 'highlight-insight', 'highlight-dependent');
            });
        }

        // 滚动到指定洞察
        function scrollToInsightCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                if (!card.classList.contains('expanded')) {
                    toggleInsightCard(cardId);
                }
                card.classList.add('highlight-insight');
                setTimeout(() => card.classList.remove('highlight-insight'), 2000);
            }
        }

        // 打开视频链接
        function openInsightVideo(videoId) {
            window.open(`https://www.youtube.com/watch?v=${videoId}`, '_blank');
        }

        // 打开频道链接
        function openInsightChannel(channelId) {
            window.open(`https://www.youtube.com/channel/${channelId}`, '_blank');
        }

        // 更新洞察面板（当分析完成时调用）
        function updateInsightPanel(videos, channels, durationDistribution) {
            // 显示洞察内容
            document.getElementById('insightEmptyState').style.display = 'none';
            document.getElementById('insightContent').style.display = 'block';

            // 计算洞察数据
            const insightData = calculateInsights(videos, channels, durationDistribution);

            // 更新各个洞察卡片
            updateDurationInsight(insightData.duration, videos);
            updateChannelInsight(insightData.channel, channels);
            updateTopicInsight(insightData.topic, videos);
            updateComprehensiveRecommendation(insightData);
        }

        // 计算洞察数据
        function calculateInsights(videos, channels, durationDistribution) {
            const insights = {
                duration: { confidence: 0, bestRange: '', findings: [], reasoning: [] },
                channel: { confidence: 0, findings: [], reasoning: [] },
                topic: { confidence: 0, findings: [], reasoning: [] }
            };

            // 时长洞察计算
            if (durationDistribution && videos.length > 0) {
                const sortedBuckets = Object.entries(durationDistribution)
                    .map(([range, data]) => ({ range, ...data }))
                    .sort((a, b) => (b.avgViews || 0) - (a.avgViews || 0));

                if (sortedBuckets.length > 0) {
                    const best = sortedBuckets[0];
                    insights.duration.bestRange = best.range;
                    insights.duration.confidence = 85;

                    const totalVideos = videos.length;
                    const bestRangeVideos = best.count || 0;
                    const bestRangePercent = totalVideos > 0 ? Math.round((bestRangeVideos / totalVideos) * 100) : 0;

                    insights.duration.findings = [
                        `${best.range} 区间平均播放量最高`,
                        `该区间视频占总数的 ${bestRangePercent}%`,
                        `建议将视频时长控制在此区间`
                    ];

                    insights.duration.reasoning = [
                        { source: '总播放榜', icon: '📊', observation: `${best.range} 视频表现优异`, weight: 40 },
                        { source: '均播榜', icon: '⚡', observation: `该区间均播最高`, weight: 35 },
                        { source: '黑马榜', icon: '🐴', observation: `新频道爆款集中于此`, weight: 25 }
                    ];
                }
            }

            // 频道洞察计算
            if (channels.length > 0) {
                const smallChannels = channels.filter(c => (c.subscribers || 0) < 10000);
                const largeChannels = channels.filter(c => (c.subscribers || 0) >= 10000);

                const smallChannelViralRate = smallChannels.length > 0 ?
                    smallChannels.filter(c => (c.avgViews || 0) > 100000).length / smallChannels.length : 0;
                const largeChannelViralRate = largeChannels.length > 0 ?
                    largeChannels.filter(c => (c.avgViews || 0) > 100000).length / largeChannels.length : 0;

                insights.channel.confidence = 72;
                insights.channel.findings = [
                    `小频道（<1万粉）占比 ${Math.round(smallChannels.length / channels.length * 100)}%`,
                    `小频道爆款率 ${Math.round(smallChannelViralRate * 100)}%`,
                    `内容质量比粉丝基数更重要`
                ];

                insights.channel.reasoning = [
                    { source: '黑马榜', icon: '🐴', observation: `小频道占黑马榜 ${Math.round(smallChannelViralRate * 100)}%`, weight: 60 },
                    { source: '增长榜', icon: '📈', observation: `小频道增长潜力大`, weight: 40 }
                ];
            }

            // 题材洞察（简化版）
            insights.topic.confidence = 78;
            insights.topic.findings = [
                '不同题材有不同的最佳时长',
                '交叉分析可发现最优组合',
                '建议根据数据选择题材方向'
            ];
            insights.topic.reasoning = [
                { source: '题材分析', icon: '🏷️', observation: '题材交叉分析', weight: 55 },
                { source: '总播放榜', icon: '📊', observation: '验证热门题材', weight: 45 }
            ];

            return insights;
        }

        // 更新时长洞察卡片
        function updateDurationInsight(data, videos) {
            // 更新标题
            if (data.bestRange) {
                document.getElementById('insight-duration-title').textContent = `${data.bestRange} 是最佳视频时长`;
            }

            // 更新置信度
            document.getElementById('insight-duration-confidence-bar').style.width = `${data.confidence}%`;
            document.getElementById('insight-duration-confidence-text').textContent = `置信度 ${data.confidence}%`;

            // 更新发现
            const findingsHtml = data.findings.map((f, i) =>
                `<div class="finding-item"><span class="finding-number">${['①','②','③'][i]}</span><span>${f}</span></div>`
            ).join('');
            document.getElementById('insight-duration-findings').innerHTML = findingsHtml;

            // 更新推理链
            const reasoningHtml = data.reasoning.map((r, i) => `
                <div class="reasoning-step" data-source-id="${r.source.toLowerCase().replace(/\s/g, '-')}">
                    <div class="step-header">
                        <span class="step-icon">${r.icon}</span>
                        <span class="step-name">${r.source}</span>
                        <span class="step-link">查看数据 ↗</span>
                    </div>
                    <div class="step-observation">${r.observation}</div>
                    <div class="step-weight">
                        <div class="weight-bar-bg"><div class="weight-bar-fill" style="width: ${r.weight}%"></div></div>
                        <span class="weight-text">权重 ${r.weight}%</span>
                    </div>
                </div>
                ${i < data.reasoning.length - 1 ? '<div class="reasoning-connector">+</div>' : ''}
            `).join('') + `
                <div class="reasoning-connector">↓</div>
                <div class="reasoning-conclusion">
                    <span class="conclusion-symbol">∴</span>
                    <span class="conclusion-text">多个榜单交叉验证 → ${data.bestRange || '最优时长区间'}</span>
                </div>
            `;
            document.getElementById('insight-duration-reasoning').innerHTML = reasoningHtml;

            // 更新数据表格
            updateDurationDataTable(videos, data.bestRange);

            // 绘制图表
            drawDurationChart(videos);
        }

        // 更新时长数据表格
        function updateDurationDataTable(videos, bestRange) {
            // 筛选最优时长区间的视频
            const filteredVideos = videos.slice(0, 20); // 简化：取前20个

            const tableHtml = `
                <div class="table-toolbar">
                    <div class="toolbar-group">
                        <span class="toolbar-label">排序:</span>
                        <select class="toolbar-select">
                            <option value="views-desc">播放量 ↓</option>
                            <option value="duration-asc">时长 ↑</option>
                        </select>
                    </div>
                    <div class="toolbar-actions">
                        <button class="toolbar-btn primary" onclick="exportInsightData()">导出数据</button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50px">#</th>
                            <th class="sortable">视频</th>
                            <th class="sortable">频道</th>
                            <th class="sortable sort-desc">播放量</th>
                            <th class="sortable">时长</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredVideos.map((v, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>
                                    <a href="${v.url || '#'}" target="_blank" class="entity-link video-link">${v.title || '未知标题'}</a>
                                </td>
                                <td>
                                    <a href="${v.channelUrl || '#'}" target="_blank" class="entity-link channel-link">${v.channel || '未知频道'}</a>
                                </td>
                                <td>${formatNumber(v.views || 0)}</td>
                                <td>${v.durationFormatted || '--'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="table-summary">
                    <div class="summary-item">
                        <span class="summary-label">共</span>
                        <span class="summary-value">${filteredVideos.length}</span>
                        <span class="summary-label">个视频</span>
                    </div>
                </div>
            `;

            document.getElementById('insight-duration-table').innerHTML = tableHtml;
            document.getElementById('insight-duration-table-title').textContent = `支撑数据：${bestRange || '最优时长'} Top ${filteredVideos.length}`;
        }

        // 绘制时长图表
        function drawDurationChart(videos) {
            const container = document.getElementById('insight-duration-chart');
            if (!container) return;

            // 计算时长分布
            const buckets = {};
            videos.forEach(v => {
                const duration = v.duration || 0;
                let bucket;
                if (duration < 180) bucket = '<3分';
                else if (duration < 300) bucket = '3-5分';
                else if (duration < 600) bucket = '5-10分';
                else if (duration < 1200) bucket = '10-20分';
                else bucket = '20分+';

                if (!buckets[bucket]) buckets[bucket] = { count: 0, totalViews: 0 };
                buckets[bucket].count++;
                buckets[bucket].totalViews += v.views || 0;
            });

            const data = ['<3分', '3-5分', '5-10分', '10-20分', '20分+'].map(range => ({
                range,
                avgViews: buckets[range] ? buckets[range].totalViews / buckets[range].count / 10000 : 0
            }));

            const maxViews = Math.max(...data.map(d => d.avgViews), 1);

            // 创建 SVG
            container.innerHTML = `
                <svg class="chart-svg" viewBox="0 0 400 250">
                    <line x1="50" y1="200" x2="380" y2="200" class="chart-axis"/>
                    <line x1="50" y1="200" x2="50" y2="30" class="chart-axis"/>

                    ${[0, 25, 50, 75, 100].map(p => {
                        const y = 200 - (p / 100) * 170;
                        const val = Math.round(maxViews * p / 100);
                        return `
                            <text x="45" y="${y + 4}" class="chart-axis-label" text-anchor="end">${val}万</text>
                            <line x1="50" y1="${y}" x2="380" y2="${y}" class="chart-grid-line"/>
                        `;
                    }).join('')}

                    ${data.map((d, i) => {
                        const x = 80 + i * 70;
                        return `<text x="${x}" y="220" class="chart-axis-label" text-anchor="middle">${d.range}</text>`;
                    }).join('')}

                    <polyline class="chart-line" points="${data.map((d, i) => {
                        const x = 80 + i * 70;
                        const y = 200 - (d.avgViews / maxViews) * 170;
                        return `${x},${y}`;
                    }).join(' ')}"/>

                    ${data.map((d, i) => {
                        const x = 80 + i * 70;
                        const y = 200 - (d.avgViews / maxViews) * 170;
                        const isBest = d.avgViews === Math.max(...data.map(dd => dd.avgViews));
                        return `<circle cx="${x}" cy="${y}" r="${isBest ? 7 : 5}" class="chart-point ${isBest ? 'highlighted' : ''}"/>`;
                    }).join('')}
                </svg>
            `;
        }

        // 更新频道洞察卡片
        function updateChannelInsight(data, channels) {
            document.getElementById('insight-channel-confidence-bar').style.width = `${data.confidence}%`;
            document.getElementById('insight-channel-confidence-text').textContent = `置信度 ${data.confidence}%`;

            const findingsHtml = data.findings.map((f, i) =>
                `<div class="finding-item"><span class="finding-number">${['①','②','③'][i]}</span><span>${f}</span></div>`
            ).join('');
            document.getElementById('insight-channel-findings').innerHTML = findingsHtml;

            const reasoningHtml = data.reasoning.map((r, i) => `
                <div class="reasoning-step">
                    <div class="step-header">
                        <span class="step-icon">${r.icon}</span>
                        <span class="step-name">${r.source}</span>
                    </div>
                    <div class="step-observation">${r.observation}</div>
                    <div class="step-weight">
                        <div class="weight-bar-bg"><div class="weight-bar-fill" style="width: ${r.weight}%"></div></div>
                        <span class="weight-text">权重 ${r.weight}%</span>
                    </div>
                </div>
                ${i < data.reasoning.length - 1 ? '<div class="reasoning-connector">+</div>' : ''}
            `).join('') + `
                <div class="reasoning-connector">↓</div>
                <div class="reasoning-conclusion">
                    <span class="conclusion-symbol">∴</span>
                    <span class="conclusion-text">新频道无需担心粉丝基数，专注内容质量</span>
                </div>
            `;
            document.getElementById('insight-channel-reasoning').innerHTML = reasoningHtml;

            // 绘制气泡图
            drawChannelBubbleChart(channels);
        }

        // 绘制频道气泡图
        function drawChannelBubbleChart(channels) {
            const container = document.getElementById('insight-channel-chart');
            if (!container) return;

            // 使用正确的字段名，按总播放量排序，取前8个避免拥挤
            const sorted = channels.slice(0, 8).sort((a, b) => (b.totalViews || 0) - (a.totalViews || 0));

            if (sorted.length === 0) {
                container.innerHTML = '<div class="no-data-hint">暂无频道数据</div>';
                return;
            }

            // 计算数据范围用于定位
            const maxViews = Math.max(...sorted.map(c => c.totalViews || 0));
            const maxSubs = Math.max(...sorted.map(c => c.subscriberCount || 1));

            container.innerHTML = `
                <div class="bubble-chart-wrapper">
                    <div class="bubble-y-axis">
                        <div class="axis-label">播放量</div>
                        <div class="axis-tick">${formatNumber(maxViews)}</div>
                        <div class="axis-tick">${formatNumber(maxViews / 2)}</div>
                        <div class="axis-tick">0</div>
                    </div>
                    <div class="bubble-chart-area">
                        ${sorted.map((c, i) => {
                            const subs = c.subscriberCount || 0;
                            const views = c.totalViews || 0;
                            const videos = c.videoCount || 1;
                            const channelId = c.channelId || '';
                            const channelName = (c.name || '未知').replace(/'/g, "\\'");

                            // X轴：订阅数（对数缩放让小频道也能分散开）
                            const xPos = maxSubs > 0 ? Math.min(92, 8 + (Math.log10(subs + 1) / Math.log10(maxSubs + 1)) * 84) : 8 + i * 10;
                            // Y轴：总播放量
                            const yPos = maxViews > 0 ? Math.max(8, 92 - (views / maxViews) * 84) : 50;
                            // 气泡大小：基于视频数量，最小50px可显示文字
                            const size = Math.max(50, 40 + Math.min(videos * 2, 40));
                            // 颜色：小频道绿色，大频道蓝色
                            const isSmall = subs < 100000;
                            // 显示名称：最多8个字符
                            const displayName = c.name ? (c.name.length > 8 ? c.name.substring(0, 7) + '…' : c.name) : '?';

                            return `
                                <div class="bubble-item ${isSmall ? 'small-channel' : 'large-channel'}"
                                     style="left: ${xPos}%; top: ${yPos}%; width: ${size}px; height: ${size}px;"
                                     onclick="showChannelTooltip(event, '${channelName}', ${subs}, ${views}, ${videos}, '${channelId}')"
                                     title="${c.name}: ${formatNumber(subs)}订阅, ${formatNumber(views)}播放">
                                    <span class="bubble-label">${displayName}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="bubble-x-axis">
                        <div class="axis-tick">0</div>
                        <div class="axis-tick">${formatNumber(maxSubs / 2)}</div>
                        <div class="axis-tick">${formatNumber(maxSubs)}</div>
                        <div class="axis-label">订阅数 →</div>
                    </div>
                    <div class="bubble-legend">
                        <span class="legend-item"><span class="legend-dot small"></span> 小频道(&lt;10万)</span>
                        <span class="legend-item"><span class="legend-dot large"></span> 大频道(≥10万)</span>
                        <span class="legend-item">⬤ 气泡越大=视频越多</span>
                    </div>
                </div>
            `;
        }

        // 显示频道详情提示
        function showChannelTooltip(event, name, subs, views, videos, channelId) {
            event.stopPropagation();
            // 移除之前的tooltip
            document.querySelectorAll('.channel-tooltip').forEach(t => t.remove());

            const tooltip = document.createElement('div');
            tooltip.className = 'channel-tooltip';

            const channelUrl = channelId ? `https://www.youtube.com/channel/${channelId}` : '';
            const avgViews = videos > 0 ? Math.round(views / videos) : 0;

            tooltip.innerHTML = `
                <div class="tooltip-header">
                    <span class="tooltip-title">📺 ${name}</span>
                    <span class="tooltip-close" onclick="this.parentElement.parentElement.remove()">✕</span>
                </div>
                <div class="tooltip-body">
                    <div class="tooltip-row"><span class="tooltip-label">订阅数</span><span class="tooltip-value">${formatNumber(subs)}</span></div>
                    <div class="tooltip-row"><span class="tooltip-label">总播放</span><span class="tooltip-value">${formatNumber(views)}</span></div>
                    <div class="tooltip-row"><span class="tooltip-label">视频数</span><span class="tooltip-value">${videos}</span></div>
                    <div class="tooltip-row"><span class="tooltip-label">均播放</span><span class="tooltip-value">${formatNumber(avgViews)}</span></div>
                </div>
                ${channelId ? `
                <div class="tooltip-footer">
                    <a href="${channelUrl}" target="_blank" class="tooltip-link">
                        🔗 打开YouTube频道
                    </a>
                </div>
                ` : ''}
            `;

            // 计算位置，避免超出屏幕
            const rect = event.target.getBoundingClientRect();
            let left = rect.right + 10;
            let top = rect.top;

            // 如果右侧空间不够，放到左侧
            if (left + 220 > window.innerWidth) {
                left = rect.left - 230;
            }
            // 如果底部空间不够，向上调整
            if (top + 200 > window.innerHeight) {
                top = window.innerHeight - 210;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            document.body.appendChild(tooltip);

            // 点击其他地方关闭
            setTimeout(() => {
                document.addEventListener('click', function closeTooltip(e) {
                    if (!tooltip.contains(e.target)) {
                        tooltip.remove();
                        document.removeEventListener('click', closeTooltip);
                    }
                });
            }, 100);
        }

        // 更新题材洞察卡片
        function updateTopicInsight(data, videos) {
            document.getElementById('insight-topic-confidence-bar').style.width = `${data.confidence}%`;
            document.getElementById('insight-topic-confidence-text').textContent = `置信度 ${data.confidence}%`;

            const findingsHtml = data.findings.map((f, i) =>
                `<div class="finding-item"><span class="finding-number">${['①','②','③'][i]}</span><span>${f}</span></div>`
            ).join('');
            document.getElementById('insight-topic-findings').innerHTML = findingsHtml;

            const reasoningHtml = data.reasoning.map((r, i) => `
                <div class="reasoning-step">
                    <div class="step-header">
                        <span class="step-icon">${r.icon}</span>
                        <span class="step-name">${r.source}</span>
                    </div>
                    <div class="step-observation">${r.observation}</div>
                    <div class="step-weight">
                        <div class="weight-bar-bg"><div class="weight-bar-fill" style="width: ${r.weight}%"></div></div>
                        <span class="weight-text">权重 ${r.weight}%</span>
                    </div>
                </div>
                ${i < data.reasoning.length - 1 ? '<div class="reasoning-connector">+</div>' : ''}
            `).join('') + `
                <div class="reasoning-connector">↓</div>
                <div class="reasoning-conclusion">
                    <span class="conclusion-symbol">∴</span>
                    <span class="conclusion-text">根据数据选择最优题材组合</span>
                </div>
            `;
            document.getElementById('insight-topic-reasoning').innerHTML = reasoningHtml;

            // 绘制热力图
            drawTopicHeatmap();
        }

        // 绘制题材热力图
        function drawTopicHeatmap() {
            const container = document.getElementById('insight-topic-chart');
            if (!container) return;

            const topics = ['教程类', 'Vlog', '知识类', '娱乐类'];
            const durations = ['<5分', '5-10分', '10-20分', '20分+'];

            // 模拟数据
            const data = topics.map(t => durations.map(() => Math.floor(Math.random() * 5) + 1));

            container.innerHTML = `
                <div class="heatmap-header">
                    ${durations.map(d => `<div class="heatmap-header-cell">${d}</div>`).join('')}
                </div>
                <div class="heatmap-container">
                    ${topics.map((t, ti) => `
                        <div class="heatmap-row">
                            <div class="heatmap-label">${t}</div>
                            ${durations.map((d, di) => `
                                <div class="heatmap-cell level-${data[ti][di]}" onclick="showHeatmapDetail('${t}', '${d}')">
                                    ${data[ti][di] * 15}万
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 显示热力图详情
        function showHeatmapDetail(topic, duration) {
            showInsightTooltip(`${topic} × ${duration}：点击查看详情`);
        }

        // 更新综合建议
        function updateComprehensiveRecommendation(insightData) {
            const avgConfidence = Math.round(
                (insightData.duration.confidence * 0.4 +
                 insightData.channel.confidence * 0.3 +
                 insightData.topic.confidence * 0.3)
            );

            document.getElementById('comprehensive-confidence').textContent = `综合置信度 ${avgConfidence}%`;

            // 更新推理树
            document.getElementById('tree-branch-container').innerHTML = `
                <div class="tree-branch-item">
                    <div class="tree-branch-connector"></div>
                    <div class="tree-node" onclick="scrollToInsightCard('insight-duration')">
                        <div class="tree-node-icon">💡</div>
                        <div class="tree-node-title">最佳时长</div>
                        <div class="tree-node-confidence">${insightData.duration.bestRange || '--'} · ${insightData.duration.confidence}%</div>
                    </div>
                </div>
                <div class="tree-branch-item">
                    <div class="tree-branch-connector"></div>
                    <div class="tree-node" onclick="scrollToInsightCard('insight-channel')">
                        <div class="tree-node-icon">💡</div>
                        <div class="tree-node-title">频道机会</div>
                        <div class="tree-node-confidence">小频道有机会 · ${insightData.channel.confidence}%</div>
                    </div>
                </div>
                <div class="tree-branch-item">
                    <div class="tree-branch-connector"></div>
                    <div class="tree-node" onclick="scrollToInsightCard('insight-topic')">
                        <div class="tree-node-icon">💡</div>
                        <div class="tree-node-title">题材选择</div>
                        <div class="tree-node-confidence">数据驱动 · ${insightData.topic.confidence}%</div>
                    </div>
                </div>
            `;

            // 更新建议列表
            document.getElementById('recommendation-list').innerHTML = `
                <div class="recommendation-item">
                    <span class="recommendation-icon">📌</span>
                    <span class="recommendation-text">将视频时长控制在 <strong>${insightData.duration.bestRange || '最优区间'}</strong></span>
                </div>
                <div class="recommendation-item">
                    <span class="recommendation-icon">📌</span>
                    <span class="recommendation-text">新频道专注<strong>内容质量</strong>，无需担心粉丝基数</span>
                </div>
                <div class="recommendation-item">
                    <span class="recommendation-icon">📌</span>
                    <span class="recommendation-text">根据热力图数据选择<strong>最优题材组合</strong></span>
                </div>
            `;

            // 更新置信度公式
            document.getElementById('confidence-formula').innerHTML =
                `${insightData.duration.confidence}% × 0.4 + ${insightData.channel.confidence}% × 0.3 + ${insightData.topic.confidence}% × 0.3 = <strong>${avgConfidence}%</strong>`;
        }

        // 显示工具提示
        function showInsightTooltip(text) {
            const tooltip = document.getElementById('insightTooltip');
            tooltip.textContent = text;
            tooltip.classList.add('visible');
            tooltip.style.left = '50%';
            tooltip.style.top = '20px';
            tooltip.style.transform = 'translateX(-50%)';
            setTimeout(() => tooltip.classList.remove('visible'), 2000);
        }

        // 导出洞察数据
        function exportInsightData() {
            showInsightTooltip('正在导出数据...');
        }

        // 格式化数字（简短版）
        // formatNumber 已在上方定义，这里是洞察系统专用的格式化函数
        function formatInsightNumber(num, short = false) {
            if (num === undefined || num === null) return '0';
            if (num >= 100000000) return (num / 100000000).toFixed(1) + '亿';
            if (num >= 10000) return (num / 10000).toFixed(short ? 0 : 1) + '万';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toString();
        }
    </script>
</body>
</html>
