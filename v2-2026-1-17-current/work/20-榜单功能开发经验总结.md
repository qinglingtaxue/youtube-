# 20-榜单功能开发经验总结

> 日期：2026-01-26
> 类型：实现层决策 + 踩坑经验

---

## 决策背景

用户需要在洞察系统中添加榜单功能，展示：
- Top 50 黑马频道（订阅少但播放好）
- Top 50 热门视频（按播放量）
- Top 10 热门话题（按视频数）

## 关键决策

### 1. 榜单位置：标签页 vs 右侧面板

**最初方案**：在页面右侧添加固定面板
**问题**：用户明确要求"在全局认识和套利分析**之间**增加榜单"
**最终方案**：作为标签页添加到导航中

**经验**：
- 理解用户意图时，注意"之间"、"旁边"、"右侧"等位置词的具体含义
- 当用户说"右侧"可能指：
  1. 页面整体右侧（独立面板）
  2. 某元素的右侧（相邻位置）
- **先确认再动手**，避免返工

### 2. 数据字段选择：theme vs keyword_source

**问题**：话题榜单只显示 2 个话题，但实际数据有很多话题

**原因分析**：
- 数据库中 `theme` 字段只有 2 个值（养生、健康养生）
- 实际话题数据存储在 `keyword_source` 字段（中医养生、健康科普、长寿秘诀等 20+ 个）

**解决方案**：
```sql
-- 错误：使用 theme 字段
SELECT theme, COUNT(*) FROM competitor_videos GROUP BY theme

-- 正确：使用 keyword_source 字段
SELECT keyword_source, COUNT(*) FROM competitor_videos GROUP BY keyword_source
```

**经验**：
- 开发前先检查实际数据分布：`SELECT DISTINCT field, COUNT(*) FROM table GROUP BY field`
- 不要假设字段含义，用数据验证
- 当结果与预期差异大时，90% 是数据源问题

### 3. 黑马频道指数计算

**公式**：`黑马指数 = 平均播放量 / max(订阅数, 1000)`

**SQL 实现**：
```sql
SELECT
    channel_name,
    AVG(view_count) as avg_views,
    MAX(subscriber_count) as subscriber_count,
    AVG(view_count) * 1.0 / MAX(MAX(subscriber_count, 1), 1000) as dark_horse_score
FROM competitor_videos
WHERE channel_name IS NOT NULL AND view_count > 0
GROUP BY channel_id, channel_name
HAVING COUNT(*) >= 2 AND MAX(subscriber_count) > 0
ORDER BY dark_horse_score DESC
```

**关键约束**：
- `HAVING COUNT(*) >= 2`：至少 2 个视频才有意义
- `MAX(subscriber_count) > 0`：必须有订阅数据
- `MAX(..., 1000)`：避免除零错误，设下限

### 4. 点击跳转实现

**需求**：频道和视频都要能点击跳转到 YouTube

**HTML 实现**：
```javascript
// 频道跳转
onclick="window.open('https://www.youtube.com/channel/{channel_id}', '_blank')"

// 视频跳转
onclick="window.open('https://www.youtube.com/watch?v={youtube_id}', '_blank')"
```

**注意事项**：
- `channel_id` 可能为空，需要检查
- 使用 `_blank` 在新标签页打开
- 添加视觉提示（↗ 图标）让用户知道可点击

## 文件修改清单

| 文件 | 修改内容 |
|------|----------|
| `api_server.py` | 新增 `/api/leaderboard` 端点 |
| `web/insight-system.html` | 添加榜单标签页和三个子标签页 |
| `web/css/insight.css` | 添加表格悬停样式 |
| `web/js/leaderboard.js` | 榜单数据加载和渲染逻辑 |

## 踩坑速查表

| 坑 | 原因 | 解决方案 |
|----|------|----------|
| 话题只有2个 | 查询了错误的字段 `theme` | 改用 `keyword_source` 字段 |
| 位置理解错误 | "右侧"有歧义 | 先确认用户指的是哪里 |
| 数据库路径错误 | 使用了空的 db 文件 | 检查实际数据在哪个 db |
| 频道链接点不开 | channel_id 为空 | 添加空值检查 |

## 可复用代码模式

### 1. 排名样式函数
```javascript
function getRankStyle(rank) {
    if (rank === 1) return 'background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1f2937;';
    if (rank === 2) return 'background: linear-gradient(135deg, #94a3b8, #64748b); color: white;';
    if (rank === 3) return 'background: linear-gradient(135deg, #d97706, #b45309); color: white;';
    return 'background: #334155; color: #94a3b8;';
}
```

### 2. 数字格式化函数
```javascript
function formatNumber(num) {
    if (num >= 100000000) return (num / 100000000).toFixed(1) + '亿';
    if (num >= 10000) return (num / 10000).toFixed(1) + '万';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toLocaleString();
}
```

### 3. 表格行模板
```html
<tr class="leaderboard-row" onclick="window.open(url, '_blank')" style="cursor: pointer;">
    <td><span style="排名样式">{rank}</span></td>
    <td><span class="link">{name}</span> <span>↗</span></td>
    <td style="text-align: right;">{value}</td>
</tr>
```

## 后续优化建议

1. **数据实时性**：添加"最后更新时间"显示
2. **筛选功能**：按时间范围筛选榜单
3. **导出功能**：支持导出 CSV
4. **缓存优化**：榜单数据可缓存，减少 DB 查询

---

**来源**：Claude Code 会话 2026-01-26
