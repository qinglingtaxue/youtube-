# TD-13: 采集关键词逻辑与视频筛选规则 / Collection Keywords Logic & Video Filtering Rules

> 结构化的关键词配置与多维度视频筛选机制
> Structured keyword configuration and multi-dimensional video filtering mechanism

---

## 决策概要 / Decision Summary

| 属性 / Attribute | 值 / Value |
|------------------|------------|
| 决策编号 / ID | TD-13 |
| 决策类型 / Type | 实现方案 / Implementation |
| 决策日期 / Date | 2026-01-19 |
| 来源对话 / Source | c16b6744 |
| 状态 / Status | 已执行 / Implemented |

---

## 配置结构 / Configuration Structure

```
config/
├── keywords/                       # 关键词配置 / Keyword Config
│   ├── core.json                   # 核心关键词
│   ├── extended.json               # 扩展关键词
│   └── competitors.json            # 竞品关键词
├── filters/                        # 筛选配置 / Filter Config
│   ├── time-range.json             # 时间范围
│   ├── duration.json               # 视频时长
│   └── quality.json                # 质量标准
└── rules/                          # 规则配置 / Rule Config
    ├── dedup.json                  # 去重规则
    └── validation.json             # 验证规则
```

---

## 配置索引 / Configuration Index

| # | 配置文件 / Config File | 中文说明 | English Description | 更新频率 / Update |
|---|------------------------|---------|---------------------|-------------------|
| 1 | `keywords/core.json` | 核心业务关键词 | Core business keywords | 月度 |
| 2 | `keywords/extended.json` | 扩展长尾关键词 | Extended long-tail keywords | 周度 |
| 3 | `keywords/competitors.json` | 竞品品牌关键词 | Competitor brand keywords | 季度 |
| 4 | `filters/time-range.json` | 时间范围筛选 | Time range filters | 固定 |
| 5 | `filters/duration.json` | 视频时长筛选 | Video duration filters | 固定 |
| 6 | `rules/dedup.json` | 去重规则配置 | Deduplication rules | 固定 |

---

## 配置详解 / Configuration Details

### 1. 关键词配置 / Keyword Configuration

```json
// config/keywords/core.json
{
  "version": "1.0",
  "groups": [
    {
      "name": "核心词",
      "priority": "high",
      "keywords": [
        "Python教程",
        "JavaScript入门",
        "React开发"
      ],
      "weight": 1.0
    },
    {
      "name": "长尾词",
      "priority": "medium",
      "keywords": [
        "Python爬虫实战",
        "React Hooks详解",
        "TypeScript高级特性"
      ],
      "weight": 0.8
    },
    {
      "name": "竞品词",
      "priority": "low",
      "keywords": [
        "某某频道",
        "某某教程"
      ],
      "weight": 0.5
    }
  ]
}
```

**关键词优先级规则 / Priority Rules:**

```
优先级调度 / Priority Scheduling
────────────────────────────────────────────────────────────

high (权重 1.0)     ████████████████████  最先采集
medium (权重 0.8)   ████████████████      其次采集
low (权重 0.5)      ██████████            最后采集

采集顺序 = 优先级 → 组内字母序
```

---

### 2. 时间范围筛选 / Time Range Filtering

```json
// config/filters/time-range.json
{
  "version": "1.0",
  "ranges": [
    {
      "name": "hour",
      "label": "最近1小时",
      "labelEn": "Last hour",
      "youtubeParam": "EgIIAQ==",
      "urlEncoded": "EgIIAQ%3D%3D",
      "useCase": "实时热点追踪"
    },
    {
      "name": "today",
      "label": "今天",
      "labelEn": "Today",
      "youtubeParam": "EgIIAg==",
      "urlEncoded": "EgIIAg%3D%3D",
      "useCase": "当日更新监控"
    },
    {
      "name": "week",
      "label": "本周",
      "labelEn": "This week",
      "youtubeParam": "EgIIAw==",
      "urlEncoded": "EgIIAw%3D%3D",
      "useCase": "周度趋势分析"
    },
    {
      "name": "month",
      "label": "本月",
      "labelEn": "This month",
      "youtubeParam": "EgIIBA==",
      "urlEncoded": "EgIIBA%3D%3D",
      "useCase": "月度内容规划"
    }
  ]
}
```

---

### 3. 视频筛选规则 / Video Filtering Rules

```typescript
// lib/filters.ts

interface Video {
  id: string
  title: string
  channel: string
  views: number
  duration: number       // 秒
  publishedAt: Date
  thumbnail: string
}

interface FilterConfig {
  minViews: number
  minDuration: number    // 秒
  maxDuration: number    // 秒
  excludeChannels: string[]
  excludeKeywords: string[]
  requiredFields: string[]
}

const defaultFilterConfig: FilterConfig = {
  minViews: 1000,
  minDuration: 10,       // 最少 10 秒
  maxDuration: 3600,     // 最多 1 小时
  excludeChannels: [],
  excludeKeywords: ['#shorts', '直播回放'],
  requiredFields: ['id', 'title', 'views', 'duration'],
}

function shouldCollect(video: Video, config: FilterConfig = defaultFilterConfig): boolean {
  // 1. 必填字段检查
  for (const field of config.requiredFields) {
    if (!video[field as keyof Video]) {
      console.log(`[Filter] Missing field: ${field}`)
      return false
    }
  }

  // 2. 播放量检查
  if (video.views < config.minViews) {
    console.log(`[Filter] Views too low: ${video.views}`)
    return false
  }

  // 3. 时长检查
  if (video.duration < config.minDuration) {
    console.log(`[Filter] Duration too short: ${video.duration}s`)
    return false
  }
  if (video.duration > config.maxDuration) {
    console.log(`[Filter] Duration too long: ${video.duration}s`)
    return false
  }

  // 4. 排除频道检查
  if (config.excludeChannels.includes(video.channel)) {
    console.log(`[Filter] Excluded channel: ${video.channel}`)
    return false
  }

  // 5. 排除关键词检查
  for (const keyword of config.excludeKeywords) {
    if (video.title.includes(keyword)) {
      console.log(`[Filter] Excluded keyword: ${keyword}`)
      return false
    }
  }

  return true
}
```

---

### 4. 去重规则 / Deduplication Rules

```typescript
// lib/dedup.ts

interface DedupConfig {
  primaryKey: string
  secondaryKeys: string[]
  similarityThreshold: number  // 0-1, 用于标题相似度
}

const defaultDedupConfig: DedupConfig = {
  primaryKey: 'id',
  secondaryKeys: ['title', 'channel'],
  similarityThreshold: 0.9,
}

class Deduplicator {
  private seen: Map<string, Video> = new Map()
  private config: DedupConfig

  constructor(config: DedupConfig = defaultDedupConfig) {
    this.config = config
  }

  isDuplicate(video: Video): boolean {
    // 1. 主键去重（视频 ID）
    if (this.seen.has(video.id)) {
      return true
    }

    // 2. 标题相似度去重
    for (const [, existing] of this.seen) {
      const similarity = this.calculateSimilarity(
        video.title,
        existing.title
      )
      if (similarity >= this.config.similarityThreshold) {
        console.log(`[Dedup] Similar title found: ${video.title}`)
        return true
      }
    }

    // 3. 记录已见视频
    this.seen.set(video.id, video)
    return false
  }

  private calculateSimilarity(a: string, b: string): number {
    // Jaccard 相似度
    const setA = new Set(a.split(''))
    const setB = new Set(b.split(''))
    const intersection = new Set([...setA].filter(x => setB.has(x)))
    const union = new Set([...setA, ...setB])
    return intersection.size / union.size
  }

  getStats(): { total: number; unique: number } {
    return {
      total: this.seen.size,
      unique: this.seen.size,
    }
  }
}
```

---

### 5. 完整采集流程 / Complete Collection Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                        采集流程 / Collection Flow                   │
└─────────────────────────────────────────────────────────────────────┘

     关键词配置                     筛选规则                     输出
    ─────────────────────────────────────────────────────────────────

    ┌─────────────┐
    │ core.json   │───┐
    └─────────────┘   │
                      │      ┌─────────────┐      ┌─────────────┐
    ┌─────────────┐   │      │             │      │             │
    │extended.json│───┼─────▶│  排序合并    │─────▶│ 生成任务队列 │
    └─────────────┘   │      │             │      │             │
                      │      └─────────────┘      └──────┬──────┘
    ┌─────────────┐   │                                  │
    │competitors  │───┘                                  │
    └─────────────┘                                      │
                                                         ▼
                                                  ┌─────────────┐
                                                  │  RPA 采集   │
                                                  └──────┬──────┘
                                                         │
         ┌───────────────────────────────────────────────┤
         │                                               │
         ▼                                               ▼
  ┌─────────────┐                               ┌─────────────┐
  │  字段验证   │                               │  去重检查   │
  └──────┬──────┘                               └──────┬──────┘
         │                                             │
         ▼                                             ▼
  ┌─────────────┐                               ┌─────────────┐
  │  播放量筛选 │                               │  相似度检测 │
  └──────┬──────┘                               └──────┬──────┘
         │                                             │
         ▼                                             ▼
  ┌─────────────┐                               ┌─────────────┐
  │  时长筛选   │                               │  记录已见   │
  └──────┬──────┘                               └──────┬──────┘
         │                                             │
         └───────────────────────┬─────────────────────┘
                                 │
                                 ▼
                          ┌─────────────┐
                          │  数据存储   │
                          │ videos.json │
                          └─────────────┘
```

---

### 6. 使用示例 / Usage Example

```typescript
// scripts/collect.ts
import { loadKeywords } from '@/config/keywords'
import { shouldCollect } from '@/lib/filters'
import { Deduplicator } from '@/lib/dedup'
import { RpaCollector } from '@/lib/rpa'

async function main() {
  // 1. 加载配置
  const keywords = await loadKeywords()
  const deduplicator = new Deduplicator()
  const collector = new RpaCollector()

  // 2. 按优先级排序
  const sortedKeywords = keywords
    .sort((a, b) => b.priority - a.priority)

  const results: Video[] = []

  // 3. 遍历采集
  for (const keyword of sortedKeywords) {
    console.log(`[Collect] Keyword: ${keyword.word}`)

    const videos = await collector.search(keyword.word, {
      timeRange: 'week',
      sortBy: 'views',
      maxResults: 100,
    })

    // 4. 筛选和去重
    for (const video of videos) {
      if (!shouldCollect(video)) continue
      if (deduplicator.isDuplicate(video)) continue

      results.push(video)
    }

    console.log(`[Collect] Found ${results.length} videos`)
  }

  // 5. 保存结果
  await saveResults(results)
  console.log(`[Done] Total: ${results.length} videos`)
}
```

---

## 快速导航 / Quick Navigation

### 想修改关键词？ / Want to modify keywords?
→ 编辑 `config/keywords/*.json`

### 想调整筛选规则？ / Want to adjust filters?
→ 编辑 `lib/filters.ts` 中的 `defaultFilterConfig`

### 想了解采集架构？ / Want collection architecture?
→ 阅读 [TD-04: RPA 矩阵架构](./04-采用RPA固化脚本矩阵架构.md)

### 想了解 YouTube 参数？ / Want YouTube params?
→ 阅读 [TD-15: YouTube 原生过滤](./15-采用YouTube原生搜索过滤机制.md)

---

## 注意事项 / Notes

1. **关键词维护 / Keyword Maintenance**：定期更新热门关键词
2. **阈值调优 / Threshold Tuning**：根据数据量调整播放量阈值
3. **去重效率 / Dedup Efficiency**：大数据量时考虑使用 BloomFilter
4. **日志记录 / Logging**：记录被过滤的原因便于分析
5. **配置版本 / Config Version**：配置文件包含版本号便于追踪
6. **热更新 / Hot Reload**：支持运行时重载配置

---

## 相关决策 / Related Decisions

| 决策 / Decision | 关系 / Relation |
|-----------------|-----------------|
| [TD-04](./04-采用RPA固化脚本矩阵架构.md) | 上游：采集框架 |
| [TD-15](./15-采用YouTube原生搜索过滤机制.md) | 配合：URL 参数构建 |

---

*最后更新 / Last Updated: 2026-01-20*
